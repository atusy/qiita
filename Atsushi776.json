[{"rendered_body":["<p><a href=\"https://qiita.com/m5d215/items/f5ae82ad9a3726519904\" id=\"reference-72b19d57523cbb3b1be7\">オンプレでVS Code as a Serviceできるcode-serverを試す<\/a> を読んでついに来た! となった．<br>\nGithub の <a href=\"https://github.com/codercom/code-server\" rel=\"nofollow noopener\" target=\"_blank\">codercom/code-server<\/a> を見ると，以下のコマンドにより <code>docker<\/code> でも試せるらしい．<br>\nせっかくなので <code>docker-compose<\/code> してみた．<br>\n今のところ <code>root<\/code> ユーザでしかコーディングできないっぽいので，強い人による <code>Dockerfile<\/code> 更新が待たれる．<br>\n<code>environment<\/code> で任意のユーザーを作れるようになったら実用しようかな．<\/p>\n\n<h1>\n<span id=\"docker-で-code-server\" class=\"fragment\"><\/span><a href=\"#docker-%E3%81%A7-code-server\"><i class=\"fa fa-link\"><\/i><\/a>docker で code-server<\/h1>\n\n<p>公式に載ってる． <code>code-server --allow-http --no-auth<\/code> をつけてると少なくとも Firefox ではセキュリティ的にアウトで弾かれる．<\/p>\n\n<div class=\"code-frame\" data-lang=\"sh\"><div class=\"highlight\"><pre>docker run <span class=\"nt\">-p<\/span> 127.0.0.1:8443:8443 <span class=\"nt\">-v<\/span> <span class=\"s2\">\"<\/span><span class=\"k\">${<\/span><span class=\"nv\">PWD<\/span><span class=\"k\">}<\/span><span class=\"s2\">:/root/project\"<\/span> codercom/code-server code-server <span class=\"nt\">--allow-http<\/span> <span class=\"nt\">--no-auth<\/span>\n<\/pre><\/div><\/div>\n\n<h1>\n<span id=\"docker-compose-で-code-server\" class=\"fragment\"><\/span><a href=\"#docker-compose-%E3%81%A7-code-server\"><i class=\"fa fa-link\"><\/i><\/a>docker-compose で code-server<\/h1>\n\n<p>以下の <code>docker-compose.yaml<\/code> を作成後， <code>sudo docker-compose up<\/code> して，ログに出てくるパスワードを入力 (よって <code>-d<\/code> オプション不可)．<br>\n二度目以降の起動時は <code>-d<\/code> をつけても OK．<br>\n<code>--allow-http --no-auth<\/code> はコメントアウトした．<\/p>\n\n<p>永続化により，projectディレクトリ以下はホストに保存されるが，ホストによる編集にはルート権限が必要．<\/p>\n\n<div class=\"code-frame\" data-lang=\"yaml\">\n<div class=\"code-lang\"><span class=\"bold\">docker-compose.yaml<\/span><\/div>\n<div class=\"highlight\"><pre><span class=\"na\">version<\/span><span class=\"pi\">:<\/span> <span class=\"s2\">\"<\/span><span class=\"s\">3\"<\/span>\n<span class=\"na\">services<\/span><span class=\"pi\">:<\/span>\n  <span class=\"na\">code<\/span><span class=\"pi\">:<\/span>\n    <span class=\"na\">image<\/span><span class=\"pi\">:<\/span> <span class=\"s\">codercom/code-server<\/span>\n    <span class=\"na\">restart<\/span><span class=\"pi\">:<\/span> <span class=\"s\">always<\/span>\n    <span class=\"na\">ports<\/span><span class=\"pi\">:<\/span> \n      <span class=\"pi\">-<\/span> <span class=\"s2\">\"<\/span><span class=\"s\">8443:8443\"<\/span>\n    <span class=\"c1\"># command: code-server --no-auth --allow-http<\/span>\n    <span class=\"na\">volumes<\/span><span class=\"pi\">:<\/span>\n      <span class=\"pi\">-<\/span> <span class=\"s\">./project:/root/project<\/span>\n<\/pre><\/div>\n<\/div>\n"],"body":["[オンプレでVS Code as a Serviceできるcode-serverを試す](https://qiita.com/m5d215/items/f5ae82ad9a3726519904) を読んでついに来た! となった．\nGithub の [codercom/code-server](https://github.com/codercom/code-server) を見ると，以下のコマンドにより `docker` でも試せるらしい．\nせっかくなので `docker-compose` してみた．\n今のところ `root` ユーザでしかコーディングできないっぽいので，強い人による `Dockerfile` 更新が待たれる．\n`environment` で任意のユーザーを作れるようになったら実用しようかな．\n\n# docker で code-server\n\n公式に載ってる． `code-server --allow-http --no-auth` をつけてると少なくとも Firefox ではセキュリティ的にアウトで弾かれる．\n\n```sh\ndocker run -p 127.0.0.1:8443:8443 -v \"${PWD}:/root/project\" codercom/code-server code-server --allow-http --no-auth\n```\n\n# docker-compose で code-server\n\n以下の `docker-compose.yaml` を作成後， `sudo docker-compose up` して，ログに出てくるパスワードを入力 (よって `-d` オプション不可)．\n二度目以降の起動時は `-d` をつけても OK．\n`--allow-http --no-auth` はコメントアウトした．\n\n永続化により，projectディレクトリ以下はホストに保存されるが，ホストによる編集にはルート権限が必要．\n\n```{docker-compose.yaml}\nversion: \"3\"\nservices:\n  code:\n    image: codercom/code-server\n    restart: always\n    ports: \n      - \"8443:8443\"\n    # command: code-server --no-auth --allow-http\n    volumes:\n      - ./project:/root/project\n```\n"],"coediting":[false],"comments_count":[0],"created_at":["2019-03-09T11:56:57+09:00"],"group":{},"id":["aa9ce6d10e943b661310"],"likes_count":[8],"private":[false],"reactions_count":[0],"tags":[{"name":["Docker"],"versions":[]},{"name":["docker-compose"],"versions":[]},{"name":["VSCode"],"versions":[]}],"title":["Code server の Docker image を試した"],"updated_at":["2019-03-09T11:56:57+09:00"],"url":["https://qiita.com/Atsushi776/items/aa9ce6d10e943b661310"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["<p>本記事でやりたいことはCtrl+Shift+Lで賄えることを教えてもらいました。<br>\nこれによりexportされない関数も読み込むことができます。<br>\n(2018/06/08 18:00)<\/p>\n\n<blockquote class=\"twitter-tweet\">\n<p>あれ、Load allはだめなの？（Ctrl+Shift+L）<\/p>— Hiroaki Yutani (@yutannihilation) <a href=\"https://twitter.com/yutannihilation/status/1004943801155182592?ref_src=twsrc%5Etfw\" rel=\"nofollow noopener\" target=\"_blank\">June 8, 2018<\/a>\n<\/blockquote>\n\n<script async src=\"https://platform.twitter.com/widgets.js\"><\/script>\n\n<hr>\n\n<p>ひょっとしたら便利なTip?<\/p>\n\n<p>パッケージ製作にデバグはつきものですが、そのためのオブジェクト(関数など)の読み込みが面倒です。<br>\n多分、よくある手は<\/p>\n\n<ul>\n<li>RStudio上で、開いているソースコードを適宜source ( <code>Ctrl+Shift+S<\/code> )<\/li>\n<li>パッケージをビルド&amp;ロード ( <code>Ctrl+Shift+B<\/code> )<\/li>\n<\/ul>\n\n<p>のどちらかでしょう。<br>\n前者であれば、exportされていない関数も使えますが、後者であれば、exportされていない関数を使うには <code>package:::function<\/code> する必要があり面倒です。<\/p>\n\n<p>そこで、以下のコードを.Rprofileに仕込んでみました。<\/p>\n\n<p>これにより、プロジェクトを開いた時、プロジェクトがパッケージ作成を目的としていると <code>./R<\/code>以下にあるソースファイル(*.R)を全て <code>source<\/code> してくれます。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">rproj<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">dir<\/span><span class=\"p\">(<\/span><span class=\"n\">pattern<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"s1\">'\\\\.Rproj$'<\/span><span class=\"p\">)[<\/span><span class=\"m\">1<\/span><span class=\"p\">]<\/span><span class=\"w\">\n<\/span><span class=\"k\">if<\/span><span class=\"p\">(<\/span><span class=\"o\">!<\/span><span class=\"nf\">is.na<\/span><span class=\"p\">(<\/span><span class=\"n\">rproj<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">&amp;&amp;<\/span><span class=\"w\"> <\/span><span class=\"nf\">any<\/span><span class=\"p\">(<\/span><span class=\"n\">grepl<\/span><span class=\"p\">(<\/span><span class=\"s1\">'BuildType: Package'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">readLines<\/span><span class=\"p\">(<\/span><span class=\"n\">rproj<\/span><span class=\"p\">))))<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n  <\/span><span class=\"nf\">invisible<\/span><span class=\"p\">(<\/span><span class=\"n\">lapply<\/span><span class=\"p\">(<\/span><span class=\"w\">\n    <\/span><span class=\"n\">dir<\/span><span class=\"p\">(<\/span><span class=\"s1\">'./R'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">pattern<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"s1\">'*.R'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">full.names<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"kc\">TRUE<\/span><span class=\"p\">),<\/span><span class=\"w\">\n    <\/span><span class=\"n\">source<\/span><span class=\"w\">\n  <\/span><span class=\"p\">))<\/span><span class=\"w\">\n<\/span><span class=\"p\">}<\/span><span class=\"w\">\n<\/span><span class=\"n\">rm<\/span><span class=\"p\">(<\/span><span class=\"n\">rpoj<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>関数を読み込み直したい時はRを再起動しましょう ( <code>Ctrl+Shift+R<\/code> )。<\/p>\n\n<p>注意点として、オブジェクトが全てGlobal環境にassignされてしまいます。<\/p>\n\n<p>開発中のパッケージを <code>library(package)<\/code> してもそれらはGlobal環境下にあるものにマスクされてしまいます。<br>\n適宜 <code>rm<\/code> して下さい。<\/p>\n\n<p>Enjoy!<\/p>\n"],"body":["\n本記事でやりたいことはCtrl+Shift+Lで賄えることを教えてもらいました。\nこれによりexportされない関数も読み込むことができます。\n(2018/06/08 18:00)\n\n<blockquote class=\"twitter-tweet\" data-lang=\"en\"><p lang=\"ja\" dir=\"ltr\">あれ、Load allはだめなの？（Ctrl+Shift+L）<\/p>&mdash; Hiroaki Yutani (@yutannihilation) <a href=\"https://twitter.com/yutannihilation/status/1004943801155182592?ref_src=twsrc%5Etfw\">June 8, 2018<\/a><\/blockquote>\n<script async src=\"https://platform.twitter.com/widgets.js\" charset=\"utf-8\"><\/script>\n\n\n----------\n\nひょっとしたら便利なTip?\n\nパッケージ製作にデバグはつきものですが、そのためのオブジェクト(関数など)の読み込みが面倒です。\n多分、よくある手は\n\n- RStudio上で、開いているソースコードを適宜source ( `Ctrl+Shift+S` )\n- パッケージをビルド&ロード ( `Ctrl+Shift+B` )\n\nのどちらかでしょう。\n前者であれば、exportされていない関数も使えますが、後者であれば、exportされていない関数を使うには `package:::function` する必要があり面倒です。\n\nそこで、以下のコードを.Rprofileに仕込んでみました。\n\nこれにより、プロジェクトを開いた時、プロジェクトがパッケージ作成を目的としていると `./R`以下にあるソースファイル(*.R)を全て `source` してくれます。\n\n```r\nrproj <- dir(pattern = '\\\\.Rproj$')[1]\nif(!is.na(rproj) && any(grepl('BuildType: Package', readLines(rproj)))) {\n  invisible(lapply(\n    dir('./R', pattern = '*.R', full.names = TRUE),\n    source\n  ))\n}\nrm(rpoj)\n```\n\n関数を読み込み直したい時はRを再起動しましょう ( `Ctrl+Shift+R` )。\n\n注意点として、オブジェクトが全てGlobal環境にassignされてしまいます。\n\n開発中のパッケージを `library(package)` してもそれらはGlobal環境下にあるものにマスクされてしまいます。\n適宜 `rm` して下さい。\n\nEnjoy!\n"],"coediting":[false],"comments_count":[3],"created_at":["2018-06-08T13:19:37+09:00"],"group":{},"id":["0f83d50338c7156b716f"],"likes_count":[1],"private":[false],"reactions_count":[0],"tags":[{"name":["R"],"versions":[]}],"title":["パッケージ製作のための.Rprofile (.Rをとにかくsource)"],"updated_at":["2018-06-08T18:00:34+09:00"],"url":["https://qiita.com/Atsushi776/items/0f83d50338c7156b716f"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["\n<h1>\n<span id=\"はじめに\" class=\"fragment\"><\/span><a href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"><i class=\"fa fa-link\"><\/i><\/a>はじめに<\/h1>\n\n<p>科学の再現性が改めて重視される世にあって、Rmarkdownの便利さもより強く認識される日々です。<\/p>\n\n<p>例えば、<a href=\"/kohske\" class=\"user-mention js-hovercard\" title=\"kohske\" data-hovercard-target-type=\"user\" data-hovercard-target-name=\"kohske\">@kohske<\/a> さんが「再現可能性のすゝめ」というRmd本を執筆しました。<br>\n<a href=\"https://qiita.com/kohske/items/3e8c02e9598c6d230a47\" class=\"autolink\" id=\"reference-f00edacb252c3ffa5757\">https://qiita.com/kohske/items/3e8c02e9598c6d230a47<\/a><\/p>\n\n<p>ちなみにまだ買ってもいません…………。<\/p>\n\n<p>このため、同書で言及されているかは知りませんが、Rmdを使って再現性を確保していくにあたって、問題となりうることの一つに<\/p>\n\n<p>.Rprofile<\/p>\n\n<p>があります。<\/p>\n\n<p>これは、R起動時に実行したしスクリプトを書いておくところで、<\/p>\n\n<ul>\n<li>CRANミラーの選択<\/li>\n<li>ライブラリの読み込み<\/li>\n<li>メッセージの表示<\/li>\n<\/ul>\n\n<p>などなど、いろいろなことができます。<\/p>\n\n<p>.Rprofileをホームディレクトリに置いて、オレオレR環境を整備しておくと便利なのですが、Rmdのknit時にも読み込まれてしまうため、異なる環境で同じRmdファイルをknitしても同じ出力が得られるとは限りません。<\/p>\n\n<p>しかし、.Rprofileをうまく使うと、Rmdファイルを作成する度に読み込むパッケージを羅列する必要がなくなるので便利です。<\/p>\n\n<p>どうしたら、再現性を保ちつつ、.Rprofileを運用できるのでしょうか。<\/p>\n\n<h1>\n<span id=\"working-directoryにrprofileを置く\" class=\"fragment\"><\/span><a href=\"#working-directory%E3%81%ABrprofile%E3%82%92%E7%BD%AE%E3%81%8F\"><i class=\"fa fa-link\"><\/i><\/a>working directoryに.Rprofileを置く<\/h1>\n\n<p>working directoryに.Rprofileを置くと、それはホームディレクトリ下のものよりも高い優先順位を持ちます。<br>\nRStudio上でプロジェクトを管理しているならば、プロジェクトディレクトリ = working directoryなので、そこに.Rprofileをコピーするといいでしょう。<br>\nディレクトリを丸ごと別環境に移しても.Rprofileの内容が再現されます。<\/p>\n\n<p>これで子chunkだけを実行する時も、必ず実行したいコードは.Rprofileに仕込めばOKですね!<\/p>\n\n<h1>\n<span id=\"rmd内にrprofileをインポートする\" class=\"fragment\"><\/span><a href=\"#rmd%E5%86%85%E3%81%ABrprofile%E3%82%92%E3%82%A4%E3%83%B3%E3%83%9D%E3%83%BC%E3%83%88%E3%81%99%E3%82%8B\"><i class=\"fa fa-link\"><\/i><\/a>Rmd内に、.Rprofileをインポートする<\/h1>\n\n<p>発展的には、プロジェクトディレクトリに置いた.RprofileをRmdファイルにインポートすると、出力(htmlなど)で.Rprofileの内容も確認できて便利です。<br>\nこれには少々工夫がいります。<\/p>\n\n<p><code>source('.Rprofile')<\/code> では、.Rprofile中のソースコードが出力に表示されないためです。<\/p>\n\n<p><code>child = '.Rprofile'<\/code> も.RprofileがRmdファイルではないがために愉快な出力になります。<\/p>\n\n<h2>\n<span id=\"そこで下記のようにします\" class=\"fragment\"><\/span><a href=\"#%E3%81%9D%E3%81%93%E3%81%A7%E4%B8%8B%E8%A8%98%E3%81%AE%E3%82%88%E3%81%86%E3%81%AB%E3%81%97%E3%81%BE%E3%81%99\"><i class=\"fa fa-link\"><\/i><\/a>そこで下記のようにします<\/h2>\n\n<h3>\n<span id=\"rprofileの編集\" class=\"fragment\"><\/span><a href=\"#rprofile%E3%81%AE%E7%B7%A8%E9%9B%86\"><i class=\"fa fa-link\"><\/i><\/a>.Rprofileの編集<\/h3>\n\n<p>冒頭に <code>## @knitr rprofile<\/code> を追記し、Rmdから.Rprofileを取り込めるようにしましょう(<a href=\"https://qiita.com/yu-iskw/items/ad6e18b65ae33d90d00a\">参考<\/a>)。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\">\n<div class=\"code-lang\"><span class=\"bold\">.Rprofile<\/span><\/div>\n<div class=\"highlight\"><pre><span class=\"n\">print<\/span><span class=\"p\">(<\/span><span class=\"s1\">'Printed before knit, but not during knit'<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"c1\"># if yout want this code to be printed, set eval = TRUE for rprofile chunk in Rprofile.Rmd<\/span><span class=\"w\">\n<\/span><span class=\"n\">hello<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"s1\">'hello world'<\/span><span class=\"w\"> <\/span><span class=\"c1\"># Although nothing in thi chunk is printed, same codes are evaluated as .Rprofile, hence you can refer to object \"hello\" later.<\/span><span class=\"w\">\n<\/span><\/pre><\/div>\n<\/div>\n\n<p>繰り返しになりますが、プロジェクトディレクトリに置いておきます。<\/p>\n\n<h3>\n<span id=\"rprofileを取り込むrmdファイルを作成\" class=\"fragment\"><\/span><a href=\"#rprofile%E3%82%92%E5%8F%96%E3%82%8A%E8%BE%BC%E3%82%80rmd%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E4%BD%9C%E6%88%90\"><i class=\"fa fa-link\"><\/i><\/a>.Rprofileを取り込むRmdファイルを作成<\/h3>\n\n<p>下記のように Rprofile.Rmd を作成しましょう。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\">\n<div class=\"code-lang\"><span class=\"bold\">Rprofile.Rmd<\/span><\/div>\n<div class=\"highlight\"><pre><span class=\"err\">``<\/span><span class=\"n\">`{r, include = FALSE}\nknitr::read_chunk(\"script.R\")\n`<\/span><span class=\"err\">`<\/span><span class=\"n\">`　\n↓ here is the content of .Rprofile\n`<\/span><span class=\"err\">`<\/span><span class=\"n\">`{r rprofile eval = TRUE}\n`<\/span><span class=\"err\">``　<\/span><span class=\"w\">\n<\/span><span class=\"err\">↑<\/span><span class=\"w\"> <\/span><span class=\"n\">here<\/span><span class=\"w\"> <\/span><span class=\"n\">is<\/span><span class=\"w\"> <\/span><span class=\"n\">the<\/span><span class=\"w\"> <\/span><span class=\"n\">content<\/span><span class=\"w\"> <\/span><span class=\"n\">of<\/span><span class=\"w\"> <\/span><span class=\"n\">.Rprofile<\/span><span class=\"w\">\n<\/span><\/pre><\/div>\n<\/div>\n\n<p>ここで何をしているかは <a href=\"/yu-iskw\" class=\"user-mention js-hovercard\" title=\"yu-iskw\" data-hovercard-target-type=\"user\" data-hovercard-target-name=\"yu-iskw\">@yu-iskw<\/a> さんの<\/p>\n\n<p><a href=\"https://qiita.com/yu-iskw/items/ad6e18b65ae33d90d00a\">Knitr で外部の R スクリプトの取り込む方法<\/a><\/p>\n\n<p>を参考にしてください。<\/p>\n\n<h3>\n<span id=\"メインのrmdからrprofilermdを呼び出す\" class=\"fragment\"><\/span><a href=\"#%E3%83%A1%E3%82%A4%E3%83%B3%E3%81%AErmd%E3%81%8B%E3%82%89rprofilermd%E3%82%92%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%99\"><i class=\"fa fa-link\"><\/i><\/a>メインのRmdからrprofile.Rmdを呼び出す<\/h3>\n\n<div class=\"code-frame\" data-lang=\"r\">\n<div class=\"code-lang\"><span class=\"bold\">main.Rmd<\/span><\/div>\n<div class=\"highlight\"><pre><span class=\"err\">``<\/span><span class=\"n\">`{r child = 'Rprofile.Rmd'}\n`<\/span><span class=\"err\">``　<\/span><span class=\"w\">\n<\/span><\/pre><\/div>\n<\/div>\n\n<h3>\n<span id=\"knitする\" class=\"fragment\"><\/span><a href=\"#knit%E3%81%99%E3%82%8B\"><i class=\"fa fa-link\"><\/i><\/a>knitする<\/h3>\n\n<p>出力はこんな感じ<\/p>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F80a6cdfc-5394-48a5-af72-4f36de2941e4.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=ff0fa59528714e8fccd150efbe6c5c45\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F80a6cdfc-5394-48a5-af72-4f36de2941e4.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=ff0fa59528714e8fccd150efbe6c5c45\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/80a6cdfc-5394-48a5-af72-4f36de2941e4.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F80a6cdfc-5394-48a5-af72-4f36de2941e4.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=b2a56ff6c9df12e1437cff5fd1165a76 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>ちなみに、Rmdを子chunkに分割した時、子chunkで <code>child = 'rprofile.Rmd'<\/code> を行う必要はありません。<br>\nそうせずとも、テスト用の子chunkをknitした時も、.Rprofileの読み込みは行われます。<br>\n.Rprofileの中身を見せる必要があるのは、親chunkに出力だけだと思います。<\/p>\n\n<h1>\n<span id=\"enjoy-ソースコードはgithub\" class=\"fragment\"><\/span><a href=\"#enjoy-%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AFgithub\"><i class=\"fa fa-link\"><\/i><\/a>Enjoy (<a href=\"https://github.com/atusy/reproducibleRmd\" rel=\"nofollow noopener\" target=\"_blank\">ソースコードはGitHub<\/a>)<\/h1>\n"],"body":["# はじめに\n\n科学の再現性が改めて重視される世にあって、Rmarkdownの便利さもより強く認識される日々です。\n\n例えば、@kohske さんが「再現可能性のすゝめ」というRmd本を執筆しました。\nhttps://qiita.com/kohske/items/3e8c02e9598c6d230a47\n\nちなみにまだ買ってもいません…………。\n\nこのため、同書で言及されているかは知りませんが、Rmdを使って再現性を確保していくにあたって、問題となりうることの一つに\n\n.Rprofile\n\nがあります。\n\nこれは、R起動時に実行したしスクリプトを書いておくところで、\n\n- CRANミラーの選択\n- ライブラリの読み込み\n- メッセージの表示\n\nなどなど、いろいろなことができます。\n\n.Rprofileをホームディレクトリに置いて、オレオレR環境を整備しておくと便利なのですが、Rmdのknit時にも読み込まれてしまうため、異なる環境で同じRmdファイルをknitしても同じ出力が得られるとは限りません。\n\nしかし、.Rprofileをうまく使うと、Rmdファイルを作成する度に読み込むパッケージを羅列する必要がなくなるので便利です。\n\nどうしたら、再現性を保ちつつ、.Rprofileを運用できるのでしょうか。\n\n# working directoryに.Rprofileを置く\n\nworking directoryに.Rprofileを置くと、それはホームディレクトリ下のものよりも高い優先順位を持ちます。\nRStudio上でプロジェクトを管理しているならば、プロジェクトディレクトリ = working directoryなので、そこに.Rprofileをコピーするといいでしょう。\nディレクトリを丸ごと別環境に移しても.Rprofileの内容が再現されます。\n\nこれで子chunkだけを実行する時も、必ず実行したいコードは.Rprofileに仕込めばOKですね!\n\n# Rmd内に、.Rprofileをインポートする\n\n発展的には、プロジェクトディレクトリに置いた.RprofileをRmdファイルにインポートすると、出力(htmlなど)で.Rprofileの内容も確認できて便利です。\nこれには少々工夫がいります。\n\n`source('.Rprofile')` では、.Rprofile中のソースコードが出力に表示されないためです。\n\n`child = '.Rprofile'` も.RprofileがRmdファイルではないがために愉快な出力になります。\n\n## そこで下記のようにします\n\n### .Rprofileの編集\n\n冒頭に `## @knitr rprofile` を追記し、Rmdから.Rprofileを取り込めるようにしましょう([参考](https://qiita.com/yu-iskw/items/ad6e18b65ae33d90d00a\n))。\n\n```r:.Rprofile\nprint('Printed before knit, but not during knit') # if yout want this code to be printed, set eval = TRUE for rprofile chunk in Rprofile.Rmd\nhello <- 'hello world' # Although nothing in thi chunk is printed, same codes are evaluated as .Rprofile, hence you can refer to object \"hello\" later.\n```\n\n繰り返しになりますが、プロジェクトディレクトリに置いておきます。\n\n### .Rprofileを取り込むRmdファイルを作成\n\n下記のように Rprofile.Rmd を作成しましょう。\n\n~~~r:Rprofile.Rmd\n```{r, include = FALSE}\nknitr::read_chunk(\"script.R\")\n```　\n↓ here is the content of .Rprofile\n```{r rprofile eval = TRUE}\n```　\n↑ here is the content of .Rprofile\n~~~\n\nここで何をしているかは @yu-iskw さんの\n\n[Knitr で外部の R スクリプトの取り込む方法](https://qiita.com/yu-iskw/items/ad6e18b65ae33d90d00a)\n\nを参考にしてください。\n\n### メインのRmdからrprofile.Rmdを呼び出す\n\n~~~r:main.Rmd\n```{r child = 'Rprofile.Rmd'}\n```　\n~~~\n\n### knitする\n\n出力はこんな感じ\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/80a6cdfc-5394-48a5-af72-4f36de2941e4.png)\n\n\n\nちなみに、Rmdを子chunkに分割した時、子chunkで `child = 'rprofile.Rmd'` を行う必要はありません。\nそうせずとも、テスト用の子chunkをknitした時も、.Rprofileの読み込みは行われます。\n.Rprofileの中身を見せる必要があるのは、親chunkに出力だけだと思います。\n\n\n# Enjoy ([ソースコードはGitHub](https://github.com/atusy/reproducibleRmd))\n"],"coediting":[false],"comments_count":[0],"created_at":["2018-05-17T23:30:43+09:00"],"group":{},"id":["8e11d65db0d231ad4648"],"likes_count":[1],"private":[false],"reactions_count":[0],"tags":[{"name":["R"],"versions":[]},{"name":["RMarkdown"],"versions":[]}],"title":["Rmarkdownに.Rprofileの内容を追加する"],"updated_at":["2018-05-17T23:39:43+09:00"],"url":["https://qiita.com/Atsushi776/items/8e11d65db0d231ad4648"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["<p>CRAN上のRパッケージはWindows向けにはバイナリで提供されていることがほとんどですが、Linux向けにはソースで提供され、コンパイルが必要です。<br>\nこのため、<code>install.packages('hoge')<\/code>すると、<\/p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>configure: error: \"ODBC headers sql.h and sqlext.h not found\"\n<\/pre><\/div><\/div>\n\n<p>といったメッセージが返ることがあります。<\/p>\n\n<p>ほうほうODBCね、と思ってbashで<\/p>\n\n<div class=\"code-frame\" data-lang=\"bash\"><div class=\"highlight\"><pre>apt search odbc\n<\/pre><\/div><\/div>\n\n<p>するとうんざりするほどのodbcを名前に含むパッケージが!<\/p>\n\n<p>経験豊かな人でなければ、どれを入れればいいか分かりません。<\/p>\n\n<h1>\n<span id=\"grepする\" class=\"fragment\"><\/span><a href=\"#grep%E3%81%99%E3%82%8B\"><i class=\"fa fa-link\"><\/i><\/a>grepする<\/h1>\n\n<p>例えば、開発者向けパッケージが怪しいなら<\/p>\n\n<div class=\"code-frame\" data-lang=\"bash\"><div class=\"highlight\"><pre>apt search odbc | <span class=\"nb\">grep <\/span>dev\n<\/pre><\/div><\/div>\n\n<p>として、grepで絞り込むことができます。<\/p>\n\n<p><code>|<\/code>はパイプで、左側の結果を右側のコマンドに渡してくれます。<br>\nこの場合、左側の結果の中から、grepでdevを含むパッケージを絞り込みます。<\/p>\n\n<p>バージョン(新旧)やアーキテクチャ(x64 or i836)の違いを除くと以下にまで絞れます。<\/p>\n\n<ul>\n<li>libghc-haskelldb-hdbc-odbc-dev - HaskellDB support for the HDBC ODBC driver<\/li>\n<li>libghc-hdbc-odbc-dev - unixODBC HDBC (Haskell Database Connectivity) Driver for GHC<\/li>\n<li>libiodbc2-dev - iODBC Driver Manager (development files)<\/li>\n<li>libocamlodbc-ocaml-dev - UnixODBC database bindings for OCaml<\/li>\n<li>unixodbc-dev - ODBC libraries for UNIX (development files)<br>\n<\/li>\n<\/ul>\n\n<p>なんとなくunixodbc-devがprimitiveっぽくて怪しい気がしますが自身は持てません。<br>\n結局sql.hとsqlext.hを含んでいないものをインストールしてしまうと残念。<\/p>\n\n<h1>\n<span id=\"apt-file-findする\" class=\"fragment\"><\/span><a href=\"#apt-file-find%E3%81%99%E3%82%8B\"><i class=\"fa fa-link\"><\/i><\/a>apt-file findする<\/h1>\n\n<p>apt-file findであるファイルを含むパッケージがどれか調べることができます。<br>\nこれを用いてsql.hとsqlext.hを含むパッケージを探しましょう。<\/p>\n\n<p>apt-fileが未インストールであればインストールします。<\/p>\n\n<div class=\"code-frame\" data-lang=\"bash\"><div class=\"highlight\"><pre><span class=\"nb\">sudo <\/span>apt update\n<span class=\"nb\">sudo <\/span>apt <span class=\"nb\">install <\/span>apt-file\n<\/pre><\/div><\/div>\n\n<p>apt-fileを使いましょう<\/p>\n\n<div class=\"code-frame\" data-lang=\"bash\"><div class=\"highlight\"><pre>apt-file update\napt-file find ^sqlext.h<span class=\"err\">$<\/span>\n<\/pre><\/div><\/div>\n\n<p>まずupdateすることでファイル一覧を入手します。<br>\nその後findで欲しいファイルを含むパッケージを見つけます。<\/p>\n\n<p>manには1つのファイルを含むパッケージを見つけるとあるので<\/p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>apt-file find sql.h sqlext.h\n<\/pre><\/div><\/div>\n\n<p>としても両方含むものを見つけることはできません。<br>\nうまく結果を統合したいですが私のshell力が足りない。<\/p>\n\n<p>sqlext.hを含むパッケージは<\/p>\n\n<ul>\n<li>libiodbc2-dev: /usr/include/iodbc/sqlext.h<\/li>\n<li>libwine-development-dev: /usr/include/wine-development/windows/sqlext.h<\/li>\n<li>mingw-w64-common: /usr/share/mingw-w64/include/sqlext.h<\/li>\n<li>mingw-w64-x86-64-dev: /usr/x86_64-w64-mingw32/include/sqlext.h<\/li>\n<li>unixodbc-dev: /usr/include/sqlext.h<\/li>\n<li>wine1.6-dev: /usr/include/wine/windows/sqlext.h<\/li>\n<\/ul>\n\n<p>ですので、やはりunixodbc-devでよさそうです。<\/p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>apt install unixodbc-dev\n<\/pre><\/div><\/div>\n\n<p>すればsql.hとsqlext.hが手に入ります。<\/p>\n\n<h1>\n<span id=\"enjoy\" class=\"fragment\"><\/span><a href=\"#enjoy\"><i class=\"fa fa-link\"><\/i><\/a>Enjoy!!<\/h1>\n\n<h1>\n<span id=\"追記-cran2debとかc2d4uの依存関係を見る\" class=\"fragment\"><\/span><a href=\"#%E8%BF%BD%E8%A8%98-cran2deb%E3%81%A8%E3%81%8Bc2d4u%E3%81%AE%E4%BE%9D%E5%AD%98%E9%96%A2%E4%BF%82%E3%82%92%E8%A6%8B%E3%82%8B\"><i class=\"fa fa-link\"><\/i><\/a>追記: cran2debとかc2d4uの依存関係を見る<\/h1>\n\n<p>2018/03/30 16:23<\/p>\n\n<p>yutannihilationさんに教えて頂きました。<br>\nちょっとまだ試せていませんが、取り急ぎ。<\/p>\n\n<blockquote class=\"twitter-tweet\">\n<p>知ってるかもですが、cran2debとかc2d4uの依存関係を見るのが確実です。 <a href=\"https://t.co/Cy9ibZ2nWA\" rel=\"nofollow noopener\" target=\"_blank\">https://t.co/Cy9ibZ2nWA<\/a> あとは、あんまり使ったことないけど <a href=\"https://t.co/4wqwyeYMXU\" rel=\"nofollow noopener\" target=\"_blank\">https://t.co/4wqwyeYMXU<\/a> も便利かも。<\/p>— Hiroaki Yutani (@yutannihilation) <a href=\"https://twitter.com/yutannihilation/status/979595083661025280?ref_src=twsrc%5Etfw\" rel=\"nofollow noopener\" target=\"_blank\">March 30, 2018<\/a>\n<\/blockquote>\n\n<script async src=\"https://platform.twitter.com/widgets.js\"><\/script>\n"],"body":["CRAN上のRパッケージはWindows向けにはバイナリで提供されていることがほとんどですが、Linux向けにはソースで提供され、コンパイルが必要です。\nこのため、`install.packages('hoge')`すると、\n\n```\nconfigure: error: \"ODBC headers sql.h and sqlext.h not found\"\n```\n\nといったメッセージが返ることがあります。\n\nほうほうODBCね、と思ってbashで\n\n```bash\napt search odbc\n```\n\nするとうんざりするほどのodbcを名前に含むパッケージが!\n\n経験豊かな人でなければ、どれを入れればいいか分かりません。\n\n# grepする\n\n例えば、開発者向けパッケージが怪しいなら\n\n```bash\napt search odbc | grep dev\n```\n\nとして、grepで絞り込むことができます。\n\n`|`はパイプで、左側の結果を右側のコマンドに渡してくれます。\nこの場合、左側の結果の中から、grepでdevを含むパッケージを絞り込みます。\n\nバージョン(新旧)やアーキテクチャ(x64 or i836)の違いを除くと以下にまで絞れます。\n\n- libghc-haskelldb-hdbc-odbc-dev - HaskellDB support for the HDBC ODBC driver\n- libghc-hdbc-odbc-dev - unixODBC HDBC (Haskell Database Connectivity) Driver for GHC\n- libiodbc2-dev - iODBC Driver Manager (development files)\n- libocamlodbc-ocaml-dev - UnixODBC database bindings for OCaml\n- unixodbc-dev - ODBC libraries for UNIX (development files)                                                    \n\nなんとなくunixodbc-devがprimitiveっぽくて怪しい気がしますが自身は持てません。\n結局sql.hとsqlext.hを含んでいないものをインストールしてしまうと残念。\n\n# apt-file findする\n\napt-file findであるファイルを含むパッケージがどれか調べることができます。\nこれを用いてsql.hとsqlext.hを含むパッケージを探しましょう。\n\napt-fileが未インストールであればインストールします。\n\n```bash\nsudo apt update\nsudo apt install apt-file\n```\n\napt-fileを使いましょう\n\n```bash\napt-file update\napt-file find ^sqlext.h$\n```\n\nまずupdateすることでファイル一覧を入手します。\nその後findで欲しいファイルを含むパッケージを見つけます。\n\nmanには1つのファイルを含むパッケージを見つけるとあるので\n\n```\napt-file find sql.h sqlext.h\n```\n\nとしても両方含むものを見つけることはできません。\nうまく結果を統合したいですが私のshell力が足りない。\n\nsqlext.hを含むパッケージは\n\n- libiodbc2-dev: /usr/include/iodbc/sqlext.h\n- libwine-development-dev: /usr/include/wine-development/windows/sqlext.h\n- mingw-w64-common: /usr/share/mingw-w64/include/sqlext.h\n- mingw-w64-x86-64-dev: /usr/x86_64-w64-mingw32/include/sqlext.h\n- unixodbc-dev: /usr/include/sqlext.h\n- wine1.6-dev: /usr/include/wine/windows/sqlext.h\n\nですので、やはりunixodbc-devでよさそうです。\n\n```\napt install unixodbc-dev\n```\n\nすればsql.hとsqlext.hが手に入ります。\n\n# Enjoy!!\n\n\n# 追記: cran2debとかc2d4uの依存関係を見る\n\n2018/03/30 16:23\n\nyutannihilationさんに教えて頂きました。\nちょっとまだ試せていませんが、取り急ぎ。\n\n<blockquote class=\"twitter-tweet\" data-lang=\"en\"><p lang=\"ja\" dir=\"ltr\">知ってるかもですが、cran2debとかc2d4uの依存関係を見るのが確実です。 <a href=\"https://t.co/Cy9ibZ2nWA\">https://t.co/Cy9ibZ2nWA<\/a> あとは、あんまり使ったことないけど <a href=\"https://t.co/4wqwyeYMXU\">https://t.co/4wqwyeYMXU<\/a> も便利かも。<\/p>&mdash; Hiroaki Yutani (@yutannihilation) <a href=\"https://twitter.com/yutannihilation/status/979595083661025280?ref_src=twsrc%5Etfw\">March 30, 2018<\/a><\/blockquote>\n<script async src=\"https://platform.twitter.com/widgets.js\" charset=\"utf-8\"><\/script>\n\n\n\n\n\n"],"coediting":[false],"comments_count":[0],"created_at":["2018-03-30T13:33:00+09:00"],"group":{},"id":["d76eee6cb0f6ba5f46cc"],"likes_count":[1],"private":[false],"reactions_count":[0],"tags":[{"name":["R"],"versions":[]},{"name":["Ubuntu"],"versions":[]},{"name":["apt"],"versions":[]}],"title":["Ubuntu系でRパッケージインストール時に足りないものがあった時"],"updated_at":["2018-03-30T16:24:48+09:00"],"url":["https://qiita.com/Atsushi776/items/d76eee6cb0f6ba5f46cc"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["<p>先日の<\/p>\n\n<p><a href=\"https://qiita.com/Atsushi776/items/176426e2195b18eb65b4\" id=\"reference-9b4348c5f055de42530b\">data.frameの高速演算には列ごとならlapply、行ごとならReduceを使おう<\/a><\/p>\n\n<p>がTwitter上で予想以上のLike, Retweetを頂いております。<br>\n軽い気持ちで書いた記事だったのでもう少し踏み込みます。<\/p>\n\n<h1>\n<span id=\"先日の記事について\" class=\"fragment\"><\/span><a href=\"#%E5%85%88%E6%97%A5%E3%81%AE%E8%A8%98%E4%BA%8B%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"><i class=\"fa fa-link\"><\/i><\/a>先日の記事について<\/h1>\n\n<p>matrixを行ごとの和を求める場合、100行100列なら<\/p>\n\n<p>rowSums &lt; apply &lt; for<\/p>\n\n<p>であることを示しました。<br>\nまた、data.frameの場合は、<\/p>\n\n<p>Reduce &lt; rowSums &lt; apply &lt; for<\/p>\n\n<p>であることを示しました。<\/p>\n\n<p>そして、rowSumsやapplyはmatrixに特化しており、data.frameをmatrixに変換するオーバーヘッドが発生するのに対し、Reduceはdata.frameをそのまま扱うことが可能なことが一因と説明し、データごとに最適な計算を考えましょうと訴えました。<\/p>\n\n<p>しかし、以下の疑問が浮いてきました。<\/p>\n\n<ul>\n<li>Reduceに入力された変数は、要素を順々に処理するので、行が増えた場合、rowSumsやapplyより遅くなるのでは？<\/li>\n<li>forならdata.frameに最適なコードを記述すれば、matrix用の関数(rowSumsやapply)より速くなってもいいのでは？\n\n<ul>\n<li>しかもイマドキ(R &gt; 3.4.0)ではJITがforも加速する<\/li>\n<\/ul>\n<\/li>\n<\/ul>\n\n<h1>\n<span id=\"実験\" class=\"fragment\"><\/span><a href=\"#%E5%AE%9F%E9%A8%93\"><i class=\"fa fa-link\"><\/i><\/a>実験<\/h1>\n\n<p>先日のコードの修正したものをもとに、100行100列のdata.frameを始めとして、100行10万列までテストデータを巨大化しつつ、ベンチマークします。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">library<\/span><span class=\"p\">(<\/span><span class=\"n\">microbenchmark<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"c1\"># ベンチマークようのパッケージ<\/span><span class=\"w\">\n<\/span><span class=\"n\">set.seed<\/span><span class=\"p\">(<\/span><span class=\"m\">123<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"c1\"># 乱数を固定<\/span><span class=\"w\">\n<\/span><span class=\"n\">nr<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"m\">100<\/span><span class=\"w\"> <\/span><span class=\"c1\"># テストデータの行数<\/span><span class=\"w\">\n<\/span><span class=\"n\">nc<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"m\">1e+2<\/span><span class=\"w\"> <\/span><span class=\"c1\"># テストデータの列数<\/span><span class=\"w\">\n\n<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">as.data.frame<\/span><span class=\"p\">(<\/span><span class=\"n\">matrix<\/span><span class=\"p\">(<\/span><span class=\"n\">runif<\/span><span class=\"p\">(<\/span><span class=\"n\">nr<\/span><span class=\"o\">*<\/span><span class=\"n\">nc<\/span><span class=\"p\">),<\/span><span class=\"w\"> <\/span><span class=\"n\">nr<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">nc<\/span><span class=\"p\">))<\/span><span class=\"w\">\n<\/span><span class=\"c1\"># テストデータの生成<\/span><span class=\"w\">\n\n<\/span><span class=\"n\">plot<\/span><span class=\"p\">(<\/span><span class=\"n\">microbenchmark<\/span><span class=\"p\">(<\/span><span class=\"w\">\n  <\/span><span class=\"n\">Reduce<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Reduce<\/span><span class=\"p\">(<\/span><span class=\"n\">`+`<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">x<\/span><span class=\"p\">),<\/span><span class=\"w\">\n  <\/span><span class=\"n\">rowSums<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">rowSums<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">),<\/span><span class=\"w\">\n  <\/span><span class=\"n\">apply<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">apply<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">sum<\/span><span class=\"p\">),<\/span><span class=\"w\">\n  <\/span><span class=\"s2\">\"for\"<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n      <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">numeric<\/span><span class=\"p\">(<\/span><span class=\"n\">ncol<\/span><span class=\"p\">(<\/span><span class=\"n\">x2<\/span><span class=\"p\">))<\/span><span class=\"w\">\n      <\/span><span class=\"k\">for<\/span><span class=\"p\">(<\/span><span class=\"n\">i<\/span><span class=\"w\"> <\/span><span class=\"k\">in<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"o\">:<\/span><span class=\"n\">nrow<\/span><span class=\"p\">(<\/span><span class=\"n\">x2<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\"> <\/span><span class=\"n\">x<\/span><span class=\"p\">[[<\/span><span class=\"n\">i<\/span><span class=\"p\">]]<\/span><span class=\"w\">\n      <\/span><span class=\"n\">y<\/span><span class=\"w\">\n  <\/span><span class=\"p\">}<\/span><span class=\"w\">\n<\/span><span class=\"p\">),<\/span><span class=\"w\"> <\/span><span class=\"n\">xlab<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"s1\">''<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">ylab<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"s1\">'nano sec'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">log<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"s1\">'y'<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<h2>\n<span id=\"100行100列\" class=\"fragment\"><\/span><a href=\"#100%E8%A1%8C100%E5%88%97\"><i class=\"fa fa-link\"><\/i><\/a>100行100列<\/h2>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F7abf670b-812c-f293-6645-dc2fcc821cd4.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=7b4c09368ed9fe8925052041b6afc924\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F7abf670b-812c-f293-6645-dc2fcc821cd4.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=7b4c09368ed9fe8925052041b6afc924\" alt=\"000005.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/7abf670b-812c-f293-6645-dc2fcc821cd4.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F7abf670b-812c-f293-6645-dc2fcc821cd4.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=347272cbcc67d4ab2c624283a84bbbc5 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>Reduce速い！<br>\nforおっそ！<\/p>\n\n<h2>\n<span id=\"100行1000列\" class=\"fragment\"><\/span><a href=\"#100%E8%A1%8C1000%E5%88%97\"><i class=\"fa fa-link\"><\/i><\/a>100行1,000列<\/h2>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F8ce08dfe-de36-61e1-1030-c81eb3022271.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=57b19e520f169563bbe5759b37b10745\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F8ce08dfe-de36-61e1-1030-c81eb3022271.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=57b19e520f169563bbe5759b37b10745\" alt=\"000009.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/8ce08dfe-de36-61e1-1030-c81eb3022271.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F8ce08dfe-de36-61e1-1030-c81eb3022271.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=90cc48b5feb46cddfb6231b98047c014 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>Reduce速い！<br>\nやはりforおっそ！<\/p>\n\n<h2>\n<span id=\"100行10000列\" class=\"fragment\"><\/span><a href=\"#100%E8%A1%8C10000%E5%88%97\"><i class=\"fa fa-link\"><\/i><\/a>100行10,000列<\/h2>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Fb740f7b3-c86b-93cb-2a6f-8f1177207e92.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=f0962ec75d25c9f8c392b966a35d0303\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Fb740f7b3-c86b-93cb-2a6f-8f1177207e92.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=f0962ec75d25c9f8c392b966a35d0303\" alt=\"00000b.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/b740f7b3-c86b-93cb-2a6f-8f1177207e92.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Fb740f7b3-c86b-93cb-2a6f-8f1177207e92.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=e6d664797d3de10b1593a303e900adfa 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>Reduce速いけど、あ、あれ？！ for頑張ってる？<\/p>\n\n<h2>\n<span id=\"100行100000列\" class=\"fragment\"><\/span><a href=\"#100%E8%A1%8C100000%E5%88%97\"><i class=\"fa fa-link\"><\/i><\/a>100行100,000列<\/h2>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Fbab42d0d-b926-023c-1f4c-49fed739a9a0.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=6d461a9f815158e8a8dbd502f90add7b\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Fbab42d0d-b926-023c-1f4c-49fed739a9a0.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=6d461a9f815158e8a8dbd502f90add7b\" alt=\"00000d.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/bab42d0d-b926-023c-1f4c-49fed739a9a0.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Fbab42d0d-b926-023c-1f4c-49fed739a9a0.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=078485096b321241f4a40b6a31561b90 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>おおお？！ forはええ！！<\/p>\n\n<h1>\n<span id=\"結論\" class=\"fragment\"><\/span><a href=\"#%E7%B5%90%E8%AB%96\"><i class=\"fa fa-link\"><\/i><\/a>結論<\/h1>\n\n<p>先日結論した通りデータに最適なコードはやはり大事。<br>\ndata.frameの行の和を求める場合<\/p>\n\n<p>Reduce &lt; rowSums &lt; apply<\/p>\n\n<p>の関係は少なくとも100行100列から100行10万列までは変わらない。<\/p>\n\n<p>forは列数(すなわち繰り返し回数)が少ない時は遅いが、多い時は最速にすらなりうる(最適化は大前提として)。<br>\n多分、forの場合、繰り返し回数が少ないとJITコンパイルの所要時間が相対的に長いのだと思う。<\/p>\n\n<h1>\n<span id=\"おまけ\" class=\"fragment\"><\/span><a href=\"#%E3%81%8A%E3%81%BE%E3%81%91\"><i class=\"fa fa-link\"><\/i><\/a>おまけ<\/h1>\n\n<p>100行100,000列のmatrixもforが速い！！<\/p>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Fbe04b607-13fb-15b8-8d16-f45a60a4857e.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=84f2f3bd9a124c6d019a0711099508fe\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Fbe04b607-13fb-15b8-8d16-f45a60a4857e.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=84f2f3bd9a124c6d019a0711099508fe\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/be04b607-13fb-15b8-8d16-f45a60a4857e.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Fbe04b607-13fb-15b8-8d16-f45a60a4857e.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=6b2cfd6261bb88cb3149fe87db61dd48 1x\" loading=\"lazy\"><\/a><\/p>\n\n<h1>\n<span id=\"enjoy\" class=\"fragment\"><\/span><a href=\"#enjoy\"><i class=\"fa fa-link\"><\/i><\/a>Enjoy!!<\/h1>\n"],"body":["先日の\n\n[data.frameの高速演算には列ごとならlapply、行ごとならReduceを使おう](https://qiita.com/Atsushi776/items/176426e2195b18eb65b4)\n\nがTwitter上で予想以上のLike, Retweetを頂いております。\n軽い気持ちで書いた記事だったのでもう少し踏み込みます。\n\n# 先日の記事について\n\nmatrixを行ごとの和を求める場合、100行100列なら\n\nrowSums < apply < for\n\nであることを示しました。\nまた、data.frameの場合は、\n\nReduce < rowSums < apply < for\n\nであることを示しました。\n\nそして、rowSumsやapplyはmatrixに特化しており、data.frameをmatrixに変換するオーバーヘッドが発生するのに対し、Reduceはdata.frameをそのまま扱うことが可能なことが一因と説明し、データごとに最適な計算を考えましょうと訴えました。\n\nしかし、以下の疑問が浮いてきました。\n\n- Reduceに入力された変数は、要素を順々に処理するので、行が増えた場合、rowSumsやapplyより遅くなるのでは？\n- forならdata.frameに最適なコードを記述すれば、matrix用の関数(rowSumsやapply)より速くなってもいいのでは？\n    - しかもイマドキ(R > 3.4.0)ではJITがforも加速する\n\n# 実験\n\n先日のコードの修正したものをもとに、100行100列のdata.frameを始めとして、100行10万列までテストデータを巨大化しつつ、ベンチマークします。\n\n```r\nlibrary(microbenchmark) # ベンチマークようのパッケージ\nset.seed(123) # 乱数を固定\nnr <- 100 # テストデータの行数\nnc <- 1e+2 # テストデータの列数\n\nx <- as.data.frame(matrix(runif(nr*nc), nr, nc))\n# テストデータの生成\n\nplot(microbenchmark(\n  Reduce = Reduce(`+`, x),\n  rowSums = rowSums(x),\n  apply = apply(x, 1, sum),\n  \"for\" = {\n      y <- numeric(ncol(x2))\n      for(i in 1:nrow(x2)) y <- y + x[[i]]\n      y\n  }\n), xlab = '', ylab = 'nano sec', log = 'y')\n```\n\n## 100行100列\n\n![000005.png](https://qiita-image-store.s3.amazonaws.com/0/149890/7abf670b-812c-f293-6645-dc2fcc821cd4.png)\n\nReduce速い！\nforおっそ！\n\n## 100行1,000列\n\n![000009.png](https://qiita-image-store.s3.amazonaws.com/0/149890/8ce08dfe-de36-61e1-1030-c81eb3022271.png)\n\nReduce速い！\nやはりforおっそ！\n\n## 100行10,000列\n\n![00000b.png](https://qiita-image-store.s3.amazonaws.com/0/149890/b740f7b3-c86b-93cb-2a6f-8f1177207e92.png)\n\nReduce速いけど、あ、あれ？！ for頑張ってる？\n\n## 100行100,000列\n\n![00000d.png](https://qiita-image-store.s3.amazonaws.com/0/149890/bab42d0d-b926-023c-1f4c-49fed739a9a0.png)\n\nおおお？！ forはええ！！\n\n# 結論\n\n先日結論した通りデータに最適なコードはやはり大事。\ndata.frameの行の和を求める場合\n\nReduce < rowSums < apply\n\nの関係は少なくとも100行100列から100行10万列までは変わらない。\n\nforは列数(すなわち繰り返し回数)が少ない時は遅いが、多い時は最速にすらなりうる(最適化は大前提として)。\n多分、forの場合、繰り返し回数が少ないとJITコンパイルの所要時間が相対的に長いのだと思う。\n\n# おまけ\n\n100行100,000列のmatrixもforが速い！！\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/be04b607-13fb-15b8-8d16-f45a60a4857e.png)\n\n\n# Enjoy!!\n"],"coediting":[false],"comments_count":[0],"created_at":["2018-03-30T11:18:23+09:00"],"group":{},"id":["c31f2345b9c698354c81"],"likes_count":[11],"private":[false],"reactions_count":[0],"tags":[{"name":["R"],"versions":[]},{"name":["for"],"versions":[]},{"name":["data.frame"],"versions":[]}],"title":["Rのforは遅いと誰が言った？ (data.frameの高速演算には列ごとならlapply、行ごとならReduceを使おうの補足)"],"updated_at":["2018-03-30T11:24:34+09:00"],"url":["https://qiita.com/Atsushi776/items/c31f2345b9c698354c81"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["<p>.Rprofileで起動時に素のRかRStudioどちらが起動されたか判定したいのですが、うまくいっていません。<br>\nどなたかうまい解決方法ご存知でしたら一報下さい。<\/p>\n\n<p>Rでは、実行環境を、<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">.Platform<\/span><span class=\"o\">$<\/span><span class=\"n\">GUI<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>で知ることができます。<\/p>\n\n<p>Windowsで素のRを起動すると、RguiないしRtermが、<br>\nLinuxで素のRを起動すると、X11が、<br>\nWindowsでもLinuxでもRStudioを起動すると、RStudioが返ります。<\/p>\n\n<p>基本的には……!<\/p>\n\n<p>これを利用すると、素のRの時とRStudioの時で.Rprofileを使い分けることが可能なのではないかと期待したのですが、実はそうはなりません。<\/p>\n\n<p>.Rprofileに<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">.Platform<\/span><span class=\"o\">$<\/span><span class=\"n\">GUI<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>を書いてRStudioを起動すると、<\/p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>[1] \"X11\" #私はLinuxユーザーです\n<\/pre><\/div><\/div>\n\n<p>と返ります。<br>\n残念!<\/p>\n\n<p>一度、素のRを呼んでいるのでしょうか？<br>\nちょっとどうしてこうなっているのか分かりません。<\/p>\n"],"body":[".Rprofileで起動時に素のRかRStudioどちらが起動されたか判定したいのですが、うまくいっていません。\nどなたかうまい解決方法ご存知でしたら一報下さい。\n\nRでは、実行環境を、\n\n```r\n.Platform$GUI\n```\nで知ることができます。\n\nWindowsで素のRを起動すると、RguiないしRtermが、\nLinuxで素のRを起動すると、X11が、\nWindowsでもLinuxでもRStudioを起動すると、RStudioが返ります。\n\n基本的には……!\n\nこれを利用すると、素のRの時とRStudioの時で.Rprofileを使い分けることが可能なのではないかと期待したのですが、実はそうはなりません。\n\n.Rprofileに\n\n```r\n.Platform$GUI\n```\n\nを書いてRStudioを起動すると、\n\n```\n[1] \"X11\" #私はLinuxユーザーです\n```\n\nと返ります。\n残念!\n\n一度、素のRを呼んでいるのでしょうか？\nちょっとどうしてこうなっているのか分かりません。\n\n\n"],"coediting":[false],"comments_count":[0],"created_at":["2018-03-28T22:42:30+09:00"],"group":{},"id":["00b9c1918f7258392b6e"],"likes_count":[0],"private":[false],"reactions_count":[0],"tags":[{"name":["R"],"versions":[]},{"name":["RStudio"],"versions":[]}],"title":["RStudioは起動時に一度、素のRを呼ぶ？"],"updated_at":["2018-03-28T22:42:30+09:00"],"url":["https://qiita.com/Atsushi776/items/00b9c1918f7258392b6e"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["<p>Rに少し慣れると、計算速度を早くしたいと感じるのはよくあることです。<br>\nRを使っていてよく扱うのは行列状のデータです(matrixやdata.frame)<\/p>\n\n<h1>\n<span id=\"matrixの場合\" class=\"fragment\"><\/span><a href=\"#matrix%E3%81%AE%E5%A0%B4%E5%90%88\"><i class=\"fa fa-link\"><\/i><\/a>matrixの場合<\/h1>\n\n<p>よく言われるのは<br>\n行列用の関数 $\\geq$ apply $\\geq$ for<br>\nです(<a href=\"http://www.anlyznews.com/2012/02/r_11.html\" rel=\"nofollow noopener\" target=\"_blank\">参考<\/a>)。<\/p>\n\n<h2>\n<span id=\"matrixを列ごとに演算\" class=\"fragment\"><\/span><a href=\"#matrix%E3%82%92%E5%88%97%E3%81%94%E3%81%A8%E3%81%AB%E6%BC%94%E7%AE%97\"><i class=\"fa fa-link\"><\/i><\/a>matrixを列ごとに演算<\/h2>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>library(microbenchmark) # ベンチマークようのパッケージ\nset.seed(123) # 乱数を固定\nx &lt;- matrix(runif(10000), 100, 100) # テストデータの生成\nplot(microbenchmark( #ベンチマークとその結果のプロット\n  colSums = colSums(x),\n  apply = apply(x, 2, sum),\n  \"for\" = {\n      y &lt;- numeric(nrow(x))\n      for(i in 1:ncol(x)) y &lt;- y + x[, i]\n      y\n  }\n), xlab = '', ylab = 'nano sec', log = 'y') #y軸は対数に\n<\/pre><\/div><\/div>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Fdf45cd20-445b-8aea-118a-15a4d337fddc.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=471e3ccd73ed6125a07936e3eaa401ff\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Fdf45cd20-445b-8aea-118a-15a4d337fddc.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=471e3ccd73ed6125a07936e3eaa401ff\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/df45cd20-445b-8aea-118a-15a4d337fddc.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Fdf45cd20-445b-8aea-118a-15a4d337fddc.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=4eab93617346bb3db72dd0ce556db086 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>ケタで違いますね。<\/p>\n\n<h1>\n<span id=\"dataframeの場合\" class=\"fragment\"><\/span><a href=\"#dataframe%E3%81%AE%E5%A0%B4%E5%90%88\"><i class=\"fa fa-link\"><\/i><\/a>data.frameの場合<\/h1>\n\n<h2>\n<span id=\"dataframeを列ごとに演算\" class=\"fragment\"><\/span><a href=\"#dataframe%E3%82%92%E5%88%97%E3%81%94%E3%81%A8%E3%81%AB%E6%BC%94%E7%AE%97\"><i class=\"fa fa-link\"><\/i><\/a>data.frameを列ごとに演算<\/h2>\n\n<p>基本的に傾向は同じです。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">x2<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">as.data.frame<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"c1\">#先のテストデータをdata.frameに変換<\/span><span class=\"w\">\n<\/span><span class=\"n\">plot<\/span><span class=\"p\">(<\/span><span class=\"n\">microbenchmark<\/span><span class=\"p\">(<\/span><span class=\"w\"> <\/span><span class=\"c1\">#先のコードのxをx2に書き換えただけ<\/span><span class=\"w\">\n  <\/span><span class=\"n\">colSums<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">colSums<\/span><span class=\"p\">(<\/span><span class=\"n\">x2<\/span><span class=\"p\">),<\/span><span class=\"w\">\n  <\/span><span class=\"n\">apply<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">apply<\/span><span class=\"p\">(<\/span><span class=\"n\">x2<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"m\">2<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">sum<\/span><span class=\"p\">),<\/span><span class=\"w\">\n  <\/span><span class=\"s2\">\"for\"<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n      <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">numeric<\/span><span class=\"p\">(<\/span><span class=\"n\">nrow<\/span><span class=\"p\">(<\/span><span class=\"n\">x2<\/span><span class=\"p\">))<\/span><span class=\"w\">\n      <\/span><span class=\"k\">for<\/span><span class=\"p\">(<\/span><span class=\"n\">i<\/span><span class=\"w\"> <\/span><span class=\"k\">in<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"o\">:<\/span><span class=\"n\">ncol<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\"> <\/span><span class=\"n\">x2<\/span><span class=\"p\">[,<\/span><span class=\"w\"> <\/span><span class=\"n\">i<\/span><span class=\"p\">]<\/span><span class=\"w\">\n      <\/span><span class=\"n\">y<\/span><span class=\"w\">\n  <\/span><span class=\"p\">}<\/span><span class=\"w\">\n<\/span><span class=\"p\">),<\/span><span class=\"w\"> <\/span><span class=\"n\">xlab<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"s1\">''<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">ylab<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"s1\">'nano sec'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">log<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"s1\">'y'<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F9a7b2e9a-db5b-7473-3674-89569638d8bf.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=32f60ea6fe7ef27e601aba3b48b68b37\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F9a7b2e9a-db5b-7473-3674-89569638d8bf.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=32f60ea6fe7ef27e601aba3b48b68b37\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/9a7b2e9a-db5b-7473-3674-89569638d8bf.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F9a7b2e9a-db5b-7473-3674-89569638d8bf.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=6e3c836cc80d837af128220b0ff9dc9d 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>しかし、forを用いた場合を除きケタで遅くなっているのが気になります。<br>\nこれはcolSumsやapplyがmatrix(厳密にはapplyはarray)に特化しているため、内部でdata.frameを一度matrixに変換しており、変換に時間がかかっているようです。<br>\nでは変換を介さない、計算を行えば速くなるのではないでしょうか。<\/p>\n\n<p>data.frameの実態はリストです。<br>\nリストに使うapply族と言えば、lapplyです。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">x2<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">as.data.frame<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"c1\">#先のテストデータをdata.frameに変換<\/span><span class=\"w\">\n<\/span><span class=\"n\">plot<\/span><span class=\"p\">(<\/span><span class=\"n\">microbenchmark<\/span><span class=\"p\">(<\/span><span class=\"w\"> <\/span><span class=\"c1\"># lapplyを追加<\/span><span class=\"w\">\n  <\/span><span class=\"n\">lapply<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">unlist<\/span><span class=\"p\">(<\/span><span class=\"n\">lapply<\/span><span class=\"p\">(<\/span><span class=\"n\">x2<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">sum<\/span><span class=\"p\">)),<\/span><span class=\"w\"> <\/span><span class=\"c1\">#unlistにより他と結果を揃える<\/span><span class=\"w\">\n  <\/span><span class=\"n\">colSums<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">colSums<\/span><span class=\"p\">(<\/span><span class=\"n\">x2<\/span><span class=\"p\">),<\/span><span class=\"w\">\n  <\/span><span class=\"n\">apply<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">apply<\/span><span class=\"p\">(<\/span><span class=\"n\">x2<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"m\">2<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">sum<\/span><span class=\"p\">),<\/span><span class=\"w\">\n  <\/span><span class=\"s2\">\"for\"<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n      <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">numeric<\/span><span class=\"p\">(<\/span><span class=\"n\">nrow<\/span><span class=\"p\">(<\/span><span class=\"n\">x2<\/span><span class=\"p\">))<\/span><span class=\"w\">\n      <\/span><span class=\"k\">for<\/span><span class=\"p\">(<\/span><span class=\"n\">i<\/span><span class=\"w\"> <\/span><span class=\"k\">in<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"o\">:<\/span><span class=\"n\">ncol<\/span><span class=\"p\">(<\/span><span class=\"n\">x2<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\"> <\/span><span class=\"n\">x2<\/span><span class=\"p\">[,<\/span><span class=\"w\"> <\/span><span class=\"n\">i<\/span><span class=\"p\">]<\/span><span class=\"w\">\n      <\/span><span class=\"n\">y<\/span><span class=\"w\">\n  <\/span><span class=\"p\">}<\/span><span class=\"w\">\n<\/span><span class=\"p\">),<\/span><span class=\"w\"> <\/span><span class=\"n\">xlab<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"s1\">''<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">ylab<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"s1\">'nano sec'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">log<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"s1\">'y'<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Fe6422ee8-eeb4-f9da-3b3e-2bf6d889e049.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=af494efa87e5583dc6efdeb75ffbcac7\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Fe6422ee8-eeb4-f9da-3b3e-2bf6d889e049.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=af494efa87e5583dc6efdeb75ffbcac7\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/e6422ee8-eeb4-f9da-3b3e-2bf6d889e049.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Fe6422ee8-eeb4-f9da-3b3e-2bf6d889e049.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=82c600e8235416d7fa9c37ae8d7f42ce 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>lapplyが群を抜いて速い！！<\/p>\n\n<h2>\n<span id=\"dataframeを行ごとに計算\" class=\"fragment\"><\/span><a href=\"#dataframe%E3%82%92%E8%A1%8C%E3%81%94%E3%81%A8%E3%81%AB%E8%A8%88%E7%AE%97\"><i class=\"fa fa-link\"><\/i><\/a>data.frameを行ごとに計算<\/h2>\n\n<p>行ごとに計算する場合はどうしたらいいでしょうか？<br>\napplyの場合は第二引数で、行方向の演算か列方向の演算か指定できますが、lapplyではそうは行きません。<br>\n代わってReduceを用います。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">plot<\/span><span class=\"p\">(<\/span><span class=\"n\">microbenchmark<\/span><span class=\"p\">(<\/span><span class=\"w\">\n  <\/span><span class=\"n\">Reduce<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Reduce<\/span><span class=\"p\">(<\/span><span class=\"n\">`+`<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">x2<\/span><span class=\"p\">),<\/span><span class=\"w\">\n  <\/span><span class=\"n\">rowSums<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">rowSums<\/span><span class=\"p\">(<\/span><span class=\"n\">x2<\/span><span class=\"p\">),<\/span><span class=\"w\">\n  <\/span><span class=\"n\">apply<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">apply<\/span><span class=\"p\">(<\/span><span class=\"n\">x2<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">sum<\/span><span class=\"p\">),<\/span><span class=\"w\">\n  <\/span><span class=\"s2\">\"for\"<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n      <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">numeric<\/span><span class=\"p\">(<\/span><span class=\"n\">ncol<\/span><span class=\"p\">(<\/span><span class=\"n\">x2<\/span><span class=\"p\">))<\/span><span class=\"w\">\n      <\/span><span class=\"k\">for<\/span><span class=\"p\">(<\/span><span class=\"n\">i<\/span><span class=\"w\"> <\/span><span class=\"k\">in<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"o\">:<\/span><span class=\"n\">nrow<\/span><span class=\"p\">(<\/span><span class=\"n\">x2<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\"> <\/span><span class=\"n\">x2<\/span><span class=\"p\">[,<\/span><span class=\"w\"> <\/span><span class=\"n\">i<\/span><span class=\"p\">]<\/span><span class=\"w\">\n      <\/span><span class=\"n\">y<\/span><span class=\"w\">\n  <\/span><span class=\"p\">}<\/span><span class=\"w\">\n<\/span><span class=\"p\">),<\/span><span class=\"w\"> <\/span><span class=\"n\">xlab<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"s1\">''<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">ylab<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"s1\">'nano sec'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">log<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"s1\">'y'<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F08a286d0-9b90-992e-ff15-f40a904cabfb.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=ab2759face9107623307782e3fe7b8f0\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F08a286d0-9b90-992e-ff15-f40a904cabfb.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=ab2759face9107623307782e3fe7b8f0\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/08a286d0-9b90-992e-ff15-f40a904cabfb.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F08a286d0-9b90-992e-ff15-f40a904cabfb.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=f60d1a83bcae68ce62cec22b774cc4f4 1x\" loading=\"lazy\"><\/a><\/p>\n\n<h1>\n<span id=\"まとめ\" class=\"fragment\"><\/span><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\"><i class=\"fa fa-link\"><\/i><\/a>まとめ<\/h1>\n\n<p>演算には扱っているデータごとに最適な形があることを意識して、<br>\ndata.frameの高速演算には列ごとならlapply、行ごとならReduceを使いましょう。<\/p>\n\n<h1>\n<span id=\"sessioninfo一部\" class=\"fragment\"><\/span><a href=\"#sessioninfo%E4%B8%80%E9%83%A8\"><i class=\"fa fa-link\"><\/i><\/a>sessionInfo(一部)<\/h1>\n\n<p>R version 3.4.4 (2018-03-15)<br>\nPlatform: x86_64-pc-linux-gnu (64-bit)<br>\nRunning under: Linux Mint 18.3<\/p>\n\n<p>Matrix products: default<br>\nBLAS: /usr/lib/openblas-base/libblas.so.3<br>\nLAPACK: /usr/lib/libopenblasp-r0.2.18.so<\/p>\n"],"body":["Rに少し慣れると、計算速度を早くしたいと感じるのはよくあることです。\nRを使っていてよく扱うのは行列状のデータです(matrixやdata.frame)\n\n#matrixの場合\n\nよく言われるのは\n行列用の関数 $\\geq$ apply $\\geq$ for\nです([参考](http://www.anlyznews.com/2012/02/r_11.html))。\n\n##matrixを列ごとに演算\n\n```\nlibrary(microbenchmark) # ベンチマークようのパッケージ\nset.seed(123) # 乱数を固定\nx <- matrix(runif(10000), 100, 100) # テストデータの生成\nplot(microbenchmark( #ベンチマークとその結果のプロット\n  colSums = colSums(x),\n  apply = apply(x, 2, sum),\n  \"for\" = {\n      y <- numeric(nrow(x))\n      for(i in 1:ncol(x)) y <- y + x[, i]\n      y\n  }\n), xlab = '', ylab = 'nano sec', log = 'y') #y軸は対数に\n```\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/df45cd20-445b-8aea-118a-15a4d337fddc.png)\n\nケタで違いますね。\n\n#data.frameの場合\n\n##data.frameを列ごとに演算\n\n基本的に傾向は同じです。\n\n```{r}\nx2 <- as.data.frame(x) #先のテストデータをdata.frameに変換\nplot(microbenchmark( #先のコードのxをx2に書き換えただけ\n  colSums = colSums(x2),\n  apply = apply(x2, 2, sum),\n  \"for\" = {\n      y <- numeric(nrow(x2))\n      for(i in 1:ncol(x)) y <- y + x2[, i]\n      y\n  }\n), xlab = '', ylab = 'nano sec', log = 'y')\n```\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/9a7b2e9a-db5b-7473-3674-89569638d8bf.png)\n\nしかし、forを用いた場合を除きケタで遅くなっているのが気になります。\nこれはcolSumsやapplyがmatrix(厳密にはapplyはarray)に特化しているため、内部でdata.frameを一度matrixに変換しており、変換に時間がかかっているようです。\nでは変換を介さない、計算を行えば速くなるのではないでしょうか。\n\ndata.frameの実態はリストです。\nリストに使うapply族と言えば、lapplyです。\n\n```{r}\nx2 <- as.data.frame(x) #先のテストデータをdata.frameに変換\nplot(microbenchmark( # lapplyを追加\n  lapply = unlist(lapply(x2, sum)), #unlistにより他と結果を揃える\n  colSums = colSums(x2),\n  apply = apply(x2, 2, sum),\n  \"for\" = {\n      y <- numeric(nrow(x2))\n      for(i in 1:ncol(x2)) y <- y + x2[, i]\n      y\n  }\n), xlab = '', ylab = 'nano sec', log = 'y')\n```\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/e6422ee8-eeb4-f9da-3b3e-2bf6d889e049.png)\n\n\nlapplyが群を抜いて速い！！\n\n## data.frameを行ごとに計算\n\n行ごとに計算する場合はどうしたらいいでしょうか？\napplyの場合は第二引数で、行方向の演算か列方向の演算か指定できますが、lapplyではそうは行きません。\n代わってReduceを用います。\n\n```r\nplot(microbenchmark(\n  Reduce = Reduce(`+`, x2),\n  rowSums = rowSums(x2),\n  apply = apply(x2, 1, sum),\n  \"for\" = {\n      y <- numeric(ncol(x2))\n      for(i in 1:nrow(x2)) y <- y + x2[, i]\n      y\n  }\n), xlab = '', ylab = 'nano sec', log = 'y')\n```\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/08a286d0-9b90-992e-ff15-f40a904cabfb.png)\n\n# まとめ\n\n演算には扱っているデータごとに最適な形があることを意識して、\ndata.frameの高速演算には列ごとならlapply、行ごとならReduceを使いましょう。\n\n# sessionInfo(一部)\n\nR version 3.4.4 (2018-03-15)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Linux Mint 18.3\n\nMatrix products: default\nBLAS: /usr/lib/openblas-base/libblas.so.3\nLAPACK: /usr/lib/libopenblasp-r0.2.18.so\n"],"coediting":[false],"comments_count":[0],"created_at":["2018-03-28T18:29:14+09:00"],"group":{},"id":["176426e2195b18eb65b4"],"likes_count":[9],"private":[false],"reactions_count":[0],"tags":[{"name":["R"],"versions":[]},{"name":["apply"],"versions":[]}],"title":["data.frameの高速演算には列ごとならlapply、行ごとならReduceを使おう"],"updated_at":["2018-03-28T18:31:27+09:00"],"url":["https://qiita.com/Atsushi776/items/176426e2195b18eb65b4"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["<p>tidyverseユーザーにとって今やなくてはならない存在がtibbleかもしれませんが、近頃、こいつのprint結果は非難囂囂です。<br>\n例えば、以下のように数字を有効(？)数字で自動に丸め、重要な(？)部分とやらに下線を引きます。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">library<\/span><span class=\"p\">(<\/span><span class=\"n\">tibble<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">tibble<\/span><span class=\"o\">::<\/span><span class=\"n\">tibble<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"p\">(<\/span><span class=\"m\">8<\/span><span class=\"w\"> <\/span><span class=\"o\">^<\/span><span class=\"w\"> <\/span><span class=\"nf\">c<\/span><span class=\"p\">(<\/span><span class=\"m\">-5<\/span><span class=\"o\">:<\/span><span class=\"m\">5<\/span><span class=\"p\">)))<\/span><span class=\"w\">\n<\/span><span class=\"n\">x<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F366bb147-7929-d476-577d-c6b5a8fbca1f.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=b9da9562e5beed1491b8d3830b1b2d13\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F366bb147-7929-d476-577d-c6b5a8fbca1f.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=b9da9562e5beed1491b8d3830b1b2d13\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/366bb147-7929-d476-577d-c6b5a8fbca1f.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F366bb147-7929-d476-577d-c6b5a8fbca1f.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=84a21e607e458bd38e9d819b6809ee59 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>バージョンによっては下線部をとそれ以外の文字色を変えていた模様。<br>\n見易いという人もいるかもしれませんが、見易さは自分で適宜調整するから生ものを返せという人もいるでしょう、<\/p>\n\n<p>いかがいたしましょうか？<\/p>\n\n<p>Rでは結果の出力に暗黙に<code>print<\/code>が呼ばれていることを利用します。<\/p>\n\n<p>tibbleオブジェクトはtbl_df, tbl, data.frameのクラスから成るので、tbl_df用のprintを定義し、printする時だけ、data.frameに戻してやりましょう。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">print.tbl_df<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">...<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"n\">print<\/span><span class=\"p\">(<\/span><span class=\"n\">as.data.frame<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">))<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>するとtibbleオブジェクトがdata.frameとしてプリントされるようになり、幸せになれます。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">x<\/span><span class=\"w\">\n<\/span><span class=\"c1\">#               x<\/span><span class=\"w\">\n<\/span><span class=\"c1\"># 1  3.051758e-05<\/span><span class=\"w\">\n<\/span><span class=\"c1\"># 2  2.441406e-04<\/span><span class=\"w\">\n<\/span><span class=\"c1\"># 3  1.953125e-03<\/span><span class=\"w\">\n<\/span><span class=\"c1\"># 4  1.562500e-02<\/span><span class=\"w\">\n<\/span><span class=\"c1\"># 5  1.250000e-01<\/span><span class=\"w\">\n<\/span><span class=\"c1\"># 6  1.000000e+00<\/span><span class=\"w\">\n<\/span><span class=\"c1\"># 7  8.000000e+00<\/span><span class=\"w\">\n<\/span><span class=\"c1\"># 8  6.400000e+01<\/span><span class=\"w\">\n<\/span><span class=\"c1\"># 9  5.120000e+02<\/span><span class=\"w\">\n<\/span><span class=\"c1\"># 10 4.096000e+03<\/span><span class=\"w\">\n<\/span><span class=\"c1\"># 11 3.276800e+04<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>下記を毎回入力するのは面倒なので、.Rprofileにでも追記しておくと都合がいいのではないかと思います。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">print.tbl_df<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">...<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"n\">print<\/span><span class=\"p\">(<\/span><span class=\"n\">as.data.frame<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">))<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>Enjoy!!<\/p>\n\n<p>2018/03/27 15:50追記<\/p>\n\n<p>単にprint.tbl_dfをprint.data.frameと同じものにするという手もあるようです。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">print.tbl_df<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">print.data.frame<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n"],"body":["tidyverseユーザーにとって今やなくてはならない存在がtibbleかもしれませんが、近頃、こいつのprint結果は非難囂囂です。\n例えば、以下のように数字を有効(？)数字で自動に丸め、重要な(？)部分とやらに下線を引きます。\n\n```r\nlibrary(tibble)\nx <- tibble::tibble(x = (8 ^ c(-5:5)))\nx\n```\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/366bb147-7929-d476-577d-c6b5a8fbca1f.png)\n\nバージョンによっては下線部をとそれ以外の文字色を変えていた模様。\n見易いという人もいるかもしれませんが、見易さは自分で適宜調整するから生ものを返せという人もいるでしょう、\n\nいかがいたしましょうか？\n\nRでは結果の出力に暗黙に`print`が呼ばれていることを利用します。\n\ntibbleオブジェクトはtbl_df, tbl, data.frameのクラスから成るので、tbl_df用のprintを定義し、printする時だけ、data.frameに戻してやりましょう。\n\n```r\nprint.tbl_df <- function(x, ...) print(as.data.frame(x))\n```\n\nするとtibbleオブジェクトがdata.frameとしてプリントされるようになり、幸せになれます。\n\n```r\nx\n#               x\n# 1  3.051758e-05\n# 2  2.441406e-04\n# 3  1.953125e-03\n# 4  1.562500e-02\n# 5  1.250000e-01\n# 6  1.000000e+00\n# 7  8.000000e+00\n# 8  6.400000e+01\n# 9  5.120000e+02\n# 10 4.096000e+03\n# 11 3.276800e+04\n```\n\n\n下記を毎回入力するのは面倒なので、.Rprofileにでも追記しておくと都合がいいのではないかと思います。\n\n```r\nprint.tbl_df <- function(x, ...) print(as.data.frame(x))\n```\n\n\nEnjoy!!\n\n\n2018/03/27 15:50追記\n\n単にprint.tbl_dfをprint.data.frameと同じものにするという手もあるようです。\n\n```r\nprint.tbl_df <- print.data.frame\n```\n"],"coediting":[false],"comments_count":[0],"created_at":["2018-03-27T15:39:36+09:00"],"group":{},"id":["0102fd3b6b69bcfa6a59"],"likes_count":[5],"private":[false],"reactions_count":[0],"tags":[{"name":["R"],"versions":[]},{"name":["tidyverse"],"versions":[]},{"name":["tibble"],"versions":[]}],"title":["tibbleの表示にお悩みの方へ"],"updated_at":["2018-03-27T15:52:25+09:00"],"url":["https://qiita.com/Atsushi776/items/0102fd3b6b69bcfa6a59"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["<p>2018/3/2の第68回TokyoRに参加してきました。<br>\nその懇親会でniszetさんとigjitさんとお話し、関数のヘルプ見る時<code>?関数<\/code>という書き方は面倒だよねという話をしました。<br>\nできたら<code>関数?<\/code>という書き方をしたいけど多分無理だよね、という話をしていました。<br>\n無理ゲーと思いつつ、RStduioなら左右のペーンを利用してヘルプと同時に関数のソースも見たいと要望は募るばかり。<br>\nそんなfunction help略してfelpパッケージに挑戦しようという話になりました。<\/p>\n\n<h1>\n<span id=\"雛形\" class=\"fragment\"><\/span><a href=\"#%E9%9B%9B%E5%BD%A2\"><i class=\"fa fa-link\"><\/i><\/a>雛形<\/h1>\n\n<p>関数のヘルプを見るには<code>help<\/code>、ソースを見るには<code>print.function<\/code>を用います。<br>\n後者は所謂総称的関数<code>print<\/code>のmethodの一つ(S3 generic)です。<br>\nこれらを組合せればヘルプとソースを同時に見るfelp関数を作れるはず。<br>\n出来上がったのが以下。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">felp<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">...<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n  <\/span><span class=\"n\">base<\/span><span class=\"o\">::<\/span><span class=\"n\">print<\/span><span class=\"p\">(<\/span><span class=\"n\">help<\/span><span class=\"p\">(<\/span><span class=\"n\">deparse<\/span><span class=\"p\">(<\/span><span class=\"nf\">substitute<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">)),<\/span><span class=\"w\"> <\/span><span class=\"n\">...<\/span><span class=\"p\">))<\/span><span class=\"w\">\n  <\/span><span class=\"n\">base<\/span><span class=\"o\">::<\/span><span class=\"n\">print.function<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">...<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"p\">}<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>このfelp関数を用い、<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">felp<\/span><span class=\"p\">(<\/span><span class=\"n\">help<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>とすれば、<code>help<\/code>のソースとヘルプを同時に見る事ができます。<\/p>\n\n<p>ポイントは4点。<\/p>\n\n<ul>\n<li>\n<code>felp(x)<\/code>のxを非標準評価する\n\n<ul>\n<li>\n<code>help(x)<\/code>とすると、<code>x<\/code>という名前の関数のヘルプを探してしまう。<\/li>\n<li>\n<code>help(deparse(substitute(x)))<\/code>ならOK<\/li>\n<\/ul>\n<\/li>\n<li>\n<code>help<\/code>を明示的に<code>print<\/code>する\n\n<ul>\n<li>\n<code>help<\/code>を<code>print<\/code>の中に入れないと、ヘルプは表示されずソースコードしか見れません。<\/li>\n<li>これはRにおいては関数内で実行された結果の内、自動に<code>print<\/code>されるのは最後に実行された行のみだからです。<\/li>\n<\/ul>\n<\/li>\n<li>\n<code>print.function<\/code>は<code>base::print.function<\/code>とし、出自を明らかにする\n\n<ul>\n<li>雛形段階では重要ではありません。<\/li>\n<li>最終的に<code>print.function<\/code>を新たに定義してマスクし、<code>関数<\/code>と打つだけでヘルプとソースを見るための布石です。<\/li>\n<\/ul>\n<\/li>\n<li>\n<code>...<\/code>を使うことで、<code>help<\/code>や<code>print.function<\/code>に引数を適宜パスする\n\n<ul>\n<li>これにより、<code>felp(select, package = 'MASS')<\/code>といった具合にどのパッケージの関数についてヘルプを見たいか、選択できるようになります。<\/li>\n<li>ただし、雛形段階ではソースを表示する関数がどのパッケージ由来かを選ぶことができません(最も近い環境のものが選ばれる)。<\/li>\n<\/ul>\n<\/li>\n<\/ul>\n\n<h1>\n<span id=\"発展させたいが\" class=\"fragment\"><\/span><a href=\"#%E7%99%BA%E5%B1%95%E3%81%95%E3%81%9B%E3%81%9F%E3%81%84%E3%81%8C\"><i class=\"fa fa-link\"><\/i><\/a>発展させたいが……！<\/h1>\n\n<p>さて、<code>print.function &lt;- felp<\/code>とすると、<code>help<\/code>と入力するだけで、<code>help<\/code>のヘルプとソースが呼び出されるようになりそうです。<br>\nしかし、実際にはこれはうまく行きません。<\/p>\n\n<blockquote>\n<p>No documentation for ‘x’ in specified packages and libraries:<br>\nyou could try ‘??x’<\/p>\n<\/blockquote>\n\n<p>という文字列の後に<code>help<\/code>のソースが表示され、ヘルプが表示されないのです。<br>\n<del>その原因には心当たりがあります。<\/del><strong>2018/03/03 13:13 以下は勘違いでした。原因は根深そうです。<code>print(x = help)<\/code>はちゃんと動きます。もっと問題は根深そうです。yutanihilationさん、ご指摘ありがとうございます。<\/strong><\/p>\n\n<p>S3 genericを利用しているため、<code>help<\/code>を入力した時、実行されているコードは以下です。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">print<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">help<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>この時<code>help<\/code>はfunctionですので、適したmethodとして<code>print.function<\/code>を呼び出し、その引数<code>x<\/code>に<code>x<\/code>を与えます。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">print.function<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">x<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>結果、現在の実装では、<code>deparse(substitute(x))<\/code>の部分が<code>\"x\"<\/code>を返します。<br>\nしかしながら、<code>x<\/code>だなんて<del>関数は定義されてい<\/del><strong>topicは<\/strong>ないよと怒られるわけです。<br>\n仕様の壁にぶちあたった気がしますが、うまい回避法があれば、ご提案下さい。<\/p>\n\n<p>2018/03/03 11:25<br>\nhelpの第一引数はtopicなので、「<code>x<\/code>だなんて関数は定義されていない」というのは実態に即していないとの指摘をyutanihilationさんから頂き、「topicはない」に修正しました。<br>\nご指摘ありがとうございます。<\/p>\n"],"body":["2018/3/2の第68回TokyoRに参加してきました。\nその懇親会でniszetさんとigjitさんとお話し、関数のヘルプ見る時`?関数`という書き方は面倒だよねという話をしました。\nできたら`関数?`という書き方をしたいけど多分無理だよね、という話をしていました。\n無理ゲーと思いつつ、RStduioなら左右のペーンを利用してヘルプと同時に関数のソースも見たいと要望は募るばかり。\nそんなfunction help略してfelpパッケージに挑戦しようという話になりました。\n\n#雛形\n\n関数のヘルプを見るには`help`、ソースを見るには`print.function`を用います。\n後者は所謂総称的関数`print`のmethodの一つ(S3 generic)です。\nこれらを組合せればヘルプとソースを同時に見るfelp関数を作れるはず。\n出来上がったのが以下。\n\n```r\nfelp <- function(x, ...) {\n  base::print(help(deparse(substitute(x)), ...))\n  base::print.function(x, ...)\n}\n```\n\nこのfelp関数を用い、\n\n```r\nfelp(help)\n```\n\nとすれば、`help`のソースとヘルプを同時に見る事ができます。\n\nポイントは4点。\n\n- `felp(x)`のxを非標準評価する\n    - `help(x)`とすると、`x`という名前の関数のヘルプを探してしまう。\n    - `help(deparse(substitute(x)))`ならOK\n- `help`を明示的に`print`する\n    - `help`を`print`の中に入れないと、ヘルプは表示されずソースコードしか見れません。\n    - これはRにおいては関数内で実行された結果の内、自動に`print`されるのは最後に実行された行のみだからです。\n- `print.function`は`base::print.function`とし、出自を明らかにする\n    - 雛形段階では重要ではありません。\n    - 最終的に`print.function`を新たに定義してマスクし、`関数`と打つだけでヘルプとソースを見るための布石です。\n- `...`を使うことで、`help`や`print.function`に引数を適宜パスする\n    - これにより、`felp(select, package = 'MASS')`といった具合にどのパッケージの関数についてヘルプを見たいか、選択できるようになります。\n    - ただし、雛形段階ではソースを表示する関数がどのパッケージ由来かを選ぶことができません(最も近い環境のものが選ばれる)。\n\n#発展させたいが……！\n\nさて、`print.function <- felp`とすると、`help`と入力するだけで、`help`のヘルプとソースが呼び出されるようになりそうです。\nしかし、実際にはこれはうまく行きません。\n\n> No documentation for ‘x’ in specified packages and libraries:\nyou could try ‘??x’\n\nという文字列の後に`help`のソースが表示され、ヘルプが表示されないのです。\n~~その原因には心当たりがあります。~~**2018/03/03 13:13 以下は勘違いでした。原因は根深そうです。`print(x = help)`はちゃんと動きます。もっと問題は根深そうです。yutanihilationさん、ご指摘ありがとうございます。**\n\nS3 genericを利用しているため、`help`を入力した時、実行されているコードは以下です。\n\n```r\nprint(x = help)\n```\n\nこの時`help`はfunctionですので、適したmethodとして`print.function`を呼び出し、その引数`x`に`x`を与えます。\n\n```r\nprint.function(x = x)\n```\n\n結果、現在の実装では、`deparse(substitute(x))`の部分が`\"x\"`を返します。\nしかしながら、`x`だなんて~~関数は定義されてい~~**topicは**ないよと怒られるわけです。\n仕様の壁にぶちあたった気がしますが、うまい回避法があれば、ご提案下さい。\n\n2018/03/03 11:25\nhelpの第一引数はtopicなので、「`x`だなんて関数は定義されていない」というのは実態に即していないとの指摘をyutanihilationさんから頂き、「topicはない」に修正しました。\nご指摘ありがとうございます。\n\n"],"coediting":[false],"comments_count":[0],"created_at":["2018-03-04T09:26:19+09:00"],"group":{},"id":["77d79f2b2c5bf4f993f1"],"likes_count":[5],"private":[false],"reactions_count":[0],"tags":[{"name":["R"],"versions":[]}],"title":["関数の中身とヘルプを同時にすぐ見たい(felp me!)"],"updated_at":["2018-03-04T13:13:59+09:00"],"url":["https://qiita.com/Atsushi776/items/77d79f2b2c5bf4f993f1"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["\n<h1>\n<span id=\"ggplot2はレイヤの順番変更や削除がやや手間\" class=\"fragment\"><\/span><a href=\"#ggplot2%E3%81%AF%E3%83%AC%E3%82%A4%E3%83%A4%E3%81%AE%E9%A0%86%E7%95%AA%E5%A4%89%E6%9B%B4%E3%82%84%E5%89%8A%E9%99%A4%E3%81%8C%E3%82%84%E3%82%84%E6%89%8B%E9%96%93\"><i class=\"fa fa-link\"><\/i><\/a>ggplot2はレイヤの順番変更や、削除がやや手間<\/h1>\n\n<p>ggplot2は、便利な作図ツールですが、データや書式をレイヤに分けている関係上、レイヤを足す順番が大事になります。<br>\n例えば下記の図は、散布図と回帰曲線を足す順番を前後させたもの。<br>\n点を目立たせたいか、回帰曲線を目立たせたいか、考えてレイヤを足さなければなりません。<\/p>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F56825b49-c8b3-d2ed-765f-c1ed7a1c747c.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=4bdfe4c1704b6116e02b6af957191282\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F56825b49-c8b3-d2ed-765f-c1ed7a1c747c.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=4bdfe4c1704b6116e02b6af957191282\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/56825b49-c8b3-d2ed-765f-c1ed7a1c747c.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F56825b49-c8b3-d2ed-765f-c1ed7a1c747c.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=ae9ee4dbc037efb6cc0def6b3680d483 1x\" loading=\"lazy\"><\/a><\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">library<\/span><span class=\"p\">(<\/span><span class=\"n\">ggplot2<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"n\">library<\/span><span class=\"p\">(<\/span><span class=\"n\">GGally<\/span><span class=\"p\">)<\/span><span class=\"w\">\n\n<\/span><span class=\"n\">gp<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"n\">iris<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Length<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Width<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"p\">))<\/span><span class=\"w\">\n\n<\/span><span class=\"n\">layers<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"nf\">list<\/span><span class=\"p\">(<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_point<\/span><span class=\"p\">(),<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_smooth<\/span><span class=\"p\">(<\/span><span class=\"n\">alpha<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">0.6<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"p\">)<\/span><span class=\"w\">\n\n<\/span><span class=\"n\">ggmatrix<\/span><span class=\"p\">(<\/span><span class=\"w\">\n  <\/span><span class=\"nf\">list<\/span><span class=\"p\">(<\/span><span class=\"w\">\n    <\/span><span class=\"n\">gp<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\"> <\/span><span class=\"n\">layers<\/span><span class=\"p\">,<\/span><span class=\"w\">\n    <\/span><span class=\"n\">gp<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\"> <\/span><span class=\"n\">rev<\/span><span class=\"p\">(<\/span><span class=\"n\">layers<\/span><span class=\"p\">)<\/span><span class=\"w\">    \n  <\/span><span class=\"p\">),<\/span><span class=\"w\">\n  <\/span><span class=\"n\">nrow<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"p\">,<\/span><span class=\"w\">\n  <\/span><span class=\"n\">ncol<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">2<\/span><span class=\"p\">,<\/span><span class=\"w\">\n  <\/span><span class=\"n\">xAxisLabels<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"nf\">c<\/span><span class=\"p\">(<\/span><span class=\"w\">\n    <\/span><span class=\"s1\">'散布図 + 回帰曲線'<\/span><span class=\"p\">,<\/span><span class=\"w\"> \n    <\/span><span class=\"s1\">'回帰曲線 + 散布図'<\/span><span class=\"w\">\n  <\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>この時、散布図+回帰曲線のプロットをした後に、やっぱり回帰曲線+散布図に直したいと思うと<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"n\">iris<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Length<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Width<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_point<\/span><span class=\"p\">()<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_smooth<\/span><span class=\"p\">(<\/span><span class=\"n\">alpha<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">0.6<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>の2行目と3行目を入れ替え、<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"n\">iris<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Length<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Width<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_smooth<\/span><span class=\"p\">(<\/span><span class=\"n\">alpha<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">0.6<\/span><span class=\"p\">)<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_point<\/span><span class=\"p\">()<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>2行目の行末に+を足し、3行目の行末から+を除くという、<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"n\">iris<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Length<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Width<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_smooth<\/span><span class=\"p\">(<\/span><span class=\"n\">alpha<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">0.6<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_point<\/span><span class=\"p\">()<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>2、3手間を要します。<br>\nこれは面倒!<\/p>\n\n<p>また、ここからやっぱり散布図がいらない! と思うと、<br>\n3行目をコメントアウトし、<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"n\">iris<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Length<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Width<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_smooth<\/span><span class=\"p\">(<\/span><span class=\"n\">alpha<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">0.6<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"c1\"># geom_point()<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>2行目の+もコメントアウト(or delete)する<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"n\">iris<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Length<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Width<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_smooth<\/span><span class=\"p\">(<\/span><span class=\"n\">alpha<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">0.6<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"c1\"># +<\/span><span class=\"w\">\n  <\/span><span class=\"c1\"># geom_point()<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>必要があります。<\/p>\n\n<p>やはり面倒だ。<\/p>\n\n<h1>\n<span id=\"-nullで解決\" class=\"fragment\"><\/span><a href=\"#-null%E3%81%A7%E8%A7%A3%E6%B1%BA\"><i class=\"fa fa-link\"><\/i><\/a>+ NULLで解決!<\/h1>\n\n<p>この問題は<code>+ NULL<\/code>で解決できます。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"n\">iris<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Length<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Width<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_point<\/span><span class=\"p\">()<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_smooth<\/span><span class=\"p\">(<\/span><span class=\"n\">alpha<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">0.6<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"kc\">NULL<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>としておくと、カットアンドペーストでレイヤの順番を変更したり、コメントアウトでレイヤを削除することもできます。<\/p>\n\n<h1>\n<span id=\"レイヤのリストを足すとき\" class=\"fragment\"><\/span><a href=\"#%E3%83%AC%E3%82%A4%E3%83%A4%E3%81%AE%E3%83%AA%E3%82%B9%E3%83%88%E3%82%92%E8%B6%B3%E3%81%99%E3%81%A8%E3%81%8D\"><i class=\"fa fa-link\"><\/i><\/a>レイヤのリストを足すとき<\/h1>\n\n<p>同様にリストの最後をNULLにしておくことで解決します。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"n\">iris<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Length<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Width<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"nf\">list<\/span><span class=\"p\">(<\/span><span class=\"w\">\n    <\/span><span class=\"n\">geom_point<\/span><span class=\"p\">(),<\/span><span class=\"w\">\n    <\/span><span class=\"n\">geom_smooth<\/span><span class=\"p\">(<\/span><span class=\"n\">alpha<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">0.6<\/span><span class=\"p\">),<\/span><span class=\"w\">\n    <\/span><span class=\"kc\">NULL<\/span><span class=\"w\">\n  <\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<h1>\n<span id=\"enjoy\" class=\"fragment\"><\/span><a href=\"#enjoy\"><i class=\"fa fa-link\"><\/i><\/a>Enjoy!<\/h1>\n\n<p>ちなみに、同様に順番が命なパイプ演算子については、<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"o\">%&gt;%<\/span><span class=\"w\"> <\/span><span class=\"n\">return<\/span><span class=\"w\"> \n<\/span><\/pre><\/div><\/div>\n\n<p>で終わるとよいことを過去の記事で書きました。<\/p>\n\n<p>%&gt;%で試行錯誤する時はreturnで終わろう<br>\n<a href=\"https://qiita.com/Atsushi776/items/dc3f6f81e9387d375269\" class=\"autolink\" id=\"reference-fdbd3cea4a836b43f06d\">https://qiita.com/Atsushi776/items/dc3f6f81e9387d375269<\/a><\/p>\n"],"body":["# ggplot2はレイヤの順番変更や、削除がやや手間\n\nggplot2は、便利な作図ツールですが、データや書式をレイヤに分けている関係上、レイヤを足す順番が大事になります。\n例えば下記の図は、散布図と回帰曲線を足す順番を前後させたもの。\n点を目立たせたいか、回帰曲線を目立たせたいか、考えてレイヤを足さなければなりません。\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/56825b49-c8b3-d2ed-765f-c1ed7a1c747c.png)\n\n```r\nlibrary(ggplot2)\nlibrary(GGally)\n\ngp <- ggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species))\n\nlayers <- list(\n  geom_point(),\n  geom_smooth(alpha = 0.6)\n)\n\nggmatrix(\n  list(\n    gp + layers,\n    gp + rev(layers)    \n  ),\n  nrow = 1,\n  ncol = 2,\n  xAxisLabels = c(\n    '散布図 + 回帰曲線', \n    '回帰曲線 + 散布図'\n  )\n)\n```\n\nこの時、散布図+回帰曲線のプロットをした後に、やっぱり回帰曲線+散布図に直したいと思うと\n\n```r\nggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species)) +\n  geom_point() +\n  geom_smooth(alpha = 0.6)\n```\n\nの2行目と3行目を入れ替え、\n\n```r\nggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species)) +\n  geom_smooth(alpha = 0.6)\n  geom_point() +\n```\n\n2行目の行末に+を足し、3行目の行末から+を除くという、\n\n```r\nggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species)) +\n  geom_smooth(alpha = 0.6) +\n  geom_point()\n```\n\n2、3手間を要します。\nこれは面倒!\n\nまた、ここからやっぱり散布図がいらない! と思うと、\n3行目をコメントアウトし、\n\n```r\nggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species)) +\n  geom_smooth(alpha = 0.6) +\n  # geom_point()\n```\n\n2行目の+もコメントアウト(or delete)する\n\n\n```r\nggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species)) +\n  geom_smooth(alpha = 0.6) # +\n  # geom_point()\n```\n\n必要があります。\n\nやはり面倒だ。\n\n# + NULLで解決!\n\nこの問題は`+ NULL`で解決できます。\n\n```r\nggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species)) +\n  geom_point() +\n  geom_smooth(alpha = 0.6) +\n  NULL\n```\n\nとしておくと、カットアンドペーストでレイヤの順番を変更したり、コメントアウトでレイヤを削除することもできます。\n\n# レイヤのリストを足すとき\n\n同様にリストの最後をNULLにしておくことで解決します。\n\n```r\nggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species)) +\n  list(\n    geom_point(),\n    geom_smooth(alpha = 0.6),\n    NULL\n  )\n```\n\n# Enjoy!\n\nちなみに、同様に順番が命なパイプ演算子については、\n\n```r\n%>% return \n```\n\nで終わるとよいことを過去の記事で書きました。\n\n%>%で試行錯誤する時はreturnで終わろう\nhttps://qiita.com/Atsushi776/items/dc3f6f81e9387d375269\n\n\n\n"],"coediting":[false],"comments_count":[0],"created_at":["2018-02-23T17:14:46+09:00"],"group":{},"id":["3c5bb75b0b1fe4c2a543"],"likes_count":[11],"private":[false],"reactions_count":[0],"tags":[{"name":["R"],"versions":[]},{"name":["ggplot2"],"versions":[]}],"title":["ggplot2で試行錯誤する時は+ NULLで終わろう"],"updated_at":["2018-02-23T17:14:46+09:00"],"url":["https://qiita.com/Atsushi776/items/3c5bb75b0b1fe4c2a543"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["<p>昨日偉そうなことを呟いてしまったので、実際どれくらいRのforを最適化できるだろうかと今朝、電車の中で遊んでいた。<\/p>\n\n<blockquote class=\"twitter-tweet\">\n<p>Rのforが遅いのは錯覚というかコツを知らないだけだ。ただ、確かにapplyファミリーやその拡張たるpurrrパッケージ、行や列ごとに演算する関数(rowSumsなど)やその拡張のmatrixStatsパッケージを使うと利便性・可読性・速度いずれ増すことが多い。pforeachは最終手段。<\/p>— Atsushi (@Atsushi776) <a href=\"https://twitter.com/Atsushi776/status/958377118420709377?ref_src=twsrc%5Etfw\" rel=\"nofollow noopener\" target=\"_blank\">January 30, 2018<\/a>\n<\/blockquote>\n\n<script async src=\"https://platform.twitter.com/widgets.js\"><\/script>\n\n<p>とりあえずcolSumsと比較するぞー!<br>\nと思い、テストコードを書いてmicrobenchmarkする。<\/p>\n\n<p>for高速化の基本として、メモリの動的確保を避け、結果を格納するオブジェクト(y)を事前に用意する。<br>\n更に関数呼び出しや代入は少なければ少ないほどいいので、結果を格納するオブジェクト(y)をインデックスとしても利用することにした。<br>\nしかしここで不思議な事態が発生。<br>\nなんとforをfunctionに入れると速くなるのだ。<\/p>\n\n<p><strong>2017/2/1追記<\/strong>: どうやらループ回数が少ない時は、特にJITコンパイルのオーバーヘッドが、計算時間の差に現れるようです(後述)。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">set.seed<\/span><span class=\"p\">(<\/span><span class=\"m\">123<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">matrix<\/span><span class=\"p\">(<\/span><span class=\"n\">runif<\/span><span class=\"p\">(<\/span><span class=\"m\">10000<\/span><span class=\"p\">),<\/span><span class=\"w\"> <\/span><span class=\"m\">10<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"m\">1000<\/span><span class=\"p\">)<\/span><span class=\"w\">\n\n<\/span><span class=\"n\">microbenchmark<\/span><span class=\"o\">::<\/span><span class=\"n\">microbenchmark<\/span><span class=\"p\">(<\/span><span class=\"w\">\n  <\/span><span class=\"n\">`naked`<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n    <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"o\">:<\/span><span class=\"n\">ncol<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">)<\/span><span class=\"w\">\n    <\/span><span class=\"k\">for<\/span><span class=\"p\">(<\/span><span class=\"n\">i<\/span><span class=\"w\"> <\/span><span class=\"k\">in<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"p\">[<\/span><span class=\"n\">i<\/span><span class=\"p\">]<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"nf\">sum<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">[,<\/span><span class=\"w\"> <\/span><span class=\"n\">i<\/span><span class=\"p\">])<\/span><span class=\"w\">\n    <\/span><span class=\"n\">y<\/span><span class=\"w\">\n  <\/span><span class=\"p\">},<\/span><span class=\"w\">\n  <\/span><span class=\"n\">`wrapped`<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n    <\/span><span class=\"p\">(<\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n      <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"o\">:<\/span><span class=\"n\">ncol<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">)<\/span><span class=\"w\">\n      <\/span><span class=\"k\">for<\/span><span class=\"p\">(<\/span><span class=\"n\">i<\/span><span class=\"w\"> <\/span><span class=\"k\">in<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"p\">[<\/span><span class=\"n\">i<\/span><span class=\"p\">]<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"nf\">sum<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">[,<\/span><span class=\"w\"> <\/span><span class=\"n\">i<\/span><span class=\"p\">])<\/span><span class=\"w\">\n      <\/span><span class=\"n\">y<\/span><span class=\"w\">\n    <\/span><span class=\"p\">})(<\/span><span class=\"n\">x<\/span><span class=\"p\">)<\/span><span class=\"w\">\n  <\/span><span class=\"p\">}<\/span><span class=\"w\">\n<\/span><span class=\"p\">)<\/span><span class=\"w\">\n\n<\/span><\/pre><\/div><\/div>\n\n<table>\n<thead>\n<tr>\n<th style=\"text-align: left\">expr<\/th>\n<th style=\"text-align: right\">min<\/th>\n<th style=\"text-align: right\">lq<\/th>\n<th style=\"text-align: right\">mean<\/th>\n<th style=\"text-align: right\">median<\/th>\n<th style=\"text-align: right\">uq<\/th>\n<th style=\"text-align: right\">max<\/th>\n<th style=\"text-align: right\">neval<\/th>\n<\/tr>\n<\/thead>\n<tbody>\n<tr>\n<td style=\"text-align: left\">naked<\/td>\n<td style=\"text-align: right\">1492.253<\/td>\n<td style=\"text-align: right\">1617.5290<\/td>\n<td style=\"text-align: right\">1901.4042<\/td>\n<td style=\"text-align: right\">1706.717<\/td>\n<td style=\"text-align: right\">1777.8755<\/td>\n<td style=\"text-align: right\">4297.369<\/td>\n<td style=\"text-align: right\">100<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: left\">wrapped<\/td>\n<td style=\"text-align: right\">431.556<\/td>\n<td style=\"text-align: right\">490.3475<\/td>\n<td style=\"text-align: right\">555.0379<\/td>\n<td style=\"text-align: right\">510.185<\/td>\n<td style=\"text-align: right\">533.5315<\/td>\n<td style=\"text-align: right\">2340.449<\/td>\n<td style=\"text-align: right\">100<\/td>\n<\/tr>\n<\/tbody>\n<\/table>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F93f74882-6598-89ef-4fa2-cf9ac96e4f92.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=065c5a480c5a64712c283e0e2a450ad2\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F93f74882-6598-89ef-4fa2-cf9ac96e4f92.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=065c5a480c5a64712c283e0e2a450ad2\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/93f74882-6598-89ef-4fa2-cf9ac96e4f92.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F93f74882-6598-89ef-4fa2-cf9ac96e4f92.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=d7c0cdae5931d093e996501fb3f28347 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>左が剥き出しで右が関数にラップしたもの。<br>\n速度が全然違う。<br>\nなじぇ……？<\/p>\n\n<p>しかも行列を1000列から100000列に増やすと差が縮むっぽい(ループ回数100倍)。<\/p>\n\n<table>\n<thead>\n<tr>\n<th style=\"text-align: left\">expr<\/th>\n<th style=\"text-align: right\">min<\/th>\n<th style=\"text-align: right\">lq<\/th>\n<th style=\"text-align: right\">mean<\/th>\n<th style=\"text-align: right\">median<\/th>\n<th style=\"text-align: right\">uq<\/th>\n<th style=\"text-align: right\">max<\/th>\n<th style=\"text-align: right\">neval<\/th>\n<\/tr>\n<\/thead>\n<tbody>\n<tr>\n<td style=\"text-align: left\">naked<\/td>\n<td style=\"text-align: right\">45.29335<\/td>\n<td style=\"text-align: right\">50.87810<\/td>\n<td style=\"text-align: right\">53.68207<\/td>\n<td style=\"text-align: right\">51.23251<\/td>\n<td style=\"text-align: right\">52.36761<\/td>\n<td style=\"text-align: right\">122.4935<\/td>\n<td style=\"text-align: right\">100<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: left\">wrapped<\/td>\n<td style=\"text-align: right\">45.42338<\/td>\n<td style=\"text-align: right\">50.00987<\/td>\n<td style=\"text-align: right\">51.31302<\/td>\n<td style=\"text-align: right\">50.44030<\/td>\n<td style=\"text-align: right\">51.08073<\/td>\n<td style=\"text-align: right\">61.9420<\/td>\n<td style=\"text-align: right\">100<\/td>\n<\/tr>\n<\/tbody>\n<\/table>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F31673eac-5736-628a-c139-23715d2297cd.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=e399903cb287c94e0e5841e164fd99db\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F31673eac-5736-628a-c139-23715d2297cd.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=e399903cb287c94e0e5841e164fd99db\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/31673eac-5736-628a-c139-23715d2297cd.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F31673eac-5736-628a-c139-23715d2297cd.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=34c96db477f840e0546cb51c77dd451a 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>ループを更に10倍する<\/p>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F6aae19ea-dd29-f43a-b041-e15a86fe9560.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=4e74ebb42a4e634d2d6d0831be299a1c\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F6aae19ea-dd29-f43a-b041-e15a86fe9560.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=4e74ebb42a4e634d2d6d0831be299a1c\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/6aae19ea-dd29-f43a-b041-e15a86fe9560.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F6aae19ea-dd29-f43a-b041-e15a86fe9560.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=86ac7de7b60390347033ad020e9abaa0 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>剥き出しのほうが速いことが多いけれど、ラップするほうが速度が安定している……？<\/p>\n\n<p>勿論両者の結果は同じ<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"o\">:<\/span><span class=\"n\">ncol<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"k\">for<\/span><span class=\"p\">(<\/span><span class=\"n\">i<\/span><span class=\"w\"> <\/span><span class=\"k\">in<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"p\">[<\/span><span class=\"n\">i<\/span><span class=\"p\">]<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"nf\">sum<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">[,<\/span><span class=\"w\"> <\/span><span class=\"n\">i<\/span><span class=\"p\">])<\/span><span class=\"w\">\n<\/span><span class=\"n\">y2<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"p\">(<\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n      <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"o\">:<\/span><span class=\"n\">ncol<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">)<\/span><span class=\"w\">\n      <\/span><span class=\"k\">for<\/span><span class=\"p\">(<\/span><span class=\"n\">i<\/span><span class=\"w\"> <\/span><span class=\"k\">in<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"p\">[<\/span><span class=\"n\">i<\/span><span class=\"p\">]<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"nf\">sum<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">[,<\/span><span class=\"w\"> <\/span><span class=\"n\">i<\/span><span class=\"p\">])<\/span><span class=\"w\">\n      <\/span><span class=\"n\">y<\/span><span class=\"w\">\n    <\/span><span class=\"p\">})(<\/span><span class=\"n\">x<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"n\">identical<\/span><span class=\"p\">(<\/span><span class=\"n\">y<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">y2<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"c1\"># [1] TRUE<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<h1>\n<span id=\"201721追記\" class=\"fragment\"><\/span><a href=\"#201721%E8%BF%BD%E8%A8%98\"><i class=\"fa fa-link\"><\/i><\/a>2017/2/1追記<\/h1>\n\n<p>R3.4.0以降では、JITコンパイルが導入されました(<code>compiler::enableJIT(3)<\/code>)。<br>\nループ回数が少ない時は、JITコンパイルのオーバーヘッドが、計算時間の差に現れるようです。<br>\nTwitter上で考察にご協力頂いた、yutannihilationさん、TobakuCptlsmさんに感謝です。<br>\nJITを無効化するには<code>compiler::enableJIT(0)<\/code>を実行します。<br>\n元に戻すには<code>compiler::enableJIT(3)<\/code>。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">compiler<\/span><span class=\"o\">::<\/span><span class=\"n\">enableJIT<\/span><span class=\"p\">(<\/span><span class=\"m\">0<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"n\">set.seed<\/span><span class=\"p\">(<\/span><span class=\"m\">123<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">matrix<\/span><span class=\"p\">(<\/span><span class=\"n\">runif<\/span><span class=\"p\">(<\/span><span class=\"m\">10000<\/span><span class=\"p\">),<\/span><span class=\"w\"> <\/span><span class=\"m\">10<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"m\">1000<\/span><span class=\"p\">)<\/span><span class=\"w\">\n\n<\/span><span class=\"n\">microbenchmark<\/span><span class=\"o\">::<\/span><span class=\"n\">microbenchmark<\/span><span class=\"p\">(<\/span><span class=\"w\">\n  <\/span><span class=\"n\">`naked`<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n    <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"o\">:<\/span><span class=\"n\">ncol<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">)<\/span><span class=\"w\">\n    <\/span><span class=\"k\">for<\/span><span class=\"p\">(<\/span><span class=\"n\">i<\/span><span class=\"w\"> <\/span><span class=\"k\">in<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"p\">[<\/span><span class=\"n\">i<\/span><span class=\"p\">]<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"nf\">sum<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">[,<\/span><span class=\"w\"> <\/span><span class=\"n\">i<\/span><span class=\"p\">])<\/span><span class=\"w\">\n    <\/span><span class=\"n\">y<\/span><span class=\"w\">\n  <\/span><span class=\"p\">},<\/span><span class=\"w\">\n  <\/span><span class=\"n\">`wrapped`<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n    <\/span><span class=\"p\">(<\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n      <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"o\">:<\/span><span class=\"n\">ncol<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">)<\/span><span class=\"w\">\n      <\/span><span class=\"k\">for<\/span><span class=\"p\">(<\/span><span class=\"n\">i<\/span><span class=\"w\"> <\/span><span class=\"k\">in<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"p\">[<\/span><span class=\"n\">i<\/span><span class=\"p\">]<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"nf\">sum<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">[,<\/span><span class=\"w\"> <\/span><span class=\"n\">i<\/span><span class=\"p\">])<\/span><span class=\"w\">\n      <\/span><span class=\"n\">y<\/span><span class=\"w\">\n    <\/span><span class=\"p\">})(<\/span><span class=\"n\">x<\/span><span class=\"p\">)<\/span><span class=\"w\">\n  <\/span><span class=\"p\">}<\/span><span class=\"w\">\n<\/span><span class=\"p\">)<\/span><span class=\"w\">\n\n<\/span><\/pre><\/div><\/div>\n\n<table>\n<thead>\n<tr>\n<th style=\"text-align: left\">expr<\/th>\n<th style=\"text-align: right\">min<\/th>\n<th style=\"text-align: right\">lq<\/th>\n<th style=\"text-align: right\">mean<\/th>\n<th style=\"text-align: right\">median<\/th>\n<th style=\"text-align: right\">uq<\/th>\n<th style=\"text-align: right\">max<\/th>\n<th style=\"text-align: right\">neval<\/th>\n<\/tr>\n<\/thead>\n<tbody>\n<tr>\n<td style=\"text-align: left\">naked<\/td>\n<td style=\"text-align: right\">889.575<\/td>\n<td style=\"text-align: right\">911.6020<\/td>\n<td style=\"text-align: right\">930.1113<\/td>\n<td style=\"text-align: right\">924.7345<\/td>\n<td style=\"text-align: right\">936.240<\/td>\n<td style=\"text-align: right\">1084.229<\/td>\n<td style=\"text-align: right\">100<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: left\">wrapped<\/td>\n<td style=\"text-align: right\">770.046<\/td>\n<td style=\"text-align: right\">796.0295<\/td>\n<td style=\"text-align: right\">843.1757<\/td>\n<td style=\"text-align: right\">811.8900<\/td>\n<td style=\"text-align: right\">822.234<\/td>\n<td style=\"text-align: right\">3968.241<\/td>\n<td style=\"text-align: right\">100<\/td>\n<\/tr>\n<\/tbody>\n<\/table>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Ff890fa47-327c-6b5d-6aa2-9af43a3b64df.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=c54b83e551e8b8378943bd1d9e070747\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Ff890fa47-327c-6b5d-6aa2-9af43a3b64df.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=c54b83e551e8b8378943bd1d9e070747\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/f890fa47-327c-6b5d-6aa2-9af43a3b64df.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Ff890fa47-327c-6b5d-6aa2-9af43a3b64df.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=200ed91499ed66678e826d27927456c4 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>それでも若干wrappedの方が速いのが気持ち悪いですが……。<\/p>\n"],"body":["昨日偉そうなことを呟いてしまったので、実際どれくらいRのforを最適化できるだろうかと今朝、電車の中で遊んでいた。\n\n<blockquote class=\"twitter-tweet\" data-lang=\"en\"><p lang=\"ja\" dir=\"ltr\">Rのforが遅いのは錯覚というかコツを知らないだけだ。ただ、確かにapplyファミリーやその拡張たるpurrrパッケージ、行や列ごとに演算する関数(rowSumsなど)やその拡張のmatrixStatsパッケージを使うと利便性・可読性・速度いずれ増すことが多い。pforeachは最終手段。<\/p>&mdash; Atsushi (@Atsushi776) <a href=\"https://twitter.com/Atsushi776/status/958377118420709377?ref_src=twsrc%5Etfw\">January 30, 2018<\/a><\/blockquote>\n<script async src=\"https://platform.twitter.com/widgets.js\" charset=\"utf-8\"><\/script>\n\nとりあえずcolSumsと比較するぞー!\nと思い、テストコードを書いてmicrobenchmarkする。\n\nfor高速化の基本として、メモリの動的確保を避け、結果を格納するオブジェクト(y)を事前に用意する。\n更に関数呼び出しや代入は少なければ少ないほどいいので、結果を格納するオブジェクト(y)をインデックスとしても利用することにした。\nしかしここで不思議な事態が発生。\nなんとforをfunctionに入れると速くなるのだ。\n\n**2017/2/1追記**: どうやらループ回数が少ない時は、特にJITコンパイルのオーバーヘッドが、計算時間の差に現れるようです(後述)。\n\n```r\nset.seed(123)\nx <- matrix(runif(10000), 10, 1000)\n\nmicrobenchmark::microbenchmark(\n  `naked` = {\n    y <- 1:ncol(x)\n    for(i in y) y[i] <- sum(x[, i])\n    y\n  },\n  `wrapped` = {\n    (function(x) {\n      y <- 1:ncol(x)\n      for(i in y) y[i] <- sum(x[, i])\n      y\n    })(x)\n  }\n)\n\n```\n|expr    |      min|        lq|      mean|   median|        uq|      max| neval|\n|:-------|--------:|---------:|---------:|--------:|---------:|--------:|-----:|\n|naked   | 1492.253| 1617.5290| 1901.4042| 1706.717| 1777.8755| 4297.369|   100|\n|wrapped |  431.556|  490.3475|  555.0379|  510.185|  533.5315| 2340.449|   100|\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/93f74882-6598-89ef-4fa2-cf9ac96e4f92.png)\n\n左が剥き出しで右が関数にラップしたもの。\n速度が全然違う。\nなじぇ……？\n\nしかも行列を1000列から100000列に増やすと差が縮むっぽい(ループ回数100倍)。\n\n|expr    |      min|       lq|     mean|   median|       uq|      max| neval|\n|:-------|--------:|--------:|--------:|--------:|--------:|--------:|-----:|\n|naked   | 45.29335| 50.87810| 53.68207| 51.23251| 52.36761| 122.4935|   100|\n|wrapped | 45.42338| 50.00987| 51.31302| 50.44030| 51.08073|  61.9420|   100|\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/31673eac-5736-628a-c139-23715d2297cd.png)\n\nループを更に10倍する\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/6aae19ea-dd29-f43a-b041-e15a86fe9560.png)\n\n剥き出しのほうが速いことが多いけれど、ラップするほうが速度が安定している……？\n\n勿論両者の結果は同じ\n\n```r\ny <- 1:ncol(x)\nfor(i in y) y[i] <- sum(x[, i])\ny2 <- (function(x) {\n      y <- 1:ncol(x)\n      for(i in y) y[i] <- sum(x[, i])\n      y\n    })(x)\nidentical(y, y2)\n# [1] TRUE\n```\n\n\n# 2017/2/1追記\n\nR3.4.0以降では、JITコンパイルが導入されました(`compiler::enableJIT(3)`)。\nループ回数が少ない時は、JITコンパイルのオーバーヘッドが、計算時間の差に現れるようです。\nTwitter上で考察にご協力頂いた、yutannihilationさん、TobakuCptlsmさんに感謝です。\nJITを無効化するには`compiler::enableJIT(0)`を実行します。\n元に戻すには`compiler::enableJIT(3)`。\n\n```r\ncompiler::enableJIT(0)\nset.seed(123)\nx <- matrix(runif(10000), 10, 1000)\n\nmicrobenchmark::microbenchmark(\n  `naked` = {\n    y <- 1:ncol(x)\n    for(i in y) y[i] <- sum(x[, i])\n    y\n  },\n  `wrapped` = {\n    (function(x) {\n      y <- 1:ncol(x)\n      for(i in y) y[i] <- sum(x[, i])\n      y\n    })(x)\n  }\n)\n\n```\n\n|expr    |     min|       lq|     mean|   median|      uq|      max| neval|\n|:-------|-------:|--------:|--------:|--------:|-------:|--------:|-----:|\n|naked   | 889.575| 911.6020| 930.1113| 924.7345| 936.240| 1084.229|   100|\n|wrapped | 770.046| 796.0295| 843.1757| 811.8900| 822.234| 3968.241|   100|\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/f890fa47-327c-6b5d-6aa2-9af43a3b64df.png)\n\nそれでも若干wrappedの方が速いのが気持ち悪いですが……。\n\n"],"coediting":[false],"comments_count":[0],"created_at":["2018-01-31T18:04:46+09:00"],"group":{},"id":["fa1686da336433a6fc17"],"likes_count":[1],"private":[false],"reactions_count":[0],"tags":[{"name":["R"],"versions":[]},{"name":["for"],"versions":[]}],"title":["forってfunctionでwrapすると速くなんの？"],"updated_at":["2018-02-01T16:38:11+09:00"],"url":["https://qiita.com/Atsushi776/items/fa1686da336433a6fc17"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["<p>最近のRStudioやRStduio ServerではTerminalにアクセスできる。<br>\nしかし、なんらかの要因でアクセスできない場合がある。<\/p>\n\n<p>そんなときは、<\/p>\n\n<ul>\n<li>RStudioのToolsメニュー\n\n<ul>\n<li>Global Options\n\n<ul>\n<li>Terminal\n\n<ul>\n<li>Connection\n\n<ul>\n<li>Connect with WebSockets<\/li>\n<\/ul>\n<\/li>\n<\/ul>\n<\/li>\n<\/ul>\n<\/li>\n<\/ul>\n<\/li>\n<\/ul>\n\n<p>のチェックマークを外してみるといい<\/p>\n\n<p>参考までに私の環境<\/p>\n\n<p>R version 3.4.3 (2017-11-30)<br>\nPlatform: x86_64-pc-linux-gnu (64-bit)<br>\nRunning under: Linux Mint 18.3<\/p>\n\n<p>RStudio version 1.1.419 <\/p>\n\n<p>丁度、Guake Terminalを導入した頃だったのもあり、PATHがうまく通ってないのかと思って<\/p>\n\n<ul>\n<li>RStudioのToolsメニュー\n\n<ul>\n<li>Global Options\n\n<ul>\n<li>Terminal\n\n<ul>\n<li>Shell\n\n<ul>\n<li>New terminals open with: Bash<\/li>\n<\/ul>\n<\/li>\n<\/ul>\n<\/li>\n<\/ul>\n<\/li>\n<\/ul>\n<\/li>\n<\/ul>\n\n<p>から、BashをCustomにしてPATHを指定してみるも、WebSocketsを使っている限りはうまくいかなかった。<\/p>\n"],"body":["最近のRStudioやRStduio ServerではTerminalにアクセスできる。\nしかし、なんらかの要因でアクセスできない場合がある。\n\nそんなときは、\n\n- RStudioのToolsメニュー\n    - Global Options\n        - Terminal\n            - Connection\n                - Connect with WebSockets\n\nのチェックマークを外してみるといい\n\n\n参考までに私の環境\n\nR version 3.4.3 (2017-11-30)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Linux Mint 18.3\n\nRStudio version 1.1.419 \n\n丁度、Guake Terminalを導入した頃だったのもあり、PATHがうまく通ってないのかと思って\n\n- RStudioのToolsメニュー\n    - Global Options\n        - Terminal\n            - Shell\n                - New terminals open with: Bash\n       \nから、BashをCustomにしてPATHを指定してみるも、WebSocketsを使っている限りはうまくいかなかった。\n\n\n"],"coediting":[false],"comments_count":[0],"created_at":["2018-01-30T11:30:39+09:00"],"group":{},"id":["67463b875b2d31394210"],"likes_count":[2],"private":[false],"reactions_count":[0],"tags":[{"name":["R"],"versions":[]},{"name":["RStudio"],"versions":[]}],"title":["RStudioでTerminalが使えない時"],"updated_at":["2018-01-30T11:32:03+09:00"],"url":["https://qiita.com/Atsushi776/items/67463b875b2d31394210"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["<p>昨日の記事の続編ですが、昨日の記事のことは忘れていいです。<\/p>\n\n<h1>\n<span id=\"gghighlightについて\" class=\"fragment\"><\/span><a href=\"#gghighlight%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"><i class=\"fa fa-link\"><\/i><\/a>gghighlightについて<\/h1>\n\n<p>グラフ作りにおいて、必要な情報だけを色付けてくれるパッケージ(yutannihilation氏作)<br>\n<a href=\"http://notchained.hatenablog.com/entry/2017/09/29/212444\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\">http://notchained.hatenablog.com/entry/2017/09/29/212444<\/a><\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">library<\/span><span class=\"p\">(<\/span><span class=\"n\">ggplot2<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"n\">library<\/span><span class=\"p\">(<\/span><span class=\"n\">gghighlight<\/span><span class=\"p\">)<\/span><span class=\"w\">\n\n<\/span><span class=\"n\">gghighlight_point<\/span><span class=\"p\">(<\/span><span class=\"n\">iris<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Length<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Width<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"p\">),<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"w\"> <\/span><span class=\"o\">==<\/span><span class=\"w\"> <\/span><span class=\"s1\">'setosa'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">use_direct_label<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"kc\">FALSE<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F8ceab87b-e174-9672-ba9d-23102167d176.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=abdbc4a04e35524735fd9740beed7149\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F8ceab87b-e174-9672-ba9d-23102167d176.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=abdbc4a04e35524735fd9740beed7149\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/8ceab87b-e174-9672-ba9d-23102167d176.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F8ceab87b-e174-9672-ba9d-23102167d176.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=08383629b64d4c88f5b0fe9218d6d312 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>ただし、<\/p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>- 限られたgeomにしか使えない\n- highlightはaesthenticsになっていない\n<\/pre><\/div><\/div>\n\n<p>といった課題がある。<br>\n前者についてはggplot_add()の登場によって解決できる見通しっぽい。<br>\n<a href=\"https://yutani.rbind.io/post/2017-11-07-ggplot-add/\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\">https://yutani.rbind.io/post/2017-11-07-ggplot-add/<\/a><\/p>\n\n<p>でも実は既にあるggplot2の実装で両方解決できるんじゃね？<br>\nと思ったので試してみました。<\/p>\n\n<p>だいたいのgeomに対応できました。<br>\n多分geom_smooth以外。<br>\ngeom_quantileはいけた。<\/p>\n\n<p>以下はggprotoの知識が必要です。<br>\nyutannihilation氏のExtending ggplot2（和訳）を理解して下さい。<br>\n<a href=\"https://qiita.com/yutannihilation/items/f30baef75a0ac02bb2f0\" class=\"autolink\" id=\"reference-0dd642956135968664c6\">https://qiita.com/yutannihilation/items/f30baef75a0ac02bb2f0<\/a><\/p>\n\n<h1>\n<span id=\"練習\" class=\"fragment\"><\/span><a href=\"#%E7%B7%B4%E7%BF%92\"><i class=\"fa fa-link\"><\/i><\/a>練習<\/h1>\n\n<h2>\n<span id=\"散布図のhighlighthlしたい点だけを描写するgeom_point_hlを作ってみる\" class=\"fragment\"><\/span><a href=\"#%E6%95%A3%E5%B8%83%E5%9B%B3%E3%81%AEhighlighthl%E3%81%97%E3%81%9F%E3%81%84%E7%82%B9%E3%81%A0%E3%81%91%E3%82%92%E6%8F%8F%E5%86%99%E3%81%99%E3%82%8Bgeom_point_hl%E3%82%92%E4%BD%9C%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B\"><i class=\"fa fa-link\"><\/i><\/a>散布図のhighlight(hl)したい点だけを描写するgeom_point_hlを作ってみる。<\/h2>\n\n<p>ggplotでは、与えられたデータに対して、様々な演算を行っています。<br>\n例えばgeom_boxplotではデータに対して、分位点や外れ値を計算し、使いやすいデータに整形した上で、プロットしています。<br>\n計算の仕方はgeom_*(stat = 'hogehoge')というstat引数で指定されています(geom_pointなら'identity', geom_boxplotなら'boxplot)。<br>\nこの使いやすいデータに整形というところがミソで、オリジナルの計算方法を定義し、statに指定すれば、いらないデータを削ることが可能です。<\/p>\n\n<p>では散布図の審美的属性(aethentics; aes)にhighlightを追加して、highlightにTRUEが指定されている値のみをプロットするようにしてみましょう。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"c1\"># 計算方法を定義<\/span><span class=\"w\">\n<\/span><span class=\"c1\"># ggprotoによるStatの作成<\/span><span class=\"w\">\n<\/span><span class=\"n\">StatPointHL<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">ggproto<\/span><span class=\"p\">(<\/span><span class=\"w\">\n  <\/span><span class=\"s1\">'StatPointHL'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"c1\">#新しいstatのクラス名<\/span><span class=\"w\">\n  <\/span><span class=\"n\">Stat<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"c1\">#継承したいggprotoオブジェクト<\/span><span class=\"w\">\n  <\/span><span class=\"n\">compute_group<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"c1\">#グループごとに必要な情報以外を消す<\/span><span class=\"w\">\n    <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">data<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">...<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"n\">data<\/span><span class=\"p\">[<\/span><span class=\"n\">data<\/span><span class=\"o\">$<\/span><span class=\"n\">highlight<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"p\">],<\/span><span class=\"w\">\n  <\/span><span class=\"n\">required_aes<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"nf\">c<\/span><span class=\"p\">(<\/span><span class=\"s1\">'x'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"s1\">'y'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"s1\">'highlight'<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"c1\">#審美的属性には散布図に必要なxとy以外に、強調したいデータかをTRUE/FALSEで示すhighlightを追加<\/span><span class=\"w\">\n<\/span><span class=\"p\">)<\/span><span class=\"w\">\n\n<\/span><span class=\"c1\"># geom_point_hlを作成<\/span><span class=\"w\">\n<\/span><span class=\"n\">geom_point_hl<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">geom_point<\/span><span class=\"w\"> <\/span><span class=\"c1\"># geom_pointをコピーして<\/span><span class=\"w\">\n<\/span><span class=\"n\">formals<\/span><span class=\"p\">(<\/span><span class=\"n\">geom_point_hl<\/span><span class=\"p\">)<\/span><span class=\"o\">$<\/span><span class=\"n\">stat<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">StatPointHL<\/span><span class=\"w\"> <\/span><span class=\"c1\">#stat引数を上書き<\/span><span class=\"w\">\n\n<\/span><span class=\"c1\"># プロットしてみる<\/span><span class=\"w\">\n<\/span><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"n\">iris<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Length<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Width<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">highlight<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"w\"> <\/span><span class=\"o\">==<\/span><span class=\"w\"> <\/span><span class=\"s1\">'setosa'<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_point_hl<\/span><span class=\"p\">()<\/span><span class=\"w\">\n\n<\/span><\/pre><\/div><\/div>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F47df883c-c340-59df-28ae-87284a7de762.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=e3edddba062ca2798bc5d90dcc9a52df\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F47df883c-c340-59df-28ae-87284a7de762.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=e3edddba062ca2798bc5d90dcc9a52df\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/47df883c-c340-59df-28ae-87284a7de762.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F47df883c-c340-59df-28ae-87284a7de762.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=6c0fe1dde0046a1409f5162c0ca1af00 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>irisのsetosa種についてのみのプロットが得られました。<\/p>\n\n<h2>\n<span id=\"boxplotについてhighlightしたいものだけ描写する\" class=\"fragment\"><\/span><a href=\"#boxplot%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6highlight%E3%81%97%E3%81%9F%E3%81%84%E3%82%82%E3%81%AE%E3%81%A0%E3%81%91%E6%8F%8F%E5%86%99%E3%81%99%E3%82%8B\"><i class=\"fa fa-link\"><\/i><\/a>boxplotについてhighlightしたいものだけ描写する<\/h2>\n\n<p>さて、実際にはboxplotなどでは複雑な計算が行われているのは既知の通り。<br>\nということは、StatBoxplotHLを作ろうとすると、compute_groupで、データのフィルタリングと演算両方を定義しなければなりません。<br>\nこれはコードが長くなりかねない…………!<br>\nというか、既に演算方法については決めてあるので、これをコピペするのも愚かです。<br>\n例えばStatBoxplotのcompute_groupはStatBoxplot$compute_groupで取り出すことができます。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">StatBoxplot<\/span><span class=\"o\">$<\/span><span class=\"n\">compute_group<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>それなら、適宜削ったデータを、親のcompute_groupに渡せばOKですね。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">data<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">...<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"n\">StatBoxplot<\/span><span class=\"o\">$<\/span><span class=\"n\">compute_group<\/span><span class=\"p\">(<\/span><span class=\"n\">data<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">data<\/span><span class=\"p\">[<\/span><span class=\"n\">data<\/span><span class=\"o\">$<\/span><span class=\"n\">highlight<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"p\">],<\/span><span class=\"w\"> <\/span><span class=\"n\">...<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>実際にはcompute_layerやcompute_panelも使われることがあるはずなので、これらもついでにwrapしましょう。<br>\n先の例ではgeom_point_hlを作りましたが、実際には、stat引数を調整するだけでいいので、その場限りの利用であれば、geom_boxplot_hlを作る必要はありません。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"c1\">#計算方法の定義<\/span><span class=\"w\">\n<\/span><span class=\"n\">StatBoxplotHL<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">ggproto<\/span><span class=\"p\">(<\/span><span class=\"w\">\n  <\/span><span class=\"s1\">'StatBoxplotHL'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"c1\">#新しいstatのクラス名<\/span><span class=\"w\">\n  <\/span><span class=\"n\">StatBoxplot<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"c1\">#継承したいggprotoオブジェクト<\/span><span class=\"w\">\n  <\/span><span class=\"n\">compute_group<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"c1\">#グループごとに必要な情報以外を消す<\/span><span class=\"w\">\n    <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">data<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">...<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"n\">StatBoxplot<\/span><span class=\"o\">$<\/span><span class=\"n\">compute_group<\/span><span class=\"p\">(<\/span><span class=\"n\">data<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">data<\/span><span class=\"p\">[<\/span><span class=\"n\">data<\/span><span class=\"o\">$<\/span><span class=\"n\">highlight<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"p\">],<\/span><span class=\"w\"> <\/span><span class=\"n\">...<\/span><span class=\"p\">),<\/span><span class=\"w\">\n  <\/span><span class=\"n\">compute_layer<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"c1\">#レイヤに必要な情報以外を消す<\/span><span class=\"w\">\n    <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">data<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">...<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"n\">StatBoxplot<\/span><span class=\"o\">$<\/span><span class=\"n\">compute_layer<\/span><span class=\"p\">(<\/span><span class=\"n\">data<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">data<\/span><span class=\"p\">[<\/span><span class=\"n\">data<\/span><span class=\"o\">$<\/span><span class=\"n\">highlight<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"p\">],<\/span><span class=\"w\"> <\/span><span class=\"n\">...<\/span><span class=\"p\">),<\/span><span class=\"w\">\n  <\/span><span class=\"n\">compute_panel<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"c1\">#パネルに必要な情報以外を消す<\/span><span class=\"w\">\n    <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">data<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">...<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"n\">StatBoxplot<\/span><span class=\"o\">$<\/span><span class=\"n\">compute_panel<\/span><span class=\"p\">(<\/span><span class=\"n\">data<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">data<\/span><span class=\"p\">[<\/span><span class=\"n\">data<\/span><span class=\"o\">$<\/span><span class=\"n\">highlight<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"p\">],<\/span><span class=\"w\"> <\/span><span class=\"n\">...<\/span><span class=\"p\">),<\/span><span class=\"w\">\n  <\/span><span class=\"n\">required_aes<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"nf\">c<\/span><span class=\"p\">(<\/span><span class=\"s1\">'x'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"s1\">'y'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"s1\">'highlight'<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"c1\">#審美的属性には散布図に必要なxとy以外に、強調したいデータかをTRUE/FALSEで示すhighlightを追加<\/span><span class=\"w\">\n<\/span><span class=\"p\">)<\/span><span class=\"w\">\n\n<\/span><span class=\"c1\">#使用例<\/span><span class=\"w\">\n<\/span><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"n\">iris<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Width<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">highlight<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"w\"> <\/span><span class=\"o\">==<\/span><span class=\"w\"> <\/span><span class=\"s1\">'setosa'<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_boxplot<\/span><span class=\"p\">(<\/span><span class=\"n\">stat<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">StatBoxplotHL<\/span><span class=\"p\">)<\/span><span class=\"w\">\n\n<\/span><\/pre><\/div><\/div>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F5b4947fe-0ea8-27c1-506f-8bbbe93492d0.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=0a84dbdadc3035f3ed9405f999c2efa9\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F5b4947fe-0ea8-27c1-506f-8bbbe93492d0.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=0a84dbdadc3035f3ed9405f999c2efa9\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/5b4947fe-0ea8-27c1-506f-8bbbe93492d0.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F5b4947fe-0ea8-27c1-506f-8bbbe93492d0.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=a80836e873a7b73e1d8b75ea76a90487 1x\" loading=\"lazy\"><\/a><\/p>\n\n<h1>\n<span id=\"実装\" class=\"fragment\"><\/span><a href=\"#%E5%AE%9F%E8%A3%85\"><i class=\"fa fa-link\"><\/i><\/a>実装<\/h1>\n\n<h2>\n<span id=\"任意のgeom_についてhighlightしたいものだけ描写する\" class=\"fragment\"><\/span><a href=\"#%E4%BB%BB%E6%84%8F%E3%81%AEgeom_%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6highlight%E3%81%97%E3%81%9F%E3%81%84%E3%82%82%E3%81%AE%E3%81%A0%E3%81%91%E6%8F%8F%E5%86%99%E3%81%99%E3%82%8B\"><i class=\"fa fa-link\"><\/i><\/a>任意のgeom_についてhighlightしたいものだけ描写する<\/h2>\n\n<p>どんどん汎用的にしていきましょう。<\/p>\n\n<p>あるgeom_についてハイライト版を作りたいとき、イチイチ継承する計算方法(Stat)を調べるのは面倒です。<br>\n各geomが指定しているstat引数から、継承相手を探してきましょう。<br>\nそれにはggplot2:::find_subclassを使います。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">ggplot2<\/span><span class=\"o\">:::<\/span><span class=\"n\">find_subclass<\/span><span class=\"p\">(<\/span><span class=\"s2\">\"Stat\"<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"s1\">'boxplot'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">parent.frame<\/span><span class=\"p\">())<\/span><span class=\"w\">\n\n<\/span><span class=\"c1\"># [Show in New Window] [Clear Output] [Expand/Collapse Output]<\/span><span class=\"w\">\n<\/span><span class=\"c1\"># <\/span><span class=\"w\">\n<\/span><span class=\"c1\"># &lt;ggproto object: Class StatBoxplot, Stat&gt;<\/span><span class=\"w\">\n<\/span><span class=\"c1\">#     aesthetics: function<\/span><span class=\"w\">\n<\/span><span class=\"c1\">#     compute_group: function<\/span><span class=\"w\">\n<\/span><span class=\"c1\">#     compute_layer: function<\/span><span class=\"w\">\n<\/span><span class=\"c1\">#     compute_panel: function<\/span><span class=\"w\">\n<\/span><span class=\"c1\">#     default_aes: uneval<\/span><span class=\"w\">\n<\/span><span class=\"c1\">#     extra_params: na.rm<\/span><span class=\"w\">\n<\/span><span class=\"c1\">#     finish_layer: function<\/span><span class=\"w\">\n<\/span><span class=\"c1\">#     non_missing_aes: weight<\/span><span class=\"w\">\n<\/span><span class=\"c1\">#     parameters: function<\/span><span class=\"w\">\n<\/span><span class=\"c1\">#     required_aes: x y<\/span><span class=\"w\">\n<\/span><span class=\"c1\">#     retransform: TRUE<\/span><span class=\"w\">\n<\/span><span class=\"c1\">#     setup_data: function<\/span><span class=\"w\">\n<\/span><span class=\"c1\">#     setup_params: function<\/span><span class=\"w\">\n<\/span><span class=\"c1\">#     super:  &lt;ggproto object: Class Stat&gt;<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>これを利用して任意のgeomからStatを探してくる関数<br>\nfind_stat_from_geomを定義します。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"c1\">#関数定義<\/span><span class=\"w\">\n<\/span><span class=\"n\">find_stat_from_geom<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">geom<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n  <\/span><span class=\"n\">ggplot2<\/span><span class=\"o\">:::<\/span><span class=\"n\">find_subclass<\/span><span class=\"p\">(<\/span><span class=\"s2\">\"Stat\"<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">formals<\/span><span class=\"p\">(<\/span><span class=\"n\">geom<\/span><span class=\"p\">)<\/span><span class=\"o\">$<\/span><span class=\"n\">stat<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">parent.frame<\/span><span class=\"p\">())<\/span><span class=\"w\">\n<\/span><span class=\"p\">}<\/span><span class=\"w\">\n\n<\/span><span class=\"c1\">#仕様例<\/span><span class=\"w\">\n<\/span><span class=\"n\">find_stat_from_geom<\/span><span class=\"p\">(<\/span><span class=\"n\">geom_point<\/span><span class=\"p\">)<\/span><span class=\"w\">\n\n<\/span><span class=\"c1\"># [Show in New Window] [Clear Output] [Expand/Collapse Output]<\/span><span class=\"w\">\n<\/span><span class=\"c1\"># <\/span><span class=\"w\">\n<\/span><span class=\"c1\"># &lt;ggproto object: Class StatIdentity, Stat&gt;<\/span><span class=\"w\">\n<\/span><span class=\"c1\">#     aesthetics: function<\/span><span class=\"w\">\n<\/span><span class=\"c1\">#     compute_group: function<\/span><span class=\"w\">\n<\/span><span class=\"c1\">#     compute_layer: function<\/span><span class=\"w\">\n<\/span><span class=\"c1\">#     compute_panel: function<\/span><span class=\"w\">\n<\/span><span class=\"c1\">#     default_aes: uneval<\/span><span class=\"w\">\n<\/span><span class=\"c1\">#     extra_params: na.rm<\/span><span class=\"w\">\n<\/span><span class=\"c1\">#     finish_layer: function<\/span><span class=\"w\">\n<\/span><span class=\"c1\">#     non_missing_aes: <\/span><span class=\"w\">\n<\/span><span class=\"c1\">#     parameters: function<\/span><span class=\"w\">\n<\/span><span class=\"c1\">#     required_aes: <\/span><span class=\"w\">\n<\/span><span class=\"c1\">#     retransform: TRUE<\/span><span class=\"w\">\n<\/span><span class=\"c1\">#     setup_data: function<\/span><span class=\"w\">\n<\/span><span class=\"c1\">#     setup_params: function<\/span><span class=\"w\">\n<\/span><span class=\"c1\">#     super:  &lt;ggproto object: Class Stat&gt;<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>これを使うと任意のgeomに用いられるStatについてHL版を作成できます。<br>\nこの時、任意のStatから、指定したMethod(compute_groupなど)を取り出し、必要なデータのみを渡すようにwrapする関数function_hlも定義しておきます。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"c1\">#compute_group, layer, panelのラッパー<\/span><span class=\"w\">\n<\/span><span class=\"n\">function_hl<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">nm<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">stat<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n  <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">data<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">...<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"n\">stat<\/span><span class=\"p\">[[<\/span><span class=\"n\">nm<\/span><span class=\"p\">]](<\/span><span class=\"n\">data<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">data<\/span><span class=\"p\">[<\/span><span class=\"n\">data<\/span><span class=\"o\">$<\/span><span class=\"n\">highlight<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"p\">],<\/span><span class=\"w\"> <\/span><span class=\"n\">...<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"p\">}<\/span><span class=\"w\">\n\n<\/span><span class=\"c1\">#ハイライトするデータだけを表示するようにしてくれるggprotoオブジェクト(Stat)を返す関数<\/span><span class=\"w\">\n<\/span><span class=\"n\">ggproto_hl<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">geom<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n  <\/span><span class=\"n\">stat<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">find_stat_from_geom<\/span><span class=\"p\">(<\/span><span class=\"n\">geom<\/span><span class=\"p\">)<\/span><span class=\"w\">\n  <\/span><span class=\"n\">ggplot2<\/span><span class=\"o\">::<\/span><span class=\"n\">ggproto<\/span><span class=\"p\">(<\/span><span class=\"w\">\n    <\/span><span class=\"n\">paste0<\/span><span class=\"p\">(<\/span><span class=\"nf\">class<\/span><span class=\"p\">(<\/span><span class=\"n\">stat<\/span><span class=\"p\">)[<\/span><span class=\"m\">1<\/span><span class=\"p\">],<\/span><span class=\"w\"> <\/span><span class=\"s1\">'HL'<\/span><span class=\"p\">),<\/span><span class=\"w\">\n    <\/span><span class=\"n\">stat<\/span><span class=\"p\">,<\/span><span class=\"w\">\n    <\/span><span class=\"n\">compute_group<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">function_hl<\/span><span class=\"p\">(<\/span><span class=\"s1\">'compute_group'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">stat<\/span><span class=\"p\">),<\/span><span class=\"w\">\n    <\/span><span class=\"n\">compute_layer<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">function_hl<\/span><span class=\"p\">(<\/span><span class=\"s1\">'compute_layer'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">stat<\/span><span class=\"p\">),<\/span><span class=\"w\">\n    <\/span><span class=\"n\">compute_panel<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">function_hl<\/span><span class=\"p\">(<\/span><span class=\"s1\">'compute_panel'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">stat<\/span><span class=\"p\">),<\/span><span class=\"w\">\n    <\/span><span class=\"n\">required_aes<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"nf\">c<\/span><span class=\"p\">(<\/span><span class=\"n\">stat<\/span><span class=\"o\">$<\/span><span class=\"n\">required_aes<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"s1\">'highlight'<\/span><span class=\"p\">)<\/span><span class=\"w\">\n  <\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"p\">}<\/span><span class=\"w\">\n\n<\/span><span class=\"c1\">#使用例<\/span><span class=\"w\">\n\n<\/span><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"n\">iris<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Length<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">highlight<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"w\"> <\/span><span class=\"o\">==<\/span><span class=\"w\"> <\/span><span class=\"s1\">'setosa'<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_density<\/span><span class=\"p\">(<\/span><span class=\"n\">stat<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">ggproto_hl<\/span><span class=\"p\">(<\/span><span class=\"n\">geom_density<\/span><span class=\"p\">))<\/span><span class=\"w\">\n\n<\/span><\/pre><\/div><\/div>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F9dd48166-8ea3-7a01-5993-32e3b84bb060.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=823aa5efec616129824f64c21ae3b897\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F9dd48166-8ea3-7a01-5993-32e3b84bb060.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=823aa5efec616129824f64c21ae3b897\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/9dd48166-8ea3-7a01-5993-32e3b84bb060.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F9dd48166-8ea3-7a01-5993-32e3b84bb060.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=5bb89b39c0df9551d50c8eb914e6bd43 1x\" loading=\"lazy\"><\/a><\/p>\n\n<h2>\n<span id=\"任意のgeom_についてlowlightしたいものだけ描写し地味にする\" class=\"fragment\"><\/span><a href=\"#%E4%BB%BB%E6%84%8F%E3%81%AEgeom_%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6lowlight%E3%81%97%E3%81%9F%E3%81%84%E3%82%82%E3%81%AE%E3%81%A0%E3%81%91%E6%8F%8F%E5%86%99%E3%81%97%E5%9C%B0%E5%91%B3%E3%81%AB%E3%81%99%E3%82%8B\"><i class=\"fa fa-link\"><\/i><\/a>任意のgeom_についてlowlightしたいものだけ描写し、地味にする<\/h2>\n\n<p>では、同様にggproto_llを定義しましょう。<br>\nこの時、function_hlとggproto_hlに対応するfunction_ll、ggproto_llでは、表示するデータの見た目をhighlightするデータより地味に見せるため、見た目を変化させる引数Ｌを追加します。<br>\nここではcolour = NAにしてみました。<br>\nscale_colour_*のna.values引数の値が採用されます(既定値: gray50)<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"c1\">#compute_group, layer, panelのラッパー<\/span><span class=\"w\">\n<\/span><span class=\"n\">function_ll<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">nm<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">stat<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">LL<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n  <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">data<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">...<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n    <\/span><span class=\"n\">data<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">data<\/span><span class=\"p\">[<\/span><span class=\"o\">!<\/span><span class=\"n\">data<\/span><span class=\"o\">$<\/span><span class=\"n\">highlight<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"p\">]<\/span><span class=\"w\">\n    <\/span><span class=\"n\">data<\/span><span class=\"p\">[<\/span><span class=\"nf\">names<\/span><span class=\"p\">(<\/span><span class=\"n\">LL<\/span><span class=\"p\">)]<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">LL<\/span><span class=\"w\"> <\/span><span class=\"c1\">#lowlightするデータの見た目を変更<\/span><span class=\"w\">\n    <\/span><span class=\"n\">stat<\/span><span class=\"p\">[[<\/span><span class=\"n\">nm<\/span><span class=\"p\">]](<\/span><span class=\"n\">data<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">data<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">...<\/span><span class=\"p\">)<\/span><span class=\"w\">\n  <\/span><span class=\"p\">}<\/span><span class=\"w\">\n<\/span><span class=\"p\">}<\/span><span class=\"w\">\n\n<\/span><span class=\"c1\">#ハイライトするデータだけを表示するようにしてくれるggprotoオブジェクト(Stat)を返す関数<\/span><span class=\"w\">\n<\/span><span class=\"n\">ggproto_ll<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">geom<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">LL<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"nf\">list<\/span><span class=\"p\">(<\/span><span class=\"n\">colour<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"kc\">NA<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n  <\/span><span class=\"n\">stat<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">find_stat_from_geom<\/span><span class=\"p\">(<\/span><span class=\"n\">geom<\/span><span class=\"p\">)<\/span><span class=\"w\">\n  <\/span><span class=\"n\">ggplot2<\/span><span class=\"o\">::<\/span><span class=\"n\">ggproto<\/span><span class=\"p\">(<\/span><span class=\"w\">\n    <\/span><span class=\"n\">paste0<\/span><span class=\"p\">(<\/span><span class=\"nf\">class<\/span><span class=\"p\">(<\/span><span class=\"n\">stat<\/span><span class=\"p\">)[<\/span><span class=\"m\">1<\/span><span class=\"p\">],<\/span><span class=\"w\"> <\/span><span class=\"s1\">'HL'<\/span><span class=\"p\">),<\/span><span class=\"w\">\n    <\/span><span class=\"n\">stat<\/span><span class=\"p\">,<\/span><span class=\"w\">\n    <\/span><span class=\"n\">compute_group<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">function_ll<\/span><span class=\"p\">(<\/span><span class=\"s1\">'compute_group'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">stat<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">LL<\/span><span class=\"p\">),<\/span><span class=\"w\">\n    <\/span><span class=\"n\">compute_layer<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">function_ll<\/span><span class=\"p\">(<\/span><span class=\"s1\">'compute_layer'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">stat<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">LL<\/span><span class=\"p\">),<\/span><span class=\"w\">\n    <\/span><span class=\"n\">compute_panel<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">function_ll<\/span><span class=\"p\">(<\/span><span class=\"s1\">'compute_panel'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">stat<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">LL<\/span><span class=\"p\">),<\/span><span class=\"w\">\n    <\/span><span class=\"n\">required_aes<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"nf\">c<\/span><span class=\"p\">(<\/span><span class=\"n\">stat<\/span><span class=\"o\">$<\/span><span class=\"n\">required_aes<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"s1\">'highlight'<\/span><span class=\"p\">)<\/span><span class=\"w\">\n  <\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"p\">}<\/span><span class=\"w\">\n\n<\/span><span class=\"c1\">#data[names(LL)] &lt;- LLをコメントアウトしないと動きません<\/span><span class=\"w\">\n<\/span><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"n\">iris<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Length<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">highlight<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"w\"> <\/span><span class=\"o\">==<\/span><span class=\"w\"> <\/span><span class=\"s1\">'setosa'<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_density<\/span><span class=\"p\">(<\/span><span class=\"n\">stat<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">ggproto_ll<\/span><span class=\"p\">(<\/span><span class=\"n\">geom_density<\/span><span class=\"p\">))<\/span><span class=\"w\">\n\n<\/span><\/pre><\/div><\/div>\n\n<p>ただし、このコードを実行すると、<br>\nError in seq.default(h[1], h[2], length.out = n) : 'to' must be a finite number<br>\nというエラーが返ってしまいます。<\/p>\n\n<p>これはcolour属性を指定しているくせに全部NAなのが原因です。<br>\nLL = list(colour = 'else')<br>\nとすると動きます。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"n\">iris<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Length<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">highlight<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"w\"> <\/span><span class=\"o\">==<\/span><span class=\"w\"> <\/span><span class=\"s1\">'setosa'<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_density<\/span><span class=\"p\">(<\/span><span class=\"n\">stat<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">ggproto_ll<\/span><span class=\"p\">(<\/span><span class=\"n\">geom_density<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">LL<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"nf\">list<\/span><span class=\"p\">(<\/span><span class=\"n\">colour<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"s1\">'else'<\/span><span class=\"p\">)))<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Fb58011ab-a854-8e3a-a37d-48945268adf1.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=a0c7b1106f15feaf058ce96b51e4a76f\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Fb58011ab-a854-8e3a-a37d-48945268adf1.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=a0c7b1106f15feaf058ce96b51e4a76f\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/b58011ab-a854-8e3a-a37d-48945268adf1.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Fb58011ab-a854-8e3a-a37d-48945268adf1.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=a8c95fbd995ac12914020ba7bf26122e 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>また、colourがちゃんと指定できるlayerと重なっていれば、LL = list(colour = NA)でもOKです。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"n\">iris<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Length<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">highlight<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"w\"> <\/span><span class=\"o\">==<\/span><span class=\"w\"> <\/span><span class=\"s1\">'setosa'<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_density<\/span><span class=\"p\">()<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_density<\/span><span class=\"p\">(<\/span><span class=\"n\">stat<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">ggproto_ll<\/span><span class=\"p\">(<\/span><span class=\"n\">geom_density<\/span><span class=\"p\">))<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F1d235ab6-11e4-8a20-5b62-dfb7fe4fed9f.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=52194792ab7aff72bb67a443655565b2\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F1d235ab6-11e4-8a20-5b62-dfb7fe4fed9f.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=52194792ab7aff72bb67a443655565b2\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/1d235ab6-11e4-8a20-5b62-dfb7fe4fed9f.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F1d235ab6-11e4-8a20-5b62-dfb7fe4fed9f.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=af33ab220885d12a0d260df9a117b192 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>この例では、lowlightした灰色の線が緑と青の線に重なっているため、結果的に、highlightすべきsetosaが目立っています。<\/p>\n\n<h2>\n<span id=\"highlight--trueなデータはhighlightしそうでないデータはlowlightする\" class=\"fragment\"><\/span><a href=\"#highlight--true%E3%81%AA%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AFhighlight%E3%81%97%E3%81%9D%E3%81%86%E3%81%A7%E3%81%AA%E3%81%84%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AFlowlight%E3%81%99%E3%82%8B\"><i class=\"fa fa-link\"><\/i><\/a>highlight == TRUEなデータはhighlightし、そうでないデータはlowlightする<\/h2>\n\n<p>ggproto_hlとggproto_llを組み合わせると、gghighlightのような挙動が実現できます。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"n\">iris<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Length<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Width<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">highlight<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"w\"> <\/span><span class=\"o\">==<\/span><span class=\"w\"> <\/span><span class=\"s1\">'setosa'<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_point<\/span><span class=\"p\">(<\/span><span class=\"n\">stat<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">ggproto_ll<\/span><span class=\"p\">(<\/span><span class=\"n\">geom_point<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_point<\/span><span class=\"p\">(<\/span><span class=\"n\">stat<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">ggproto_hl<\/span><span class=\"p\">(<\/span><span class=\"n\">geom_point<\/span><span class=\"p\">))<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F10d9bd86-fcfc-edb0-8c67-243c757c939b.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=8b6a61adb014740481da1891ccc55823\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F10d9bd86-fcfc-edb0-8c67-243c757c939b.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=8b6a61adb014740481da1891ccc55823\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/10d9bd86-fcfc-edb0-8c67-243c757c939b.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F10d9bd86-fcfc-edb0-8c67-243c757c939b.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=a1243f8fe3ec6657a6900e076a71584c 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>ですが、誰もこんな冗長な書き方はしたくないと思います。<\/p>\n\n<h2>\n<span id=\"任意のgeomに対しhighlight版geomを返す高階関数を定義\" class=\"fragment\"><\/span><a href=\"#%E4%BB%BB%E6%84%8F%E3%81%AEgeom%E3%81%AB%E5%AF%BE%E3%81%97highlight%E7%89%88geom%E3%82%92%E8%BF%94%E3%81%99%E9%AB%98%E9%9A%8E%E9%96%A2%E6%95%B0%E3%82%92%E5%AE%9A%E7%BE%A9\"><i class=\"fa fa-link\"><\/i><\/a>任意のgeomに対しhighlight版geomを返す高階関数を定義<\/h2>\n\n<p>しました!<br>\nやっていることは2つのレイヤ(LLとHL)の重ね合わせですからpurrr::pmapを使って、geomのstatだけを自動指定しましょう。<br>\n高階関数なので、返ってきた関数に引数を与えることで、shapeやsizeを調整可能です。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">library<\/span><span class=\"p\">(<\/span><span class=\"n\">purrr<\/span><span class=\"p\">)<\/span><span class=\"w\">\n\n<\/span><span class=\"c1\">#高階関数定義<\/span><span class=\"w\">\n<\/span><span class=\"n\">gghl<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">geom<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">LL<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"nf\">list<\/span><span class=\"p\">(<\/span><span class=\"n\">colour<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"kc\">NA<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n  <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">...<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n    <\/span><span class=\"nf\">list<\/span><span class=\"p\">(<\/span><span class=\"n\">stat<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"nf\">list<\/span><span class=\"p\">(<\/span><span class=\"w\">\n      <\/span><span class=\"n\">ggproto_ll<\/span><span class=\"p\">(<\/span><span class=\"n\">geom<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">LL<\/span><span class=\"p\">),<\/span><span class=\"w\">\n      <\/span><span class=\"n\">ggproto_hl<\/span><span class=\"p\">(<\/span><span class=\"n\">geom<\/span><span class=\"p\">)<\/span><span class=\"w\">\n    <\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n      <\/span><span class=\"n\">purrr<\/span><span class=\"o\">::<\/span><span class=\"n\">pmap<\/span><span class=\"p\">(<\/span><span class=\"n\">geom<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">...<\/span><span class=\"p\">)<\/span><span class=\"w\">\n  <\/span><span class=\"p\">}<\/span><span class=\"w\">\n<\/span><span class=\"p\">}<\/span><span class=\"w\">\n\n<\/span><span class=\"c1\">#使用例<\/span><span class=\"w\">\n<\/span><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"n\">iris<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Length<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Width<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">highlight<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"w\"> <\/span><span class=\"o\">==<\/span><span class=\"w\"> <\/span><span class=\"s1\">'setosa'<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\"> \n  <\/span><span class=\"n\">gghl<\/span><span class=\"p\">(<\/span><span class=\"n\">geom_point<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">LL<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"nf\">list<\/span><span class=\"p\">(<\/span><span class=\"n\">colour<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"kc\">NA<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">size<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"p\">))(<\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">size<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">10<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">scale_size_identity<\/span><span class=\"p\">()<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F0b0c0dfb-bdcd-d9d7-59de-a043ce2be873.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=f63a828be25718f617df5c2095f0b5b4\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F0b0c0dfb-bdcd-d9d7-59de-a043ce2be873.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=f63a828be25718f617df5c2095f0b5b4\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/0b0c0dfb-bdcd-d9d7-59de-a043ce2be873.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F0b0c0dfb-bdcd-d9d7-59de-a043ce2be873.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=eb8bbd0a20dfedad7837b8c1cd1c7990 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>繰り返し使うものを定義するのもOK<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">geom_density_hl<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">gghl<\/span><span class=\"p\">(<\/span><span class=\"n\">geom_density<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"n\">iris<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Width<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">highlight<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"w\"> <\/span><span class=\"o\">==<\/span><span class=\"w\"> <\/span><span class=\"s1\">'setosa'<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_density_hl<\/span><span class=\"p\">()<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F26d611d1-ca8d-764c-bf9e-722152d7649f.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=6dc026b97826449b07e497d5a0a76499\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F26d611d1-ca8d-764c-bf9e-722152d7649f.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=6dc026b97826449b07e497d5a0a76499\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/26d611d1-ca8d-764c-bf9e-722152d7649f.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F26d611d1-ca8d-764c-bf9e-722152d7649f.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=94d36e7d789f0afc6e4f14d8d1fba84e 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>これで、代替のgeomに対応できたはずですが、geom_smoothだけはうまくいっていません。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"n\">iris<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Length<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Width<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">highlight<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"w\"> <\/span><span class=\"o\">==<\/span><span class=\"w\"> <\/span><span class=\"s1\">'setosa'<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">gghl<\/span><span class=\"p\">(<\/span><span class=\"n\">geom_smooth<\/span><span class=\"p\">)()<\/span><span class=\"w\">\n\n<\/span><span class=\"c1\"># Computation failed in `stat_smooth()`: object 'auto' of mode 'function' was not found<\/span><span class=\"w\">\n<\/span><span class=\"c1\"># Computation failed in `stat_smooth()`: object 'auto' of mode 'function' was not found<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F985570ab-c324-4e3b-0bf3-a99030e08579.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=f3f3cdc87bfe60fc584dfef485efb6df\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F985570ab-c324-4e3b-0bf3-a99030e08579.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=f3f3cdc87bfe60fc584dfef485efb6df\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/985570ab-c324-4e3b-0bf3-a99030e08579.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F985570ab-c324-4e3b-0bf3-a99030e08579.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=2a79e5c410096b4aea8887664ad0e268 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>geom_quantileはうまくいきます<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"n\">iris<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Length<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Width<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">highlight<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"w\"> <\/span><span class=\"o\">==<\/span><span class=\"w\"> <\/span><span class=\"s1\">'setosa'<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">gghl<\/span><span class=\"p\">(<\/span><span class=\"n\">geom_point<\/span><span class=\"p\">)()<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">gghl<\/span><span class=\"p\">(<\/span><span class=\"n\">geom_quantile<\/span><span class=\"p\">)()<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F0ab93578-3254-1c75-aa70-44b8924c8f19.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=718ed408bab631063e6a121a3d9070fb\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F0ab93578-3254-1c75-aa70-44b8924c8f19.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=718ed408bab631063e6a121a3d9070fb\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/0ab93578-3254-1c75-aa70-44b8924c8f19.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F0ab93578-3254-1c75-aa70-44b8924c8f19.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=d180d8ae80f00e95a469f9cbf9c76bad 1x\" loading=\"lazy\"><\/a><\/p>\n\n<h1>\n<span id=\"補足\" class=\"fragment\"><\/span><a href=\"#%E8%A3%9C%E8%B6%B3\"><i class=\"fa fa-link\"><\/i><\/a>補足<\/h1>\n\n<p>これまでaes(highlight = hoge == fuga)という形でhighlightを指定していましたが、勿論、data.frameにhighlightするか決める論理値の列を入れてもOKです。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">iris<\/span><span class=\"o\">$<\/span><span class=\"n\">hl<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">iris<\/span><span class=\"o\">$<\/span><span class=\"n\">Species<\/span><span class=\"w\"> <\/span><span class=\"o\">==<\/span><span class=\"w\"> <\/span><span class=\"s1\">'setosa'<\/span><span class=\"w\">\n<\/span><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"n\">iris<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Length<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Width<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">highlight<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">hl<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">gghl<\/span><span class=\"p\">(<\/span><span class=\"n\">geom_point<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">LL<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"nf\">list<\/span><span class=\"p\">(<\/span><span class=\"n\">colour<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"kc\">NA<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">alpha<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">0.3<\/span><span class=\"p\">))()<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F52531fa7-306d-96dd-2295-50af0b55cbe9.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=5dedcbc7c5c2a3f059c9b43273b06923\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F52531fa7-306d-96dd-2295-50af0b55cbe9.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=5dedcbc7c5c2a3f059c9b43273b06923\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/52531fa7-306d-96dd-2295-50af0b55cbe9.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F52531fa7-306d-96dd-2295-50af0b55cbe9.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=acc1451bdd7ab246f36f389157be2025 1x\" loading=\"lazy\"><\/a><\/p>\n\n<h1>\n<span id=\"完成版\" class=\"fragment\"><\/span><a href=\"#%E5%AE%8C%E6%88%90%E7%89%88\"><i class=\"fa fa-link\"><\/i><\/a>完成版<\/h1>\n\n<p>説明は上ですでにしています<br>\n現在geom_smoothと格闘中<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">function_hl<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">nm<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">stat<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n  <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">data<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">...<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"n\">stat<\/span><span class=\"p\">[[<\/span><span class=\"n\">nm<\/span><span class=\"p\">]](<\/span><span class=\"n\">data<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">data<\/span><span class=\"p\">[<\/span><span class=\"n\">data<\/span><span class=\"o\">$<\/span><span class=\"n\">highlight<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"p\">],<\/span><span class=\"w\"> <\/span><span class=\"n\">...<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"p\">}<\/span><span class=\"w\">\n\n<\/span><span class=\"n\">ggproto_hl<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">geom<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n  <\/span><span class=\"n\">stat<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">ggplot2<\/span><span class=\"o\">:::<\/span><span class=\"n\">find_subclass<\/span><span class=\"p\">(<\/span><span class=\"s2\">\"Stat\"<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">formals<\/span><span class=\"p\">(<\/span><span class=\"n\">geom<\/span><span class=\"p\">)<\/span><span class=\"o\">$<\/span><span class=\"n\">stat<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">parent.frame<\/span><span class=\"p\">())<\/span><span class=\"w\">\n  <\/span><span class=\"n\">ggplot2<\/span><span class=\"o\">::<\/span><span class=\"n\">ggproto<\/span><span class=\"p\">(<\/span><span class=\"w\">\n    <\/span><span class=\"n\">paste0<\/span><span class=\"p\">(<\/span><span class=\"nf\">class<\/span><span class=\"p\">(<\/span><span class=\"n\">stat<\/span><span class=\"p\">)[<\/span><span class=\"m\">1<\/span><span class=\"p\">],<\/span><span class=\"w\"> <\/span><span class=\"s1\">'HL'<\/span><span class=\"p\">),<\/span><span class=\"w\">\n    <\/span><span class=\"n\">stat<\/span><span class=\"p\">,<\/span><span class=\"w\">\n    <\/span><span class=\"n\">compute_group<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">function_hl<\/span><span class=\"p\">(<\/span><span class=\"s1\">'compute_group'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">stat<\/span><span class=\"p\">),<\/span><span class=\"w\">\n    <\/span><span class=\"n\">compute_layer<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">function_hl<\/span><span class=\"p\">(<\/span><span class=\"s1\">'compute_layer'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">stat<\/span><span class=\"p\">),<\/span><span class=\"w\">\n    <\/span><span class=\"n\">compute_panel<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">function_hl<\/span><span class=\"p\">(<\/span><span class=\"s1\">'compute_panel'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">stat<\/span><span class=\"p\">),<\/span><span class=\"w\">\n    <\/span><span class=\"n\">required_aes<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"nf\">c<\/span><span class=\"p\">(<\/span><span class=\"n\">stat<\/span><span class=\"o\">$<\/span><span class=\"n\">required_aes<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"s1\">'highlight'<\/span><span class=\"p\">)<\/span><span class=\"w\">\n  <\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"p\">}<\/span><span class=\"w\">\n\n<\/span><span class=\"n\">function_ll<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">nm<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">stat<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">LL<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n  <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">data<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">...<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n    <\/span><span class=\"n\">data<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">data<\/span><span class=\"p\">[<\/span><span class=\"o\">!<\/span><span class=\"n\">data<\/span><span class=\"o\">$<\/span><span class=\"n\">highlight<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"p\">]<\/span><span class=\"w\">\n    <\/span><span class=\"n\">data<\/span><span class=\"p\">[<\/span><span class=\"nf\">names<\/span><span class=\"p\">(<\/span><span class=\"n\">LL<\/span><span class=\"p\">)]<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">LL<\/span><span class=\"w\">\n    <\/span><span class=\"n\">stat<\/span><span class=\"p\">[[<\/span><span class=\"n\">nm<\/span><span class=\"p\">]](<\/span><span class=\"n\">data<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">data<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">...<\/span><span class=\"p\">)<\/span><span class=\"w\">\n  <\/span><span class=\"p\">}<\/span><span class=\"w\">\n<\/span><span class=\"p\">}<\/span><span class=\"w\">\n\n\n<\/span><span class=\"n\">ggproto_ll<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">geom<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">LL<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"nf\">list<\/span><span class=\"p\">(<\/span><span class=\"n\">colour<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"kc\">NA<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n  <\/span><span class=\"n\">stat<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">ggplot2<\/span><span class=\"o\">:::<\/span><span class=\"n\">find_subclass<\/span><span class=\"p\">(<\/span><span class=\"s2\">\"Stat\"<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">formals<\/span><span class=\"p\">(<\/span><span class=\"n\">geom<\/span><span class=\"p\">)<\/span><span class=\"o\">$<\/span><span class=\"n\">stat<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">parent.frame<\/span><span class=\"p\">())<\/span><span class=\"w\">\n  <\/span><span class=\"n\">ggplot2<\/span><span class=\"o\">::<\/span><span class=\"n\">ggproto<\/span><span class=\"p\">(<\/span><span class=\"w\">\n    <\/span><span class=\"n\">paste0<\/span><span class=\"p\">(<\/span><span class=\"nf\">class<\/span><span class=\"p\">(<\/span><span class=\"n\">stat<\/span><span class=\"p\">)[<\/span><span class=\"m\">1<\/span><span class=\"p\">],<\/span><span class=\"w\"> <\/span><span class=\"s1\">'HL'<\/span><span class=\"p\">),<\/span><span class=\"w\">\n    <\/span><span class=\"n\">stat<\/span><span class=\"p\">,<\/span><span class=\"w\">\n    <\/span><span class=\"n\">compute_group<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">function_ll<\/span><span class=\"p\">(<\/span><span class=\"s1\">'compute_group'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">stat<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">LL<\/span><span class=\"p\">),<\/span><span class=\"w\">\n    <\/span><span class=\"n\">compute_layer<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">function_ll<\/span><span class=\"p\">(<\/span><span class=\"s1\">'compute_layer'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">stat<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">LL<\/span><span class=\"p\">),<\/span><span class=\"w\">\n    <\/span><span class=\"n\">compute_panel<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">function_ll<\/span><span class=\"p\">(<\/span><span class=\"s1\">'compute_panel'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">stat<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">LL<\/span><span class=\"p\">),<\/span><span class=\"w\">\n    <\/span><span class=\"n\">required_aes<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"nf\">c<\/span><span class=\"p\">(<\/span><span class=\"n\">stat<\/span><span class=\"o\">$<\/span><span class=\"n\">required_aes<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"s1\">'highlight'<\/span><span class=\"p\">)<\/span><span class=\"w\">\n  <\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"p\">}<\/span><span class=\"w\">\n\n<\/span><span class=\"n\">gghl<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">geom<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">LL<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"nf\">list<\/span><span class=\"p\">(<\/span><span class=\"n\">colour<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"kc\">NA<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n  <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">...<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n    <\/span><span class=\"nf\">list<\/span><span class=\"p\">(<\/span><span class=\"n\">stat<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"nf\">list<\/span><span class=\"p\">(<\/span><span class=\"w\">\n      <\/span><span class=\"n\">ggproto_ll<\/span><span class=\"p\">(<\/span><span class=\"n\">geom<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">LL<\/span><span class=\"p\">),<\/span><span class=\"w\">\n      <\/span><span class=\"n\">ggproto_hl<\/span><span class=\"p\">(<\/span><span class=\"n\">geom<\/span><span class=\"p\">)<\/span><span class=\"w\">\n    <\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n      <\/span><span class=\"n\">purrr<\/span><span class=\"o\">::<\/span><span class=\"n\">pmap<\/span><span class=\"p\">(<\/span><span class=\"n\">geom<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">...<\/span><span class=\"p\">)<\/span><span class=\"w\">\n  <\/span><span class=\"p\">}<\/span><span class=\"w\">\n<\/span><span class=\"p\">}<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n"],"body":["昨日の記事の続編ですが、昨日の記事のことは忘れていいです。\n\n# gghighlightについて\n\nグラフ作りにおいて、必要な情報だけを色付けてくれるパッケージ(yutannihilation氏作)\nhttp://notchained.hatenablog.com/entry/2017/09/29/212444\n\n```r\nlibrary(ggplot2)\nlibrary(gghighlight)\n\ngghighlight_point(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species), Species == 'setosa', use_direct_label = FALSE)\n```\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/8ceab87b-e174-9672-ba9d-23102167d176.png)\n\n\nただし、\n\n    - 限られたgeomにしか使えない\n    - highlightはaesthenticsになっていない\n\nといった課題がある。\n前者についてはggplot_add()の登場によって解決できる見通しっぽい。\nhttps://yutani.rbind.io/post/2017-11-07-ggplot-add/\n\nでも実は既にあるggplot2の実装で両方解決できるんじゃね？\nと思ったので試してみました。\n\nだいたいのgeomに対応できました。\n多分geom_smooth以外。\ngeom_quantileはいけた。\n\n以下はggprotoの知識が必要です。\nyutannihilation氏のExtending ggplot2（和訳）を理解して下さい。\nhttps://qiita.com/yutannihilation/items/f30baef75a0ac02bb2f0\n\n# 練習\n\n## 散布図のhighlight(hl)したい点だけを描写するgeom_point_hlを作ってみる。\n\nggplotでは、与えられたデータに対して、様々な演算を行っています。\n例えばgeom_boxplotではデータに対して、分位点や外れ値を計算し、使いやすいデータに整形した上で、プロットしています。\n計算の仕方はgeom_*(stat = 'hogehoge')というstat引数で指定されています(geom_pointなら'identity', geom_boxplotなら'boxplot)。\nこの使いやすいデータに整形というところがミソで、オリジナルの計算方法を定義し、statに指定すれば、いらないデータを削ることが可能です。\n\nでは散布図の審美的属性(aethentics; aes)にhighlightを追加して、highlightにTRUEが指定されている値のみをプロットするようにしてみましょう。\n\n```r\n# 計算方法を定義\n# ggprotoによるStatの作成\nStatPointHL <- ggproto(\n  'StatPointHL', #新しいstatのクラス名\n  Stat, #継承したいggprotoオブジェクト\n  compute_group = #グループごとに必要な情報以外を消す\n    function(data, ...) data[data$highlight, ],\n  required_aes = c('x', 'y', 'highlight') #審美的属性には散布図に必要なxとy以外に、強調したいデータかをTRUE/FALSEで示すhighlightを追加\n)\n\n# geom_point_hlを作成\ngeom_point_hl <- geom_point # geom_pointをコピーして\nformals(geom_point_hl)$stat <- StatPointHL #stat引数を上書き\n\n# プロットしてみる\nggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species, highlight = Species == 'setosa')) +\n  geom_point_hl()\n\n```\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/47df883c-c340-59df-28ae-87284a7de762.png)\n\nirisのsetosa種についてのみのプロットが得られました。\n\n## boxplotについてhighlightしたいものだけ描写する\n\nさて、実際にはboxplotなどでは複雑な計算が行われているのは既知の通り。\nということは、StatBoxplotHLを作ろうとすると、compute_groupで、データのフィルタリングと演算両方を定義しなければなりません。\nこれはコードが長くなりかねない…………!\nというか、既に演算方法については決めてあるので、これをコピペするのも愚かです。\n例えばStatBoxplotのcompute_groupはStatBoxplot$compute_groupで取り出すことができます。\n\n```r\nStatBoxplot$compute_group\n```\n\nそれなら、適宜削ったデータを、親のcompute_groupに渡せばOKですね。\n\n```r\nfunction(data, ...) StatBoxplot$compute_group(data = data[data$highlight, ], ...)\n```\n\n実際にはcompute_layerやcompute_panelも使われることがあるはずなので、これらもついでにwrapしましょう。\n先の例ではgeom_point_hlを作りましたが、実際には、stat引数を調整するだけでいいので、その場限りの利用であれば、geom_boxplot_hlを作る必要はありません。\n\n```r\n#計算方法の定義\nStatBoxplotHL <- ggproto(\n  'StatBoxplotHL', #新しいstatのクラス名\n  StatBoxplot, #継承したいggprotoオブジェクト\n  compute_group = #グループごとに必要な情報以外を消す\n    function(data, ...) StatBoxplot$compute_group(data = data[data$highlight, ], ...),\n  compute_layer = #レイヤに必要な情報以外を消す\n    function(data, ...) StatBoxplot$compute_layer(data = data[data$highlight, ], ...),\n  compute_panel = #パネルに必要な情報以外を消す\n    function(data, ...) StatBoxplot$compute_panel(data = data[data$highlight, ], ...),\n  required_aes = c('x', 'y', 'highlight') #審美的属性には散布図に必要なxとy以外に、強調したいデータかをTRUE/FALSEで示すhighlightを追加\n)\n\n#使用例\nggplot(iris, aes(x = Species, y = Sepal.Width, highlight = Species == 'setosa')) +\n  geom_boxplot(stat = StatBoxplotHL)\n\n```\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/5b4947fe-0ea8-27c1-506f-8bbbe93492d0.png)\n\n#実装\n\n## 任意のgeom_についてhighlightしたいものだけ描写する\n\nどんどん汎用的にしていきましょう。\n\nあるgeom_についてハイライト版を作りたいとき、イチイチ継承する計算方法(Stat)を調べるのは面倒です。\n各geomが指定しているstat引数から、継承相手を探してきましょう。\nそれにはggplot2:::find_subclassを使います。\n\n```r\nggplot2:::find_subclass(\"Stat\", 'boxplot', parent.frame())\n\n# [Show in New Window] [Clear Output] [Expand/Collapse Output]\n# \n# <ggproto object: Class StatBoxplot, Stat>\n#     aesthetics: function\n#     compute_group: function\n#     compute_layer: function\n#     compute_panel: function\n#     default_aes: uneval\n#     extra_params: na.rm\n#     finish_layer: function\n#     non_missing_aes: weight\n#     parameters: function\n#     required_aes: x y\n#     retransform: TRUE\n#     setup_data: function\n#     setup_params: function\n#     super:  <ggproto object: Class Stat>\n```\n\nこれを利用して任意のgeomからStatを探してくる関数\nfind_stat_from_geomを定義します。\n\n```r\n#関数定義\nfind_stat_from_geom <- function(geom) {\n  ggplot2:::find_subclass(\"Stat\", formals(geom)$stat, parent.frame())\n}\n\n#仕様例\nfind_stat_from_geom(geom_point)\n\n# [Show in New Window] [Clear Output] [Expand/Collapse Output]\n# \n# <ggproto object: Class StatIdentity, Stat>\n#     aesthetics: function\n#     compute_group: function\n#     compute_layer: function\n#     compute_panel: function\n#     default_aes: uneval\n#     extra_params: na.rm\n#     finish_layer: function\n#     non_missing_aes: \n#     parameters: function\n#     required_aes: \n#     retransform: TRUE\n#     setup_data: function\n#     setup_params: function\n#     super:  <ggproto object: Class Stat>\n```\n\nこれを使うと任意のgeomに用いられるStatについてHL版を作成できます。\nこの時、任意のStatから、指定したMethod(compute_groupなど)を取り出し、必要なデータのみを渡すようにwrapする関数function_hlも定義しておきます。\n\n```r\n#compute_group, layer, panelのラッパー\nfunction_hl <- function(nm, stat) {\n  function(data, ...) stat[[nm]](data = data[data$highlight, ], ...)\n}\n\n#ハイライトするデータだけを表示するようにしてくれるggprotoオブジェクト(Stat)を返す関数\nggproto_hl <- function(geom) {\n  stat <- find_stat_from_geom(geom)\n  ggplot2::ggproto(\n    paste0(class(stat)[1], 'HL'),\n    stat,\n    compute_group = function_hl('compute_group', stat),\n    compute_layer = function_hl('compute_layer', stat),\n    compute_panel = function_hl('compute_panel', stat),\n    required_aes = c(stat$required_aes, 'highlight')\n  )\n}\n\n#使用例\n\nggplot(iris, aes(x = Sepal.Length, color = Species, highlight = Species == 'setosa')) +\n  geom_density(stat = ggproto_hl(geom_density))\n\n```\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/9dd48166-8ea3-7a01-5993-32e3b84bb060.png)\n\n\n## 任意のgeom_についてlowlightしたいものだけ描写し、地味にする\n\nでは、同様にggproto_llを定義しましょう。\nこの時、function_hlとggproto_hlに対応するfunction_ll、ggproto_llでは、表示するデータの見た目をhighlightするデータより地味に見せるため、見た目を変化させる引数Ｌを追加します。\nここではcolour = NAにしてみました。\nscale_colour_*のna.values引数の値が採用されます(既定値: gray50)\n\n```r\n#compute_group, layer, panelのラッパー\nfunction_ll <- function(nm, stat, LL) {\n  function(data, ...) {\n    data <- data[!data$highlight, ]\n    data[names(LL)] <- LL #lowlightするデータの見た目を変更\n    stat[[nm]](data = data, ...)\n  }\n}\n\n#ハイライトするデータだけを表示するようにしてくれるggprotoオブジェクト(Stat)を返す関数\nggproto_ll <- function(geom, LL = list(colour = NA)) {\n  stat <- find_stat_from_geom(geom)\n  ggplot2::ggproto(\n    paste0(class(stat)[1], 'HL'),\n    stat,\n    compute_group = function_ll('compute_group', stat, LL),\n    compute_layer = function_ll('compute_layer', stat, LL),\n    compute_panel = function_ll('compute_panel', stat, LL),\n    required_aes = c(stat$required_aes, 'highlight')\n  )\n}\n\n#data[names(LL)] <- LLをコメントアウトしないと動きません\nggplot(iris, aes(x = Sepal.Length, color = Species, highlight = Species == 'setosa')) +\n  geom_density(stat = ggproto_ll(geom_density))\n\n```\n\nただし、このコードを実行すると、\nError in seq.default(h[1], h[2], length.out = n) : 'to' must be a finite number\nというエラーが返ってしまいます。\n\nこれはcolour属性を指定しているくせに全部NAなのが原因です。\nLL = list(colour = 'else')\nとすると動きます。\n\n```r\nggplot(iris, aes(x = Sepal.Length, color = Species, highlight = Species == 'setosa')) +\n  geom_density(stat = ggproto_ll(geom_density, LL = list(colour = 'else')))\n```\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/b58011ab-a854-8e3a-a37d-48945268adf1.png)\n\n\nまた、colourがちゃんと指定できるlayerと重なっていれば、LL = list(colour = NA)でもOKです。\n\n```r\nggplot(iris, aes(x = Sepal.Length, color = Species, highlight = Species == 'setosa')) +\n  geom_density() +\n  geom_density(stat = ggproto_ll(geom_density))\n```\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/1d235ab6-11e4-8a20-5b62-dfb7fe4fed9f.png)\n\nこの例では、lowlightした灰色の線が緑と青の線に重なっているため、結果的に、highlightすべきsetosaが目立っています。\n\n## highlight == TRUEなデータはhighlightし、そうでないデータはlowlightする\n\nggproto_hlとggproto_llを組み合わせると、gghighlightのような挙動が実現できます。\n\n```r\nggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species, highlight = Species == 'setosa')) +\n  geom_point(stat = ggproto_ll(geom_point)) +\n  geom_point(stat = ggproto_hl(geom_point))\n```\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/10d9bd86-fcfc-edb0-8c67-243c757c939b.png)\n\nですが、誰もこんな冗長な書き方はしたくないと思います。\n\n## 任意のgeomに対しhighlight版geomを返す高階関数を定義\n\nしました!\nやっていることは2つのレイヤ(LLとHL)の重ね合わせですからpurrr::pmapを使って、geomのstatだけを自動指定しましょう。\n高階関数なので、返ってきた関数に引数を与えることで、shapeやsizeを調整可能です。\n\n```r\nlibrary(purrr)\n\n#高階関数定義\ngghl <- function(geom, LL = list(colour = NA)) {\n  function(...) {\n    list(stat = list(\n      ggproto_ll(geom, LL),\n      ggproto_hl(geom)\n    )) %>%\n      purrr::pmap(geom, ...)\n  }\n}\n\n#使用例\nggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species, highlight = Species == 'setosa')) + \n  gghl(geom_point, LL = list(colour = NA, size = 1))(aes(size = 10)) +\n  scale_size_identity()\n```\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/0b0c0dfb-bdcd-d9d7-59de-a043ce2be873.png)\n\n繰り返し使うものを定義するのもOK\n\n```r\ngeom_density_hl <- gghl(geom_density)\nggplot(iris, aes(x = Sepal.Width, color = Species, highlight = Species == 'setosa')) +\n  geom_density_hl()\n```\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/26d611d1-ca8d-764c-bf9e-722152d7649f.png)\n\nこれで、代替のgeomに対応できたはずですが、geom_smoothだけはうまくいっていません。\n\n```r\nggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species, highlight = Species == 'setosa')) +\n  gghl(geom_smooth)()\n\n# Computation failed in `stat_smooth()`: object 'auto' of mode 'function' was not found\n# Computation failed in `stat_smooth()`: object 'auto' of mode 'function' was not found\n```\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/985570ab-c324-4e3b-0bf3-a99030e08579.png)\n\ngeom_quantileはうまくいきます\n\n```r\nggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species, highlight = Species == 'setosa')) +\n  gghl(geom_point)() +\n  gghl(geom_quantile)()\n```\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/0ab93578-3254-1c75-aa70-44b8924c8f19.png)\n\n# 補足\n\nこれまでaes(highlight = hoge == fuga)という形でhighlightを指定していましたが、勿論、data.frameにhighlightするか決める論理値の列を入れてもOKです。\n\n```r\niris$hl <- iris$Species == 'setosa'\nggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species, highlight = hl)) +\n  gghl(geom_point, LL = list(colour = NA, alpha = 0.3))()\n```\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/52531fa7-306d-96dd-2295-50af0b55cbe9.png)\n\n\n#完成版\n\n説明は上ですでにしています\n現在geom_smoothと格闘中\n\n```r\nfunction_hl <- function(nm, stat) {\n  function(data, ...) stat[[nm]](data = data[data$highlight, ], ...)\n}\n\nggproto_hl <- function(geom) {\n  stat <- ggplot2:::find_subclass(\"Stat\", formals(geom)$stat, parent.frame())\n  ggplot2::ggproto(\n    paste0(class(stat)[1], 'HL'),\n    stat,\n    compute_group = function_hl('compute_group', stat),\n    compute_layer = function_hl('compute_layer', stat),\n    compute_panel = function_hl('compute_panel', stat),\n    required_aes = c(stat$required_aes, 'highlight')\n  )\n}\n\nfunction_ll <- function(nm, stat, LL) {\n  function(data, ...) {\n    data <- data[!data$highlight, ]\n    data[names(LL)] <- LL\n    stat[[nm]](data = data, ...)\n  }\n}\n\n\nggproto_ll <- function(geom, LL = list(colour = NA)) {\n  stat <- ggplot2:::find_subclass(\"Stat\", formals(geom)$stat, parent.frame())\n  ggplot2::ggproto(\n    paste0(class(stat)[1], 'HL'),\n    stat,\n    compute_group = function_ll('compute_group', stat, LL),\n    compute_layer = function_ll('compute_layer', stat, LL),\n    compute_panel = function_ll('compute_panel', stat, LL),\n    required_aes = c(stat$required_aes, 'highlight')\n  )\n}\n\ngghl <- function(geom, LL = list(colour = NA)) {\n  function(...) {\n    list(stat = list(\n      ggproto_ll(geom, LL),\n      ggproto_hl(geom)\n    )) %>%\n      purrr::pmap(geom, ...)\n  }\n}\n```\n"],"coediting":[false],"comments_count":[0],"created_at":["2018-01-29T14:01:03+09:00"],"group":{},"id":["8cf30d10821ec83d696d"],"likes_count":[0],"private":[false],"reactions_count":[0],"tags":[{"name":["R"],"versions":[]},{"name":["ggplot2"],"versions":[]}],"title":["gghighlight汎用化2"],"updated_at":["2018-01-29T14:58:43+09:00"],"url":["https://qiita.com/Atsushi776/items/8cf30d10821ec83d696d"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["\n<h2>\n<span id=\"gghighlightについて\" class=\"fragment\"><\/span><a href=\"#gghighlight%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\"><i class=\"fa fa-link\"><\/i><\/a>gghighlightについて<\/h2>\n\n<p>グラフ作りにおいて、必要な情報だけを色付けてくれるパッケージ(yutannihilation氏作)<br>\n<a href=\"http://notchained.hatenablog.com/entry/2017/09/29/212444\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\">http://notchained.hatenablog.com/entry/2017/09/29/212444<\/a><\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">gghighlight_point<\/span><span class=\"p\">(<\/span><span class=\"n\">iris<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Length<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Width<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"p\">),<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"w\"> <\/span><span class=\"o\">==<\/span><span class=\"w\"> <\/span><span class=\"s1\">'setosa'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">use_direct_label<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"kc\">FALSE<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F8ceab87b-e174-9672-ba9d-23102167d176.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=abdbc4a04e35524735fd9740beed7149\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F8ceab87b-e174-9672-ba9d-23102167d176.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=abdbc4a04e35524735fd9740beed7149\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/8ceab87b-e174-9672-ba9d-23102167d176.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F8ceab87b-e174-9672-ba9d-23102167d176.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=08383629b64d4c88f5b0fe9218d6d312 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>ただし、<\/p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>- 限られたgeomにしか使えない\n- highlightはaesthenticsになっていない\n<\/pre><\/div><\/div>\n\n<p>といった課題がある。<br>\n前者についてはggplot_add()の登場によって解決できる見通しっぽい。<br>\n<a href=\"https://yutani.rbind.io/post/2017-11-07-ggplot-add/\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\">https://yutani.rbind.io/post/2017-11-07-ggplot-add/<\/a><\/p>\n\n<p>でも実は既にあるggplot2の実装でできるんじゃね？<br>\nと思ったので試してみました。<\/p>\n\n<p>ただ、結局、実用的なのは一部のgeomのみです(boxplotやdensityなどstatで計算を行うものは不可).<br>\ngeom_point, geom_lineに加え、geom_rect, ribbon, areaなどはいけることを確認しました。<\/p>\n\n<h1>\n<span id=\"highlightする関数を返す高階関数\" class=\"fragment\"><\/span><a href=\"#highlight%E3%81%99%E3%82%8B%E9%96%A2%E6%95%B0%E3%82%92%E8%BF%94%E3%81%99%E9%AB%98%E9%9A%8E%E9%96%A2%E6%95%B0\"><i class=\"fa fa-link\"><\/i><\/a>highlightする関数を返す高階関数<\/h1>\n\n<p>.geomにはggplot2::GeomPointなどのGeom*オブジェクトを指定します。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">library<\/span><span class=\"p\">(<\/span><span class=\"n\">ggplot2<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"n\">library<\/span><span class=\"p\">(<\/span><span class=\"n\">purrr<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"n\">library<\/span><span class=\"p\">(<\/span><span class=\"n\">stringr<\/span><span class=\"p\">)<\/span><span class=\"w\">\n\n<\/span><span class=\"n\">gghl<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">.geom<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">LL<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"nf\">list<\/span><span class=\"p\">(<\/span><span class=\"n\">colour<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"kc\">NA<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n  <\/span><span class=\"c1\">#.geom Geom objects (e.g., ggplot2::GeomPoint)<\/span><span class=\"w\">\n  <\/span><span class=\"c1\"># LL default aethentics for lowlights<\/span><span class=\"w\">\n  <\/span><span class=\"n\">Stats<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"nf\">substitute<\/span><span class=\"p\">(<\/span><span class=\"n\">.geom<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\"> <\/span><span class=\"c1\"># Generate Stat for lowlight and highlight<\/span><span class=\"w\">\n      <\/span><span class=\"n\">deparse<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n      <\/span><span class=\"n\">stringr<\/span><span class=\"o\">::<\/span><span class=\"n\">str_replace<\/span><span class=\"p\">(<\/span><span class=\"s1\">'(.*::)?Geom'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"s1\">'Stat'<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\"> \n      <\/span><span class=\"n\">paste0<\/span><span class=\"p\">(<\/span><span class=\"nf\">c<\/span><span class=\"p\">(<\/span><span class=\"s1\">'LL'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"s1\">'HL'<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\"> <\/span><span class=\"c1\"># _class LL = lowlight HL = highlight<\/span><span class=\"w\">\n      <\/span><span class=\"nf\">list<\/span><span class=\"p\">(<\/span><span class=\"nf\">c<\/span><span class=\"p\">(<\/span><span class=\"w\"> <\/span><span class=\"c1\"># compute_group<\/span><span class=\"w\">\n        <\/span><span class=\"n\">LL<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">data<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">scales<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n          <\/span><span class=\"n\">data<\/span><span class=\"p\">[<\/span><span class=\"nf\">names<\/span><span class=\"p\">(<\/span><span class=\"n\">LL<\/span><span class=\"p\">)]<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">LL<\/span><span class=\"w\">\n          <\/span><span class=\"n\">as.data.frame<\/span><span class=\"p\">(<\/span><span class=\"n\">data<\/span><span class=\"p\">)[<\/span><span class=\"o\">!<\/span><span class=\"nf\">as.logical<\/span><span class=\"p\">(<\/span><span class=\"n\">data<\/span><span class=\"o\">$<\/span><span class=\"n\">highlight<\/span><span class=\"p\">),<\/span><span class=\"w\"> <\/span><span class=\"p\">]<\/span><span class=\"w\">\n        <\/span><span class=\"p\">},<\/span><span class=\"w\">\n        <\/span><span class=\"n\">HL<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">data<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">scales<\/span><span class=\"p\">)<\/span><span class=\"w\">\n          <\/span><span class=\"n\">data<\/span><span class=\"p\">[<\/span><span class=\"nf\">as.logical<\/span><span class=\"p\">(<\/span><span class=\"n\">data<\/span><span class=\"o\">$<\/span><span class=\"n\">highlight<\/span><span class=\"p\">),<\/span><span class=\"w\"> <\/span><span class=\"p\">]<\/span><span class=\"w\">\n      <\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n      <\/span><span class=\"n\">setNames<\/span><span class=\"p\">(<\/span><span class=\"nf\">c<\/span><span class=\"p\">(<\/span><span class=\"s1\">'_class'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"s1\">'compute_group'<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n      <\/span><span class=\"n\">purrr<\/span><span class=\"o\">::<\/span><span class=\"n\">pmap<\/span><span class=\"p\">(<\/span><span class=\"w\">\n        <\/span><span class=\"n\">ggplot2<\/span><span class=\"o\">::<\/span><span class=\"n\">ggproto<\/span><span class=\"p\">,<\/span><span class=\"w\">\n        <\/span><span class=\"n\">`_inherit`<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">ggplot2<\/span><span class=\"o\">::<\/span><span class=\"n\">Stat<\/span><span class=\"p\">,<\/span><span class=\"w\">\n        <\/span><span class=\"n\">required_aes<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"nf\">c<\/span><span class=\"p\">(<\/span><span class=\"n\">.geom<\/span><span class=\"o\">$<\/span><span class=\"n\">required_aes<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"s1\">'highlight'<\/span><span class=\"p\">)<\/span><span class=\"w\">\n      <\/span><span class=\"p\">)<\/span><span class=\"w\">\n\n  <\/span><span class=\"c1\">#return stat_ function for highlighjting<\/span><span class=\"w\">\n  <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"w\">\n    <\/span><span class=\"n\">mapping<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"kc\">NULL<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">data<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"kc\">NULL<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">geom<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">.geom<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">position<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"s2\">\"identity\"<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">na.rm<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"kc\">FALSE<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">show.legend<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"kc\">NA<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">inherit.aes<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"kc\">TRUE<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">...<\/span><span class=\"p\">,<\/span><span class=\"w\">\n    <\/span><span class=\"n\">.Stats<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Stats<\/span><span class=\"w\">\n  <\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n    <\/span><span class=\"n\">purrr<\/span><span class=\"o\">::<\/span><span class=\"n\">map<\/span><span class=\"p\">(<\/span><span class=\"w\">\n      <\/span><span class=\"n\">.Stats<\/span><span class=\"p\">,<\/span><span class=\"w\">\n      <\/span><span class=\"n\">ggplot2<\/span><span class=\"o\">::<\/span><span class=\"n\">layer<\/span><span class=\"p\">,<\/span><span class=\"w\">\n      <\/span><span class=\"n\">data<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">data<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">mapping<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">mapping<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">geom<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">geom<\/span><span class=\"p\">,<\/span><span class=\"w\">\n      <\/span><span class=\"n\">position<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">position<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">show.legend<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">show.legend<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">inherit.aes<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">inherit.aes<\/span><span class=\"p\">,<\/span><span class=\"w\">\n      <\/span><span class=\"n\">params<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"nf\">list<\/span><span class=\"p\">(<\/span><span class=\"n\">na.rm<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">na.rm<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">...<\/span><span class=\"p\">)<\/span><span class=\"w\">\n    <\/span><span class=\"p\">)<\/span><span class=\"w\">\n  <\/span><span class=\"p\">}<\/span><span class=\"w\">\n<\/span><span class=\"p\">}<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<h1>\n<span id=\"使用例\" class=\"fragment\"><\/span><a href=\"#%E4%BD%BF%E7%94%A8%E4%BE%8B\"><i class=\"fa fa-link\"><\/i><\/a>使用例<\/h1>\n\n<p>デフォルトではhighlightしないデータの色をNAにします。<br>\nそれらはggplot2::scale_colour_dicreteなどscale_color*系のna.valuesに指定された色でプロットされます(既定値はgray50)<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">g<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"n\">iris<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Length<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Width<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">highlight<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"w\"> <\/span><span class=\"o\">==<\/span><span class=\"w\"> <\/span><span class=\"s1\">'setosa'<\/span><span class=\"p\">))<\/span><span class=\"w\">\n<\/span><span class=\"n\">g<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\"> <\/span><span class=\"n\">gghl<\/span><span class=\"p\">(<\/span><span class=\"n\">ggplot2<\/span><span class=\"o\">::<\/span><span class=\"n\">GeomPoint<\/span><span class=\"p\">)()<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F534a977b-4733-e4d2-e57b-5ce19bd46409.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=d6856c08670464d673ceb9fa29c2d9ce\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F534a977b-4733-e4d2-e57b-5ce19bd46409.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=d6856c08670464d673ceb9fa29c2d9ce\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/534a977b-4733-e4d2-e57b-5ce19bd46409.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F534a977b-4733-e4d2-e57b-5ce19bd46409.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=116d183ce242bfb927e19b8b878649fb 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>他に<\/p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>- 引数LL(lowlightの略)にalphaやfillを指定して、highlightしないデータの見た目を変える\n- 任意のstat_highlight_*を作成する\n<\/pre><\/div><\/div>\n\n<p>といったことが可能です<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"w\">\n<\/span><span class=\"n\">stat_highlight_boxplot<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">gghl<\/span><span class=\"p\">(<\/span><span class=\"n\">ggplot2<\/span><span class=\"o\">::<\/span><span class=\"n\">GeomBoxplot<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">LL<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"nf\">list<\/span><span class=\"p\">(<\/span><span class=\"n\">alpha<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">0.3<\/span><span class=\"p\">))<\/span><span class=\"w\">\n<\/span><span class=\"n\">g<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\"> <\/span><span class=\"n\">stat_highlight_point<\/span><span class=\"p\">()<\/span><span class=\"w\">\n\n<\/span><\/pre><\/div><\/div>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F66bac346-5918-07d7-b85d-14a8c25080c4.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=f985ce8dcf90acbda05fb7de3a18cbdf\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F66bac346-5918-07d7-b85d-14a8c25080c4.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=f985ce8dcf90acbda05fb7de3a18cbdf\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/66bac346-5918-07d7-b85d-14a8c25080c4.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F66bac346-5918-07d7-b85d-14a8c25080c4.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=4cffa9e395be987d2aab0774fab662f5 1x\" loading=\"lazy\"><\/a><\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">geom_highlight_rect<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">gghl<\/span><span class=\"p\">(<\/span><span class=\"n\">GeomRect<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">LL<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"nf\">list<\/span><span class=\"p\">(<\/span><span class=\"n\">fill<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">0<\/span><span class=\"p\">))<\/span><span class=\"w\">\n<\/span><span class=\"n\">df<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">data.frame<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">sample.int<\/span><span class=\"p\">(<\/span><span class=\"m\">10<\/span><span class=\"p\">),<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">sample.int<\/span><span class=\"p\">(<\/span><span class=\"m\">10<\/span><span class=\"p\">),<\/span><span class=\"w\"> <\/span><span class=\"n\">w<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">z<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">sample.int<\/span><span class=\"p\">(<\/span><span class=\"m\">10<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"m\">10<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">replace<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"kc\">TRUE<\/span><span class=\"p\">))<\/span><span class=\"w\">\n<\/span><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"w\">\n  <\/span><span class=\"n\">df<\/span><span class=\"p\">,<\/span><span class=\"w\"> \n  <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">xmin<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">-<\/span><span class=\"w\"> <\/span><span class=\"n\">w<\/span><span class=\"w\"> <\/span><span class=\"o\">/<\/span><span class=\"w\"> <\/span><span class=\"m\">2<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">xmax<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\"> <\/span><span class=\"n\">w<\/span><span class=\"w\"> <\/span><span class=\"o\">/<\/span><span class=\"w\"> <\/span><span class=\"m\">2<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">ymin<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">ymax<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">fill<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">z<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">highlight<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">z<\/span><span class=\"w\"> <\/span><span class=\"o\">&gt;<\/span><span class=\"w\"> <\/span><span class=\"m\">5<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_highlight_rect<\/span><span class=\"p\">()<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_text<\/span><span class=\"p\">(<\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">x<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">label<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">z<\/span><span class=\"p\">),<\/span><span class=\"w\"> <\/span><span class=\"n\">vjust<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">scale_fill_gradient2<\/span><span class=\"p\">()<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F04022578-96fe-2fa1-3cf3-28630c2a89c2.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=b87a7d2d50a93228e876d895f645e783\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F04022578-96fe-2fa1-3cf3-28630c2a89c2.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=b87a7d2d50a93228e876d895f645e783\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/04022578-96fe-2fa1-3cf3-28630c2a89c2.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F04022578-96fe-2fa1-3cf3-28630c2a89c2.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=6e2e50e6346f553c70bc1737bc70d041 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>ただし、現状では、geom_boxplotやgeom_densityなど、データに対して演算を行うgeomには対応していません。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"n\">iris<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Length<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">highlight<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Species<\/span><span class=\"w\"> <\/span><span class=\"o\">==<\/span><span class=\"w\"> <\/span><span class=\"s1\">'setosa'<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">gghl<\/span><span class=\"p\">(<\/span><span class=\"n\">GeomBoxplot<\/span><span class=\"p\">)()<\/span><span class=\"w\">\n<\/span><span class=\"c1\"># Error: stat_boxplot_ll requires the following missing aesthetics: lower, upper, middle, ymin, ymax<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n"],"body":["## gghighlightについて\n\nグラフ作りにおいて、必要な情報だけを色付けてくれるパッケージ(yutannihilation氏作)\nhttp://notchained.hatenablog.com/entry/2017/09/29/212444\n\n```r\ngghighlight_point(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species), Species == 'setosa', use_direct_label = FALSE)\n```\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/8ceab87b-e174-9672-ba9d-23102167d176.png)\n\n\nただし、\n\n    - 限られたgeomにしか使えない\n    - highlightはaesthenticsになっていない\n\nといった課題がある。\n前者についてはggplot_add()の登場によって解決できる見通しっぽい。\nhttps://yutani.rbind.io/post/2017-11-07-ggplot-add/\n\nでも実は既にあるggplot2の実装でできるんじゃね？\nと思ったので試してみました。\n\nただ、結局、実用的なのは一部のgeomのみです(boxplotやdensityなどstatで計算を行うものは不可).\ngeom_point, geom_lineに加え、geom_rect, ribbon, areaなどはいけることを確認しました。\n\n# highlightする関数を返す高階関数\n\n.geomにはggplot2::GeomPointなどのGeom*オブジェクトを指定します。\n\n```r\nlibrary(ggplot2)\nlibrary(purrr)\nlibrary(stringr)\n\ngghl <- function(.geom, LL = list(colour = NA)) {\n  #.geom Geom objects (e.g., ggplot2::GeomPoint)\n  # LL default aethentics for lowlights\n  Stats <- substitute(.geom) %>% # Generate Stat for lowlight and highlight\n      deparse %>%\n      stringr::str_replace('(.*::)?Geom', 'Stat') %>% \n      paste0(c('LL', 'HL')) %>% # _class LL = lowlight HL = highlight\n      list(c( # compute_group\n        LL = function(data, scales) {\n          data[names(LL)] <- LL\n          as.data.frame(data)[!as.logical(data$highlight), ]\n        },\n        HL = function(data, scales)\n          data[as.logical(data$highlight), ]\n      )) %>%\n      setNames(c('_class', 'compute_group')) %>%\n      purrr::pmap(\n        ggplot2::ggproto,\n        `_inherit` = ggplot2::Stat,\n        required_aes = c(.geom$required_aes, 'highlight')\n      )\n  \n  #return stat_ function for highlighjting\n  function(\n    mapping = NULL, data = NULL, geom = .geom, position = \"identity\", na.rm = FALSE, show.legend = NA, inherit.aes = TRUE, ...,\n    .Stats = Stats\n  ) {\n    purrr::map(\n      .Stats,\n      ggplot2::layer,\n      data = data, mapping = mapping, geom = geom,\n      position = position, show.legend = show.legend, inherit.aes = inherit.aes,\n      params = list(na.rm = na.rm, ...)\n    )\n  }\n}\n```\n\n# 使用例\n\nデフォルトではhighlightしないデータの色をNAにします。\nそれらはggplot2::scale_colour_dicreteなどscale_color*系のna.valuesに指定された色でプロットされます(既定値はgray50)\n\n```r\ng <- ggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species, highlight = Species == 'setosa'))\ng + gghl(ggplot2::GeomPoint)()\n```\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/534a977b-4733-e4d2-e57b-5ce19bd46409.png)\n\n他に\n\n    - 引数LL(lowlightの略)にalphaやfillを指定して、highlightしないデータの見た目を変える\n    - 任意のstat_highlight_*を作成する\n\nといったことが可能です\n\n```r\n\nstat_highlight_boxplot <- gghl(ggplot2::GeomBoxplot, LL = list(alpha = 0.3))\ng + stat_highlight_point()\n\n```\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/66bac346-5918-07d7-b85d-14a8c25080c4.png)\n\n```r\ngeom_highlight_rect <- gghl(GeomRect, LL = list(fill = 0))\ndf <- data.frame(x = sample.int(10), y = sample.int(10), w = 1, z = sample.int(10, 10, replace = TRUE))\nggplot(\n  df, \n  aes(xmin = x - w / 2, xmax = x + w / 2, ymin = y, ymax = y + 1, fill = z, highlight = z > 5)\n) +\n  geom_highlight_rect() +\n  geom_text(aes(x = x, y = y, label = z), vjust = 1) +\n  scale_fill_gradient2()\n```\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/04022578-96fe-2fa1-3cf3-28630c2a89c2.png)\n\nただし、現状では、geom_boxplotやgeom_densityなど、データに対して演算を行うgeomには対応していません。\n\n```r\nggplot(iris, aes(x = Species, y = Sepal.Length, color = Species, highlight = Species == 'setosa')) +\n  gghl(GeomBoxplot)()\n# Error: stat_boxplot_ll requires the following missing aesthetics: lower, upper, middle, ymin, ymax\n```\n"],"coediting":[false],"comments_count":[0],"created_at":["2018-01-28T17:09:06+09:00"],"group":{},"id":["c7260806a597d4553ef2"],"likes_count":[1],"private":[false],"reactions_count":[0],"tags":[{"name":["R"],"versions":[]},{"name":["ggplot2"],"versions":[]}],"title":["gghighlightを汎用的にしたい(中途半端)"],"updated_at":["2018-01-28T21:07:30+09:00"],"url":["https://qiita.com/Atsushi776/items/c7260806a597d4553ef2"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["<p><a href=\"https://qiita.com/Atsushi776/items/ce12840de6e37f7291f3\" id=\"reference-f4d8ce61dbe715156b32\">先日の投稿<\/a>で紹介した、ポアソン過程の観測値がxの時の期待値λの分布が形状母数x+1, 尺度母数1のガンマ分布に従う性質の応用編。<\/p>\n\n<p>計数データの誤差を推定するため、データがポアソン過程で得られていると仮定して、観測値の信頼区間を求めることにした。<\/p>\n\n<p>Rの場合、簡易的にはpoisson.test()で求めることができるらしい(<a href=\"https://oku.edu.mie-u.ac.jp/%7Eokumura/stat/CI/\" rel=\"nofollow noopener\" target=\"_blank\">奥村先生のページ<\/a>)。<br>\nたとえば観測値が1の時の期待値の95%信頼区間は以下のようにして0.025 - 5.572とされる。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"o\">&gt;<\/span><span class=\"w\"> <\/span><span class=\"n\">poisson.test<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">conf.level<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">0.95<\/span><span class=\"p\">)<\/span><span class=\"w\">\n    <\/span><span class=\"n\">Exact<\/span><span class=\"w\"> <\/span><span class=\"n\">Poisson<\/span><span class=\"w\"> <\/span><span class=\"n\">test<\/span><span class=\"w\">\n\n<\/span><span class=\"n\">data<\/span><span class=\"o\">:<\/span><span class=\"w\">  <\/span><span class=\"m\">1<\/span><span class=\"w\"> <\/span><span class=\"n\">time<\/span><span class=\"w\"> <\/span><span class=\"n\">base<\/span><span class=\"o\">:<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"w\">\n<\/span><span class=\"n\">number<\/span><span class=\"w\"> <\/span><span class=\"n\">of<\/span><span class=\"w\"> <\/span><span class=\"n\">events<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">time<\/span><span class=\"w\"> <\/span><span class=\"n\">base<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">p<\/span><span class=\"o\">-<\/span><span class=\"n\">value<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"w\">\n<\/span><span class=\"n\">alternative<\/span><span class=\"w\"> <\/span><span class=\"n\">hypothesis<\/span><span class=\"o\">:<\/span><span class=\"w\"> <\/span><span class=\"n\">true<\/span><span class=\"w\"> <\/span><span class=\"n\">event<\/span><span class=\"w\"> <\/span><span class=\"n\">rate<\/span><span class=\"w\"> <\/span><span class=\"n\">is<\/span><span class=\"w\"> <\/span><span class=\"n\">not<\/span><span class=\"w\"> <\/span><span class=\"n\">equal<\/span><span class=\"w\"> <\/span><span class=\"n\">to<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"w\">\n<\/span><span class=\"m\">95<\/span><span class=\"w\"> <\/span><span class=\"n\">percent<\/span><span class=\"w\"> <\/span><span class=\"n\">confidence<\/span><span class=\"w\"> <\/span><span class=\"n\">interval<\/span><span class=\"o\">:<\/span><span class=\"w\">\n <\/span><span class=\"m\">0.02531781<\/span><span class=\"w\"> <\/span><span class=\"m\">5.57164339<\/span><span class=\"w\">\n<\/span><span class=\"n\">sample<\/span><span class=\"w\"> <\/span><span class=\"n\">estimates<\/span><span class=\"o\">:<\/span><span class=\"w\">\n<\/span><span class=\"n\">event<\/span><span class=\"w\"> <\/span><span class=\"n\">rate<\/span><span class=\"w\"> \n         <\/span><span class=\"m\">1<\/span><span class=\"w\"> \n<\/span><\/pre><\/div><\/div>\n\n<p>しかし、poisson.test()は複数の観測値に対して信頼区間を計算するようにできていない。<br>\nまた、信頼区間以外にもいろいろ計算していて信頼区間だけを取り出す手間が必要になる。<\/p>\n\n<p>そこで、ポアソン過程の観測値がxの時の期待値λの分布が形状母数x+1, 尺度母数1のガンマ分布に従うことを利用し、qgamma()を用いる。<br>\nqgamma()はガンマ分布の左側p%のquantileを求めてくれる関数。<br>\npoisson.test()内部でも用いられている。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"m\">0<\/span><span class=\"o\">:<\/span><span class=\"m\">10<\/span><span class=\"w\"> <\/span><span class=\"c1\">#観測値<\/span><span class=\"w\">\n<\/span><span class=\"n\">x.L<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">qgamma<\/span><span class=\"p\">(<\/span><span class=\"m\">0.025<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"c1\">#95%信頼区間の下側<\/span><span class=\"w\">\n<\/span><span class=\"n\">x.H<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">qgamma<\/span><span class=\"p\">(<\/span><span class=\"m\">0.975<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"c1\">#95%信頼区間の上側<\/span><span class=\"w\">\n<\/span><span class=\"n\">knitr<\/span><span class=\"o\">::<\/span><span class=\"n\">kable<\/span><span class=\"p\">(<\/span><span class=\"n\">data.frame<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">x.L<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">x.H<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"c1\">#表に出力<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<table>\n<thead>\n<tr>\n<th style=\"text-align: right\">x<\/th>\n<th style=\"text-align: right\">x.L<\/th>\n<th style=\"text-align: right\">x.H<\/th>\n<\/tr>\n<\/thead>\n<tbody>\n<tr>\n<td style=\"text-align: right\">0<\/td>\n<td style=\"text-align: right\">0.0253178<\/td>\n<td style=\"text-align: right\">3.688880<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">0.2422093<\/td>\n<td style=\"text-align: right\">5.571643<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: right\">2<\/td>\n<td style=\"text-align: right\">0.6186721<\/td>\n<td style=\"text-align: right\">7.224688<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: right\">3<\/td>\n<td style=\"text-align: right\">1.0898654<\/td>\n<td style=\"text-align: right\">8.767273<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: right\">4<\/td>\n<td style=\"text-align: right\">1.6234864<\/td>\n<td style=\"text-align: right\">10.241589<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: right\">5<\/td>\n<td style=\"text-align: right\">2.2018943<\/td>\n<td style=\"text-align: right\">11.668332<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: right\">6<\/td>\n<td style=\"text-align: right\">2.8143631<\/td>\n<td style=\"text-align: right\">13.059474<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: right\">7<\/td>\n<td style=\"text-align: right\">3.4538322<\/td>\n<td style=\"text-align: right\">14.422675<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: right\">8<\/td>\n<td style=\"text-align: right\">4.1153731<\/td>\n<td style=\"text-align: right\">15.763189<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: right\">9<\/td>\n<td style=\"text-align: right\">4.7953887<\/td>\n<td style=\"text-align: right\">17.084803<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: right\">10<\/td>\n<td style=\"text-align: right\">5.4911604<\/td>\n<td style=\"text-align: right\">18.390356<\/td>\n<\/tr>\n<\/tbody>\n<\/table>\n\n<p>観測値が0 - 10の場合の95%信頼区間を推定できた!<br>\nと、思いきや、先のpoisson.test(1)の結果<\/p>\n\n<table>\n<thead>\n<tr>\n<th style=\"text-align: right\">x<\/th>\n<th style=\"text-align: right\">x.L<\/th>\n<th style=\"text-align: right\">x.H<\/th>\n<\/tr>\n<\/thead>\n<tbody>\n<tr>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">0.02531781<\/td>\n<td style=\"text-align: right\">5.57164339<\/td>\n<\/tr>\n<\/tbody>\n<\/table>\n\n<p>と比較すると何かおかしい。<br>\npoisson.test()で推定されたx = 1の時のx.Lは、qgamma()で推定されたx = 0の時のx.Lと一致している。<br>\nx.Hは問題ない。<\/p>\n\n<p>どなたか理由ご存知の方いらっしゃれば教えて下さい。<\/p>\n"],"body":["[先日の投稿](https://qiita.com/Atsushi776/items/ce12840de6e37f7291f3)で紹介した、ポアソン過程の観測値がxの時の期待値λの分布が形状母数x+1, 尺度母数1のガンマ分布に従う性質の応用編。\n\n計数データの誤差を推定するため、データがポアソン過程で得られていると仮定して、観測値の信頼区間を求めることにした。\n\nRの場合、簡易的にはpoisson.test()で求めることができるらしい([奥村先生のページ](https://oku.edu.mie-u.ac.jp/~okumura/stat/CI/))。\nたとえば観測値が1の時の期待値の95%信頼区間は以下のようにして0.025 - 5.572とされる。\n\n```r\n> poisson.test(x = 1, conf.level = 0.95)\n\tExact Poisson test\n\ndata:  1 time base: 1\nnumber of events = 1, time base = 1, p-value = 1\nalternative hypothesis: true event rate is not equal to 1\n95 percent confidence interval:\n 0.02531781 5.57164339\nsample estimates:\nevent rate \n         1 \n```\n\nしかし、poisson.test()は複数の観測値に対して信頼区間を計算するようにできていない。\nまた、信頼区間以外にもいろいろ計算していて信頼区間だけを取り出す手間が必要になる。\n\nそこで、ポアソン過程の観測値がxの時の期待値λの分布が形状母数x+1, 尺度母数1のガンマ分布に従うことを利用し、qgamma()を用いる。\nqgamma()はガンマ分布の左側p%のquantileを求めてくれる関数。\npoisson.test()内部でも用いられている。\n\n```r\nx <- 0:10 #観測値\nx.L <- qgamma(0.025, x + 1) #95%信頼区間の下側\nx.H <- qgamma(0.975, x + 1) #95%信頼区間の上側\nknitr::kable(data.frame(x, x.L, x.H)) #表に出力\n```\n\n|  x|       x.L|       x.H|\n|--:|---------:|---------:|\n|  0| 0.0253178|  3.688880|\n|  1| 0.2422093|  5.571643|\n|  2| 0.6186721|  7.224688|\n|  3| 1.0898654|  8.767273|\n|  4| 1.6234864| 10.241589|\n|  5| 2.2018943| 11.668332|\n|  6| 2.8143631| 13.059474|\n|  7| 3.4538322| 14.422675|\n|  8| 4.1153731| 15.763189|\n|  9| 4.7953887| 17.084803|\n| 10| 5.4911604| 18.390356|\n\n観測値が0 - 10の場合の95%信頼区間を推定できた!\nと、思いきや、先のpoisson.test(1)の結果\n\n|  x|       x.L|       x.H|\n|--:|---------:|---------:|\n|1|0.02531781|5.57164339|\n\nと比較すると何かおかしい。\npoisson.test()で推定されたx = 1の時のx.Lは、qgamma()で推定されたx = 0の時のx.Lと一致している。\nx.Hは問題ない。\n\nどなたか理由ご存知の方いらっしゃれば教えて下さい。\n\n"],"coediting":[false],"comments_count":[2],"created_at":["2017-12-27T13:14:26+09:00"],"group":{},"id":["410438de9be3522a231c"],"likes_count":[1],"private":[false],"reactions_count":[0],"tags":[{"name":["R"],"versions":[]},{"name":["統計学"],"versions":[]}],"title":["ポアソン過程で得られた観測値の信頼区間を求めたい"],"updated_at":["2017-12-27T13:16:06+09:00"],"url":["https://qiita.com/Atsushi776/items/410438de9be3522a231c"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["\n<h1>\n<span id=\"って\" class=\"fragment\"><\/span><a href=\"#%E3%81%A3%E3%81%A6\"><i class=\"fa fa-link\"><\/i><\/a>%&gt;%って？<\/h1>\n\n<p>dplyr(厳密にはmagrittr)というライブラリを導入することで使えるRでパイプラインを実現する中置演算子。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">plot<\/span><span class=\"p\">(<\/span><span class=\"n\">density<\/span><span class=\"p\">(<\/span><span class=\"n\">iris<\/span><span class=\"o\">$<\/span><span class=\"n\">Sepal.Length<\/span><span class=\"p\">))<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>は、<\/p>\n\n<p>「iris(アヤメ)のSepal.Length(萼片長)についてdensityでカーネル密度を計算して、結果をplotする」<\/p>\n\n<p>に相当するが、頭で考える流れとコードの流れが見事に逆であることが分かる。<\/p>\n\n<p>これが%&gt;%を使うと<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">library<\/span><span class=\"p\">(<\/span><span class=\"n\">dplyr<\/span><span class=\"p\">)<\/span><span class=\"w\">\n\n<\/span><span class=\"n\">iris<\/span><span class=\"o\">$<\/span><span class=\"n\">Species<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">density<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">plot<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>と思考と調和的な流れでコーディングでき、%&gt;%でほどよく改行でき、とても読み易くなりデバグも用意になる。。<\/p>\n\n<p>もう少し詳しいところはkilometerさんが先日のTokyo.Rで綺麗に図解してくださったので、<a href=\"https://speakerdeck.com/kilometer/66th-tokyo-dot-r-beginner-session2?slide=16\" rel=\"nofollow noopener\" target=\"_blank\">そちら<\/a>を参照して頂きたい。<\/p>\n\n<h1>\n<span id=\"hoge--returnで便利に\" class=\"fragment\"><\/span><a href=\"#hoge--return%E3%81%A7%E4%BE%BF%E5%88%A9%E3%81%AB\"><i class=\"fa fa-link\"><\/i><\/a>hoge %&gt;% returnで便利に<\/h1>\n\n<p>コーディングしていると<\/p>\n\n<p>この処理をなくしたい!<br>\n処理の順番を変えたい!<\/p>\n\n<p>といったことが往々にして起きる。<br>\n最終行以外はコメントアウトやカットアンドペーストで一発だ。<\/p>\n\n<p>しかし、最終行が対象になると手間が増える。<br>\nたとえば、アヤメデータをフィルタリングするため<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">iris<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\"> \n  <\/span><span class=\"n\">filter<\/span><span class=\"p\">(<\/span><span class=\"n\">Sepal.Length<\/span><span class=\"w\"> <\/span><span class=\"o\">&gt;<\/span><span class=\"w\"> <\/span><span class=\"m\">5<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\"> <\/span><span class=\"c1\">#萼片長が5以上<\/span><span class=\"w\">\n  <\/span><span class=\"n\">filter<\/span><span class=\"p\">(<\/span><span class=\"n\">Species<\/span><span class=\"w\"> <\/span><span class=\"o\">==<\/span><span class=\"w\"> <\/span><span class=\"s1\">'setosa'<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\"> <\/span><span class=\"c1\">#setosa種<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>とした時、やっぱSpeciesはフィルタリングしなくていいとなると<\/p>\n\n<ol>\n<li>3行目を消す(orコメントアウトする)<\/li>\n<li>2行目の末尾のパイプラインを消す(orコメントアウトする)<\/li>\n<\/ol>\n\n<p>といったステップを踏むことになる(以下)。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">iris<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\"> \n  <\/span><span class=\"n\">filter<\/span><span class=\"p\">(<\/span><span class=\"n\">Sepal.Length<\/span><span class=\"w\"> <\/span><span class=\"o\">&gt;<\/span><span class=\"w\"> <\/span><span class=\"m\">5<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"c1\"># %&gt;% #萼片長が5以上<\/span><span class=\"w\">\n  <\/span><span class=\"c1\"># filter(Species == 'setosa' %&gt;% #setosa種<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>ところが、予めreturnで終わっておくと以下のように3行目をコメントアウトするだけでよい。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">iris<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\"> \n  <\/span><span class=\"n\">filter<\/span><span class=\"p\">(<\/span><span class=\"n\">Sepal.Length<\/span><span class=\"w\"> <\/span><span class=\"o\">&gt;<\/span><span class=\"w\"> <\/span><span class=\"m\">5<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\"> <\/span><span class=\"c1\">#萼片長が5以上<\/span><span class=\"w\">\n  <\/span><span class=\"c1\"># filter(Species == 'setosa' %&gt;% #setosa種<\/span><span class=\"w\">\n  <\/span><span class=\"nf\">return<\/span><span class=\"p\">()<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>3行目をコメントアウトするだけでよい。<\/p>\n\n<p>RStudioユーザーであればCtrl + Shift + Cで行をコメントアウトできるので便利だ。<br>\nしかも適切にインデントしてくれる。<\/p>\n\n<h1>\n<span id=\"hoge--str--returnで更に便利に\" class=\"fragment\"><\/span><a href=\"#hoge--str--return%E3%81%A7%E6%9B%B4%E3%81%AB%E4%BE%BF%E5%88%A9%E3%81%AB\"><i class=\"fa fa-link\"><\/i><\/a>hoge %&gt;% str %&gt;% returnで更に便利に<\/h1>\n\n<p>strを使うと、オブジェクトの構造が分かる。<br>\nデバグに便利。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">iris<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">select<\/span><span class=\"p\">(<\/span><span class=\"o\">-<\/span><span class=\"n\">Species<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">scale<\/span><span class=\"p\">()<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">lm<\/span><span class=\"p\">(<\/span><span class=\"n\">Sepal.Length<\/span><span class=\"w\"> <\/span><span class=\"o\">~<\/span><span class=\"w\"> <\/span><span class=\"n\">.<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">data<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">.<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>は失敗する。<br>\nscaleの返り値がマトリクスで、データフレームではないからだ。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">iris<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">select<\/span><span class=\"p\">(<\/span><span class=\"o\">-<\/span><span class=\"n\">Species<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">scale<\/span><span class=\"p\">()<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">lm<\/span><span class=\"p\">(<\/span><span class=\"n\">Sepal.Length<\/span><span class=\"w\"> <\/span><span class=\"o\">~<\/span><span class=\"w\"> <\/span><span class=\"n\">.<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">data<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">.<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">str<\/span><span class=\"p\">()<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"nf\">return<\/span><span class=\"p\">()<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>としておくと、<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">iris<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">select<\/span><span class=\"p\">(<\/span><span class=\"o\">-<\/span><span class=\"n\">Species<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">scale<\/span><span class=\"p\">()<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"c1\"># lm(Sepal.Length ~ ., data = .) %&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">str<\/span><span class=\"p\">()<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"nf\">return<\/span><span class=\"p\">()<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>任意行をコメントアウトした時の結果の構造を見ることができる。<br>\nそして、あ、scaleの返り値はmatrixなのかと気付くと,<code>as.data.frame %&gt;%<\/code>を挿入して<code>str %&gt;%<\/code>をコメントアウトすればいい。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">iris<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">select<\/span><span class=\"p\">(<\/span><span class=\"o\">-<\/span><span class=\"n\">Species<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">scale<\/span><span class=\"p\">()<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">as.data.frame<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">lm<\/span><span class=\"p\">(<\/span><span class=\"n\">Sepal.Length<\/span><span class=\"w\"> <\/span><span class=\"o\">~<\/span><span class=\"w\"> <\/span><span class=\"n\">.<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">data<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">.<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"c1\"># str() %&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"nf\">return<\/span><span class=\"p\">()<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>この長さのパイプラインでは大したことがないが、長くなればなるほど便利だ。<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">iris<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">select<\/span><span class=\"p\">(<\/span><span class=\"o\">-<\/span><span class=\"n\">Species<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"c1\"># scale() %&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"c1\"># as.data.frame %&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"c1\"># lm(Sepal.Length ~ ., data = .) %&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">str<\/span><span class=\"p\">()<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"nf\">return<\/span><span class=\"p\">()<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>とほとんどをコメントアウトして、うまくいっていることを確認したら一行ずつコメントアウトを取り消し、strを見ることを繰り返して最後にstrをコメントアウトするといったデバグができる。<\/p>\n"],"body":["# %>%って？\n\ndplyr(厳密にはmagrittr)というライブラリを導入することで使えるRでパイプラインを実現する中置演算子。\n\n```r\nplot(density(iris$Sepal.Length))\n```\n\nは、\n\n「iris(アヤメ)のSepal.Length(萼片長)についてdensityでカーネル密度を計算して、結果をplotする」\n\nに相当するが、頭で考える流れとコードの流れが見事に逆であることが分かる。\n\nこれが%>%を使うと\n\n```r\nlibrary(dplyr)\n\niris$Species %>%\n  density %>%\n  plot\n```\n\nと思考と調和的な流れでコーディングでき、%>%でほどよく改行でき、とても読み易くなりデバグも用意になる。。\n\nもう少し詳しいところはkilometerさんが先日のTokyo.Rで綺麗に図解してくださったので、[そちら](https://speakerdeck.com/kilometer/66th-tokyo-dot-r-beginner-session2?slide=16)を参照して頂きたい。\n\n# hoge %>% returnで便利に\n\nコーディングしていると\n\nこの処理をなくしたい!\n処理の順番を変えたい!\n\nといったことが往々にして起きる。\n最終行以外はコメントアウトやカットアンドペーストで一発だ。\n\nしかし、最終行が対象になると手間が増える。\nたとえば、アヤメデータをフィルタリングするため\n\n```r\niris %>% \n  filter(Sepal.Length > 5) %>% #萼片長が5以上\n  filter(Species == 'setosa' %>% #setosa種\n```\n\nとした時、やっぱSpeciesはフィルタリングしなくていいとなると\n\n1. 3行目を消す(orコメントアウトする)\n2. 2行目の末尾のパイプラインを消す(orコメントアウトする)\n\nといったステップを踏むことになる(以下)。\n\n```r\niris %>% \n  filter(Sepal.Length > 5) # %>% #萼片長が5以上\n  # filter(Species == 'setosa' %>% #setosa種\n```\n\nところが、予めreturnで終わっておくと以下のように3行目をコメントアウトするだけでよい。\n\n```r\niris %>% \n  filter(Sepal.Length > 5) %>% #萼片長が5以上\n  # filter(Species == 'setosa' %>% #setosa種\n  return()\n```\n\n3行目をコメントアウトするだけでよい。\n\nRStudioユーザーであればCtrl + Shift + Cで行をコメントアウトできるので便利だ。\nしかも適切にインデントしてくれる。\n\n# hoge %>% str %>% returnで更に便利に\n\nstrを使うと、オブジェクトの構造が分かる。\nデバグに便利。\n\n```r\niris %>%\n  select(-Species) %>%\n  scale() %>%\n  lm(Sepal.Length ~ ., data = .)\n```\n\nは失敗する。\nscaleの返り値がマトリクスで、データフレームではないからだ。\n\n```r\niris %>%\n  select(-Species) %>%\n  scale() %>%\n  lm(Sepal.Length ~ ., data = .) %>%\n  str() %>%\n  return()\n```\n\nとしておくと、\n\n```r\niris %>%\n  select(-Species) %>%\n  scale() %>%\n  # lm(Sepal.Length ~ ., data = .) %>%\n  str() %>%\n  return()\n```\n\n任意行をコメントアウトした時の結果の構造を見ることができる。\nそして、あ、scaleの返り値はmatrixなのかと気付くと,`as.data.frame %>%`を挿入して`str %>%`をコメントアウトすればいい。\n\n```r\niris %>%\n  select(-Species) %>%\n  scale() %>%\n  as.data.frame %>%\n  lm(Sepal.Length ~ ., data = .) %>%\n  # str() %>%\n  return()\n```\n\nこの長さのパイプラインでは大したことがないが、長くなればなるほど便利だ。\n\n```r\niris %>%\n  select(-Species) %>%\n  # scale() %>%\n  # as.data.frame %>%\n  # lm(Sepal.Length ~ ., data = .) %>%\n  str() %>%\n  return()\n```\n\nとほとんどをコメントアウトして、うまくいっていることを確認したら一行ずつコメントアウトを取り消し、strを見ることを繰り返して最後にstrをコメントアウトするといったデバグができる。\n"],"coediting":[false],"comments_count":[0],"created_at":["2017-12-22T14:58:12+09:00"],"group":{},"id":["dc3f6f81e9387d375269"],"likes_count":[5],"private":[false],"reactions_count":[0],"tags":[{"name":["R"],"versions":[]},{"name":["magrittr"],"versions":[]}],"title":["%>%で試行錯誤する時はreturnで終わろう"],"updated_at":["2017-12-22T14:58:12+09:00"],"url":["https://qiita.com/Atsushi776/items/dc3f6f81e9387d375269"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["<p>tidyverseってなんぞ?<\/p>\n\n<p>このところのtidyverseユーザーたちの関心で，<a href=\"https://adventar.org/calendars/2188\" rel=\"nofollow noopener\" target=\"_blank\">Advent Calendar<\/a>にまでなってしまいました．<br>\nそこで私も12/9のAdvent Calendarに登録しました．<br>\n先だっては<a href=\"http://notchained.hatenablog.com/entry/tidyverse\" rel=\"nofollow noopener\" target=\"_blank\">俺たちのtidyverseはこれからだ！ by yutanihilationさん<\/a>やTwitter上で話題になりました．<br>\n話題を取り上げた方々が訳語を知りたいのではなく，実態に迫りたいのだろうことは想像にかたくありません．<br>\nそして「<a href=\"http://notchained.hatenablog.com/entry/2017/10/26/203205\" rel=\"nofollow noopener\" target=\"_blank\">もうtidyの訳語はtidyでよくない？ by yutanihilationさん<\/a>」といった事態に．<\/p>\n\n<p>こんなに話題になるのは，tidyverseが発展途上ながら，実用的だからでしょう．<br>\n加えて，tidy data(<a href=\"https://speakerdeck.com/fnshr/zheng-ran-detatutenani\" rel=\"nofollow noopener\" target=\"_blank\">整然データってなに？ by Nishiharaさん<\/a>)とtidyverseは等価ではない(tidyverseにtidy dataは含まれる包含関係？)ことが，混乱を招きます．<\/p>\n\n<p>で，tidyverseとはなにかを考える時，みなさんtidyに注目しがちですが，verseに注目してみました．<\/p>\n\n<p>universe(宇宙)やmultiverse(多元的宇宙)という言葉があることから，tidyvereはtidyな世界とか宇宙とか環境とかそういった意味合いだろうと皆さん念頭に置いている気がします．<br>\nしかし，verseの訳語を英辞郎で調べると<\/p>\n\n<ul>\n<li>(動) 〔散文を〕韻文に作り替える<\/li>\n<li>(名) 〔ある形式の〕詩◆無韻詩（blank verse）や自由詩（free verse）などがある。<\/li>\n<\/ul>\n\n<p>といった説明が出てきます．<br>\nということは<\/p>\n\n<p>tidyverse == tidy詩 == tidyポエム？!<\/p>\n\n<p>なんということでしょう．<br>\n我々のAdvent Calendarもtidyverseなのです．<\/p>\n\n<p>さて，ここでもう一つ重要なのが，動詞としてのverseで\"韻文に作り替える\"です．<br>\nもうお分かりですよね．<br>\nみなさん大好きパイプ演算子で韻を踏もうということです．<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\">\n<div class=\"code-lang\"><span class=\"bold\">散文<\/span><\/div>\n<div class=\"highlight\"><pre><span class=\"n\">plot<\/span><span class=\"p\">(<\/span><span class=\"n\">density<\/span><span class=\"p\">(<\/span><span class=\"n\">iris<\/span><span class=\"o\">$<\/span><span class=\"n\">Sepal.Length<\/span><span class=\"p\">))<\/span><span class=\"w\">\n<\/span><\/pre><\/div>\n<\/div>\n\n<div class=\"code-frame\" data-lang=\"r\">\n<div class=\"code-lang\"><span class=\"bold\">韻文<\/span><\/div>\n<div class=\"highlight\"><pre><span class=\"n\">iris<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">dplyr<\/span><span class=\"o\">::<\/span><span class=\"n\">select<\/span><span class=\"p\">(<\/span><span class=\"n\">Sepal.Length<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">unlist<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">density<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">plot<\/span><span class=\"w\">\n<\/span><\/pre><\/div>\n<\/div>\n\n<p>更に<a href=\"https://cran.r-project.org/web/packages/tidyverse/vignettes/manifesto.html\" rel=\"nofollow noopener\" target=\"_blank\">The tidy tools manifesto<\/a>にあるルールを足して，詩としての体裁を整えて(tidy)いく．<br>\nこれは詩でいう自由詩(free verse)より定型詩(rythmed verse)でいこうぜ!といったムーブメントに他なりません!(過言)<\/p>\n\n<p>ということで，<\/p>\n\n<p>tidyverseは「詩を整える」という意味で，転じて定型詩を訳語にするというのはいかがでしょうか．<\/p>\n\n<p>皆さん詩うようにcodingしましょう!!<\/p>\n\n<p>いいかげん，ggplot2もパイプを基本にしてもらいたいものです．<\/p>\n"],"body":["tidyverseってなんぞ?\n\nこのところのtidyverseユーザーたちの関心で，[Advent Calendar](https://adventar.org/calendars/2188)にまでなってしまいました．\nそこで私も12/9のAdvent Calendarに登録しました．\n先だっては[俺たちのtidyverseはこれからだ！ by yutanihilationさん](http://notchained.hatenablog.com/entry/tidyverse)やTwitter上で話題になりました．\n話題を取り上げた方々が訳語を知りたいのではなく，実態に迫りたいのだろうことは想像にかたくありません．\nそして「[もうtidyの訳語はtidyでよくない？ by yutanihilationさん](http://notchained.hatenablog.com/entry/2017/10/26/203205)」といった事態に．\n\nこんなに話題になるのは，tidyverseが発展途上ながら，実用的だからでしょう．\n加えて，tidy data([整然データってなに？ by Nishiharaさん](https://speakerdeck.com/fnshr/zheng-ran-detatutenani))とtidyverseは等価ではない(tidyverseにtidy dataは含まれる包含関係？)ことが，混乱を招きます．\n\nで，tidyverseとはなにかを考える時，みなさんtidyに注目しがちですが，verseに注目してみました．\n\nuniverse(宇宙)やmultiverse(多元的宇宙)という言葉があることから，tidyvereはtidyな世界とか宇宙とか環境とかそういった意味合いだろうと皆さん念頭に置いている気がします．\nしかし，verseの訳語を英辞郎で調べると\n\n- (動) 〔散文を〕韻文に作り替える\n- (名) 〔ある形式の〕詩◆無韻詩（blank verse）や自由詩（free verse）などがある。\n\nといった説明が出てきます．\nということは\n\ntidyverse == tidy詩 == tidyポエム？!\n\nなんということでしょう．\n我々のAdvent Calendarもtidyverseなのです．\n\nさて，ここでもう一つ重要なのが，動詞としてのverseで\"韻文に作り替える\"です．\nもうお分かりですよね．\nみなさん大好きパイプ演算子で韻を踏もうということです．\n\n```r:散文\nplot(density(iris$Sepal.Length))\n```\n\n```r:韻文\niris %>%\n  dplyr::select(Sepal.Length) %>%\n  unlist %>%\n  density %>%\n  plot\n```\n\n更に[The tidy tools manifesto](https://cran.r-project.org/web/packages/tidyverse/vignettes/manifesto.html)にあるルールを足して，詩としての体裁を整えて(tidy)いく．\nこれは詩でいう自由詩(free verse)より定型詩(rythmed verse)でいこうぜ!といったムーブメントに他なりません!(過言)\n\nということで，\n\ntidyverseは「詩を整える」という意味で，転じて定型詩を訳語にするというのはいかがでしょうか．\n\n皆さん詩うようにcodingしましょう!!\n\nいいかげん，ggplot2もパイプを基本にしてもらいたいものです．\n"],"coediting":[false],"comments_count":[0],"created_at":["2017-12-08T15:10:02+09:00"],"group":{},"id":["da5d4ddac04c5d0c1c32"],"likes_count":[1],"private":[false],"reactions_count":[0],"tags":[{"name":["R"],"versions":[]},{"name":["tidyverse"],"versions":[]}],"title":["tidyverse ≒ 定型詩"],"updated_at":["2017-12-08T15:28:36+09:00"],"url":["https://qiita.com/Atsushi776/items/da5d4ddac04c5d0c1c32"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["<p><a href=\"http://notchained.hatenablog.com/entry/2017/12/02/091230\" rel=\"nofollow noopener\" target=\"_blank\">yutanihilationさんの記事<\/a>でアドベントカレンダーに空きがあるのを知ったので登録してみました．<br>\nタイトルはteramonagiさんリスペクトです(<a href=\"https://www.slideshare.net/teramonagi/ss-11296227\" rel=\"nofollow noopener\" target=\"_blank\">指数分布とポアソン分布のイケナイ関係<\/a>)．<\/p>\n\n<h1>\n<span id=\"rでポアソン過程の観測値から期待値を密度推定したい\" class=\"fragment\"><\/span><a href=\"#r%E3%81%A7%E3%83%9D%E3%82%A2%E3%82%BD%E3%83%B3%E9%81%8E%E7%A8%8B%E3%81%AE%E8%A6%B3%E6%B8%AC%E5%80%A4%E3%81%8B%E3%82%89%E6%9C%9F%E5%BE%85%E5%80%A4%E3%82%92%E5%AF%86%E5%BA%A6%E6%8E%A8%E5%AE%9A%E3%81%97%E3%81%9F%E3%81%84\"><i class=\"fa fa-link\"><\/i><\/a>Rでポアソン過程の観測値から期待値を密度推定したい<\/h1>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">plot<\/span><span class=\"p\">(<\/span><span class=\"n\">density<\/span><span class=\"p\">(<\/span><span class=\"n\">rpois<\/span><span class=\"p\">(<\/span><span class=\"m\">100<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"m\">1.5<\/span><span class=\"p\">)))<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F3d03bc06-8d69-25ea-b35a-a7da64b4cace.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=c523b60d398ff8201e1ee503ccfe4cf2\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F3d03bc06-8d69-25ea-b35a-a7da64b4cace.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=c523b60d398ff8201e1ee503ccfe4cf2\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/3d03bc06-8d69-25ea-b35a-a7da64b4cace.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F3d03bc06-8d69-25ea-b35a-a7da64b4cace.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=84300877514cf990182abfbb49ae25f6 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>orz...<\/p>\n\n<h2>\n<span id=\"問-ポアソン過程で得られた観測値がxの時期待値λの分布は何分布\" class=\"fragment\"><\/span><a href=\"#%E5%95%8F-%E3%83%9D%E3%82%A2%E3%82%BD%E3%83%B3%E9%81%8E%E7%A8%8B%E3%81%A7%E5%BE%97%E3%82%89%E3%82%8C%E3%81%9F%E8%A6%B3%E6%B8%AC%E5%80%A4%E3%81%8Cx%E3%81%AE%E6%99%82%E6%9C%9F%E5%BE%85%E5%80%A4%CE%BB%E3%81%AE%E5%88%86%E5%B8%83%E3%81%AF%E4%BD%95%E5%88%86%E5%B8%83\"><i class=\"fa fa-link\"><\/i><\/a>問: ポアソン過程で得られた観測値がxの時，期待値λの分布は何分布？<\/h2>\n\n<h2>\n<span id=\"答-形状母数k--x--1-尺度母数θ--1のガンマ分布\" class=\"fragment\"><\/span><a href=\"#%E7%AD%94-%E5%BD%A2%E7%8A%B6%E6%AF%8D%E6%95%B0k--x--1-%E5%B0%BA%E5%BA%A6%E6%AF%8D%E6%95%B0%CE%B8--1%E3%81%AE%E3%82%AC%E3%83%B3%E3%83%9E%E5%88%86%E5%B8%83\"><i class=\"fa fa-link\"><\/i><\/a>答: 形状母数k = x + 1， 尺度母数θ = 1のガンマ分布<\/h2>\n\n<h2>\n<span id=\"証明\" class=\"fragment\"><\/span><a href=\"#%E8%A8%BC%E6%98%8E\"><i class=\"fa fa-link\"><\/i><\/a>証明<\/h2>\n\n<p>ポアソン分布は期待値λ(&gt; 0)の事象がX回起きる確率を教えてくれる離散確率分布で確率質量関数は以下の通り．<\/p>\n\n<p>$$<br>\nPoisson(X) = \\lambda ^ X e ^ {-\\lambda} / X!<br>\n$$<\/p>\n\n<p>従って，ある事象がx回(0以上の整数)起きた時の期待値の確率密度関数は<\/p>\n\n<p>$$<br>\nP(\\lambda) = \\lambda ^ x e ^ {-\\lambda} / x!<br>\n$$<\/p>\n\n<p>となる．<\/p>\n\n<p>ガンマ分布の確率密度関数は形状母数をk，尺度母数をθとして<\/p>\n\n<p>$$<br>\nGamma(X) = X ^ {k - 1} e ^ {-X/\\theta} / \\Gamma(k)<br>\n$$<\/p>\n\n<p>と表される．<br>\nここでΓはガンマ関数．<br>\nX = λ，k = x + 1, θ = 1の時，<\/p>\n\n<p>$$<br>\nGamma(\\lambda) = \\lambda ^ x e ^ {-\\lambda} / \\Gamma(x + 1)<br>\n$$<\/p>\n\n<p>となる．<br>\nxは0以上の整数より，x+1は自然数だから，<\/p>\n\n<p>$$<br>\n\\Gamma(x + 1) = x!<br>\n$$<\/p>\n\n<p>よって<\/p>\n\n<p>$$<br>\nGamma(\\lambda) = \\lambda ^ x e ^ {-\\lambda} / x!<br>\n$$<\/p>\n\n<p>となってP(λ)と一致する．<\/p>\n\n<h2>\n<span id=\"rで確認\" class=\"fragment\"><\/span><a href=\"#r%E3%81%A7%E7%A2%BA%E8%AA%8D\"><i class=\"fa fa-link\"><\/i><\/a>Rで確認<\/h2>\n\n<p>例えばある事象を3回観察した時の期待値の分布は<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">library<\/span><span class=\"p\">(<\/span><span class=\"n\">dplyr<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"n\">library<\/span><span class=\"p\">(<\/span><span class=\"n\">ggplot2<\/span><span class=\"p\">)<\/span><span class=\"w\">\n\n<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">data.frame<\/span><span class=\"p\">(<\/span><span class=\"w\">\n  <\/span><span class=\"n\">X<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">3<\/span><span class=\"p\">,<\/span><span class=\"w\">\n  <\/span><span class=\"n\">lambda<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">seq<\/span><span class=\"p\">(<\/span><span class=\"m\">0<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"m\">15<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"m\">0.1<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">mutate<\/span><span class=\"p\">(<\/span><span class=\"w\">\n    <\/span><span class=\"n\">p<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">unlist<\/span><span class=\"p\">(<\/span><span class=\"n\">Map<\/span><span class=\"p\">(<\/span><span class=\"n\">dpois<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">X<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">lambda<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">lambda<\/span><span class=\"p\">)),<\/span><span class=\"w\">\n    <\/span><span class=\"n\">gamma<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">dgamma<\/span><span class=\"p\">(<\/span><span class=\"n\">lambda<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">shape<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">X<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">rate<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"p\">)<\/span><span class=\"w\">\n  <\/span><span class=\"p\">)<\/span><span class=\"w\">\n\n<\/span><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">lambda<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_line<\/span><span class=\"p\">(<\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">p<\/span><span class=\"p\">),<\/span><span class=\"w\"> <\/span><span class=\"n\">lwd<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">2<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"s1\">'blue'<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\"> <\/span><span class=\"c1\">#青線<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_line<\/span><span class=\"p\">(<\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">gamma<\/span><span class=\"p\">),<\/span><span class=\"w\"> <\/span><span class=\"n\">lwd<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">2<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">lty<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">2<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"s1\">'red'<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"c1\">#赤線<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>ポアソン分布の確率質量関数から導出した期待値の分布(青線)と，ガンマ分布(赤線)が一致<\/p>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F22e64800-9b48-e623-0e29-1c6ddd695c5a.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=1e164be4060014965bd8cf87a57b6eb8\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F22e64800-9b48-e623-0e29-1c6ddd695c5a.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=1e164be4060014965bd8cf87a57b6eb8\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/22e64800-9b48-e623-0e29-1c6ddd695c5a.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F22e64800-9b48-e623-0e29-1c6ddd695c5a.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=6b62dee8defd08336bdbf78167add88d 1x\" loading=\"lazy\"><\/a><\/p>\n\n<h1>\n<span id=\"応用例\" class=\"fragment\"><\/span><a href=\"#%E5%BF%9C%E7%94%A8%E4%BE%8B\"><i class=\"fa fa-link\"><\/i><\/a>応用例<\/h1>\n\n<h2>\n<span id=\"期待値の密度推定\" class=\"fragment\"><\/span><a href=\"#%E6%9C%9F%E5%BE%85%E5%80%A4%E3%81%AE%E5%AF%86%E5%BA%A6%E6%8E%A8%E5%AE%9A\"><i class=\"fa fa-link\"><\/i><\/a>期待値の密度推定<\/h2>\n\n<p>期待値1のポアソン分布に基く乱数を100個生成した時，<\/p>\n\n<ul>\n<li>ヒストグラム(ビン幅1)<\/li>\n<li>カーネル密度(青点線)<\/li>\n<li>混合ガンマ分布(赤線)<\/li>\n<\/ul>\n\n<p>により期待値の分布を見てみる．<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">set.seed<\/span><span class=\"p\">(<\/span><span class=\"m\">123<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"c1\"># 乱数固定<\/span><span class=\"w\">\n<\/span><span class=\"n\">X<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">rpois<\/span><span class=\"p\">(<\/span><span class=\"m\">100<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"c1\"># ポアソン分布に従う乱数生成<\/span><span class=\"w\">\n<\/span><span class=\"n\">lambda<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">seq<\/span><span class=\"p\">(<\/span><span class=\"m\">0<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"m\">20<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"m\">0.1<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"c1\"># ポアソン分布の期待値の密度の推定範囲を指定<\/span><span class=\"w\">\n<\/span><span class=\"n\">X_dens<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">X<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\"> <\/span><span class=\"c1\"># 混合分布を生成<\/span><span class=\"w\">\n  <\/span><span class=\"n\">setNames<\/span><span class=\"p\">(<\/span><span class=\"n\">nm<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">.<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">lapply<\/span><span class=\"p\">(<\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">X<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n    <\/span><span class=\"n\">data.frame<\/span><span class=\"p\">(<\/span><span class=\"w\">\n      <\/span><span class=\"n\">X<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">X<\/span><span class=\"p\">,<\/span><span class=\"w\">\n      <\/span><span class=\"n\">lambda<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">lambda<\/span><span class=\"p\">,<\/span><span class=\"w\">\n      <\/span><span class=\"n\">p<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">dgamma<\/span><span class=\"p\">(<\/span><span class=\"n\">lambda<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">X<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"p\">)<\/span><span class=\"w\">\n    <\/span><span class=\"p\">)<\/span><span class=\"w\">\n  <\/span><span class=\"p\">})<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">bind_rows<\/span><span class=\"p\">()<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">group_by<\/span><span class=\"p\">(<\/span><span class=\"n\">lambda<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">summarise<\/span><span class=\"p\">(<\/span><span class=\"n\">p<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">mean<\/span><span class=\"p\">(<\/span><span class=\"n\">p<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">mutate<\/span><span class=\"p\">(<\/span><span class=\"n\">X<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"kc\">NA_integer_<\/span><span class=\"p\">)<\/span><span class=\"w\">\n\n\n<\/span><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"w\">\n  <\/span><span class=\"n\">data.frame<\/span><span class=\"p\">(<\/span><span class=\"n\">X<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n    <\/span><span class=\"n\">mutate<\/span><span class=\"p\">(<\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"w\"> <\/span><span class=\"o\">/<\/span><span class=\"w\"> <\/span><span class=\"n\">n<\/span><span class=\"p\">()),<\/span><span class=\"w\"> \n  <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">X<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_col<\/span><span class=\"p\">(<\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"p\">),<\/span><span class=\"w\"> <\/span><span class=\"n\">fill<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"kc\">NA<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"s1\">'gray50'<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\"> <\/span><span class=\"c1\"># 乱数のヒストグラム<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_density<\/span><span class=\"p\">(<\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"s1\">'blue'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">lty<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">2<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\"> <\/span><span class=\"c1\"># 乱数の密度分布<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_line<\/span><span class=\"p\">(<\/span><span class=\"n\">data<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">X_dens<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">lambda<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">p<\/span><span class=\"p\">),<\/span><span class=\"w\"> <\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"s1\">'red'<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\"> <\/span><span class=\"c1\"># 期待値の密度分布<\/span><span class=\"w\">\n  <\/span><span class=\"n\">scale_x_continuous<\/span><span class=\"p\">(<\/span><span class=\"n\">breaks<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">-2<\/span><span class=\"o\">:<\/span><span class=\"m\">10<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">limits<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"nf\">c<\/span><span class=\"p\">(<\/span><span class=\"m\">-2<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"m\">10<\/span><span class=\"p\">))<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Fa821801d-24cd-00f2-b515-0fe7c9379535.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=4221300f8a8777f862abbdeb621363d4\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Fa821801d-24cd-00f2-b515-0fe7c9379535.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=4221300f8a8777f862abbdeb621363d4\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/a821801d-24cd-00f2-b515-0fe7c9379535.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Fa821801d-24cd-00f2-b515-0fe7c9379535.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=f8bf34430d2708310294e062b6b6ab9c 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>カーネル密度を使うと，本来あり得ない負の回数が起きる確率が推定されてしまう．<br>\n乱数が離散値であるため，マルチモーダルな密度分布が得られてしまう．<br>\nこういった問題を混合ガンマ分布では回避できる．<\/p>\n\n<h1>\n<span id=\"感想\" class=\"fragment\"><\/span><a href=\"#%E6%84%9F%E6%83%B3\"><i class=\"fa fa-link\"><\/i><\/a>感想<\/h1>\n\n<p>負の二項分布がポアソン分布の期待値がガンマ分布に従う時の分布に相当するから，データの過分散対策に使おうとか，ベイジアンでMCMCする時にポアソン分布の期待値の事前分布にガンマ分布を使おうっていうのはこの辺から来てるのかな……？<br>\n天下りが過ぎて，うまくいきそうなのはわかるけどなぜかわからなかったけど，納得できた．<\/p>\n\n<p>また，ガンマ分布はWikipediaなんか見ても，どういう時に使うかは書いてあるけど，どういう時に起きるかは書いていなくて，一体ナニモノぞといった感じがしてしまう．<br>\n非負で連続値をとる確率過程はガンマ分布で! なんて言われても……．<br>\nまさしくポアソン分布の期待値は非負の連続値をとるのだけれども，実際これがガンマ分布に従うことが今回わかって嬉しい．<\/p>\n\n<p>あと，混合分布の厳密(？)な作りかたがよくわからず，積分値が1になるよう，混合する各分布におけるxの確率密度の平均を混合分布のxにおける確率密度としてプロットしてみたけどあっているのだろうか……．<\/p>\n"],"body":["\n[yutanihilationさんの記事](http://notchained.hatenablog.com/entry/2017/12/02/091230)でアドベントカレンダーに空きがあるのを知ったので登録してみました．\nタイトルはteramonagiさんリスペクトです([指数分布とポアソン分布のイケナイ関係](https://www.slideshare.net/teramonagi/ss-11296227))．\n\n\n# Rでポアソン過程の観測値から期待値を密度推定したい\n\n```r\nplot(density(rpois(100, 1.5)))\n```\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/3d03bc06-8d69-25ea-b35a-a7da64b4cace.png)\n\norz...\n\n\n## 問: ポアソン過程で得られた観測値がxの時，期待値λの分布は何分布？\n\n## 答: 形状母数k = x + 1， 尺度母数θ = 1のガンマ分布\n\n## 証明\n\nポアソン分布は期待値λ(> 0)の事象がX回起きる確率を教えてくれる離散確率分布で確率質量関数は以下の通り．\n\n$$\nPoisson(X) = \\lambda ^ X e ^ {-\\lambda} / X!\n$$\n\n従って，ある事象がx回(0以上の整数)起きた時の期待値の確率密度関数は\n\n$$\nP(\\lambda) = \\lambda ^ x e ^ {-\\lambda} / x!\n$$\n\nとなる．\n\nガンマ分布の確率密度関数は形状母数をk，尺度母数をθとして\n\n$$\nGamma(X) = X ^ {k - 1} e ^ {-X/\\theta} / \\Gamma(k)\n$$\n\nと表される．\nここでΓはガンマ関数．\nX = λ，k = x + 1, θ = 1の時，\n\n$$\nGamma(\\lambda) = \\lambda ^ x e ^ {-\\lambda} / \\Gamma(x + 1)\n$$\n\nとなる．\nxは0以上の整数より，x+1は自然数だから，\n\n$$\n\\Gamma(x + 1) = x!\n$$\n\nよって\n\n$$\nGamma(\\lambda) = \\lambda ^ x e ^ {-\\lambda} / x!\n$$\n\nとなってP(λ)と一致する．\n\n## Rで確認\n\n例えばある事象を3回観察した時の期待値の分布は\n\n```r\nlibrary(dplyr)\nlibrary(ggplot2)\n\nx <- data.frame(\n  X = 3,\n  lambda = seq(0, 15, 0.1)\n) %>%\n  mutate(\n    p = unlist(Map(dpois, x = X, lambda = lambda)),\n    gamma = dgamma(lambda, shape = X + 1, rate = 1)\n  )\n\nggplot(x, aes(x = lambda)) +\n  geom_line(aes(y = p), lwd = 2, color = 'blue') + #青線\n  geom_line(aes(y = gamma), lwd = 2, lty = 2, color = 'red') #赤線\n```\n\nポアソン分布の確率質量関数から導出した期待値の分布(青線)と，ガンマ分布(赤線)が一致\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/22e64800-9b48-e623-0e29-1c6ddd695c5a.png)\n\n# 応用例\n\n## 期待値の密度推定\n\n期待値1のポアソン分布に基く乱数を100個生成した時，\n\n- ヒストグラム(ビン幅1)\n- カーネル密度(青点線)\n- 混合ガンマ分布(赤線)\n\nにより期待値の分布を見てみる．\n\n```r\nset.seed(123) # 乱数固定\nX <- rpois(100, 1) # ポアソン分布に従う乱数生成\nlambda <- seq(0, 20, 0.1) # ポアソン分布の期待値の密度の推定範囲を指定\nX_dens <- X %>% # 混合分布を生成\n  setNames(nm = .) %>%\n  lapply(function(X) {\n    data.frame(\n      X = X,\n      lambda = lambda,\n      p = dgamma(lambda, X + 1)\n    )\n  }) %>%\n  bind_rows() %>%\n  group_by(lambda) %>%\n  summarise(p = mean(p)) %>%\n  mutate(X = NA_integer_)\n\n\nggplot(\n  data.frame(X) %>%\n    mutate(y = 1 / n()), \n  aes(x = X)\n) +\n  geom_col(aes(y = y), fill = NA, color = 'gray50') + # 乱数のヒストグラム\n  geom_density(color = 'blue', lty = 2) + # 乱数の密度分布\n  geom_line(data = X_dens, aes(x = lambda, y = p), color = 'red') + # 期待値の密度分布\n  scale_x_continuous(breaks = -2:10, limits = c(-2, 10))\n```\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/a821801d-24cd-00f2-b515-0fe7c9379535.png)\n\nカーネル密度を使うと，本来あり得ない負の回数が起きる確率が推定されてしまう．\n乱数が離散値であるため，マルチモーダルな密度分布が得られてしまう．\nこういった問題を混合ガンマ分布では回避できる．\n\n#感想\n\n負の二項分布がポアソン分布の期待値がガンマ分布に従う時の分布に相当するから，データの過分散対策に使おうとか，ベイジアンでMCMCする時にポアソン分布の期待値の事前分布にガンマ分布を使おうっていうのはこの辺から来てるのかな……？\n天下りが過ぎて，うまくいきそうなのはわかるけどなぜかわからなかったけど，納得できた．\n\nまた，ガンマ分布はWikipediaなんか見ても，どういう時に使うかは書いてあるけど，どういう時に起きるかは書いていなくて，一体ナニモノぞといった感じがしてしまう．\n非負で連続値をとる確率過程はガンマ分布で! なんて言われても……．\nまさしくポアソン分布の期待値は非負の連続値をとるのだけれども，実際これがガンマ分布に従うことが今回わかって嬉しい．\n\nあと，混合分布の厳密(？)な作りかたがよくわからず，積分値が1になるよう，混合する各分布におけるxの確率密度の平均を混合分布のxにおける確率密度としてプロットしてみたけどあっているのだろうか……．\n"],"coediting":[false],"comments_count":[0],"created_at":["2017-12-05T14:32:46+09:00"],"group":{},"id":["ce12840de6e37f7291f3"],"likes_count":[14],"private":[false],"reactions_count":[0],"tags":[{"name":["R"],"versions":[]},{"name":["統計学"],"versions":[]},{"name":["ポアソン分布"],"versions":[]},{"name":["ガンマ分布"],"versions":[]}],"title":["ポアソン分布とガンマ分布のイケナイ関係"],"updated_at":["2017-12-12T00:04:52+09:00"],"url":["https://qiita.com/Atsushi776/items/ce12840de6e37f7291f3"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["\n<h1>\n<span id=\"こんなデータフレームを\" class=\"fragment\"><\/span><a href=\"#%E3%81%93%E3%82%93%E3%81%AA%E3%83%87%E3%83%BC%E3%82%BF%E3%83%95%E3%83%AC%E3%83%BC%E3%83%A0%E3%82%92\"><i class=\"fa fa-link\"><\/i><\/a>こんなデータフレームを<\/h1>\n\n<table>\n<thead>\n<tr>\n<th style=\"text-align: right\">int<\/th>\n<th style=\"text-align: left\">lgl<\/th>\n<th style=\"text-align: left\">chr<\/th>\n<th style=\"text-align: left\">lgl.1<\/th>\n<th style=\"text-align: left\">lgl.2<\/th>\n<th style=\"text-align: right\">int.1<\/th>\n<th style=\"text-align: left\">chr.1<\/th>\n<th style=\"text-align: left\">lgl.3<\/th>\n<th style=\"text-align: left\">chr.2<\/th>\n<th style=\"text-align: left\">chr.3<\/th>\n<\/tr>\n<\/thead>\n<tbody>\n<tr>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<\/tr>\n<\/tbody>\n<\/table>\n\n<h1>\n<span id=\"こうしたい\" class=\"fragment\"><\/span><a href=\"#%E3%81%93%E3%81%86%E3%81%97%E3%81%9F%E3%81%84\"><i class=\"fa fa-link\"><\/i><\/a>こうしたい<\/h1>\n\n<table>\n<thead>\n<tr>\n<th style=\"text-align: left\">chr<\/th>\n<th style=\"text-align: left\">chr.1<\/th>\n<th style=\"text-align: left\">lgl<\/th>\n<th style=\"text-align: left\">lgl.1<\/th>\n<th style=\"text-align: left\">lgl.2<\/th>\n<th style=\"text-align: left\">lgl.3<\/th>\n<th style=\"text-align: right\">int<\/th>\n<th style=\"text-align: right\">int.1<\/th>\n<th style=\"text-align: right\">int.2<\/th>\n<th style=\"text-align: right\">int.3<\/th>\n<\/tr>\n<\/thead>\n<tbody>\n<tr>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<\/tr>\n<\/tbody>\n<\/table>\n\n<h1>\n<span id=\"テストデータの用意\" class=\"fragment\"><\/span><a href=\"#%E3%83%86%E3%82%B9%E3%83%88%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E7%94%A8%E6%84%8F\"><i class=\"fa fa-link\"><\/i><\/a>テストデータの用意<\/h1>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"w\">\n<\/span><span class=\"n\">nr<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"m\">5<\/span><span class=\"w\"> <\/span><span class=\"c1\">#テストデータ(data.frame)の行数<\/span><span class=\"w\">\n\n<\/span><span class=\"n\">d0<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">data.frame<\/span><span class=\"p\">(<\/span><span class=\"w\"> <\/span><span class=\"c1\">#テストデータの基本構成要素<\/span><span class=\"w\">\n  <\/span><span class=\"n\">int<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"nf\">rep<\/span><span class=\"p\">(<\/span><span class=\"m\">1<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">nr<\/span><span class=\"p\">),<\/span><span class=\"w\"> <\/span><span class=\"c1\">#integer<\/span><span class=\"w\">\n  <\/span><span class=\"n\">chr<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"nf\">rep<\/span><span class=\"p\">(<\/span><span class=\"s1\">'chr'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">nr<\/span><span class=\"p\">),<\/span><span class=\"w\"> <\/span><span class=\"c1\">#character<\/span><span class=\"w\">\n  <\/span><span class=\"n\">lgl<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"nf\">rep<\/span><span class=\"p\">(<\/span><span class=\"kc\">TRUE<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">nr<\/span><span class=\"p\">),<\/span><span class=\"w\"> <\/span><span class=\"c1\">#logical<\/span><span class=\"w\">\n  <\/span><span class=\"n\">stringsAsFactors<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"kc\">FALSE<\/span><span class=\"w\"> <\/span><span class=\"c1\">#characterがfactorに変換されることを防ぐ<\/span><span class=\"w\">\n<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"n\">set.seed<\/span><span class=\"p\">(<\/span><span class=\"m\">123<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"c1\">#乱数の固定<\/span><span class=\"w\">\n<\/span><span class=\"n\">d1<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">d0<\/span><span class=\"p\">[<\/span><span class=\"n\">sample.int<\/span><span class=\"p\">(<\/span><span class=\"nf\">length<\/span><span class=\"p\">(<\/span><span class=\"n\">d0<\/span><span class=\"p\">),<\/span><span class=\"w\"> <\/span><span class=\"m\">10<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">replace<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"kc\">TRUE<\/span><span class=\"p\">)]<\/span><span class=\"w\"> <\/span><span class=\"c1\">#d0を基に10列のデータフレームを作成<\/span><span class=\"w\">\n\n<\/span><span class=\"n\">d1<\/span><span class=\"w\"> <\/span><span class=\"c1\">#テストデータ<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<table>\n<thead>\n<tr>\n<th style=\"text-align: right\">int<\/th>\n<th style=\"text-align: left\">lgl<\/th>\n<th style=\"text-align: left\">chr<\/th>\n<th style=\"text-align: left\">lgl.1<\/th>\n<th style=\"text-align: left\">lgl.2<\/th>\n<th style=\"text-align: right\">int.1<\/th>\n<th style=\"text-align: left\">chr.1<\/th>\n<th style=\"text-align: left\">lgl.3<\/th>\n<th style=\"text-align: left\">chr.2<\/th>\n<th style=\"text-align: left\">chr.3<\/th>\n<\/tr>\n<\/thead>\n<tbody>\n<tr>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<\/tr>\n<\/tbody>\n<\/table>\n\n<h1>\n<span id=\"列の型順にソート\" class=\"fragment\"><\/span><a href=\"#%E5%88%97%E3%81%AE%E5%9E%8B%E9%A0%86%E3%81%AB%E3%82%BD%E3%83%BC%E3%83%88\"><i class=\"fa fa-link\"><\/i><\/a>列の型順にソート<\/h1>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"w\">\n<\/span><span class=\"n\">classes<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">sapply<\/span><span class=\"p\">(<\/span><span class=\"n\">d1<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">class<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"c1\">#各列の型を入手<\/span><span class=\"w\">\n<\/span><span class=\"n\">d2<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">d1<\/span><span class=\"p\">[<\/span><span class=\"n\">order<\/span><span class=\"p\">(<\/span><span class=\"n\">classes<\/span><span class=\"p\">)]<\/span><span class=\"w\"> <\/span><span class=\"c1\">#ソート<\/span><span class=\"w\">\n\n<\/span><span class=\"n\">d2<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<table>\n<thead>\n<tr>\n<th style=\"text-align: left\">chr<\/th>\n<th style=\"text-align: left\">chr.1<\/th>\n<th style=\"text-align: left\">lgl<\/th>\n<th style=\"text-align: left\">lgl.1<\/th>\n<th style=\"text-align: left\">lgl.2<\/th>\n<th style=\"text-align: left\">lgl.3<\/th>\n<th style=\"text-align: right\">int<\/th>\n<th style=\"text-align: right\">int.1<\/th>\n<th style=\"text-align: right\">int.2<\/th>\n<th style=\"text-align: right\">int.3<\/th>\n<\/tr>\n<\/thead>\n<tbody>\n<tr>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">chr<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: left\">TRUE<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<td style=\"text-align: right\">1<\/td>\n<\/tr>\n<\/tbody>\n<\/table>\n\n<p>パイプラインでやるなら<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">library<\/span><span class=\"p\">(<\/span><span class=\"n\">dplyr<\/span><span class=\"p\">)<\/span><span class=\"w\">\n\n<\/span><span class=\"n\">d1<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">`[`<\/span><span class=\"p\">(<\/span><span class=\"n\">order<\/span><span class=\"p\">(<\/span><span class=\"n\">sapply<\/span><span class=\"p\">(<\/span><span class=\"n\">.<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">class<\/span><span class=\"p\">)))<\/span><span class=\"w\">\n\n\n<\/span><\/pre><\/div><\/div>\n"],"body":["#こんなデータフレームを\n\n| int|lgl  |chr |lgl.1 |lgl.2 | int.1|chr.1 |lgl.3 |chr.2 |chr.3 |\n|---:|:----|:---|:-----|:-----|-----:|:-----|:-----|:-----|:-----|\n|   1|TRUE |chr |TRUE  |TRUE  |     1|chr   |TRUE  |chr   |chr   |\n|   1|TRUE |chr |TRUE  |TRUE  |     1|chr   |TRUE  |chr   |chr   |\n|   1|TRUE |chr |TRUE  |TRUE  |     1|chr   |TRUE  |chr   |chr   |\n|   1|TRUE |chr |TRUE  |TRUE  |     1|chr   |TRUE  |chr   |chr   |\n|   1|TRUE |chr |TRUE  |TRUE  |     1|chr   |TRUE  |chr   |chr   |\n\n#こうしたい\n\n|chr |chr.1 |lgl  |lgl.1 |lgl.2 |lgl.3 | int| int.1| int.2| int.3|\n|:---|:-----|:----|:-----|:-----|:-----|---:|-----:|-----:|-----:|\n|chr |chr   |TRUE |TRUE  |TRUE  |TRUE  |   1|     1|     1|     1|\n|chr |chr   |TRUE |TRUE  |TRUE  |TRUE  |   1|     1|     1|     1|\n|chr |chr   |TRUE |TRUE  |TRUE  |TRUE  |   1|     1|     1|     1|\n|chr |chr   |TRUE |TRUE  |TRUE  |TRUE  |   1|     1|     1|     1|\n|chr |chr   |TRUE |TRUE  |TRUE  |TRUE  |   1|     1|     1|     1|\n\n#テストデータの用意\n\n```r\n\nnr <- 5 #テストデータ(data.frame)の行数\n\nd0 <- data.frame( #テストデータの基本構成要素\n  int = rep(1, nr), #integer\n  chr = rep('chr', nr), #character\n  lgl = rep(TRUE, nr), #logical\n  stringsAsFactors = FALSE #characterがfactorに変換されることを防ぐ\n)\nset.seed(123) #乱数の固定\nd1 <- d0[sample.int(length(d0), 10, replace = TRUE)] #d0を基に10列のデータフレームを作成\n\nd1 #テストデータ\n```\n\n| int|lgl  |chr |lgl.1 |lgl.2 | int.1|chr.1 |lgl.3 |chr.2 |chr.3 |\n|---:|:----|:---|:-----|:-----|-----:|:-----|:-----|:-----|:-----|\n|   1|TRUE |chr |TRUE  |TRUE  |     1|chr   |TRUE  |chr   |chr   |\n|   1|TRUE |chr |TRUE  |TRUE  |     1|chr   |TRUE  |chr   |chr   |\n|   1|TRUE |chr |TRUE  |TRUE  |     1|chr   |TRUE  |chr   |chr   |\n|   1|TRUE |chr |TRUE  |TRUE  |     1|chr   |TRUE  |chr   |chr   |\n|   1|TRUE |chr |TRUE  |TRUE  |     1|chr   |TRUE  |chr   |chr   |\n\n\n#列の型順にソート\n\n```r\n\nclasses <- sapply(d1, class) #各列の型を入手\nd2 <- d1[order(classes)] #ソート\n\nd2\n```\n\n\n|chr |chr.1 |lgl  |lgl.1 |lgl.2 |lgl.3 | int| int.1| int.2| int.3|\n|:---|:-----|:----|:-----|:-----|:-----|---:|-----:|-----:|-----:|\n|chr |chr   |TRUE |TRUE  |TRUE  |TRUE  |   1|     1|     1|     1|\n|chr |chr   |TRUE |TRUE  |TRUE  |TRUE  |   1|     1|     1|     1|\n|chr |chr   |TRUE |TRUE  |TRUE  |TRUE  |   1|     1|     1|     1|\n|chr |chr   |TRUE |TRUE  |TRUE  |TRUE  |   1|     1|     1|     1|\n|chr |chr   |TRUE |TRUE  |TRUE  |TRUE  |   1|     1|     1|     1|\n\n\nパイプラインでやるなら\n\n```r\nlibrary(dplyr)\n\nd1 %>%\n  `[`(order(sapply(., class)))\n\n\n```\n"],"coediting":[false],"comments_count":[0],"created_at":["2017-11-14T19:39:31+09:00"],"group":{},"id":["94253a822336412436a4"],"likes_count":[0],"private":[false],"reactions_count":[0],"tags":[{"name":["R"],"versions":[]}],"title":["データフレームを列の型でソートする"],"updated_at":["2017-11-14T19:40:52+09:00"],"url":["https://qiita.com/Atsushi776/items/94253a822336412436a4"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["\n<h1>\n<span id=\"多重共線性とは\" class=\"fragment\"><\/span><a href=\"#%E5%A4%9A%E9%87%8D%E5%85%B1%E7%B7%9A%E6%80%A7%E3%81%A8%E3%81%AF\"><i class=\"fa fa-link\"><\/i><\/a>多重共線性とは<\/h1>\n\n<p>説明変数同士が強く相関していること．<br>\n例えば月の売り上げが月の降水量と月の降水日数に比例するモデルを考えると，降水量と降水日数の間は相関しているので，このモデルには多重共線性がある．<\/p>\n\n<p>多重共線性があると，回帰係数の標準誤差が大きくなり、訓練データが変わる(増える)度に分析結果が大きく変わりうるらしい．<br>\nでも予測精度には影響しないとか．<br>\n……なにが起きてるの？<br>\nどういう時に問題になるだとか，数学的にはどういう状況かとかいった説明はWeb上に沢山見かける(<a href=\"http://www.housecat442.com/?p=494\" rel=\"nofollow noopener\" target=\"_blank\">例<\/a>)ので、今回は図で理解したい．<\/p>\n\n<h1>\n<span id=\"多重共線性のないとき\" class=\"fragment\"><\/span><a href=\"#%E5%A4%9A%E9%87%8D%E5%85%B1%E7%B7%9A%E6%80%A7%E3%81%AE%E3%81%AA%E3%81%84%E3%81%A8%E3%81%8D\"><i class=\"fa fa-link\"><\/i><\/a>多重共線性のないとき<\/h1>\n\n<p>$z = x + y$<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">n<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"m\">100<\/span><span class=\"w\">\n<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">runif<\/span><span class=\"p\">(<\/span><span class=\"n\">n<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\"> <\/span><span class=\"n\">rnorm<\/span><span class=\"p\">(<\/span><span class=\"n\">n<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">sd<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">0.05<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">runif<\/span><span class=\"p\">(<\/span><span class=\"n\">n<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\"> <\/span><span class=\"n\">rnorm<\/span><span class=\"p\">(<\/span><span class=\"n\">n<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">sd<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">0.05<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"n\">z<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\"> <\/span><span class=\"n\">rnorm<\/span><span class=\"p\">(<\/span><span class=\"n\">n<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">sd<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">0.05<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"n\">plot3D<\/span><span class=\"o\">::<\/span><span class=\"n\">scatter3D<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">z<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Ff00c743a-18e8-4d8e-8e97-b5bdceff040b.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=2a5018ec467638cc4d551eada3a828c5\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Ff00c743a-18e8-4d8e-8e97-b5bdceff040b.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=2a5018ec467638cc4d551eada3a828c5\" alt=\"unnamed-chunk-1-1.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/f00c743a-18e8-4d8e-8e97-b5bdceff040b.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Ff00c743a-18e8-4d8e-8e97-b5bdceff040b.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=31504b7c8569a795e1ec30c47b93af38 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>どう頑張っても，これらの点を乗せられる平面は1面しか描けないと思う．<\/p>\n\n<h1>\n<span id=\"多重共線性のある時\" class=\"fragment\"><\/span><a href=\"#%E5%A4%9A%E9%87%8D%E5%85%B1%E7%B7%9A%E6%80%A7%E3%81%AE%E3%81%82%E3%82%8B%E6%99%82\"><i class=\"fa fa-link\"><\/i><\/a>多重共線性のある時<\/h1>\n\n<p>xとyが1:1で比例するようにしてみた．<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\"> <\/span><span class=\"n\">rnorm<\/span><span class=\"p\">(<\/span><span class=\"n\">n<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">sd<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">0.05<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"n\">z<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\"> <\/span><span class=\"n\">rnorm<\/span><span class=\"p\">(<\/span><span class=\"n\">n<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">sd<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"m\">0.05<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"n\">plot3D<\/span><span class=\"o\">::<\/span><span class=\"n\">scatter3D<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">z<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F266d83f3-1c7b-4a96-ec32-8c30c8b3e53c.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=d4e15f8920f5fb8ad3c0d44dd1329ab1\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F266d83f3-1c7b-4a96-ec32-8c30c8b3e53c.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=d4e15f8920f5fb8ad3c0d44dd1329ab1\" alt=\"unnamed-chunk-2-1.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/266d83f3-1c7b-4a96-ec32-8c30c8b3e53c.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F266d83f3-1c7b-4a96-ec32-8c30c8b3e53c.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=415c5c4dd9b6ad26a853367a4f8aca40 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>今度も$z = x + y$に乗るが， 直線上に並んだ点を乗せる面は無数に描けるので<br>\n$z = 2x$,<br>\n$z = 0.1x + 1.9y$<br>\n$z = 100x - 98y$<br>\nなどにも乗る．<\/p>\n\n<p>回帰係数の標準誤差が大きく，その大小や正負の関係も信用成らないとはこのことかとお分かり頂けると思う．<br><br>\nということは，たまたま追加したデータのxまたはyが外れ値だったりすると，直前とは全く異なる面で回帰されるだろうことが分かる．<\/p>\n\n<p>一方でどの式を解としても予測には影響がない．<\/p>\n\n<h1>\n<span id=\"多重共線性を避けるには\" class=\"fragment\"><\/span><a href=\"#%E5%A4%9A%E9%87%8D%E5%85%B1%E7%B7%9A%E6%80%A7%E3%82%92%E9%81%BF%E3%81%91%E3%82%8B%E3%81%AB%E3%81%AF\"><i class=\"fa fa-link\"><\/i><\/a>多重共線性を避けるには<\/h1>\n\n<p>回帰係数の大小に興味がなく，予測しかしないならば，多重共線性は必ずしも忌避すべきものではない．<br>\nただし，観測値が不足すると，ランク不足により，説明変数を減らす必要が生じうる．<br>\nこんな時は明示的に説明変数を取捨選択してもいいし，LASSOなどの正則化を用いるのも手だ．<\/p>\n"],"body":["#多重共線性とは\n\n説明変数同士が強く相関していること．\n例えば月の売り上げが月の降水量と月の降水日数に比例するモデルを考えると，降水量と降水日数の間は相関しているので，このモデルには多重共線性がある．\n\n多重共線性があると，回帰係数の標準誤差が大きくなり、訓練データが変わる(増える)度に分析結果が大きく変わりうるらしい．\nでも予測精度には影響しないとか．\n……なにが起きてるの？\nどういう時に問題になるだとか，数学的にはどういう状況かとかいった説明はWeb上に沢山見かける([例](http://www.housecat442.com/?p=494))ので、今回は図で理解したい．\n\n#多重共線性のないとき\n\n$z = x + y$\n\n\n```r\nn <- 100\nx <- runif(n) + rnorm(n, sd = 0.05)\ny <- runif(n) + rnorm(n, sd = 0.05)\nz <- x + y + rnorm(n, sd = 0.05)\nplot3D::scatter3D(x, y, z)\n```\n\n![unnamed-chunk-1-1.png](https://qiita-image-store.s3.amazonaws.com/0/149890/f00c743a-18e8-4d8e-8e97-b5bdceff040b.png)\n\n\nどう頑張っても，これらの点を乗せられる平面は1面しか描けないと思う．\n\n#多重共線性のある時\n\nxとyが1:1で比例するようにしてみた．\n\n\n```r\ny <- x + rnorm(n, sd = 0.05)\nz <- x + y + rnorm(n, sd = 0.05)\nplot3D::scatter3D(x, y, z)\n```\n\n![unnamed-chunk-2-1.png](https://qiita-image-store.s3.amazonaws.com/0/149890/266d83f3-1c7b-4a96-ec32-8c30c8b3e53c.png)\n\n\n今度も$z = x + y$に乗るが， 直線上に並んだ点を乗せる面は無数に描けるので\n$z = 2x$,\n$z = 0.1x + 1.9y$\n$z = 100x - 98y$\nなどにも乗る．\n\n回帰係数の標準誤差が大きく，その大小や正負の関係も信用成らないとはこのことかとお分かり頂けると思う．  \nということは，たまたま追加したデータのxまたはyが外れ値だったりすると，直前とは全く異なる面で回帰されるだろうことが分かる．\n\n一方でどの式を解としても予測には影響がない．\n\n#多重共線性を避けるには\n\n回帰係数の大小に興味がなく，予測しかしないならば，多重共線性は必ずしも忌避すべきものではない．\nただし，観測値が不足すると，ランク不足により，説明変数を減らす必要が生じうる．\nこんな時は明示的に説明変数を取捨選択してもいいし，LASSOなどの正則化を用いるのも手だ．\n\n"],"coediting":[false],"comments_count":[0],"created_at":["2017-10-20T17:10:24+09:00"],"group":{},"id":["a8078755a7436da29671"],"likes_count":[13],"private":[false],"reactions_count":[0],"tags":[{"name":["R"],"versions":[]},{"name":["統計学"],"versions":[]}],"title":["3次元空間で図解する多重共線性"],"updated_at":["2017-10-20T17:10:24+09:00"],"url":["https://qiita.com/Atsushi776/items/a8078755a7436da29671"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["<p>LinuxでSambaを用いてファイル共有する時、共有フォルダ内にシンボリックリンクを作っても既定ではアクセスできない。<\/p>\n\n<p>Ubuntu 10.4以降では/etc/samba/smb.confに<\/p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>[global]\nunix extensions = no\nwide links = yes\n<\/pre><\/div><\/div>\n\n<p>を追記すればいいようだ(<a href=\"http://takuya-1st.hatenablog.jp/entry/20100509/1273424397\" rel=\"nofollow noopener\" target=\"_blank\">それマグで!<\/a>)。<\/p>\n\n<p>ReadyNASの場合、/etc/samba/smb.confを覗いてみると編集するなと書いてある。<br>\n自動生成なので、せっかく書き換えても上書きされてしまうようだ。<br>\nもう少し中を見ると、<\/p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>include = /etc/frontview/samba/smb.conf.defaults\ninclude = /etc/frontview/samba/smb.conf.%a\ninclude = /etc/frontview/samba/smb.conf.overrides\ninclude = /etc/frontview/samba/Shares.conf\ninclude = /etc/frontview/samba/Shares.conf.%G\ninclude = /etc/frontview/samba/addons/addons.conf\ninclude = /run/usb/samba/Shares.conf\n<\/pre><\/div><\/div>\n\n<p>と複数のconfファイルを参照しているので、いずれかに先の内容を追記すればいい。<br>\n私は<\/p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>include = /etc/frontview/samba/smb.conf.defaults\n<\/pre><\/div><\/div>\n\n<p>を選んだ。<\/p>\n\n<p>ただし、ReadyOSのアップデートの度に、confファイルは修正されてしまうようで、毎度修正の必要がある。<\/p>\n"],"body":["LinuxでSambaを用いてファイル共有する時、共有フォルダ内にシンボリックリンクを作っても既定ではアクセスできない。\n\nUbuntu 10.4以降では/etc/samba/smb.confに\n\n```\n[global]\nunix extensions = no\nwide links = yes\n```\n\nを追記すればいいようだ([それマグで!](http://takuya-1st.hatenablog.jp/entry/20100509/1273424397))。\n\nReadyNASの場合、/etc/samba/smb.confを覗いてみると編集するなと書いてある。\n自動生成なので、せっかく書き換えても上書きされてしまうようだ。\nもう少し中を見ると、\n\n```\ninclude = /etc/frontview/samba/smb.conf.defaults\ninclude = /etc/frontview/samba/smb.conf.%a\ninclude = /etc/frontview/samba/smb.conf.overrides\ninclude = /etc/frontview/samba/Shares.conf\ninclude = /etc/frontview/samba/Shares.conf.%G\ninclude = /etc/frontview/samba/addons/addons.conf\ninclude = /run/usb/samba/Shares.conf\n```\n\nと複数のconfファイルを参照しているので、いずれかに先の内容を追記すればいい。\n私は\n\n```\ninclude = /etc/frontview/samba/smb.conf.defaults\n```\n\nを選んだ。\n\nただし、ReadyOSのアップデートの度に、confファイルは修正されてしまうようで、毎度修正の必要がある。\n\n\n"],"coediting":[false],"comments_count":[0],"created_at":["2017-10-06T23:20:04+09:00"],"group":{},"id":["3fb6ecf60a2940d93bad"],"likes_count":[0],"private":[false],"reactions_count":[0],"tags":[{"name":["Linux"],"versions":[]},{"name":["samba"],"versions":[]},{"name":["NAS"],"versions":[]}],"title":["ReadyNASの共有フォルダにシンボリックリンクを作成する"],"updated_at":["2017-10-06T23:20:04+09:00"],"url":["https://qiita.com/Atsushi776/items/3fb6ecf60a2940d93bad"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["\n<h1>\n<span id=\"rmarkdownとは\" class=\"fragment\"><\/span><a href=\"#rmarkdown%E3%81%A8%E3%81%AF\"><i class=\"fa fa-link\"><\/i><\/a>rmarkdownとは<\/h1>\n\n<p>Rでデータ解析した結果(プロットなど)に、その説明や解釈をドキュメントとして加えたhtml, pdf, docxなどを出力できるスゴい奴。<\/p>\n\n<p>詳しい説明は日本語でもいっぱいあります(<a href=\"https://kazutan.github.io/kazutanR/Rmd_intro.html#r_markdown%E3%81%A8%E3%81%AF\" rel=\"nofollow noopener\" target=\"_blank\">kazutanさんのとか<\/a>)<\/p>\n\n<h1>\n<span id=\"レポートが長くなった時に\" class=\"fragment\"><\/span><a href=\"#%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88%E3%81%8C%E9%95%B7%E3%81%8F%E3%81%AA%E3%81%A3%E3%81%9F%E6%99%82%E3%81%AB\"><i class=\"fa fa-link\"><\/i><\/a>レポートが長くなった時に<\/h1>\n\n<p>ファイルを分割したくなりますよね。<\/p>\n\n<p>そんなあなたに<code>child<\/code>引数。<\/p>\n\n<p>```{r, child = 'ichiro.Rmd'}<\/p>\n\n<p>```<\/p>\n\n<p>とすると、親のRmdファイルの任意の場所にichiro.Rmdを挿入できます。<br>\nchildはmdファイルでもOK<\/p>\n\n<h1>\n<span id=\"もっとレポートが長くなった時に\" class=\"fragment\"><\/span><a href=\"#%E3%82%82%E3%81%A3%E3%81%A8%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88%E3%81%8C%E9%95%B7%E3%81%8F%E3%81%AA%E3%81%A3%E3%81%9F%E6%99%82%E3%81%AB\"><i class=\"fa fa-link\"><\/i><\/a>もっとレポートが長くなった時に<\/h1>\n\n<p>もっとファイルを分割したくなりますよね。<\/p>\n\n<p>```{r, child = 'ichiro.Rmd'}<\/p>\n\n<p>```<\/p>\n\n<p>```{r, child = 'jiro.Rmd'}<\/p>\n\n<p>```<\/p>\n\n<p>みたいなコードを何度も繰り返すのか……？<br>\nムダに複数行使うし、順番変えにくいし……。<\/p>\n\n<p>英単語のchildは単数形ですが、引数のchildは一人に限定しません。<\/p>\n\n<p>```{r, child = c('ichiro.Rmd', 'jiro.Rmd', 'saburo.Rmd', 'shiro.Rmd')}<\/p>\n\n<p>```<\/p>\n\n<p>なんてことが可能なのです。<br>\nこれなら、<code>c()<\/code>の中でRmdの順番を変えるなり、足すなり引くなり自由自在。<\/p>\n\n<p>直前のチャンクで<code>x &lt;- dir(pattern = '\\\\.Rmd$')<\/code>なんてしえおけばディレクトリ内にあるRmdファイルを一辺に合体なんてことも可能。<br>\nこれはbookdownを使うことでも可能(また<a href=\"https://kazutan.github.io/JapanR2016/JapanR2016.html#/\" rel=\"nofollow noopener\" target=\"_blank\">kazutanさんの説明参照<\/a>)なのだけれど、スライド作りには使えないんだよなあ。<br>\nrevealjsを使いたいので、こんな方法を考えてみました。<\/p>\n"],"body":["#rmarkdownとは\n\nRでデータ解析した結果(プロットなど)に、その説明や解釈をドキュメントとして加えたhtml, pdf, docxなどを出力できるスゴい奴。\n\n詳しい説明は日本語でもいっぱいあります([kazutanさんのとか](https://kazutan.github.io/kazutanR/Rmd_intro.html#r_markdownとは))\n\n#レポートが長くなった時に\n\nファイルを分割したくなりますよね。\n\nそんなあなたに`child`引数。\n\n\\```{r, child = 'ichiro.Rmd'}\n\n\\```\n\nとすると、親のRmdファイルの任意の場所にichiro.Rmdを挿入できます。\nchildはmdファイルでもOK\n\n#もっとレポートが長くなった時に\n\nもっとファイルを分割したくなりますよね。\n\n\n\\```{r, child = 'ichiro.Rmd'}\n\n\\```\n\n\\```{r, child = 'jiro.Rmd'}\n\n\\```\n\n\nみたいなコードを何度も繰り返すのか……？\nムダに複数行使うし、順番変えにくいし……。\n\n英単語のchildは単数形ですが、引数のchildは一人に限定しません。\n\n\\```{r, child = c('ichiro.Rmd', 'jiro.Rmd', 'saburo.Rmd', 'shiro.Rmd')}\n\n\\```\n\nなんてことが可能なのです。\nこれなら、`c()`の中でRmdの順番を変えるなり、足すなり引くなり自由自在。\n\n直前のチャンクで`x <- dir(pattern = '\\\\.Rmd$')`なんてしえおけばディレクトリ内にあるRmdファイルを一辺に合体なんてことも可能。\nこれはbookdownを使うことでも可能(また[kazutanさんの説明参照](https://kazutan.github.io/JapanR2016/JapanR2016.html#/))なのだけれど、スライド作りには使えないんだよなあ。\nrevealjsを使いたいので、こんな方法を考えてみました。\n"],"coediting":[false],"comments_count":[0],"created_at":["2017-09-21T13:49:51+09:00"],"group":{},"id":["d96e39caf14042ef8327"],"likes_count":[3],"private":[false],"reactions_count":[0],"tags":[{"name":["R"],"versions":[]},{"name":["RMarkdown"],"versions":[]}],"title":["rmakdownのchildは単数形だけど一人じゃない"],"updated_at":["2019-04-12T16:50:45+09:00"],"url":["https://qiita.com/Atsushi776/items/d96e39caf14042ef8327"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["<p>2019/3/19<\/p>\n\n<p>こちらにもっと簡単な方法を紹介しました (通知が遅くなりました)．<\/p>\n\n<p>「geom_histogramのビン幅を動的に決定する」<br>\n<a href=\"https://blog.atusy.net/2018/11/09/binwdith-for-geom-histogram/\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\">https://blog.atusy.net/2018/11/09/binwdith-for-geom-histogram/<\/a><\/p>\n\n<p><a href=\"#facet%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E5%A4%9A%E5%A4%89%E9%87%8F%E3%81%AE%E3%83%92%E3%82%B9%E3%83%88%E3%82%B0%E3%83%A9%E3%83%A0%E3%82%92%E3%81%84%E3%81%A3%E3%81%BA%E3%82%93%E3%81%AB%E4%BD%9C%E3%82%8B\">facetを使って多変量のヒストグラムをいっぺんに作る<\/a> 場合は本記事，最終節参照です．<\/p>\n\n<h1>\n<span id=\"はじめに\" class=\"fragment\"><\/span><a href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"><i class=\"fa fa-link\"><\/i><\/a>はじめに<\/h1>\n\n<p><code>ggplot2：：geom_histogram<\/code>はデフォルトでビン数が30に固定されている．<br>\n試しにプロットすると，<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"n\">iris<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">Sepal.Length<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\"> <\/span><span class=\"n\">geom_histogram<\/span><span class=\"p\">()<\/span><span class=\"w\">\n<\/span><span class=\"n\">`stat_bin()`<\/span><span class=\"w\"> <\/span><span class=\"n\">using<\/span><span class=\"w\"> <\/span><span class=\"n\">`bins = 30`.<\/span><span class=\"w\"> <\/span><span class=\"n\">Pick<\/span><span class=\"w\"> <\/span><span class=\"n\">better<\/span><span class=\"w\"> <\/span><span class=\"n\">value<\/span><span class=\"w\"> <\/span><span class=\"n\">with<\/span><span class=\"w\"> <\/span><span class=\"n\">`binwidth`.<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>なんて返ってきて，ビン数(幅)は自分で調整してねと言われる．<br>\nこれは探索的すぎて多変量を見たい時なんて特に面倒だ．<\/p>\n\n<p>できれば，<code>graphics::hist<\/code>のように自動で決めてほしいし，なんなら，ビン幅を決めるアルゴリズムを任意に選択したい(<code>graphics::hist<\/code>でいうbreaks引数の指定)．<\/p>\n\n<h1>\n<span id=\"graphicshistと合体だ\" class=\"fragment\"><\/span><a href=\"#graphicshist%E3%81%A8%E5%90%88%E4%BD%93%E3%81%A0\"><i class=\"fa fa-link\"><\/i><\/a><code>graphics::hist<\/code>と合体だ!<\/h1>\n\n<p><code>graphics::hist<\/code>はhistogramクラスのリストを返す．<br>\n(引数<code>plot<\/code>がTRUEならプロットし，リストをinvisibleに返し，FALSEならプロットせずにリストをreturnする)<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"o\">&gt;<\/span><span class=\"w\"> <\/span><span class=\"n\">str<\/span><span class=\"p\">(<\/span><span class=\"n\">hist<\/span><span class=\"p\">(<\/span><span class=\"n\">iris<\/span><span class=\"p\">[[<\/span><span class=\"m\">1<\/span><span class=\"p\">]]))<\/span><span class=\"w\">\n<\/span><span class=\"n\">List<\/span><span class=\"w\"> <\/span><span class=\"n\">of<\/span><span class=\"w\"> <\/span><span class=\"m\">6<\/span><span class=\"w\">\n <\/span><span class=\"o\">$<\/span><span class=\"w\"> <\/span><span class=\"n\">breaks<\/span><span class=\"w\">  <\/span><span class=\"o\">:<\/span><span class=\"w\"> <\/span><span class=\"n\">num<\/span><span class=\"w\"> <\/span><span class=\"p\">[<\/span><span class=\"m\">1<\/span><span class=\"o\">:<\/span><span class=\"m\">9<\/span><span class=\"p\">]<\/span><span class=\"w\"> <\/span><span class=\"m\">4<\/span><span class=\"w\"> <\/span><span class=\"m\">4.5<\/span><span class=\"w\"> <\/span><span class=\"m\">5<\/span><span class=\"w\"> <\/span><span class=\"m\">5.5<\/span><span class=\"w\"> <\/span><span class=\"m\">6<\/span><span class=\"w\"> <\/span><span class=\"m\">6.5<\/span><span class=\"w\"> <\/span><span class=\"m\">7<\/span><span class=\"w\"> <\/span><span class=\"m\">7.5<\/span><span class=\"w\"> <\/span><span class=\"m\">8<\/span><span class=\"w\">\n <\/span><span class=\"o\">$<\/span><span class=\"w\"> <\/span><span class=\"n\">counts<\/span><span class=\"w\">  <\/span><span class=\"o\">:<\/span><span class=\"w\"> <\/span><span class=\"n\">int<\/span><span class=\"w\"> <\/span><span class=\"p\">[<\/span><span class=\"m\">1<\/span><span class=\"o\">:<\/span><span class=\"m\">8<\/span><span class=\"p\">]<\/span><span class=\"w\"> <\/span><span class=\"m\">5<\/span><span class=\"w\"> <\/span><span class=\"m\">27<\/span><span class=\"w\"> <\/span><span class=\"m\">27<\/span><span class=\"w\"> <\/span><span class=\"m\">30<\/span><span class=\"w\"> <\/span><span class=\"m\">31<\/span><span class=\"w\"> <\/span><span class=\"m\">18<\/span><span class=\"w\"> <\/span><span class=\"m\">6<\/span><span class=\"w\"> <\/span><span class=\"m\">6<\/span><span class=\"w\">\n <\/span><span class=\"o\">$<\/span><span class=\"w\"> <\/span><span class=\"n\">density<\/span><span class=\"w\"> <\/span><span class=\"o\">:<\/span><span class=\"w\"> <\/span><span class=\"n\">num<\/span><span class=\"w\"> <\/span><span class=\"p\">[<\/span><span class=\"m\">1<\/span><span class=\"o\">:<\/span><span class=\"m\">8<\/span><span class=\"p\">]<\/span><span class=\"w\"> <\/span><span class=\"m\">0.0667<\/span><span class=\"w\"> <\/span><span class=\"m\">0.36<\/span><span class=\"w\"> <\/span><span class=\"m\">0.36<\/span><span class=\"w\"> <\/span><span class=\"m\">0.4<\/span><span class=\"w\"> <\/span><span class=\"m\">0.4133<\/span><span class=\"w\"> <\/span><span class=\"n\">...<\/span><span class=\"w\">\n <\/span><span class=\"o\">$<\/span><span class=\"w\"> <\/span><span class=\"n\">mids<\/span><span class=\"w\">    <\/span><span class=\"o\">:<\/span><span class=\"w\"> <\/span><span class=\"n\">num<\/span><span class=\"w\"> <\/span><span class=\"p\">[<\/span><span class=\"m\">1<\/span><span class=\"o\">:<\/span><span class=\"m\">8<\/span><span class=\"p\">]<\/span><span class=\"w\"> <\/span><span class=\"m\">4.25<\/span><span class=\"w\"> <\/span><span class=\"m\">4.75<\/span><span class=\"w\"> <\/span><span class=\"m\">5.25<\/span><span class=\"w\"> <\/span><span class=\"m\">5.75<\/span><span class=\"w\"> <\/span><span class=\"m\">6.25<\/span><span class=\"w\"> <\/span><span class=\"m\">6.75<\/span><span class=\"w\"> <\/span><span class=\"m\">7.25<\/span><span class=\"w\"> <\/span><span class=\"m\">7.75<\/span><span class=\"w\">\n <\/span><span class=\"o\">$<\/span><span class=\"w\"> <\/span><span class=\"n\">xname<\/span><span class=\"w\">   <\/span><span class=\"o\">:<\/span><span class=\"w\"> <\/span><span class=\"n\">chr<\/span><span class=\"w\"> <\/span><span class=\"s2\">\"iris[[1]]\"<\/span><span class=\"w\">\n <\/span><span class=\"o\">$<\/span><span class=\"w\"> <\/span><span class=\"n\">equidist<\/span><span class=\"o\">:<\/span><span class=\"w\"> <\/span><span class=\"n\">logi<\/span><span class=\"w\"> <\/span><span class=\"kc\">TRUE<\/span><span class=\"w\">\n <\/span><span class=\"o\">-<\/span><span class=\"w\"> <\/span><span class=\"nf\">attr<\/span><span class=\"p\">(<\/span><span class=\"o\">*<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"s2\">\"class\"<\/span><span class=\"p\">)<\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">chr<\/span><span class=\"w\"> <\/span><span class=\"s2\">\"histogram\"<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>このmidsとcountsを用いてggplot2で棒グラフを作ればいいのだ．<\/p>\n\n<h1>\n<span id=\"やってみよう\" class=\"fragment\"><\/span><a href=\"#%E3%82%84%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%88%E3%81%86\"><i class=\"fa fa-link\"><\/i><\/a>やってみよう<\/h1>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"w\">\n<\/span><span class=\"n\">library<\/span><span class=\"p\">(<\/span><span class=\"n\">ggplot2<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"n\">library<\/span><span class=\"p\">(<\/span><span class=\"n\">dplyr<\/span><span class=\"p\">)<\/span><span class=\"w\">\n\n<\/span><span class=\"n\">iris<\/span><span class=\"p\">[[<\/span><span class=\"m\">1<\/span><span class=\"p\">]]<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\"> <\/span><span class=\"c1\">#ヒストグラムを作るデータ<\/span><span class=\"w\">\n  <\/span><span class=\"n\">hist<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\"> <\/span><span class=\"c1\">#度数分布の計算．<\/span><span class=\"w\">\n  <\/span><span class=\"n\">`[`<\/span><span class=\"p\">(<\/span><span class=\"nf\">c<\/span><span class=\"p\">(<\/span><span class=\"s1\">'mids'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"s1\">'counts'<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\"> <\/span><span class=\"c1\">#必要なデータの取り出し<\/span><span class=\"w\">\n  <\/span><span class=\"n\">as.data.frame<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\"> <\/span><span class=\"c1\">#ggplotが受けつけるデータフレームの形に直す<\/span><span class=\"w\">\n  <\/span><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">mids<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">counts<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\"> <\/span><span class=\"c1\">#プロット<\/span><span class=\"w\">\n  <\/span><span class=\"n\">`+`<\/span><span class=\"p\">(<\/span><span class=\"n\">geom_col<\/span><span class=\"p\">())<\/span><span class=\"w\">\n\n\n<\/span><\/pre><\/div><\/div>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F021bfe15-ba80-e742-f066-bf0ba6f545bc.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=bc748d6a8fa87dc8428240c12aadf981\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F021bfe15-ba80-e742-f066-bf0ba6f545bc.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=bc748d6a8fa87dc8428240c12aadf981\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/021bfe15-ba80-e742-f066-bf0ba6f545bc.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F021bfe15-ba80-e742-f066-bf0ba6f545bc.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=76ed2f32b1fd17de9a3df5a05d29f00c 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>棒と棒の間に隙間があるのは，histogramとしては不恰好だし，ビンの幅によってはまるでデータのない部分かのように見えてしまうだろう．<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"w\">\n<\/span><span class=\"n\">library<\/span><span class=\"p\">(<\/span><span class=\"n\">ggplot2<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"n\">library<\/span><span class=\"p\">(<\/span><span class=\"n\">dplyr<\/span><span class=\"p\">)<\/span><span class=\"w\">\n\n<\/span><span class=\"n\">iris<\/span><span class=\"p\">[[<\/span><span class=\"m\">1<\/span><span class=\"p\">]]<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\"> <\/span><span class=\"c1\">#ヒストグラムを作るデータ<\/span><span class=\"w\">\n  <\/span><span class=\"n\">hist<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\"> <\/span><span class=\"c1\">#度数分布の計算．<\/span><span class=\"w\">\n  <\/span><span class=\"n\">`[`<\/span><span class=\"p\">(<\/span><span class=\"nf\">c<\/span><span class=\"p\">(<\/span><span class=\"s1\">'mids'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"s1\">'counts'<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\"> <\/span><span class=\"c1\">#必要なデータの取り出し<\/span><span class=\"w\">\n  <\/span><span class=\"n\">as.data.frame<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\"> <\/span><span class=\"c1\">#ggplotが受けつけるデータフレームの形に直す<\/span><span class=\"w\">\n  <\/span><span class=\"n\">mutate<\/span><span class=\"p\">(<\/span><span class=\"n\">width<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">mids<\/span><span class=\"p\">[<\/span><span class=\"m\">2<\/span><span class=\"p\">]<\/span><span class=\"w\"> <\/span><span class=\"o\">-<\/span><span class=\"w\"> <\/span><span class=\"n\">mids<\/span><span class=\"p\">[<\/span><span class=\"m\">1<\/span><span class=\"p\">])<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\"> <\/span><span class=\"c1\">#ビン幅の設定<\/span><span class=\"w\">\n  <\/span><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">mids<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">counts<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">width<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">width<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\"> <\/span><span class=\"c1\">#プロット<\/span><span class=\"w\">\n  <\/span><span class=\"n\">`+`<\/span><span class=\"p\">(<\/span><span class=\"n\">geom_col<\/span><span class=\"p\">())<\/span><span class=\"w\">\n\n\n<\/span><\/pre><\/div><\/div>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F4c272e84-8452-9a11-1b38-9a066d2b5319.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=5d8f1c125498165e04fb52bf17ab22ac\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F4c272e84-8452-9a11-1b38-9a066d2b5319.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=5d8f1c125498165e04fb52bf17ab22ac\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/4c272e84-8452-9a11-1b38-9a066d2b5319.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F4c272e84-8452-9a11-1b38-9a066d2b5319.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=df1dd8636b4bdd1ad783817dc4e4d921 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>ぽくなったぞ!<\/p>\n\n<h1>\n<span id=\"facetを使って多変量のヒストグラムをいっぺんに作る\" class=\"fragment\"><\/span><a href=\"#facet%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E5%A4%9A%E5%A4%89%E9%87%8F%E3%81%AE%E3%83%92%E3%82%B9%E3%83%88%E3%82%B0%E3%83%A9%E3%83%A0%E3%82%92%E3%81%84%E3%81%A3%E3%81%BA%E3%82%93%E3%81%AB%E4%BD%9C%E3%82%8B\"><i class=\"fa fa-link\"><\/i><\/a>facetを使って多変量のヒストグラムをいっぺんに作る!<\/h1>\n\n<p>ここからはdplyrやtidyrに慣れていないと辛い<\/p>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">library<\/span><span class=\"p\">(<\/span><span class=\"n\">ggplot2<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"n\">library<\/span><span class=\"p\">(<\/span><span class=\"n\">dplyr<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"n\">library<\/span><span class=\"p\">(<\/span><span class=\"n\">tidyr<\/span><span class=\"p\">)<\/span><span class=\"w\">\n\n<\/span><span class=\"n\">iris<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">gather<\/span><span class=\"p\">(<\/span><span class=\"n\">var<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">val<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"o\">-<\/span><span class=\"n\">Species<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">group_by<\/span><span class=\"p\">(<\/span><span class=\"n\">var<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">summarise<\/span><span class=\"p\">(<\/span><span class=\"w\">\n    <\/span><span class=\"n\">data<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"nf\">list<\/span><span class=\"p\">(<\/span><span class=\"n\">data.frame<\/span><span class=\"p\">(<\/span><span class=\"n\">hist<\/span><span class=\"p\">(<\/span><span class=\"n\">val<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">breaks<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"s1\">'Scott'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">plot<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"kc\">FALSE<\/span><span class=\"p\">)[<\/span><span class=\"nf\">c<\/span><span class=\"p\">(<\/span><span class=\"s1\">'mids'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"s1\">'counts'<\/span><span class=\"p\">)]))<\/span><span class=\"w\">\n  <\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">ungroup<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\"> \n  <\/span><span class=\"n\">mutate<\/span><span class=\"p\">(<\/span><span class=\"n\">data<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">map<\/span><span class=\"p\">(<\/span><span class=\"n\">data<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">mutate<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">width<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">mids<\/span><span class=\"p\">[<\/span><span class=\"m\">2<\/span><span class=\"p\">]<\/span><span class=\"w\"> <\/span><span class=\"o\">-<\/span><span class=\"w\"> <\/span><span class=\"n\">mids<\/span><span class=\"p\">[<\/span><span class=\"m\">1<\/span><span class=\"p\">]))<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">unnest<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">mids<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">counts<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">width<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">width<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\">\n  <\/span><span class=\"n\">`+`<\/span><span class=\"p\">(<\/span><span class=\"nf\">list<\/span><span class=\"p\">(<\/span><span class=\"w\">\n    <\/span><span class=\"n\">geom_col<\/span><span class=\"p\">(),<\/span><span class=\"w\">\n    <\/span><span class=\"n\">facet_grid<\/span><span class=\"p\">(<\/span><span class=\"n\">.<\/span><span class=\"w\"> <\/span><span class=\"o\">~<\/span><span class=\"w\"> <\/span><span class=\"n\">var<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">scale<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"s1\">'free'<\/span><span class=\"p\">)<\/span><span class=\"w\">\n  <\/span><span class=\"p\">))<\/span><span class=\"w\">\n\n<\/span><\/pre><\/div><\/div>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F75a70cbb-8caa-88cc-d70f-bc42573f65d0.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=c23f399c4228e86aaa446d65b3675a31\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F75a70cbb-8caa-88cc-d70f-bc42573f65d0.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=c23f399c4228e86aaa446d65b3675a31\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/75a70cbb-8caa-88cc-d70f-bc42573f65d0.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F75a70cbb-8caa-88cc-d70f-bc42573f65d0.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=fa5d4eee26cc7e4c4f0f80a13ab38b0f 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>変数ごとにビン幅を変えることに成功した!<\/p>\n"],"body":["\n2019/3/19\n\nこちらにもっと簡単な方法を紹介しました (通知が遅くなりました)．\n\n「geom_histogramのビン幅を動的に決定する」\nhttps://blog.atusy.net/2018/11/09/binwdith-for-geom-histogram/\n\n[facetを使って多変量のヒストグラムをいっぺんに作る](#facetを使って多変量のヒストグラムをいっぺんに作る) 場合は本記事，最終節参照です．\n\n#はじめに\n\n`ggplot2：：geom_histogram`はデフォルトでビン数が30に固定されている．\n試しにプロットすると，\n\n```r\nggplot(iris, aes(x = Sepal.Length)) + geom_histogram()\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n```\n\nなんて返ってきて，ビン数(幅)は自分で調整してねと言われる．\nこれは探索的すぎて多変量を見たい時なんて特に面倒だ．\n\nできれば，`graphics::hist`のように自動で決めてほしいし，なんなら，ビン幅を決めるアルゴリズムを任意に選択したい(`graphics::hist`でいうbreaks引数の指定)．\n\n#`graphics::hist`と合体だ!\n\n`graphics::hist`はhistogramクラスのリストを返す．\n(引数`plot`がTRUEならプロットし，リストをinvisibleに返し，FALSEならプロットせずにリストをreturnする)\n\n```r\n> str(hist(iris[[1]]))\nList of 6\n $ breaks  : num [1:9] 4 4.5 5 5.5 6 6.5 7 7.5 8\n $ counts  : int [1:8] 5 27 27 30 31 18 6 6\n $ density : num [1:8] 0.0667 0.36 0.36 0.4 0.4133 ...\n $ mids    : num [1:8] 4.25 4.75 5.25 5.75 6.25 6.75 7.25 7.75\n $ xname   : chr \"iris[[1]]\"\n $ equidist: logi TRUE\n - attr(*, \"class\")= chr \"histogram\"\n```\n\nこのmidsとcountsを用いてggplot2で棒グラフを作ればいいのだ．\n\n#やってみよう\n\n```r\n\nlibrary(ggplot2)\nlibrary(dplyr)\n\niris[[1]] %>% #ヒストグラムを作るデータ\n  hist %>% #度数分布の計算．\n  `[`(c('mids', 'counts')) %>% #必要なデータの取り出し\n  as.data.frame %>% #ggplotが受けつけるデータフレームの形に直す\n  ggplot(aes(x = mids, y = counts)) %>% #プロット\n  `+`(geom_col())\n  \n\n```\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/021bfe15-ba80-e742-f066-bf0ba6f545bc.png)\n\n棒と棒の間に隙間があるのは，histogramとしては不恰好だし，ビンの幅によってはまるでデータのない部分かのように見えてしまうだろう．\n\n```r\n\nlibrary(ggplot2)\nlibrary(dplyr)\n\niris[[1]] %>% #ヒストグラムを作るデータ\n  hist %>% #度数分布の計算．\n  `[`(c('mids', 'counts')) %>% #必要なデータの取り出し\n  as.data.frame %>% #ggplotが受けつけるデータフレームの形に直す\n  mutate(width = mids[2] - mids[1]) %>% #ビン幅の設定\n  ggplot(aes(x = mids, y = counts, width = width)) %>% #プロット\n  `+`(geom_col())\n  \n\n```\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/4c272e84-8452-9a11-1b38-9a066d2b5319.png)\n\nぽくなったぞ!\n\n#facetを使って多変量のヒストグラムをいっぺんに作る!\n\nここからはdplyrやtidyrに慣れていないと辛い\n\n```r\nlibrary(ggplot2)\nlibrary(dplyr)\nlibrary(tidyr)\n\niris %>%\n  gather(var, val, -Species) %>%\n  group_by(var) %>%\n  summarise(\n    data = list(data.frame(hist(val, breaks = 'Scott', plot = FALSE)[c('mids', 'counts')]))\n  ) %>%\n  ungroup %>% \n  mutate(data = map(data, mutate, width = mids[2] - mids[1])) %>%\n  unnest %>%\n  ggplot(aes(x = mids, y = counts, width = width)) %>%\n  `+`(list(\n    geom_col(),\n    facet_grid(. ~ var, scale = 'free')\n  ))\n\n```\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/75a70cbb-8caa-88cc-d70f-bc42573f65d0.png)\n\n変数ごとにビン幅を変えることに成功した!\n\n"],"coediting":[false],"comments_count":[2],"created_at":["2017-09-08T17:37:26+09:00"],"group":{},"id":["f71a6f011118031f6e0a"],"likes_count":[5],"private":[false],"reactions_count":[0],"tags":[{"name":["R"],"versions":[]},{"name":["ggplot2"],"versions":[]},{"name":["histogram"],"versions":[]}],"title":["ggplot2でビン幅を自動的に決めたヒストグラム"],"updated_at":["2019-03-19T08:50:46+09:00"],"url":["https://qiita.com/Atsushi776/items/f71a6f011118031f6e0a"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["\n<h1>\n<span id=\"発端\" class=\"fragment\"><\/span><a href=\"#%E7%99%BA%E7%AB%AF\"><i class=\"fa fa-link\"><\/i><\/a>発端<\/h1>\n\n<p>Ubuntu 14.04 LTSを16.04LTSにアップグレードしようと思ったが，<\/p>\n\n<p><code>sudo apt-get update<\/code><\/p>\n\n<p>で404エラー続出．<br>\n無視して以下を実行しようとするものの<\/p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>sudo apt-get upgrade\nsudo do-release-upgrade\nsudo reboot\nsudo do-release-upgrade -d\nsudo reboot\n<\/pre><\/div><\/div>\n\n<p>404エラーのせいで<code>sudo do-release-upgrade<\/code>が止まる．<\/p>\n\n<h1>\n<span id=\"ネット上で見かける解\" class=\"fragment\"><\/span><a href=\"#%E3%83%8D%E3%83%83%E3%83%88%E4%B8%8A%E3%81%A7%E8%A6%8B%E3%81%8B%E3%81%91%E3%82%8B%E8%A7%A3\"><i class=\"fa fa-link\"><\/i><\/a>ネット上で見かける解<\/h1>\n\n<p><a href=\"http://qiita.com/ytyng/items/76784390a538bbb5117e\" class=\"autolink\" id=\"reference-32f16b026d597a216d9a\">http://qiita.com/ytyng/items/76784390a538bbb5117e<\/a><br>\nによると404エラーは古いバージョンのUbuntuを使っていると置きるらしく，<\/p>\n\n<p><code>/etc/apt/source.list<\/code><\/p>\n\n<p>に含まれるsecurity.ubuntu.comとarchive.ubuntu.comをold-release.ubuntu.comに置換すればいいとされる．<br>\nそれは以下のコードで一発．<\/p>\n\n<p><code>sudo sed -i -e 's/archive.ubuntu.com\\|security.ubuntu.com/old-releases.ubuntu.com/g' /etc/apt/sources.list<\/code><\/p>\n\n<p>しかし，やはり404エラーが出る．<\/p>\n\n<p>Ubuntu 14.04 LTSの通称はtrustyだが，<\/p>\n\n<p><a href=\"http://old-releases.ubuntu.com/ubuntu/dists/\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\">http://old-releases.ubuntu.com/ubuntu/dists/<\/a><\/p>\n\n<p>を見ると，trustyが含まれていない．<br>\nつまり，trustyはまだold-releaseではないらしいのだ．<\/p>\n\n<h1>\n<span id=\"結局どうするか\" class=\"fragment\"><\/span><a href=\"#%E7%B5%90%E5%B1%80%E3%81%A9%E3%81%86%E3%81%99%E3%82%8B%E3%81%8B\"><i class=\"fa fa-link\"><\/i><\/a>結局どうするか<\/h1>\n\n<p>source.listを初期化してみたところうまくいった．<\/p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>sudo rm /etc/apt/sources.list\nsudo -i software-properties-gtk\n<\/pre><\/div><\/div>\n\n<p>を実行した後，適宜レポジトリを選択し直す．<br>\n今回は<br>\n<a href=\"https://askubuntu.com/questions/124017/how-do-i-restore-the-default-repositories\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\">https://askubuntu.com/questions/124017/how-do-i-restore-the-default-repositories<\/a><br>\nを見ながらGUIで行った．<\/p>\n\n<p>これで<\/p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>sudo apt-get update\nsudo apt-get upgrade\nsudo do-release-upgrade\nsudo reboot\nsudo do-release-upgrade -d\nsudo reboot\n<\/pre><\/div><\/div>\n\n<p>すれば無事更新されるはずだ．<\/p>\n\n<h1>\n<span id=\"おまけ-bootの空き容量が足りない\" class=\"fragment\"><\/span><a href=\"#%E3%81%8A%E3%81%BE%E3%81%91-boot%E3%81%AE%E7%A9%BA%E3%81%8D%E5%AE%B9%E9%87%8F%E3%81%8C%E8%B6%B3%E3%82%8A%E3%81%AA%E3%81%84\"><i class=\"fa fa-link\"><\/i><\/a>おまけ: \\bootの空き容量が足りない!<\/h1>\n\n<p>無事に行くと思ったらまた<code>sudo do-release-upgrade<\/code>で躓いた．<br>\n今度は<code>\\boot<\/code>の空き領域が足りないらしい．<br>\nこれは古いバージョンのカーネルを削除すればOK<\/p>\n\n<p><code>dpkg -l linux-image-\\* | grep ^ii<\/code><\/p>\n\n<p>でインストールされているカーネルの一覧を出し，古いものを削除する<\/p>\n\n<p><code>apt-get purge linux-image-hogehoge<\/code><\/p>\n"],"body":["#発端\n\nUbuntu 14.04 LTSを16.04LTSにアップグレードしようと思ったが，\n\n`sudo apt-get update`\n\nで404エラー続出．\n無視して以下を実行しようとするものの\n\n```\nsudo apt-get upgrade\nsudo do-release-upgrade\nsudo reboot\nsudo do-release-upgrade -d\nsudo reboot\n```\n\n404エラーのせいで`sudo do-release-upgrade`が止まる．\n\n#ネット上で見かける解\n\nhttp://qiita.com/ytyng/items/76784390a538bbb5117e\nによると404エラーは古いバージョンのUbuntuを使っていると置きるらしく，\n\n`/etc/apt/source.list`\n\nに含まれるsecurity.ubuntu.comとarchive.ubuntu.comをold-release.ubuntu.comに置換すればいいとされる．\nそれは以下のコードで一発．\n\n`sudo sed -i -e 's/archive.ubuntu.com\\|security.ubuntu.com/old-releases.ubuntu.com/g' /etc/apt/sources.list`\n\nしかし，やはり404エラーが出る．\n\nUbuntu 14.04 LTSの通称はtrustyだが，\n\nhttp://old-releases.ubuntu.com/ubuntu/dists/\n\nを見ると，trustyが含まれていない．\nつまり，trustyはまだold-releaseではないらしいのだ．\n\n#結局どうするか\n\nsource.listを初期化してみたところうまくいった．\n\n```\nsudo rm /etc/apt/sources.list\nsudo -i software-properties-gtk\n```\n\nを実行した後，適宜レポジトリを選択し直す．\n今回は\nhttps://askubuntu.com/questions/124017/how-do-i-restore-the-default-repositories\nを見ながらGUIで行った．\n\nこれで\n\n\n```\nsudo apt-get update\nsudo apt-get upgrade\nsudo do-release-upgrade\nsudo reboot\nsudo do-release-upgrade -d\nsudo reboot\n```\n\nすれば無事更新されるはずだ．\n\n#おまけ: \\bootの空き容量が足りない!\n\n無事に行くと思ったらまた`sudo do-release-upgrade`で躓いた．\n今度は`\\boot`の空き領域が足りないらしい．\nこれは古いバージョンのカーネルを削除すればOK\n\n`dpkg -l linux-image-\\* | grep ^ii`\n\nでインストールされているカーネルの一覧を出し，古いものを削除する\n\n`apt-get purge linux-image-hogehoge`\n"],"coediting":[false],"comments_count":[0],"created_at":["2017-07-26T17:16:09+09:00"],"group":{},"id":["cb8d7d5bbce53d374a41"],"likes_count":[11],"private":[false],"reactions_count":[0],"tags":[{"name":["Linux"],"versions":[]},{"name":["Ubuntu"],"versions":[]},{"name":["apt"],"versions":[]}],"title":["apt-get updateで404"],"updated_at":["2017-07-26T17:16:09+09:00"],"url":["https://qiita.com/Atsushi776/items/cb8d7d5bbce53d374a41"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["<p>数式中で一部の文字をノンイタリック(ローマン体)にしたい場合がある。<\/p>\n\n<p>$a_\\mathrm{a}$<\/p>\n\n<p>この時使えるコマンドには<\/p>\n\n<div class=\"code-frame\" data-lang=\"TeX\"><div class=\"highlight\"><pre><span class=\"k\">\\rm<\/span>\n<\/pre><\/div><\/div>\n\n<p>$$a_\\rm{a}$$<\/p>\n\n<div class=\"code-frame\" data-lang=\"TeX\"><div class=\"highlight\"><pre><span class=\"k\">\\mathrm<\/span>\n<\/pre><\/div><\/div>\n\n<p>$$a_\\textrm{a}$$<\/p>\n\n<div class=\"code-frame\" data-lang=\"TeX\"><div class=\"highlight\"><pre><span class=\"k\">\\textrm<\/span>\n<\/pre><\/div><\/div>\n\n<p>$$a_\\mathrm{a}$$<\/p>\n\n<p>があるが、<code>\\rm<\/code>は古く推奨されないらしい。<br>\nそのせいか、Rmdをhtmlやpdfに変換する時はいいが、wordに変換すると、数式にならない。<br>\n適宜<code>\\mathrm<\/code>や<code>\\textrm<\/code>を使おう。<\/p>\n"],"body":["数式中で一部の文字をノンイタリック(ローマン体)にしたい場合がある。\n\n$a_\\mathrm{a}$\n\nこの時使えるコマンドには\n\n```TeX\n\\rm\n```\n\n$$a_\\rm{a}$$\n\n```TeX\n\\mathrm\n```\n$$a_\\textrm{a}$$\n\n```TeX\n\\textrm\n```\n$$a_\\mathrm{a}$$\n\nがあるが、`\\rm`は古く推奨されないらしい。\nそのせいか、Rmdをhtmlやpdfに変換する時はいいが、wordに変換すると、数式にならない。\n適宜`\\mathrm`や`\\textrm`を使おう。\n"],"coediting":[false],"comments_count":[0],"created_at":["2017-07-10T18:19:14+09:00"],"group":{},"id":["215cec9f59b0814c1367"],"likes_count":[0],"private":[false],"reactions_count":[0],"tags":[{"name":["LaTeX"],"versions":[]},{"name":["R"],"versions":[]},{"name":["Word"],"versions":[]},{"name":["RMarkdown"],"versions":[]}],"title":["Rmarkdownをwordに出力する際のTeXコマンドの注意(\\rm)"],"updated_at":["2017-07-10T18:19:56+09:00"],"url":["https://qiita.com/Atsushi776/items/215cec9f59b0814c1367"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["\n<h1>\n<span id=\"はじめに\" class=\"fragment\"><\/span><a href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"><i class=\"fa fa-link\"><\/i><\/a>はじめに<\/h1>\n\n<p>pythonでは<\/p>\n\n<p><a href=\"http://qiita.com/okipow/items/3f0b173748b5802695ef\" id=\"reference-2f0f16aaa6a78063fc0c\">【メモ】量指定子を変えると正規表現の実行速度が桁で変わる（仮）<\/a><\/p>\n\n<p>という話があるので、Rでも試してみた。<\/p>\n\n<ul>\n<li> <code>+<\/code>と<code>{1, }<\/code><br>\n<\/li>\n<li> <code>*<\/code>と<code>{0, }<\/code><br>\n<\/li>\n<li> <code>?<\/code>と<code>{0, 1}<\/code><br>\n<\/li>\n<\/ul>\n\n<p>を比較する。<\/p>\n\n<p>結果としては<code>base::grep<\/code>も<code>stringr::str_detect<\/code>も大差ないか、<code>{m, n}<\/code>で指定する方が若干遅い。<\/p>\n\n<p>残念。<\/p>\n\n<h1>\n<span id=\"実験開始\" class=\"fragment\"><\/span><a href=\"#%E5%AE%9F%E9%A8%93%E9%96%8B%E5%A7%8B\"><i class=\"fa fa-link\"><\/i><\/a>実験開始<\/h1>\n\n<h2>\n<span id=\"準備\" class=\"fragment\"><\/span><a href=\"#%E6%BA%96%E5%82%99\"><i class=\"fa fa-link\"><\/i><\/a>準備<\/h2>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">require<\/span><span class=\"p\">(<\/span><span class=\"n\">stringr<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"n\">require<\/span><span class=\"p\">(<\/span><span class=\"n\">microbenchmark<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"n\">require<\/span><span class=\"p\">(<\/span><span class=\"n\">knitr<\/span><span class=\"p\">)<\/span><span class=\"w\">\n\n<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"s1\">'bbbbbbbbbbbbbbbbbb'<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<h2>\n<span id=\"basegrepの場合\" class=\"fragment\"><\/span><a href=\"#basegrep%E3%81%AE%E5%A0%B4%E5%90%88\"><i class=\"fa fa-link\"><\/i><\/a><code>base::grep<\/code>の場合<\/h2>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">kable<\/span><span class=\"p\">(<\/span><span class=\"n\">summary<\/span><span class=\"p\">(<\/span><span class=\"n\">microbenchmark<\/span><span class=\"p\">(<\/span><span class=\"w\">\n  <\/span><span class=\"n\">grep<\/span><span class=\"p\">(<\/span><span class=\"s1\">'b+'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">x<\/span><span class=\"p\">),<\/span><span class=\"w\">\n  <\/span><span class=\"n\">grep<\/span><span class=\"p\">(<\/span><span class=\"s1\">'b{1,}'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">x<\/span><span class=\"p\">),<\/span><span class=\"w\">\n  <\/span><span class=\"n\">grep<\/span><span class=\"p\">(<\/span><span class=\"s1\">'b*'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">x<\/span><span class=\"p\">),<\/span><span class=\"w\">\n  <\/span><span class=\"n\">grep<\/span><span class=\"p\">(<\/span><span class=\"s1\">'b{0,}'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">x<\/span><span class=\"p\">),<\/span><span class=\"w\">\n  <\/span><span class=\"n\">grep<\/span><span class=\"p\">(<\/span><span class=\"s1\">'b?'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">x<\/span><span class=\"p\">),<\/span><span class=\"w\">\n  <\/span><span class=\"n\">grep<\/span><span class=\"p\">(<\/span><span class=\"s1\">'b{0,1}'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">x<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"p\">)))<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<table>\n<thead>\n<tr>\n<th style=\"text-align: left\">expr<\/th>\n<th style=\"text-align: right\">min<\/th>\n<th style=\"text-align: right\">lq<\/th>\n<th style=\"text-align: right\">mean<\/th>\n<th style=\"text-align: right\">median<\/th>\n<th style=\"text-align: right\">uq<\/th>\n<th style=\"text-align: right\">max<\/th>\n<th style=\"text-align: right\">neval<\/th>\n<\/tr>\n<\/thead>\n<tbody>\n<tr>\n<td style=\"text-align: left\">grep(\"b+\", x)<\/td>\n<td style=\"text-align: right\">4.790<\/td>\n<td style=\"text-align: right\">5.4740<\/td>\n<td style=\"text-align: right\">8.80653<\/td>\n<td style=\"text-align: right\">5.4750<\/td>\n<td style=\"text-align: right\">9.5795<\/td>\n<td style=\"text-align: right\">67.057<\/td>\n<td style=\"text-align: right\">100<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: left\">grep(\"b{1,}\", x)<\/td>\n<td style=\"text-align: right\">4.790<\/td>\n<td style=\"text-align: right\">5.4740<\/td>\n<td style=\"text-align: right\">7.33539<\/td>\n<td style=\"text-align: right\">5.8165<\/td>\n<td style=\"text-align: right\">10.2640<\/td>\n<td style=\"text-align: right\">14.369<\/td>\n<td style=\"text-align: right\">100<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: left\">grep(\"b*\", x)<\/td>\n<td style=\"text-align: right\">5.474<\/td>\n<td style=\"text-align: right\">5.4740<\/td>\n<td style=\"text-align: right\">7.52007<\/td>\n<td style=\"text-align: right\">6.1580<\/td>\n<td style=\"text-align: right\">7.1850<\/td>\n<td style=\"text-align: right\">34.213<\/td>\n<td style=\"text-align: right\">100<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: left\">grep(\"b{0,}\", x)<\/td>\n<td style=\"text-align: right\">5.474<\/td>\n<td style=\"text-align: right\">5.4745<\/td>\n<td style=\"text-align: right\">9.04599<\/td>\n<td style=\"text-align: right\">6.1580<\/td>\n<td style=\"text-align: right\">10.2640<\/td>\n<td style=\"text-align: right\">116.322<\/td>\n<td style=\"text-align: right\">100<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: left\">grep(\"b?\", x)<\/td>\n<td style=\"text-align: right\">4.790<\/td>\n<td style=\"text-align: right\">5.4740<\/td>\n<td style=\"text-align: right\">8.36862<\/td>\n<td style=\"text-align: right\">6.1580<\/td>\n<td style=\"text-align: right\">10.2640<\/td>\n<td style=\"text-align: right\">56.109<\/td>\n<td style=\"text-align: right\">100<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: left\">grep(\"b{0,1}\", x)<\/td>\n<td style=\"text-align: right\">5.474<\/td>\n<td style=\"text-align: right\">5.4740<\/td>\n<td style=\"text-align: right\">9.29229<\/td>\n<td style=\"text-align: right\">6.1580<\/td>\n<td style=\"text-align: right\">6.8430<\/td>\n<td style=\"text-align: right\">95.110<\/td>\n<td style=\"text-align: right\">100<\/td>\n<\/tr>\n<\/tbody>\n<\/table>\n\n<h2>\n<span id=\"stringrstr_detectの場合\" class=\"fragment\"><\/span><a href=\"#stringrstr_detect%E3%81%AE%E5%A0%B4%E5%90%88\"><i class=\"fa fa-link\"><\/i><\/a><code>stringr::str_detect<\/code>の場合<\/h2>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">kable<\/span><span class=\"p\">(<\/span><span class=\"n\">summary<\/span><span class=\"p\">(<\/span><span class=\"n\">microbenchmark<\/span><span class=\"p\">(<\/span><span class=\"w\">\n  <\/span><span class=\"n\">str_detect<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"s1\">'b+'<\/span><span class=\"p\">),<\/span><span class=\"w\">\n  <\/span><span class=\"n\">str_detect<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"s1\">'b{1,}'<\/span><span class=\"p\">),<\/span><span class=\"w\">\n  <\/span><span class=\"n\">str_detect<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"s1\">'b*'<\/span><span class=\"p\">),<\/span><span class=\"w\">\n  <\/span><span class=\"n\">str_detect<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"s1\">'b{0,}'<\/span><span class=\"p\">),<\/span><span class=\"w\">\n  <\/span><span class=\"n\">str_detect<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"s1\">'b?'<\/span><span class=\"p\">),<\/span><span class=\"w\">\n  <\/span><span class=\"n\">str_detect<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"s1\">'b{0,1}'<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"p\">)))<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<table>\n<thead>\n<tr>\n<th style=\"text-align: left\">expr<\/th>\n<th style=\"text-align: right\">min<\/th>\n<th style=\"text-align: right\">lq<\/th>\n<th style=\"text-align: right\">mean<\/th>\n<th style=\"text-align: right\">median<\/th>\n<th style=\"text-align: right\">uq<\/th>\n<th style=\"text-align: right\">max<\/th>\n<th style=\"text-align: right\">neval<\/th>\n<\/tr>\n<\/thead>\n<tbody>\n<tr>\n<td style=\"text-align: left\">str_detect(x, \"b+\")<\/td>\n<td style=\"text-align: right\">34.212<\/td>\n<td style=\"text-align: right\">36.2650<\/td>\n<td style=\"text-align: right\">51.34606<\/td>\n<td style=\"text-align: right\">37.6340<\/td>\n<td style=\"text-align: right\">60.5560<\/td>\n<td style=\"text-align: right\">216.222<\/td>\n<td style=\"text-align: right\">100<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: left\">str_detect(x, \"b{1,}\")<\/td>\n<td style=\"text-align: right\">35.581<\/td>\n<td style=\"text-align: right\">37.6340<\/td>\n<td style=\"text-align: right\">51.42818<\/td>\n<td style=\"text-align: right\">39.6870<\/td>\n<td style=\"text-align: right\">64.6615<\/td>\n<td style=\"text-align: right\">172.430<\/td>\n<td style=\"text-align: right\">100<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: left\">str_detect(x, \"b*\")<\/td>\n<td style=\"text-align: right\">34.896<\/td>\n<td style=\"text-align: right\">36.2655<\/td>\n<td style=\"text-align: right\">53.82303<\/td>\n<td style=\"text-align: right\">39.3445<\/td>\n<td style=\"text-align: right\">63.9770<\/td>\n<td style=\"text-align: right\">169.693<\/td>\n<td style=\"text-align: right\">100<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: left\">str_detect(x, \"b{0,}\")<\/td>\n<td style=\"text-align: right\">35.581<\/td>\n<td style=\"text-align: right\">37.6340<\/td>\n<td style=\"text-align: right\">54.09672<\/td>\n<td style=\"text-align: right\">46.1875<\/td>\n<td style=\"text-align: right\">66.3725<\/td>\n<td style=\"text-align: right\">110.164<\/td>\n<td style=\"text-align: right\">100<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: left\">str_detect(x, \"b?\")<\/td>\n<td style=\"text-align: right\">33.528<\/td>\n<td style=\"text-align: right\">34.8970<\/td>\n<td style=\"text-align: right\">54.08311<\/td>\n<td style=\"text-align: right\">41.7390<\/td>\n<td style=\"text-align: right\">59.8715<\/td>\n<td style=\"text-align: right\">460.498<\/td>\n<td style=\"text-align: right\">100<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: left\">str_detect(x, \"b{0,1}\")<\/td>\n<td style=\"text-align: right\">34.212<\/td>\n<td style=\"text-align: right\">35.5810<\/td>\n<td style=\"text-align: right\">59.48179<\/td>\n<td style=\"text-align: right\">52.0030<\/td>\n<td style=\"text-align: right\">59.1875<\/td>\n<td style=\"text-align: right\">632.243<\/td>\n<td style=\"text-align: right\">100<\/td>\n<\/tr>\n<\/tbody>\n<\/table>\n\n<h1>\n<span id=\"感想\" class=\"fragment\"><\/span><a href=\"#%E6%84%9F%E6%83%B3\"><i class=\"fa fa-link\"><\/i><\/a>感想<\/h1>\n\n<ul>\n<li> <code>{m, n}<\/code>の方が、明示的で分かりよいと思う<\/li>\n<li> <code>grep<\/code>の方が速いのは意外だった<\/li>\n<\/ul>\n"],"body":["#はじめに\n\npythonでは\n\n[【メモ】量指定子を変えると正規表現の実行速度が桁で変わる（仮）](http://qiita.com/okipow/items/3f0b173748b5802695ef)\n\nという話があるので、Rでも試してみた。\n\n-  `+`と`{1, }`  \n-  `*`と`{0, }`  \n-  `?`と`{0, 1}`  \n\nを比較する。\n\n結果としては`base::grep`も`stringr::str_detect`も大差ないか、`{m, n}`で指定する方が若干遅い。\n\n残念。\n\n#実験開始\n\n##準備\n\n```r\nrequire(stringr)\nrequire(microbenchmark)\nrequire(knitr)\n\nx <- 'bbbbbbbbbbbbbbbbbb'\n```\n\n##`base::grep`の場合\n\n```r\nkable(summary(microbenchmark(\n  grep('b+', x),\n  grep('b{1,}', x),\n  grep('b*', x),\n  grep('b{0,}', x),\n  grep('b?', x),\n  grep('b{0,1}', x)\n)))\n```\n\n|expr              |   min|     lq|    mean| median|      uq|     max| neval|\n|:-----------------|-----:|------:|-------:|------:|-------:|-------:|-----:|\n|grep(\"b+\", x)     | 4.790| 5.4740| 8.80653| 5.4750|  9.5795|  67.057|   100|\n|grep(\"b{1,}\", x)  | 4.790| 5.4740| 7.33539| 5.8165| 10.2640|  14.369|   100|\n|grep(\"b*\", x)     | 5.474| 5.4740| 7.52007| 6.1580|  7.1850|  34.213|   100|\n|grep(\"b{0,}\", x)  | 5.474| 5.4745| 9.04599| 6.1580| 10.2640| 116.322|   100|\n|grep(\"b?\", x)     | 4.790| 5.4740| 8.36862| 6.1580| 10.2640|  56.109|   100|\n|grep(\"b{0,1}\", x) | 5.474| 5.4740| 9.29229| 6.1580|  6.8430|  95.110|   100|\n\n##`stringr::str_detect`の場合\n\n```r\nkable(summary(microbenchmark(\n  str_detect(x, 'b+'),\n  str_detect(x, 'b{1,}'),\n  str_detect(x, 'b*'),\n  str_detect(x, 'b{0,}'),\n  str_detect(x, 'b?'),\n  str_detect(x, 'b{0,1}')\n)))\n```\n\n|expr                    |    min|      lq|     mean|  median|      uq|     max| neval|\n|:-----------------------|------:|-------:|--------:|-------:|-------:|-------:|-----:|\n|str_detect(x, \"b+\")     | 34.212| 36.2650| 51.34606| 37.6340| 60.5560| 216.222|   100|\n|str_detect(x, \"b{1,}\")  | 35.581| 37.6340| 51.42818| 39.6870| 64.6615| 172.430|   100|\n|str_detect(x, \"b*\")     | 34.896| 36.2655| 53.82303| 39.3445| 63.9770| 169.693|   100|\n|str_detect(x, \"b{0,}\")  | 35.581| 37.6340| 54.09672| 46.1875| 66.3725| 110.164|   100|\n|str_detect(x, \"b?\")     | 33.528| 34.8970| 54.08311| 41.7390| 59.8715| 460.498|   100|\n|str_detect(x, \"b{0,1}\") | 34.212| 35.5810| 59.48179| 52.0030| 59.1875| 632.243|   100|\n\n\n#感想\n\n-  `{m, n}`の方が、明示的で分かりよいと思う\n-  `grep`の方が速いのは意外だった\n"],"coediting":[false],"comments_count":[0],"created_at":["2017-07-04T22:35:16+09:00"],"group":{},"id":["918b4f92ba6a164ca7ad"],"likes_count":[1],"private":[false],"reactions_count":[0],"tags":[{"name":["R"],"versions":[]},{"name":["正規表現"],"versions":[]}],"title":["Rでは量指定子を変えても正規表現の実行速度にほとんど影響しない"],"updated_at":["2017-07-04T22:47:19+09:00"],"url":["https://qiita.com/Atsushi776/items/918b4f92ba6a164ca7ad"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["\n<h1>\n<span id=\"普通にヒストグラムカーネル密度推定\" class=\"fragment\"><\/span><a href=\"#%E6%99%AE%E9%80%9A%E3%81%AB%E3%83%92%E3%82%B9%E3%83%88%E3%82%B0%E3%83%A9%E3%83%A0%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E5%AF%86%E5%BA%A6%E6%8E%A8%E5%AE%9A\"><i class=\"fa fa-link\"><\/i><\/a>普通にヒストグラム&amp;カーネル密度推定<\/h1>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Ff4db335c-3a9e-52f2-07e2-89d8cbbcb188.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=0ea0845bdf57df9f1cf6e713306b580d\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Ff4db335c-3a9e-52f2-07e2-89d8cbbcb188.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=0ea0845bdf57df9f1cf6e713306b580d\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/f4db335c-3a9e-52f2-07e2-89d8cbbcb188.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Ff4db335c-3a9e-52f2-07e2-89d8cbbcb188.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=c5ab96bea0e48fde676f76ce714a8d56 1x\" loading=\"lazy\"><\/a><\/p>\n\n<h1>\n<span id=\"実際には各観測値はそれぞれに誤差を持つ\" class=\"fragment\"><\/span><a href=\"#%E5%AE%9F%E9%9A%9B%E3%81%AB%E3%81%AF%E5%90%84%E8%A6%B3%E6%B8%AC%E5%80%A4%E3%81%AF%E3%81%9D%E3%82%8C%E3%81%9E%E3%82%8C%E3%81%AB%E8%AA%A4%E5%B7%AE%E3%82%92%E6%8C%81%E3%81%A4\"><i class=\"fa fa-link\"><\/i><\/a>実際には各観測値はそれぞれに誤差を持つ<\/h1>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F44eea894-9221-aa6e-f84c-aa3a9c84ed67.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=9f0ba425cd03e0eec30c06c779df5545\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F44eea894-9221-aa6e-f84c-aa3a9c84ed67.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=9f0ba425cd03e0eec30c06c779df5545\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/44eea894-9221-aa6e-f84c-aa3a9c84ed67.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F44eea894-9221-aa6e-f84c-aa3a9c84ed67.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=5973346c1fdcb138b8975e6034506713 1x\" loading=\"lazy\"><\/a><\/p>\n\n<h1>\n<span id=\"誤差を考慮した密度推定はできないか\" class=\"fragment\"><\/span><a href=\"#%E8%AA%A4%E5%B7%AE%E3%82%92%E8%80%83%E6%85%AE%E3%81%97%E3%81%9F%E5%AF%86%E5%BA%A6%E6%8E%A8%E5%AE%9A%E3%81%AF%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E3%81%8B\"><i class=\"fa fa-link\"><\/i><\/a>誤差を考慮した密度推定はできないか？<\/h1>\n\n<h2>\n<span id=\"とりあえず混合分布にしてみる\" class=\"fragment\"><\/span><a href=\"#%E3%81%A8%E3%82%8A%E3%81%82%E3%81%88%E3%81%9A%E6%B7%B7%E5%90%88%E5%88%86%E5%B8%83%E3%81%AB%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\"><i class=\"fa fa-link\"><\/i><\/a>とりあえず，混合分布にしてみる<\/h2>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F0effe004-3a52-8a66-b489-feb40029ad3f.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=57aa5522bd20048eb9fbe8b159cf473f\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F0effe004-3a52-8a66-b489-feb40029ad3f.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=57aa5522bd20048eb9fbe8b159cf473f\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/0effe004-3a52-8a66-b489-feb40029ad3f.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F0effe004-3a52-8a66-b489-feb40029ad3f.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=68234cc86e341005566bf6d9c76c36c8 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>中心極限定理めえ!!<\/p>\n\n<h2>\n<span id=\"誤差がある程度小さいときはうまくいく\" class=\"fragment\"><\/span><a href=\"#%E8%AA%A4%E5%B7%AE%E3%81%8C%E3%81%82%E3%82%8B%E7%A8%8B%E5%BA%A6%E5%B0%8F%E3%81%95%E3%81%84%E3%81%A8%E3%81%8D%E3%81%AF%E3%81%86%E3%81%BE%E3%81%8F%E3%81%84%E3%81%8F\"><i class=\"fa fa-link\"><\/i><\/a>誤差がある程度小さいときはうまくいく<\/h2>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F4b1d6a75-3f6e-bec0-8281-a5434a6e2519.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=d50439010a8b032852cd2e469642d80d\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F4b1d6a75-3f6e-bec0-8281-a5434a6e2519.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=d50439010a8b032852cd2e469642d80d\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/4b1d6a75-3f6e-bec0-8281-a5434a6e2519.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F4b1d6a75-3f6e-bec0-8281-a5434a6e2519.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=e1fa7dfcbfb79505a9d7e55b915dccf7 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>とはいえ，フツーに密度推定した方が分かりよい．<\/p>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F1a10b0cb-539c-ee0b-3395-1a7c167433a8.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=1bc9df285a8ffc0790cf3b2ceaf0ba08\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F1a10b0cb-539c-ee0b-3395-1a7c167433a8.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=1bc9df285a8ffc0790cf3b2ceaf0ba08\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/1a10b0cb-539c-ee0b-3395-1a7c167433a8.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F1a10b0cb-539c-ee0b-3395-1a7c167433a8.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=aeda3cedb66d9b75c1b87bc4c58da51f 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>これは， ヒストグラムやカーネル密度が，各観測値の誤差が同程度で十分小さい場合の混合分布に近似されるためと考えられる．<\/p>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F1e05e659-c742-7b3a-6db1-def88ca9254c.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=4cefbb644494c4bc0ca4e6fea9130a64\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F1e05e659-c742-7b3a-6db1-def88ca9254c.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=4cefbb644494c4bc0ca4e6fea9130a64\" alt=\"image.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/1e05e659-c742-7b3a-6db1-def88ca9254c.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F1e05e659-c742-7b3a-6db1-def88ca9254c.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=eb50587905d237eb3b171d12a4c0e722 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>そういう意味では， ヒストグラムやカーネル密度では過剰に分離して見えてしまっているわけか……．<br>\nどっち使うのがいいのだろう？<\/p>\n\n<h1>\n<span id=\"今回使ったrコード\" class=\"fragment\"><\/span><a href=\"#%E4%BB%8A%E5%9B%9E%E4%BD%BF%E3%81%A3%E3%81%9Fr%E3%82%B3%E3%83%BC%E3%83%89\"><i class=\"fa fa-link\"><\/i><\/a>今回使ったRコード<\/h1>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"w\">\n<\/span><span class=\"n\">require<\/span><span class=\"p\">(<\/span><span class=\"n\">ggplot2<\/span><span class=\"p\">)<\/span><span class=\"w\">\n\n<\/span><span class=\"c1\">#misture normal distributions<\/span><span class=\"w\">\n<\/span><span class=\"n\">dmnorm<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">means<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">sigmas<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">groups<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"kc\">NA<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"kc\">NULL<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n\n  <\/span><span class=\"c1\">#set x<\/span><span class=\"w\">\n  <\/span><span class=\"k\">if<\/span><span class=\"p\">(<\/span><span class=\"nf\">is.null<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n    <\/span><span class=\"n\">x_min<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"nf\">min<\/span><span class=\"p\">(<\/span><span class=\"n\">means<\/span><span class=\"w\"> <\/span><span class=\"o\">-<\/span><span class=\"w\"> <\/span><span class=\"m\">3<\/span><span class=\"w\"> <\/span><span class=\"o\">*<\/span><span class=\"w\"> <\/span><span class=\"n\">sigmas<\/span><span class=\"p\">)<\/span><span class=\"w\">\n    <\/span><span class=\"n\">x_max<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"nf\">max<\/span><span class=\"p\">(<\/span><span class=\"n\">means<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\"> <\/span><span class=\"m\">3<\/span><span class=\"w\"> <\/span><span class=\"o\">*<\/span><span class=\"w\"> <\/span><span class=\"n\">sigmas<\/span><span class=\"p\">)<\/span><span class=\"w\">\n    <\/span><span class=\"n\">x_by<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"m\">10<\/span><span class=\"w\"> <\/span><span class=\"o\">^<\/span><span class=\"w\"> <\/span><span class=\"p\">(<\/span><span class=\"nf\">round<\/span><span class=\"p\">(<\/span><span class=\"nf\">log<\/span><span class=\"p\">(<\/span><span class=\"n\">x_max<\/span><span class=\"w\"> <\/span><span class=\"o\">-<\/span><span class=\"w\"> <\/span><span class=\"n\">x_min<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"m\">10<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">-<\/span><span class=\"w\"> <\/span><span class=\"m\">4<\/span><span class=\"p\">)<\/span><span class=\"w\">\n    <\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">seq<\/span><span class=\"p\">(<\/span><span class=\"n\">x_min<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">x_max<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">x_by<\/span><span class=\"p\">)<\/span><span class=\"w\">\n    <\/span><span class=\"n\">rm<\/span><span class=\"p\">(<\/span><span class=\"n\">x_min<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">x_max<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">x_by<\/span><span class=\"p\">)<\/span><span class=\"w\">\n  <\/span><span class=\"p\">}<\/span><span class=\"w\">\n\n  <\/span><span class=\"c1\">#set groups  <\/span><span class=\"w\">\n  <\/span><span class=\"k\">if<\/span><span class=\"p\">(<\/span><span class=\"nf\">is.na<\/span><span class=\"p\">(<\/span><span class=\"n\">groups<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n    <\/span><span class=\"n\">groups<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"nf\">as.character<\/span><span class=\"p\">(<\/span><span class=\"n\">means<\/span><span class=\"p\">)<\/span><span class=\"w\">\n  <\/span><span class=\"p\">}<\/span><span class=\"w\"> <\/span><span class=\"k\">else<\/span><span class=\"w\"> <\/span><span class=\"k\">if<\/span><span class=\"p\">(<\/span><span class=\"nf\">length<\/span><span class=\"p\">(<\/span><span class=\"n\">groups<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">!=<\/span><span class=\"w\"> <\/span><span class=\"nf\">length<\/span><span class=\"p\">(<\/span><span class=\"n\">means<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n    <\/span><span class=\"n\">stop<\/span><span class=\"p\">(<\/span><span class=\"s1\">'groups should be NA or a vector wit length equal to means'<\/span><span class=\"p\">)<\/span><span class=\"w\">\n  <\/span><span class=\"p\">}<\/span><span class=\"w\">\n\n  <\/span><span class=\"n\">groups<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">unlist<\/span><span class=\"p\">(<\/span><span class=\"n\">lapply<\/span><span class=\"p\">(<\/span><span class=\"nf\">c<\/span><span class=\"p\">(<\/span><span class=\"n\">groups<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"kc\">NA<\/span><span class=\"p\">),<\/span><span class=\"w\"> <\/span><span class=\"n\">rep<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"nf\">length<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"p\">)))<\/span><span class=\"w\">\n\n  <\/span><span class=\"c1\">#estimate each distributions<\/span><span class=\"w\">\n  <\/span><span class=\"n\">each<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">Map<\/span><span class=\"p\">(<\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">means<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">sigmas<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">.x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">x<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"n\">dnorm<\/span><span class=\"p\">(<\/span><span class=\"n\">.x<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">means<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">sigmas<\/span><span class=\"p\">),<\/span><span class=\"w\"> <\/span><span class=\"n\">means<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">sigmas<\/span><span class=\"p\">)<\/span><span class=\"w\">\n\n  <\/span><span class=\"c1\">#estimate mixture distributions<\/span><span class=\"w\">\n  <\/span><span class=\"n\">mix<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">rowSums<\/span><span class=\"p\">(<\/span><span class=\"n\">as.data.frame<\/span><span class=\"p\">(<\/span><span class=\"n\">each<\/span><span class=\"p\">))<\/span><span class=\"w\">\n\n  <\/span><span class=\"c1\">#output data.frame<\/span><span class=\"w\">\n  <\/span><span class=\"n\">data.frame<\/span><span class=\"p\">(<\/span><span class=\"w\">\n    <\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">x<\/span><span class=\"p\">,<\/span><span class=\"w\">\n    <\/span><span class=\"n\">probability<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"nf\">c<\/span><span class=\"p\">(<\/span><span class=\"n\">unlist<\/span><span class=\"p\">(<\/span><span class=\"n\">each<\/span><span class=\"p\">),<\/span><span class=\"w\"> <\/span><span class=\"n\">mix<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">/<\/span><span class=\"w\"> <\/span><span class=\"nf\">sum<\/span><span class=\"p\">(<\/span><span class=\"n\">mix<\/span><span class=\"p\">),<\/span><span class=\"w\">\n    <\/span><span class=\"n\">group<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">groups<\/span><span class=\"w\">\n  <\/span><span class=\"p\">)<\/span><span class=\"w\">\n\n<\/span><span class=\"p\">}<\/span><span class=\"w\">\n\n<\/span><span class=\"c1\">#random number based on mixture normal distributions<\/span><span class=\"w\">\n<\/span><span class=\"n\">rmnorm<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"k\">function<\/span><span class=\"p\">(<\/span><span class=\"n\">n<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">means<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">sigmas<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">prob<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"kc\">NULL<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">groups<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"kc\">NA<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"p\">{<\/span><span class=\"w\">\n  <\/span><span class=\"n\">n<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">table<\/span><span class=\"p\">(<\/span><span class=\"n\">sample<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"nf\">length<\/span><span class=\"p\">(<\/span><span class=\"n\">means<\/span><span class=\"p\">),<\/span><span class=\"w\"> <\/span><span class=\"n\">size<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">n<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">replace<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"kc\">TRUE<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">prob<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">prob<\/span><span class=\"p\">))<\/span><span class=\"w\">\n  <\/span><span class=\"n\">unlist<\/span><span class=\"p\">(<\/span><span class=\"n\">Map<\/span><span class=\"p\">(<\/span><span class=\"n\">rnorm<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">n<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">means<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">sigmas<\/span><span class=\"p\">))<\/span><span class=\"w\">\n<\/span><span class=\"p\">}<\/span><span class=\"w\">\n\n<\/span><span class=\"c1\">#test<\/span><span class=\"w\">\n<\/span><span class=\"n\">set.seed<\/span><span class=\"p\">(<\/span><span class=\"m\">123<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"n\">n<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"m\">20<\/span><span class=\"w\">\n<\/span><span class=\"n\">means<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">rmnorm<\/span><span class=\"p\">(<\/span><span class=\"n\">n<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"nf\">c<\/span><span class=\"p\">(<\/span><span class=\"m\">100<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"m\">120<\/span><span class=\"p\">),<\/span><span class=\"w\"> <\/span><span class=\"n\">runif<\/span><span class=\"p\">(<\/span><span class=\"n\">n<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"m\">5<\/span><span class=\"p\">))<\/span><span class=\"w\">\n<\/span><span class=\"n\">sigmas<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">runif<\/span><span class=\"p\">(<\/span><span class=\"n\">n<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"m\">1<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"m\">15<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"n\">age<\/span><span class=\"w\"> <\/span><span class=\"o\">&lt;-<\/span><span class=\"w\"> <\/span><span class=\"n\">dmnorm<\/span><span class=\"p\">(<\/span><span class=\"n\">means<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">sigmas<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">%&gt;%<\/span><span class=\"w\"> <\/span><span class=\"n\">mutate<\/span><span class=\"p\">(<\/span><span class=\"n\">facet<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">ifelse<\/span><span class=\"p\">(<\/span><span class=\"nf\">is.na<\/span><span class=\"p\">(<\/span><span class=\"n\">group<\/span><span class=\"p\">),<\/span><span class=\"w\"> <\/span><span class=\"s1\">'mix'<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"s1\">'each'<\/span><span class=\"p\">))<\/span><span class=\"w\">\n\n<\/span><span class=\"c1\">#each and mixture distributions<\/span><span class=\"w\">\n<\/span><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"n\">age<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">x<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">probability<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">group<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_line<\/span><span class=\"p\">()<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">theme<\/span><span class=\"p\">(<\/span><span class=\"n\">legend.position<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"s1\">'none'<\/span><span class=\"p\">)<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">facet_grid<\/span><span class=\"p\">(<\/span><span class=\"n\">facet<\/span><span class=\"w\"> <\/span><span class=\"o\">~<\/span><span class=\"w\"> <\/span><span class=\"n\">.<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">scale<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"s1\">'free'<\/span><span class=\"p\">)<\/span><span class=\"w\">\n\n<\/span><span class=\"c1\">#histograms and kernel densities<\/span><span class=\"w\">\n<\/span><span class=\"n\">ggplot<\/span><span class=\"p\">(<\/span><span class=\"n\">as.data.frame<\/span><span class=\"p\">(<\/span><span class=\"n\">means<\/span><span class=\"p\">),<\/span><span class=\"w\"> <\/span><span class=\"n\">aes<\/span><span class=\"p\">(<\/span><span class=\"n\">x<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">means<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">y<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"n\">..density..<\/span><span class=\"p\">))<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_histogram<\/span><span class=\"p\">()<\/span><span class=\"w\"> <\/span><span class=\"o\">+<\/span><span class=\"w\">\n  <\/span><span class=\"n\">geom_density<\/span><span class=\"p\">(<\/span><span class=\"n\">color<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"s1\">'blue'<\/span><span class=\"p\">)<\/span><span class=\"w\">\n\n\n<\/span><\/pre><\/div><\/div>\n"],"body":["#普通にヒストグラム&カーネル密度推定\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/f4db335c-3a9e-52f2-07e2-89d8cbbcb188.png)\n\n#実際には各観測値はそれぞれに誤差を持つ\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/44eea894-9221-aa6e-f84c-aa3a9c84ed67.png)\n\n#誤差を考慮した密度推定はできないか？\n\n##とりあえず，混合分布にしてみる\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/0effe004-3a52-8a66-b489-feb40029ad3f.png)\n\n中心極限定理めえ!!\n\n##誤差がある程度小さいときはうまくいく\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/4b1d6a75-3f6e-bec0-8281-a5434a6e2519.png)\n\nとはいえ，フツーに密度推定した方が分かりよい．\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/1a10b0cb-539c-ee0b-3395-1a7c167433a8.png)\n\nこれは， ヒストグラムやカーネル密度が，各観測値の誤差が同程度で十分小さい場合の混合分布に近似されるためと考えられる．\n\n![image.png](https://qiita-image-store.s3.amazonaws.com/0/149890/1e05e659-c742-7b3a-6db1-def88ca9254c.png)\n\nそういう意味では， ヒストグラムやカーネル密度では過剰に分離して見えてしまっているわけか……．\nどっち使うのがいいのだろう？\n\n#今回使ったRコード\n\n```r\n\nrequire(ggplot2)\n\n#misture normal distributions\ndmnorm <- function(means, sigmas, groups = NA, x = NULL) {\n  \n  #set x\n  if(is.null(x)) {\n    x_min <- min(means - 3 * sigmas)\n    x_max <- max(means + 3 * sigmas)\n    x_by <- 10 ^ (round(log(x_max - x_min, 10)) - 4)\n    x <- seq(x_min, x_max, x_by)\n    rm(x_min, x_max, x_by)\n  }\n  \n  #set groups  \n  if(is.na(groups)) {\n    groups <- as.character(means)\n  } else if(length(groups) != length(means)) {\n    stop('groups should be NA or a vector wit length equal to means')\n  }\n  \n  groups <- unlist(lapply(c(groups, NA), rep, length(x)))\n  \n  #estimate each distributions\n  each <- Map(function(means, sigmas, .x = x) dnorm(.x, means, sigmas), means, sigmas)\n  \n  #estimate mixture distributions\n  mix <- rowSums(as.data.frame(each))\n  \n  #output data.frame\n  data.frame(\n    x = x,\n    probability = c(unlist(each), mix) / sum(mix),\n    group = groups\n  )\n  \n}\n\n#random number based on mixture normal distributions\nrmnorm <- function(n, means, sigmas, prob = NULL, groups = NA) {\n  n <- table(sample(x = length(means), size = n, replace = TRUE, prob = prob))\n  unlist(Map(rnorm, n, means, sigmas))\n}\n\n#test\nset.seed(123)\nn <- 20\nmeans <- rmnorm(n, c(100, 120), runif(n, 1, 5))\nsigmas <- runif(n, 1, 15)\nage <- dmnorm(means, sigmas) %>% mutate(facet = ifelse(is.na(group), 'mix', 'each'))\n\n#each and mixture distributions\nggplot(age, aes(x = x, y = probability, color = group)) +\n  geom_line() +\n  theme(legend.position = 'none') +\n  facet_grid(facet ~ ., scale = 'free')\n\n#histograms and kernel densities\nggplot(as.data.frame(means), aes(x = means, y = ..density..)) +\n  geom_histogram() +\n  geom_density(color = 'blue')\n\n\n```\n"],"coediting":[false],"comments_count":[0],"created_at":["2017-07-04T19:34:15+09:00"],"group":{},"id":["4f89a5738caaa125fddb"],"likes_count":[1],"private":[false],"reactions_count":[0],"tags":[{"name":["R"],"versions":[]},{"name":["統計学"],"versions":[]}],"title":["観測値の誤差が既知な場合の密度推定したい……"],"updated_at":["2017-07-04T19:57:55+09:00"],"url":["https://qiita.com/Atsushi776/items/4f89a5738caaa125fddb"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["\n<h1>\n<span id=\"linux-mintって\" class=\"fragment\"><\/span><a href=\"#linux-mint%E3%81%A3%E3%81%A6\"><i class=\"fa fa-link\"><\/i><\/a>Linux Mintって？<\/h1>\n\n<p>Ubuntu派生のディストロで、使いやすくてUIもよい。<br>\nUnityなんてなかった！！（本家Ubuntuでも18からGnomeに戻るらしい）<\/p>\n\n<p>別にRedHat系でもOpenSuse系でもよいのだけれど、Linuxにすると、<strong>RStudioServer<\/strong>が使えて、色んな端末から同じ環境で計算ができるようになる。<br>\nやったネ！<\/p>\n\n<p>ホントはDockerコンテナとか使うともっといいらしいのだけれど、こういうのはちょっとずつね。<\/p>\n\n<h1>\n<span id=\"今回の動作環境\" class=\"fragment\"><\/span><a href=\"#%E4%BB%8A%E5%9B%9E%E3%81%AE%E5%8B%95%E4%BD%9C%E7%92%B0%E5%A2%83\"><i class=\"fa fa-link\"><\/i><\/a>今回の動作環境<\/h1>\n\n<p>第7世代Intel CPUにLinux Mint 18.1<\/p>\n\n<h1>\n<span id=\"rとrstudioserverのインストール\" class=\"fragment\"><\/span><a href=\"#r%E3%81%A8rstudioserver%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB\"><i class=\"fa fa-link\"><\/i><\/a>RとRStudioServerのインストール<\/h1>\n\n<p><a href=\"https://www.rstudio.com/products/rstudio/download-server/\" rel=\"nofollow noopener\" target=\"_blank\">ここ<\/a>に書いてある通りにするだけ。<br>\nできたら<a href=\"http://localhost:8787/\" rel=\"nofollow noopener\" target=\"_blank\">http://localhost:8787/<\/a>にアクセスしてみよう<\/p>\n\n<p>英語は嫌だという人のために必要部をコピペしておくと<\/p>\n\n<p>64bit版のLinux MintやUbuntu,Debianなら<\/p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>$ sudo apt-get install r-base\n$ sudo apt-get install gdebi-core\n$ wget https://download2.rstudio.org/rstudio-server-1.0.143-amd64.deb\n$ sudo gdebi rstudio-server-1.0.143-amd64.deb\n<\/pre><\/div><\/div>\n\n<p>を実行するだけ簡単！<\/p>\n\n<h1>\n<span id=\"needsの導入\" class=\"fragment\"><\/span><a href=\"#needs%E3%81%AE%E5%B0%8E%E5%85%A5\"><i class=\"fa fa-link\"><\/i><\/a><code>needs<\/code>の導入<\/h1>\n\n<p><code>needs<\/code>パッケージは複数パッケージの読み込みを容易にしつつ、存在しないパッケージを自動でインストールしてくれる優れもの。<br>\n詳しい紹介は<a href=\"http://qiita.com/uri/items/dd7c5cddbb6b0ae342c6\" id=\"reference-2ef9c674fa9ad9987d11\">uriさん<\/a>の記事を参照。<\/p>\n\n<p>導入手順として<a href=\"https://github.com/joshkatz/needs\" rel=\"nofollow noopener\" target=\"_blank\">githubのページ<\/a>には<\/p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>install.packages(\"needs\")\n# for the dev version:\n# devtools::install_github(\"joshkatz/needs\", ref = \"development\")\nlibrary(needs)\n\n# answer \"yes\" when prompted, and you will never have\n# to type library or install.packages again. hooray.\n<\/pre><\/div><\/div>\n\n<p>と書かれているが、ターミナルに<code>$ R<\/code>と入力してRを立ち上げ、上記を実行しても失敗する。<br>\nエラーメッセージのコピーを忘れてしまって申し訳ないが、書き込み制限のある設定ファイルをいじるのが原因のようなので、<code>$sudo R<\/code>としてRをスーパーユーザーで立ち上げてやればよい。<\/p>\n\n<h1>\n<span id=\"tidyverseの導入\" class=\"fragment\"><\/span><a href=\"#tidyverse%E3%81%AE%E5%B0%8E%E5%85%A5\"><i class=\"fa fa-link\"><\/i><\/a><code>tidyverse<\/code>の導入<\/h1>\n\n<p>みんな大好きtidyverseだが、いかんせん多数のパッケージの集合体であるために、依存関係が複雑なようだ。<br>\nR内でのパッケージの依存関係はもちろんのこと、OS側のソフトの依存関係にも注意が必要。<br>\n今回の環境では以下の順でコードを実行すると、うまく<code>tidyverse<\/code>を導入できた。<\/p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>$ sudo apt-get update\n$ sudo apt-get upgrade\n$ sudo apt-get install build-essential gfortran g++ libcurl4-openssl-dev libxml2-dev\n$ R\n&gt; install.packages(\"readxl\")\n&gt; install.packages(\"tidyverse\")\n<\/pre><\/div><\/div>\n\n<p>上述の<code>needs<\/code>を早速使って\"tidyverse\"をインストールしたいところだが、<code>install.packages<\/code>のほうが、インストール過程の詳細なメッセージが見られるので、今回は後者を推す。<\/p>\n\n<p>うまくいかなかった場合はメッセージを確認しよう。<\/p>\n\n<p>RStudioServerをインストールした人は、Rコード部分はRStudioServer上でやってもいい。<\/p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>/bin/bash: g++: command not found\n<\/pre><\/div><\/div>\n\n<p>のようなメッセージが出てきた場合は、システム側に不足なソフトウェアがある（上述の場合は<code>g++<\/code>)<br>\n大体の<code>tidyverse<\/code>インストール周りのトラブルはこのエラーに起因している。<br>\n一通りシステムに必要なソフトをインストールしたら、もう一度、<code>tidyverse<\/code>をインストールしてみよう。<\/p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>Error in library.dynam(lib, package, package.lib) : \n  shared object ‘readxl.so’ not found\n<\/pre><\/div><\/div>\n\n<p>というようなメッセージがあれば、個別にRのパッケージをインストールしてみるといい（上述の場合は<code>readxl<\/code>）。<\/p>\n\n<p>これで、だいたいRを快適に利用できるようになったはずだ。<\/p>\n\n<h1>\n<span id=\"その他のパッケージの導入\" class=\"fragment\"><\/span><a href=\"#%E3%81%9D%E3%81%AE%E4%BB%96%E3%81%AE%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%81%AE%E5%B0%8E%E5%85%A5\"><i class=\"fa fa-link\"><\/i><\/a>その他のパッケージの導入<\/h1>\n\n<p>このあたりはお好みで。<\/p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>needs(data.table, pipeR)\n<\/pre><\/div><\/div>\n\n<p><code>data.table<\/code>は、data.frameの拡張するもの。<br>\n他に、表形式ファイルを<code>base::read.csv<\/code>などよりも高速に読み込める<code>fread<\/code>や、<code>base::write.csv<\/code>などよりも高速に書き込める<code>fwrite<\/code>などの関数が用意されている。<\/p>\n\n<p><code>pipeR<\/code>はRでパイプラインを可能にするパッケージ。<br>\n<code>magrittr<\/code>とライバル関係（？）にあたるが、パフォーマンスなどの観点で<code>pipeR<\/code>の方が優れているらしい。<\/p>\n"],"body":["#Linux Mintって？\n\nUbuntu派生のディストロで、使いやすくてUIもよい。\nUnityなんてなかった！！（本家Ubuntuでも18からGnomeに戻るらしい）\n\n別にRedHat系でもOpenSuse系でもよいのだけれど、Linuxにすると、**RStudioServer**が使えて、色んな端末から同じ環境で計算ができるようになる。\nやったネ！\n\nホントはDockerコンテナとか使うともっといいらしいのだけれど、こういうのはちょっとずつね。\n\n#今回の動作環境\n第7世代Intel CPUにLinux Mint 18.1\n\n#RとRStudioServerのインストール\n\n[ここ](https://www.rstudio.com/products/rstudio/download-server/)に書いてある通りにするだけ。\nできたら[http://localhost:8787/](http://localhost:8787/)にアクセスしてみよう\n\n英語は嫌だという人のために必要部をコピペしておくと\n\n64bit版のLinux MintやUbuntu,Debianなら\n\n```\n$ sudo apt-get install r-base\n$ sudo apt-get install gdebi-core\n$ wget https://download2.rstudio.org/rstudio-server-1.0.143-amd64.deb\n$ sudo gdebi rstudio-server-1.0.143-amd64.deb\n```\n\nを実行するだけ簡単！\n\n\n#`needs`の導入\n\n`needs`パッケージは複数パッケージの読み込みを容易にしつつ、存在しないパッケージを自動でインストールしてくれる優れもの。\n詳しい紹介は[uriさん](http://qiita.com/uri/items/dd7c5cddbb6b0ae342c6)の記事を参照。\n\n導入手順として[githubのページ](https://github.com/joshkatz/needs)には\n\n```\ninstall.packages(\"needs\")\n# for the dev version:\n# devtools::install_github(\"joshkatz/needs\", ref = \"development\")\nlibrary(needs)\n\n# answer \"yes\" when prompted, and you will never have\n# to type library or install.packages again. hooray.\n```\n\nと書かれているが、ターミナルに`$ R`と入力してRを立ち上げ、上記を実行しても失敗する。\nエラーメッセージのコピーを忘れてしまって申し訳ないが、書き込み制限のある設定ファイルをいじるのが原因のようなので、`$sudo R`としてRをスーパーユーザーで立ち上げてやればよい。\n\n#`tidyverse`の導入\n\nみんな大好きtidyverseだが、いかんせん多数のパッケージの集合体であるために、依存関係が複雑なようだ。\nR内でのパッケージの依存関係はもちろんのこと、OS側のソフトの依存関係にも注意が必要。\n今回の環境では以下の順でコードを実行すると、うまく`tidyverse`を導入できた。\n\n```\n$ sudo apt-get update\n$ sudo apt-get upgrade\n$ sudo apt-get install build-essential gfortran g++ libcurl4-openssl-dev libxml2-dev\n$ R\n> install.packages(\"readxl\")\n> install.packages(\"tidyverse\")\n```\n\n上述の`needs`を早速使って\"tidyverse\"をインストールしたいところだが、`install.packages`のほうが、インストール過程の詳細なメッセージが見られるので、今回は後者を推す。\n\nうまくいかなかった場合はメッセージを確認しよう。\n\nRStudioServerをインストールした人は、Rコード部分はRStudioServer上でやってもいい。\n\n```\n/bin/bash: g++: command not found\n```\n\nのようなメッセージが出てきた場合は、システム側に不足なソフトウェアがある（上述の場合は`g++`)\n大体の`tidyverse`インストール周りのトラブルはこのエラーに起因している。\n一通りシステムに必要なソフトをインストールしたら、もう一度、`tidyverse`をインストールしてみよう。\n\n\n```\nError in library.dynam(lib, package, package.lib) : \n  shared object ‘readxl.so’ not found\n```\n\nというようなメッセージがあれば、個別にRのパッケージをインストールしてみるといい（上述の場合は`readxl`）。\n\nこれで、だいたいRを快適に利用できるようになったはずだ。\n\n#その他のパッケージの導入\n\nこのあたりはお好みで。\n\n```\nneeds(data.table, pipeR)\n```\n\n`data.table`は、data.frameの拡張するもの。\n他に、表形式ファイルを`base::read.csv`などよりも高速に読み込める`fread`や、`base::write.csv`などよりも高速に書き込める`fwrite`などの関数が用意されている。\n\n`pipeR`はRでパイプラインを可能にするパッケージ。\n`magrittr`とライバル関係（？）にあたるが、パフォーマンスなどの観点で`pipeR`の方が優れているらしい。\n\n\n"],"coediting":[false],"comments_count":[0],"created_at":["2017-05-30T15:12:02+09:00"],"group":{},"id":["cf15fc37a170fae610c9"],"likes_count":[1],"private":[false],"reactions_count":[0],"tags":[{"name":["R"],"versions":[]},{"name":["RStudioServer"],"versions":[]},{"name":["tidyverse"],"versions":[]},{"name":["needs"],"versions":[]}],"title":["Linux MintにRとよく使うパッケージとかをインストール"],"updated_at":["2017-05-30T15:12:02+09:00"],"url":["https://qiita.com/Atsushi776/items/cf15fc37a170fae610c9"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["\n<h1>\n<span id=\"はじめに\" class=\"fragment\"><\/span><a href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\"><i class=\"fa fa-link\"><\/i><\/a>はじめに<\/h1>\n\n<p>Rmarkdownで日本語を含むPDFを作成する際、躓きやすいポイントと対処方法を紹介する。<\/p>\n\n<p>Rmakrdownを未だ導入していない人は<br>\n<a href=\"http://gihyo.jp/admin/serial/01/r-markdown/0002\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\">http://gihyo.jp/admin/serial/01/r-markdown/0002<\/a><br>\nあたりを参考にして欲しい。<\/p>\n\n<p>RMarkdownを使えば、<\/p>\n\n<ul>\n<li> Markdown記法を中心としつつ、数式にTeX記法、メタデータにYAML記法と、柔軟且つ容易でキレイなテキストの作成が可能<\/li>\n<li> Rコードが自動着色される<\/li>\n<li> Rコード実行結果の添付される<\/li>\n<li> html, docx, pdfなど適宜出力形式を選択できる<\/li>\n<\/ul>\n\n<p>といったメリットがある。<\/p>\n\n<p>このうち、PDFの出力は、TeX環境の事前準備が必要な上、日本語の取り扱いが若干トリッキーなのだ。<\/p>\n\n<h1>\n<span id=\"参考にしたwebサイト\" class=\"fragment\"><\/span><a href=\"#%E5%8F%82%E8%80%83%E3%81%AB%E3%81%97%E3%81%9Fweb%E3%82%B5%E3%82%A4%E3%83%88\"><i class=\"fa fa-link\"><\/i><\/a>参考にしたWebサイト<\/h1>\n\n<ul>\n<li> <a href=\"https://miyazakikenji.wordpress.com/2015/08/14/r-markdown-%E3%81%AB%E6%97%A5%E6%9C%AC%E8%AA%9Epdf/\" rel=\"nofollow noopener\" target=\"_blank\">miyazakikenji: R Markdown に日本語pdf<\/a>\n<\/li>\n<li> <a href=\"http://www.trifields.jp/how-to-set-up-for-outputting-a-pdf-of-the-japanese-at-knitr-in-ubuntu-1404-and-r-1615\" rel=\"nofollow noopener\" target=\"_blank\">トライフィールズ: Ubuntu,R knitrで日本語のPDFを出力するための設定<\/a>\n<\/li>\n<li> <a href=\"http://cotaro-science.blogspot.jp/2017/03/pandoc-xelatex-pdf.html\" rel=\"nofollow noopener\" target=\"_blank\">コタの科学日記: pandoc + xelatex で日本語 PDF を作る<\/a>\n<\/li>\n<\/ul>\n\n<h1>\n<span id=\"rmarkdown環境の用意\" class=\"fragment\"><\/span><a href=\"#rmarkdown%E7%92%B0%E5%A2%83%E3%81%AE%E7%94%A8%E6%84%8F\"><i class=\"fa fa-link\"><\/i><\/a>Rmarkdown環境の用意<\/h1>\n\n<p><a href=\"http://gihyo.jp/admin/serial/01/r-markdown/0002\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\">http://gihyo.jp/admin/serial/01/r-markdown/0002<\/a><br>\nを参照<\/p>\n\n<h1>\n<span id=\"tex環境の用意\" class=\"fragment\"><\/span><a href=\"#tex%E7%92%B0%E5%A2%83%E3%81%AE%E7%94%A8%E6%84%8F\"><i class=\"fa fa-link\"><\/i><\/a>TeX環境の用意<\/h1>\n\n<p>メジャーなTeX環境には<\/p>\n\n<ul>\n<li> TeX Live\n\n<ul>\n<li> 世界的に最もメジャー<\/li>\n<li> 昨今では日本語組版も十全に行える<\/li>\n<\/ul>\n<\/li>\n<li> MikTex\n\n<ul>\n<li> RStudioオススメ<\/li>\n<li> 日本語対応はほどほどらしい<\/li>\n<\/ul>\n<\/li>\n<li> W32Tex\n\n<ul>\n<li> 日本で最もメジャー<\/li>\n<li> 日本語組版も安心<\/li>\n<li> インストール後、PATHを通す必要がある(Windows)<\/li>\n<\/ul>\n<\/li>\n<\/ul>\n\n<p>などがある。<br>\n今回はTeX Live 2016を用いた。<br>\nインストーラは日本語でも動き、簡単にインストールできる。<br>\nただし、3時間以上かかるので、時間があるときに行うことを勧める。<\/p>\n\n<h1>\n<span id=\"yamlでlatexエンジンを選ぶ\" class=\"fragment\"><\/span><a href=\"#yaml%E3%81%A7latex%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%B3%E3%82%92%E9%81%B8%E3%81%B6\"><i class=\"fa fa-link\"><\/i><\/a>YAMLでLaTeXエンジンを選ぶ<\/h1>\n\n<p>Rmarkdownで利用できるLaTeXエンジンには<\/p>\n\n<ul>\n<li> pdflatex\n\n<ul>\n<li> 日本語不可<\/li>\n<\/ul>\n<\/li>\n<li> xelatex\n\n<ul>\n<li> 日本語可<\/li>\n<\/ul>\n<\/li>\n<li> lualatex\n\n<ul>\n<li> 日本語可<\/li>\n<\/ul>\n<\/li>\n<\/ul>\n\n<p>の三種類。<br>\n実用上はxelatexかlualatexとなる。<br>\nxelatexはlualatexよりも出力が3倍程度速いらしい(<a href=\"http://cotaro-science.blogspot.jp/2017/03/pandoc-xelatex-pdf.html\" class=\"autolink\" rel=\"nofollow noopener\" target=\"_blank\">http://cotaro-science.blogspot.jp/2017/03/pandoc-xelatex-pdf.html<\/a>)<\/p>\n\n<h2>\n<span id=\"xelatexを用いる場合\" class=\"fragment\"><\/span><a href=\"#xelatex%E3%82%92%E7%94%A8%E3%81%84%E3%82%8B%E5%A0%B4%E5%90%88\"><i class=\"fa fa-link\"><\/i><\/a>xelatexを用いる場合<\/h2>\n\n<p>.Rmdファイル<strong>冒頭<\/strong>に以下のYAMLを記載する。<br>\nYAMLには他にもタイトルや著者などのメタデータを記入できる。<\/p>\n\n<div class=\"code-frame\" data-lang=\"yaml\"><div class=\"highlight\"><pre><span class=\"nn\">---<\/span>\n<span class=\"na\">output<\/span><span class=\"pi\">:<\/span>\n  <span class=\"na\">pdf_document<\/span><span class=\"pi\">:<\/span> \n    <span class=\"na\">latex_engine<\/span><span class=\"pi\">:<\/span> <span class=\"s\">xelatex<\/span> \n<span class=\"na\">header-includes<\/span><span class=\"pi\">:<\/span> \n  <span class=\"pi\">-<\/span> <span class=\"s\">\\usepackage{bookmark}<\/span> \n  <span class=\"pi\">-<\/span> <span class=\"s\">\\usepackage{xltxtra}<\/span> \n  <span class=\"pi\">-<\/span> <span class=\"s\">\\usepackage{zxjatype}<\/span> \n  <span class=\"pi\">-<\/span> <span class=\"s\">\\usepackage[ipa]{zxjafont}<\/span> \n<span class=\"nn\">---<\/span>\n<\/pre><\/div><\/div>\n\n<p>ネット上では<code>- \\usepackage{bookmark}<\/code>を読み込まない例も見受けられたが、当方ではこれがないと失敗した。<\/p>\n\n<p>または、<\/p>\n\n<div class=\"code-frame\" data-lang=\"yaml\"><div class=\"highlight\"><pre><span class=\"nn\">---<\/span>\n<span class=\"na\">output<\/span><span class=\"pi\">:<\/span>\n  <span class=\"na\">pdf_document<\/span><span class=\"pi\">:<\/span> \n    <span class=\"na\">latex_engine<\/span><span class=\"pi\">:<\/span> <span class=\"s\">xelatex<\/span> \n<span class=\"na\">documentclass<\/span><span class=\"pi\">:<\/span> <span class=\"s\">bxjsarticle<\/span>\n<span class=\"na\">classoption<\/span><span class=\"pi\">:<\/span> <span class=\"s\">xelatex,ja=standard<\/span>\n<span class=\"na\">geometry<\/span><span class=\"pi\">:<\/span> <span class=\"s\">no<\/span>\n<span class=\"nn\">---<\/span>\n<\/pre><\/div><\/div>\n\n<p>でもよい。<\/p>\n\n<h2>\n<span id=\"lualatexを用いる場合\" class=\"fragment\"><\/span><a href=\"#lualatex%E3%82%92%E7%94%A8%E3%81%84%E3%82%8B%E5%A0%B4%E5%90%88\"><i class=\"fa fa-link\"><\/i><\/a>lualatexを用いる場合<\/h2>\n\n<p>.Rmdファイル<strong>冒頭<\/strong>に以下のYAMLを記載する。<\/p>\n\n<div class=\"code-frame\" data-lang=\"yaml\"><div class=\"highlight\"><pre><span class=\"nn\">---<\/span>\n<span class=\"na\">output<\/span><span class=\"pi\">:<\/span>\n  <span class=\"na\">pdf_document<\/span><span class=\"pi\">:<\/span> \n    <span class=\"na\">latex_engine<\/span><span class=\"pi\">:<\/span> <span class=\"s\">lualatex<\/span> \n<span class=\"na\">documentclass<\/span><span class=\"pi\">:<\/span> <span class=\"s\">ltjsarticle<\/span> \n<span class=\"nn\">---<\/span>\n<\/pre><\/div><\/div>\n\n<h1>\n<span id=\"グラフに日本語が含まれる場合\" class=\"fragment\"><\/span><a href=\"#%E3%82%B0%E3%83%A9%E3%83%95%E3%81%AB%E6%97%A5%E6%9C%AC%E8%AA%9E%E3%81%8C%E5%90%AB%E3%81%BE%E3%82%8C%E3%82%8B%E5%A0%B4%E5%90%88\"><i class=\"fa fa-link\"><\/i><\/a>グラフに日本語が含まれる場合<\/h1>\n\n<p><a href=\"http://www.trifields.jp/how-to-set-up-for-outputting-a-pdf-of-the-japanese-at-knitr-in-ubuntu-1404-and-r-1615\" rel=\"nofollow noopener\" target=\"_blank\">トライフィールズ: Ubuntu,R knitrで日本語のPDFを出力するための設定<\/a>を参照<\/p>\n\n<h1>\n<span id=\"rmdファイルの文字コード\" class=\"fragment\"><\/span><a href=\"#rmd%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E6%96%87%E5%AD%97%E3%82%B3%E3%83%BC%E3%83%89\"><i class=\"fa fa-link\"><\/i><\/a>.Rmdファイルの文字コード<\/h1>\n\n<p>SJISで特に問題はない。<br>\nUTF-8(BOMなし)も使える。<br>\nUTF-8(BOMあり)はYAMLを正常に読み込まなくなる。<\/p>\n\n<h1>\n<span id=\"レンダリング\" class=\"fragment\"><\/span><a href=\"#%E3%83%AC%E3%83%B3%E3%83%80%E3%83%AA%E3%83%B3%E3%82%B0\"><i class=\"fa fa-link\"><\/i><\/a>レンダリング<\/h1>\n\n<div class=\"code-frame\" data-lang=\"r\"><div class=\"highlight\"><pre><span class=\"n\">require<\/span><span class=\"p\">(<\/span><span class=\"n\">rmarkdown<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><span class=\"n\">render<\/span><span class=\"p\">(<\/span><span class=\"s2\">\"test.Rmd\"<\/span><span class=\"p\">,<\/span><span class=\"w\"> <\/span><span class=\"n\">output_format<\/span><span class=\"w\"> <\/span><span class=\"o\">=<\/span><span class=\"w\"> <\/span><span class=\"s2\">\"pdf_document\"<\/span><span class=\"p\">)<\/span><span class=\"w\">\n<\/span><\/pre><\/div><\/div>\n\n<p>とすれば、\"test.pdf\"ファイルが作成される。<\/p>\n"],"body":["#はじめに\n\nRmarkdownで日本語を含むPDFを作成する際、躓きやすいポイントと対処方法を紹介する。\n\nRmakrdownを未だ導入していない人は\nhttp://gihyo.jp/admin/serial/01/r-markdown/0002\nあたりを参考にして欲しい。\n\nRMarkdownを使えば、\n\n-  Markdown記法を中心としつつ、数式にTeX記法、メタデータにYAML記法と、柔軟且つ容易でキレイなテキストの作成が可能\n-  Rコードが自動着色される\n-  Rコード実行結果の添付される\n-  html, docx, pdfなど適宜出力形式を選択できる\n\nといったメリットがある。\n\nこのうち、PDFの出力は、TeX環境の事前準備が必要な上、日本語の取り扱いが若干トリッキーなのだ。\n\n#参考にしたWebサイト\n\n-  [miyazakikenji: R Markdown に日本語pdf](https://miyazakikenji.wordpress.com/2015/08/14/r-markdown-%E3%81%AB%E6%97%A5%E6%9C%AC%E8%AA%9Epdf/)\n-  [トライフィールズ: Ubuntu,R knitrで日本語のPDFを出力するための設定](http://www.trifields.jp/how-to-set-up-for-outputting-a-pdf-of-the-japanese-at-knitr-in-ubuntu-1404-and-r-1615)\n-  [コタの科学日記: pandoc + xelatex で日本語 PDF を作る](http://cotaro-science.blogspot.jp/2017/03/pandoc-xelatex-pdf.html)\n\n#Rmarkdown環境の用意\n\nhttp://gihyo.jp/admin/serial/01/r-markdown/0002\nを参照\n\n#TeX環境の用意\n\nメジャーなTeX環境には\n\n-  TeX Live\n    -  世界的に最もメジャー\n    -  昨今では日本語組版も十全に行える\n-  MikTex\n    -  RStudioオススメ\n    -  日本語対応はほどほどらしい\n-  W32Tex\n    -  日本で最もメジャー\n    -  日本語組版も安心\n    -  インストール後、PATHを通す必要がある(Windows)\n\nなどがある。\n今回はTeX Live 2016を用いた。\nインストーラは日本語でも動き、簡単にインストールできる。\nただし、3時間以上かかるので、時間があるときに行うことを勧める。\n\n#YAMLでLaTeXエンジンを選ぶ\n\nRmarkdownで利用できるLaTeXエンジンには\n\n-  pdflatex\n    -  日本語不可\n-  xelatex\n    -  日本語可\n-  lualatex\n    -  日本語可\n\nの三種類。\n実用上はxelatexかlualatexとなる。\nxelatexはlualatexよりも出力が3倍程度速いらしい(http://cotaro-science.blogspot.jp/2017/03/pandoc-xelatex-pdf.html)\n\n##xelatexを用いる場合\n\n.Rmdファイル**冒頭**に以下のYAMLを記載する。\nYAMLには他にもタイトルや著者などのメタデータを記入できる。\n\n```yaml\n---\noutput:\n  pdf_document: \n    latex_engine: xelatex \nheader-includes: \n  - \\usepackage{bookmark} \n  - \\usepackage{xltxtra} \n  - \\usepackage{zxjatype} \n  - \\usepackage[ipa]{zxjafont} \n---\n```\n\nネット上では`  - \\usepackage{bookmark}`を読み込まない例も見受けられたが、当方ではこれがないと失敗した。\n\nまたは、\n\n```yaml\n---\noutput:\n  pdf_document: \n    latex_engine: xelatex \ndocumentclass: bxjsarticle\nclassoption: xelatex,ja=standard\ngeometry: no\n---\n```\n\nでもよい。\n\n##lualatexを用いる場合\n\n.Rmdファイル**冒頭**に以下のYAMLを記載する。\n\n```yaml\n---\noutput:\n  pdf_document: \n    latex_engine: lualatex \ndocumentclass: ltjsarticle \n---\n```\n\n#グラフに日本語が含まれる場合\n\n[トライフィールズ: Ubuntu,R knitrで日本語のPDFを出力するための設定](http://www.trifields.jp/how-to-set-up-for-outputting-a-pdf-of-the-japanese-at-knitr-in-ubuntu-1404-and-r-1615)を参照\n\n\n#.Rmdファイルの文字コード\n\nSJISで特に問題はない。\nUTF-8(BOMなし)も使える。\nUTF-8(BOMあり)はYAMLを正常に読み込まなくなる。\n\n#レンダリング\n\n```r\nrequire(rmarkdown)\nrender(\"test.Rmd\", output_format = \"pdf_document\")\n```\n\nとすれば、\"test.pdf\"ファイルが作成される。\n\n\n\n\n\n\n\n\n\n\n\n\n\n"],"coediting":[false],"comments_count":[0],"created_at":["2017-05-26T09:49:47+09:00"],"group":{},"id":["9ef1e5d744e2b91c61ee"],"likes_count":[26],"private":[false],"reactions_count":[0],"tags":[{"name":["LaTeX"],"versions":[]},{"name":["R"],"versions":[]},{"name":["RMarkdown"],"versions":[]}],"title":["Rmarkdownで日本語PDFを出力する"],"updated_at":["2018-03-12T14:23:20+09:00"],"url":["https://qiita.com/Atsushi776/items/9ef1e5d744e2b91c61ee"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["\n<h1>\n<span id=\"概要\" class=\"fragment\"><\/span><a href=\"#%E6%A6%82%E8%A6%81\"><i class=\"fa fa-link\"><\/i><\/a>概要<\/h1>\n\n<ul>\n<li>ポアソン分布に従うデータ(平均値$λ$)を時間や空間で規格化しようとして、定数$k$で割ると平均値$λ$は$λ/k$と分散は$λ/k^2$になる。<\/li>\n<li> 規格化されたカウントデータにおいて平均値 $\\neq$ 分散<\/li>\n<li> もはやポアソン分布ではなくなってしまう。<\/li>\n<li> ポアソン分布を仮定できるデータは個数データであって割合データではない。<\/li>\n<li> おまけにこれを体感できるRコードを付録した。<\/li>\n<\/ul>\n\n<h1>\n<span id=\"始めに\" class=\"fragment\"><\/span><a href=\"#%E5%A7%8B%E3%82%81%E3%81%AB\"><i class=\"fa fa-link\"><\/i><\/a>始めに<\/h1>\n\n<p>久保さんが「<a href=\"http://hosho.ees.hokudai.ac.jp/%7Ekubo/stat/2011/z/skubostat2011z.pdf\" rel=\"nofollow noopener\" target=\"_blank\">何でも「割算」するな<\/a>」と警鐘を鳴らしている。<\/p>\n\n<p>その理由の一つとして<\/p>\n\n<ul>\n<li> 観測値 / 観測値がどんな確率分布に従うのか見通しが悪い<\/li>\n<\/ul>\n\n<p>ということを挙げている。<\/p>\n\n<p>まさしくこの事例にあたる現象にぶつかったので紹介する。<\/p>\n\n<h1>\n<span id=\"単位時間あたりの信号検出率はポアソン分布にならない\" class=\"fragment\"><\/span><a href=\"#%E5%8D%98%E4%BD%8D%E6%99%82%E9%96%93%E3%81%82%E3%81%9F%E3%82%8A%E3%81%AE%E4%BF%A1%E5%8F%B7%E6%A4%9C%E5%87%BA%E7%8E%87%E3%81%AF%E3%83%9D%E3%82%A2%E3%82%BD%E3%83%B3%E5%88%86%E5%B8%83%E3%81%AB%E3%81%AA%E3%82%89%E3%81%AA%E3%81%84\"><i class=\"fa fa-link\"><\/i><\/a>単位時間あたりの信号検出率はポアソン分布にならない。<\/h1>\n\n<h2>\n<span id=\"過少分散の例\" class=\"fragment\"><\/span><a href=\"#%E9%81%8E%E5%B0%91%E5%88%86%E6%95%A3%E3%81%AE%E4%BE%8B\"><i class=\"fa fa-link\"><\/i><\/a>過少分散の例<\/h2>\n\n<p>以下に示すのはEPMA(電子線マイクロアナライザ)による単位時間あたりのX線カウント数の平均値(mean)と分散(var)の散布図。<br>\nmean = varとなるところに直線を引いてある。<\/p>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Fdd0b02d2-3735-5932-5f59-43bd59a2ac3b.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=0d17c8177d5b4eb9e59f5358be8e39cb\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Fdd0b02d2-3735-5932-5f59-43bd59a2ac3b.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=0d17c8177d5b4eb9e59f5358be8e39cb\" alt=\"underdispersion.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/dd0b02d2-3735-5932-5f59-43bd59a2ac3b.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2Fdd0b02d2-3735-5932-5f59-43bd59a2ac3b.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=4365ba4ff54d7b34bad32a485b700568 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>分散と平均値が比例していることにポアソン分布らしさを感じる。<br>\nしかし、ポアソン分布と見做すには、随分と過少分散しているのが分かる。<\/p>\n\n<h2>\n<span id=\"原因\" class=\"fragment\"><\/span><a href=\"#%E5%8E%9F%E5%9B%A0\"><i class=\"fa fa-link\"><\/i><\/a>原因<\/h2>\n\n<p>上述の問題は5秒間計測したデータを単位時間あたりのデータに変換してしまっているため。<\/p>\n\n<p>ポアソン分布に従うデータは、平均値($\\bar{x}$)と分散($s^2$)が同じになる特徴を持つ。<br>\nここで、標本分散の計算式は<\/p>\n\n<p>$s^2 = 1/(n-1)\\sum_{i=1}^{n}(\\bar{x} - x_i)^2$<\/p>\n\n<p>だから、元データが定数$k$で割られていた場合、新たに得られる平均値は$kλ$であるのに対し、分散は$k^2λ$となってしまう。<\/p>\n\n<p>従って分散 / 平均値 = kとなり、<\/p>\n\n<ul>\n<li>$k &gt; 1$ならば過少分散<\/li>\n<li>$0 &lt; k &lt; 1$ならば過剰分散<\/li>\n<\/ul>\n\n<p>が発生する。<\/p>\n\n<h2>\n<span id=\"どうする\" class=\"fragment\"><\/span><a href=\"#%E3%81%A9%E3%81%86%E3%81%99%E3%82%8B\"><i class=\"fa fa-link\"><\/i><\/a>どうする？<\/h2>\n\n<p>単位時間あたりのX線検出率を、X線検出回数に戻してやればいい。<br>\nつまり、データを5倍する。<\/p>\n\n<p><a href=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F4fcb1f12-0f08-6f8f-d358-5e02f4682ab6.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=4b2f1c1054e056347795d922ee41b340\" target=\"_blank\" rel=\"nofollow noopener\"><img src=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F4fcb1f12-0f08-6f8f-d358-5e02f4682ab6.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=4b2f1c1054e056347795d922ee41b340\" alt=\"poisson.png\" data-canonical-src=\"https://qiita-image-store.s3.amazonaws.com/0/149890/4fcb1f12-0f08-6f8f-d358-5e02f4682ab6.png\" srcset=\"https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F149890%2F4fcb1f12-0f08-6f8f-d358-5e02f4682ab6.png?ixlib=rb-1.2.2&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=f24d6685b987953d2744c4c7350cacf7 1x\" loading=\"lazy\"><\/a><\/p>\n\n<p>一部に過剰分散が認められるが、概ね平均値と分散が$1:1$になったのが分かると思う。<\/p>\n\n<h1>\n<span id=\"結論\" class=\"fragment\"><\/span><a href=\"#%E7%B5%90%E8%AB%96\"><i class=\"fa fa-link\"><\/i><\/a>結論<\/h1>\n\n<p>ポアソン分布はあくまで個数データに期待される分布で、割合データに期待するものではない。<\/p>\n\n<h1>\n<span id=\"おまけrコード\" class=\"fragment\"><\/span><a href=\"#%E3%81%8A%E3%81%BE%E3%81%91r%E3%82%B3%E3%83%BC%E3%83%89\"><i class=\"fa fa-link\"><\/i><\/a>おまけ(Rコード)<\/h1>\n\n<p>今回の問題を体感してもらえるRコードを残しておきます。<\/p>\n\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>\n#模擬データの作成\n\n##集団の数\ngroup &lt;- 30 \n\n##各集団に属する固体の数\n\nn_min &lt;- 1\nn_max &lt;- 100\n\nn &lt;- round(runif(group, n_min, n_max))\n\n##各集団の何らかのカウントデータの平均値\nlambda_min &lt;- 9.1\nlambda_max &lt;- 100\n\nlambda &lt;- round(runif(group, lambda_min, lambda_max))\n\n##集団ごとに、乱数を生成\nd &lt;- Map(rpois, lambda, n)\n\n##集団ごとの平均値、分散を算出\nd_mean &lt;- sapply(d, mean)\nd_var &lt;- sapply(d, var)\n\n##プロット(平均値v.s.分散)\n##結果はy = xに乗る\nplot(d_mean, d_var, xlim = c(0, max(d_mean)), ylim = c(0, max(d_var)))\nabline(0, 1)\n\n\n##dを定数kで割った時の\n##平均値v.s.分散\n##結果はy = xから外れる\nk &lt;- 5\n\nd_per_k &lt;- lapply(d, `/`, k)\nd_per_k_mean &lt;- sapply(d_per_k, mean)\nd_per_k_var &lt;- sapply(d_per_k, var)\n\nplot(d_per_k_mean, d_per_k_var, xlim = c(0, max(d_per_k_mean)), ylim = c(0, max(d_per_k_var)))\nabline(0, 1)\n\n\n<\/pre><\/div><\/div>\n"],"body":["#概要\n\n- ポアソン分布に従うデータ(平均値$λ$)を時間や空間で規格化しようとして、定数$k$で割ると平均値$λ$は$λ/k$と分散は$λ/k^2$になる。\n-  規格化されたカウントデータにおいて平均値 $\\neq$ 分散\n-  もはやポアソン分布ではなくなってしまう。\n-  ポアソン分布を仮定できるデータは個数データであって割合データではない。\n-  おまけにこれを体感できるRコードを付録した。\n\n#始めに\n\n久保さんが「[何でも「割算」するな](http://hosho.ees.hokudai.ac.jp/~kubo/stat/2011/z/skubostat2011z.pdf)」と警鐘を鳴らしている。\n\nその理由の一つとして\n\n  -  観測値 / 観測値がどんな確率分布に従うのか見通しが悪い\n\nということを挙げている。\n\nまさしくこの事例にあたる現象にぶつかったので紹介する。\n\n\n#単位時間あたりの信号検出率はポアソン分布にならない。\n\n##過少分散の例\n\n以下に示すのはEPMA(電子線マイクロアナライザ)による単位時間あたりのX線カウント数の平均値(mean)と分散(var)の散布図。\nmean = varとなるところに直線を引いてある。\n\n![underdispersion.png](https://qiita-image-store.s3.amazonaws.com/0/149890/dd0b02d2-3735-5932-5f59-43bd59a2ac3b.png)\n\n分散と平均値が比例していることにポアソン分布らしさを感じる。\nしかし、ポアソン分布と見做すには、随分と過少分散しているのが分かる。\n\n##原因\n\n上述の問題は5秒間計測したデータを単位時間あたりのデータに変換してしまっているため。\n\nポアソン分布に従うデータは、平均値($\\bar{x}$)と分散($s^2$)が同じになる特徴を持つ。\nここで、標本分散の計算式は\n\n$s^2 = 1/(n-1)\\sum_{i=1}^{n}(\\bar{x} - x_i)^2$\n\nだから、元データが定数$k$で割られていた場合、新たに得られる平均値は$kλ$であるのに対し、分散は$k^2λ$となってしまう。\n\n従って分散 / 平均値 = kとなり、\n\n- $k > 1$ならば過少分散\n- $0 < k < 1$ならば過剰分散\n\nが発生する。\n\n##どうする？\n\n単位時間あたりのX線検出率を、X線検出回数に戻してやればいい。\nつまり、データを5倍する。\n\n![poisson.png](https://qiita-image-store.s3.amazonaws.com/0/149890/4fcb1f12-0f08-6f8f-d358-5e02f4682ab6.png)\n\n一部に過剰分散が認められるが、概ね平均値と分散が$1:1$になったのが分かると思う。\n\n#結論\n\nポアソン分布はあくまで個数データに期待される分布で、割合データに期待するものではない。\n\n#おまけ(Rコード)\n\n今回の問題を体感してもらえるRコードを残しておきます。\n\n```\n\n#模擬データの作成\n\n##集団の数\ngroup <- 30 \n\n##各集団に属する固体の数\n\nn_min <- 1\nn_max <- 100\n\nn <- round(runif(group, n_min, n_max))\n\n##各集団の何らかのカウントデータの平均値\nlambda_min <- 9.1\nlambda_max <- 100\n\nlambda <- round(runif(group, lambda_min, lambda_max))\n\n##集団ごとに、乱数を生成\nd <- Map(rpois, lambda, n)\n\n##集団ごとの平均値、分散を算出\nd_mean <- sapply(d, mean)\nd_var <- sapply(d, var)\n\n##プロット(平均値v.s.分散)\n##結果はy = xに乗る\nplot(d_mean, d_var, xlim = c(0, max(d_mean)), ylim = c(0, max(d_var)))\nabline(0, 1)\n\n\n##dを定数kで割った時の\n##平均値v.s.分散\n##結果はy = xから外れる\nk <- 5\n\nd_per_k <- lapply(d, `/`, k)\nd_per_k_mean <- sapply(d_per_k, mean)\nd_per_k_var <- sapply(d_per_k, var)\n\nplot(d_per_k_mean, d_per_k_var, xlim = c(0, max(d_per_k_mean)), ylim = c(0, max(d_per_k_var)))\nabline(0, 1)\n\n\n```\n\n\n\n\n\n\n\n\n\n\n"],"coediting":[false],"comments_count":[0],"created_at":["2017-05-11T15:53:11+09:00"],"group":{},"id":["e276d37069eddf296f5a"],"likes_count":[1],"private":[false],"reactions_count":[0],"tags":[{"name":["R"],"versions":[]},{"name":["確率分布"],"versions":[]},{"name":["ポアソン分布"],"versions":[]}],"title":["何でも割り算はNGらしい"],"updated_at":["2017-05-11T15:53:11+09:00"],"url":["https://qiita.com/Atsushi776/items/e276d37069eddf296f5a"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["\n<h1>\n<span id=\"結論\" class=\"fragment\"><\/span><a href=\"#%E7%B5%90%E8%AB%96\"><i class=\"fa fa-link\"><\/i><\/a>結論<\/h1>\n\n<p>Rを閉じるボタンで即座にsaveせず終了するようにしたければ、.Rprofileに<\/p>\n\n<p><code>q &lt;- function (save = \"no\", status = 0, runLast = TRUE) .Internal(quit(save, status, runLast))<\/code><\/p>\n\n<p>を追加しよう。<\/p>\n\n<p>注意: 既存の関数の上書きはバグの温床になりかねないので自己責任でお願いします。<\/p>\n\n<h1>\n<span id=\"rを終了するには\" class=\"fragment\"><\/span><a href=\"#r%E3%82%92%E7%B5%82%E4%BA%86%E3%81%99%E3%82%8B%E3%81%AB%E3%81%AF\"><i class=\"fa fa-link\"><\/i><\/a>Rを終了するには<\/h1>\n\n<ul>\n<li> 閉じるボタン<\/li>\n<li> <code>q()<\/code>\n<\/li>\n<\/ul>\n\n<p>のどちらかを実行する。<br>\nこの時セッションを保存するか聞かれるが、だいたい保存しない(と思う)。<br>\n聞かれたくない人は<\/p>\n\n<p><code>q(save = \"no\")<\/code><\/p>\n\n<p>を実行する必要がある。<\/p>\n\n<p>または、「<a href=\"http://d.hatena.ne.jp/hoxo_m/20111026/p1\" rel=\"nofollow noopener\" target=\"_blank\">R を終了させる最短コードがおもしろい<\/a>」でも紹介されているように、<\/p>\n\n<p><code>class(Q)=Q=\"no\";print.no=q<\/code><\/p>\n\n<p>を.Rprofileに記入しておくと、<code>Q<\/code>一文字で終了できる。<\/p>\n\n<h1>\n<span id=\"閉じるボタンでも即終了したいんじゃ\" class=\"fragment\"><\/span><a href=\"#%E9%96%89%E3%81%98%E3%82%8B%E3%83%9C%E3%82%BF%E3%83%B3%E3%81%A7%E3%82%82%E5%8D%B3%E7%B5%82%E4%BA%86%E3%81%97%E3%81%9F%E3%81%84%E3%82%93%E3%81%98%E3%82%83\"><i class=\"fa fa-link\"><\/i><\/a>閉じるボタンでも即終了したいんじゃ！<\/h1>\n\n<p>という人は、<\/p>\n\n<p>関数<code>q<\/code>の引数既定値を<code>save = \"no\"<\/code>にして上書きすればいい。<\/p>\n\n<p>標準では<br>\n<code>q &lt;- function (save = \"default\", status = 0, runLast = TRUE) .Internal(quit(save, status, runLast))<\/code><\/p>\n\n<p>となっているので、<\/p>\n\n<p><code>q &lt;- function (save = \"no\", status = 0, runLast = TRUE) .Internal(quit(save, status, runLast))<\/code><\/p>\n\n<p>として、これを.Rprofileに書き込む。<\/p>\n\n<p>既存の関数の上書きはバグの温床になりかねないので自己責任でお願いします。<br>\n最も、他の関数から<code>q<\/code>が呼び出されることなんて早々ないだろうから大丈夫だろうと思うのですが……。<\/p>\n\n<p>ちなみに、<code>rm(q)<\/code>すればいつでも元の<code>q<\/code>(すなわち<code>base::q<\/code>)が使えるようになります。<\/p>\n\n<p>これは上述の<code>class(Q)=Q=\"no\";print.no=q<\/code>とも共存可能で、これでコンソールからでも閉じるボタンからでも即座にRを終了できるようになりました。<\/p>\n\n<p>やったネ！<\/p>\n"],"body":["#結論\n\nRを閉じるボタンで即座にsaveせず終了するようにしたければ、.Rprofileに\n\n`q <- function (save = \"no\", status = 0, runLast = TRUE) .Internal(quit(save, status, runLast))`\n\nを追加しよう。\n\n注意: 既存の関数の上書きはバグの温床になりかねないので自己責任でお願いします。\n\n#Rを終了するには\n\n-  閉じるボタン\n-  `q()`\n\nのどちらかを実行する。\nこの時セッションを保存するか聞かれるが、だいたい保存しない(と思う)。\n聞かれたくない人は\n\n`q(save = \"no\")`\n\nを実行する必要がある。\n\nまたは、「[R を終了させる最短コードがおもしろい](http://d.hatena.ne.jp/hoxo_m/20111026/p1)」でも紹介されているように、\n\n`class(Q)=Q=\"no\";print.no=q`\n\nを.Rprofileに記入しておくと、`Q`一文字で終了できる。\n\n#閉じるボタンでも即終了したいんじゃ！\n\nという人は、\n\n関数`q`の引数既定値を`save = \"no\"`にして上書きすればいい。\n\n標準では\n`q <- function (save = \"default\", status = 0, runLast = TRUE) .Internal(quit(save, status, runLast))`\n\nとなっているので、\n\n`q <- function (save = \"no\", status = 0, runLast = TRUE) .Internal(quit(save, status, runLast))`\n\nとして、これを.Rprofileに書き込む。\n\n既存の関数の上書きはバグの温床になりかねないので自己責任でお願いします。\n最も、他の関数から`q`が呼び出されることなんて早々ないだろうから大丈夫だろうと思うのですが……。\n\nちなみに、`rm(q)`すればいつでも元の`q`(すなわち`base::q`)が使えるようになります。\n\nこれは上述の`class(Q)=Q=\"no\";print.no=q`とも共存可能で、これでコンソールからでも閉じるボタンからでも即座にRを終了できるようになりました。\n\nやったネ！\n\n\n\n\n\n\n\n\n\n\n\n\n"],"coediting":[false],"comments_count":[0],"created_at":["2017-04-30T21:00:01+09:00"],"group":{},"id":["290255f6944caa9e5474"],"likes_count":[0],"private":[false],"reactions_count":[0],"tags":[{"name":["R"],"versions":[]}],"title":["Rを閉じるボタンで即座にsaveせず終了する"],"updated_at":["2017-04-30T21:00:01+09:00"],"url":["https://qiita.com/Atsushi776/items/290255f6944caa9e5474"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}},{"rendered_body":["\n<h1>\n<span id=\"概要\" class=\"fragment\"><\/span><a href=\"#%E6%A6%82%E8%A6%81\"><i class=\"fa fa-link\"><\/i><\/a>概要<\/h1>\n\n<p>data.table::freadは行が観測値、列が変数な表を読み込む関数<br>\n行が変数で列が観測値な表をfreadすると残念な結果になるから工夫しよう<\/p>\n\n<h1>\n<span id=\"rで表形式のファイルcsvなどを読み込む一般的な方法\" class=\"fragment\"><\/span><a href=\"#r%E3%81%A7%E8%A1%A8%E5%BD%A2%E5%BC%8F%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%83%ABcsv%E3%81%AA%E3%81%A9%E3%82%92%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%82%80%E4%B8%80%E8%88%AC%E7%9A%84%E3%81%AA%E6%96%B9%E6%B3%95\"><i class=\"fa fa-link\"><\/i><\/a>Rで表形式のファイル(csvなど)を読み込む一般的な方法<\/h1>\n\n<ul>\n<li>read.table<\/li>\n<li>readr::read_delim<\/li>\n<li>readxl::readxlsx<\/li>\n<li>data.table::fread<\/li>\n<li>など<\/li>\n<\/ul>\n\n<p>これらはいずれも、行に観測値を記録したファイルの読み込みしか対応していない。<br>\n例えばiris[1:5, ]のような表。<\/p>\n\n<table>\n<thead>\n<tr>\n<th style=\"text-align: center\"><\/th>\n<th style=\"text-align: center\">Sepal.Length<\/th>\n<th style=\"text-align: center\">Sepal.Width<\/th>\n<th style=\"text-align: center\">Petal.Length<\/th>\n<th style=\"text-align: center\">Petal.Width<\/th>\n<th style=\"text-align: center\">Species<\/th>\n<\/tr>\n<\/thead>\n<tbody>\n<tr>\n<td style=\"text-align: center\">1<\/td>\n<td style=\"text-align: center\">5.1<\/td>\n<td style=\"text-align: center\">3.5<\/td>\n<td style=\"text-align: center\">1.4<\/td>\n<td style=\"text-align: center\">0.2<\/td>\n<td style=\"text-align: center\">setosa<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: center\">2<\/td>\n<td style=\"text-align: center\">4.9<\/td>\n<td style=\"text-align: center\">3.0<\/td>\n<td style=\"text-align: center\">1.4<\/td>\n<td style=\"text-align: center\">0.2<\/td>\n<td style=\"text-align: center\">setosa<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: center\">3<\/td>\n<td style=\"text-align: center\">4.7<\/td>\n<td style=\"text-align: center\">3.2<\/td>\n<td style=\"text-align: center\">1.3<\/td>\n<td style=\"text-align: center\">0.2<\/td>\n<td style=\"text-align: center\">setosa<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: center\">4<\/td>\n<td style=\"text-align: center\">4.6<\/td>\n<td style=\"text-align: center\">3.1<\/td>\n<td style=\"text-align: center\">1.5<\/td>\n<td style=\"text-align: center\">0.2<\/td>\n<td style=\"text-align: center\">setosa<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: center\">5<\/td>\n<td style=\"text-align: center\">5.0<\/td>\n<td style=\"text-align: center\">3.6<\/td>\n<td style=\"text-align: center\">1.4<\/td>\n<td style=\"text-align: center\">0.2<\/td>\n<td style=\"text-align: center\">setosa<\/td>\n<\/tr>\n<\/tbody>\n<\/table>\n\n<p>しかし、以下のように列に観測値を記録していく業界もあるのだ……。<\/p>\n\n<table>\n<thead>\n<tr>\n<th style=\"text-align: center\"><\/th>\n<th style=\"text-align: center\">1<\/th>\n<th style=\"text-align: center\">2<\/th>\n<th style=\"text-align: center\">3<\/th>\n<th style=\"text-align: center\">4<\/th>\n<th style=\"text-align: center\">5<\/th>\n<\/tr>\n<\/thead>\n<tbody>\n<tr>\n<td style=\"text-align: center\">Sepal.Length<\/td>\n<td style=\"text-align: center\">5.1<\/td>\n<td style=\"text-align: center\">4.9<\/td>\n<td style=\"text-align: center\">4.7<\/td>\n<td style=\"text-align: center\">4.6<\/td>\n<td style=\"text-align: center\">5.0<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: center\">Sepal.Width<\/td>\n<td style=\"text-align: center\">3.5<\/td>\n<td style=\"text-align: center\">3.0<\/td>\n<td style=\"text-align: center\">3.2<\/td>\n<td style=\"text-align: center\">3.1<\/td>\n<td style=\"text-align: center\">3.6<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: center\">Petal.Length<\/td>\n<td style=\"text-align: center\">1.4<\/td>\n<td style=\"text-align: center\">1.4<\/td>\n<td style=\"text-align: center\">1.3<\/td>\n<td style=\"text-align: center\">1.5<\/td>\n<td style=\"text-align: center\">1.4<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: center\">Petal.Width<\/td>\n<td style=\"text-align: center\">0.2<\/td>\n<td style=\"text-align: center\">0.2<\/td>\n<td style=\"text-align: center\">0.2<\/td>\n<td style=\"text-align: center\">0.2<\/td>\n<td style=\"text-align: center\">0.2<\/td>\n<\/tr>\n<tr>\n<td style=\"text-align: center\">Species<\/td>\n<td style=\"text-align: center\">setosa<\/td>\n<td style=\"text-align: center\">setosa<\/td>\n<td style=\"text-align: center\">setosa<\/td>\n<td style=\"text-align: center\">setosa<\/td>\n<td style=\"text-align: center\">setosa<\/td>\n<\/tr>\n<\/tbody>\n<\/table>\n\n<p>後者をcsvファイルとして、例えばdata.table::freadで読み込むと以下の問題が起こる<\/p>\n\n<ul>\n<li>data.tableはrow.namesを持たないので、項目(例えばSepal.Length)が観測値扱いになる<\/li>\n<li>各列の型がcharacterになってしまい、plotなどで扱い辛い\n\n<ul>\n<li>data.tableはlist of columnsなので、型は列ごとに一意でなければならない。従って、列中に含まれる値を最も柔軟に表現できる型が選ばれる。<\/li>\n<\/ul>\n<\/li>\n<li>無論、読み込んだデータをtransposeしても、理想的に成形された表形式データを得られない<\/li>\n<li>他にも細かい面倒が色々。<\/li>\n<\/ul>\n\n<blockquote>\n<p>#今回は表の読み込みにdata.tableパッケージを使う<br>\nrequire(data.table)<\/p>\n\n<p>#iris[1:5, ]を元にcsvファイルを用意<br>\ncsv &lt;- \"Sepal.Length,5.1,4.9,4.7,4.6,5.0\\nSepal.Width,3.5,3.0,3.2,3.1,3.6\\nPetal.Length,1.4,1.4,1.3,1.5,1.4\\nPetal.Width,0.2,0.2,0.2,0.2,0.2\\nSpecies,setosa,setosa,setosa,setosa,setosa\\n\"<\/p>\n\n<p>#csvファイルを読み込み<br>\nd &lt;- fread(csv)<\/p>\n\n<p>#各列の型はcharacterにcoercedされている<br>\nsapply(d, typeof)<\/p>\n\n<blockquote>\n<div class=\"code-frame\" data-lang=\"text\"><div class=\"highlight\"><pre>V1          V2          V3          V4          V5          V6 \n<\/pre><\/div><\/div>\n\n<p>\"character\" \"character\" \"character\" \"character\" \"character\" \"character\" <\/p>\n<\/blockquote>\n\n<p>#transposeしてみると<br>\n(現実 &lt;- t(d))<\/p>\n\n<blockquote>\n<p>[,1]           [,2]          [,3]           [,4]          [,5]<br><br>\nV1 \"Sepal.Length\" \"Sepal.Width\" \"Petal.Length\" \"Petal.Width\" \"Species\"<br>\nV2 \"5.1\"          \"3.5\"         \"1.4\"          \"0.2\"         \"setosa\" <br>\nV3 \"4.9\"          \"3.0\"         \"1.4\"          \"0.2\"         \"setosa\" <br>\nV4 \"4.7\"          \"3.2\"         \"1.3\"          \"0.2\"         \"setosa\" <br>\nV5 \"4.6\"          \"3.1\"         \"1.5\"          \"0.2\"         \"setosa\" <br>\nV6 \"5.0\"          \"3.6\"         \"1.4\"          \"0.2\"         \"setosa\" <\/p>\n<\/blockquote>\n\n<p>(理想 &lt;- data.table::as.data.table(iris[1:5, ]))<\/p>\n\n<blockquote>\n<p>Sepal.Length Sepal.Width Petal.Length Petal.Width Species<br>\n1:          5.1         3.5          1.4         0.2  setosa<br>\n2:          4.9         3.0          1.4         0.2  setosa<br>\n3:          4.7         3.2          1.3         0.2  setosa<br>\n4:          4.6         3.1          1.5         0.2  setosa<br>\n5:          5.0         3.6          1.4         0.2  setosa<\/p>\n<\/blockquote>\n\n<p>現実 == 理想<\/p>\n\n<blockquote>\n<p>FALSE<\/p>\n<\/blockquote>\n<\/blockquote>\n\n<p>現実と理想の差を悔み、本論から目を反らした話をすると、Rは日本語を変数にできる。<\/p>\n\n<h1>\n<span id=\"どうする\" class=\"fragment\"><\/span><a href=\"#%E3%81%A9%E3%81%86%E3%81%99%E3%82%8B\"><i class=\"fa fa-link\"><\/i><\/a>どうする？<\/h1>\n\n<ul>\n<li>毎回、元データをtransposeしてcsvに保存<\/li>\n<li>R上でデータを整形する関数を作る<\/li>\n<\/ul>\n\n<p>前者は面倒なので後者を試みる。<\/p>\n\n<h2>\n<span id=\"雛形\" class=\"fragment\"><\/span><a href=\"#%E9%9B%9B%E5%BD%A2\"><i class=\"fa fa-link\"><\/i><\/a>雛形<\/h2>\n\n<ol>\n<li>データをheaderなしcharacter型のdata.tableとして読込<\/li>\n<li>各列中の文字列をコンマ区切りの文字列として結合<\/li>\n<li>2の各項を改行文字(\\n)で結合<\/li>\n<li>freadし直す(headerアリ)<\/li>\n<\/ol>\n\n<blockquote>\n<p>require(data.table)<br>\nrequire(pipeR)<br>\n#transpose fread<br>\ntfread &lt;- function(input) {<br>\n    input %&gt;&gt;%<br>\n        data.table::fread(header = FALSE) %&gt;&gt;%<br>\n        as.matrix %&gt;&gt;% <br>\n        apply(2, paste, collapse = \",\") %&gt;&gt;%<br>\n        paste(collapse = \"\\n\") %&gt;&gt;%<br>\n        data.table::fread(header = TRUE)<\/p>\n<\/blockquote>\n\n<h2>\n<span id=\"更に便利に\" class=\"fragment\"><\/span><a href=\"#%E6%9B%B4%E3%81%AB%E4%BE%BF%E5%88%A9%E3%81%AB\"><i class=\"fa fa-link\"><\/i><\/a>更に便利に<\/h2>\n\n<ul>\n<li>2回のfreadに好きなargumentを与えたい<\/li>\n<li>表計算ソフト上のエラーメッセージ(e.g., #DIV/0!)を欠損値にしたい\n\n<ul>\n<li>放置すると、エラーメッセージを含む変数の型はcharacter型になってしまう<\/li>\n<\/ul>\n<\/li>\n<li>空白の行・列を削除して、すっきりさせたい<\/li>\n<\/ul>\n\n<h3>\n<span id=\"うおりゃあああ\" class=\"fragment\"><\/span><a href=\"#%E3%81%86%E3%81%8A%E3%82%8A%E3%82%83%E3%81%82%E3%81%82%E3%81%82\"><i class=\"fa fa-link\"><\/i><\/a>うおりゃあああ<\/h3>\n\n<blockquote>\n<p>require(data.table)<br>\nrequire(stringr)<\/p>\n\n<p>tfread &lt;- function(input, remove_null = TRUE, ss = c('excel', 'libre'), args1 = list(), args2 = list()) {<br>\n  #ABOUT ARGUMENTS#################################################<br>\n  #remove_null = TRUE removes null rows and columns<br>\n  #ss: spread sheet<br>\n  #args1: list of arguments to fread input data<br><br>\n  #args2: list of arguments to fread the transposed input data<br>\n  #When there are duplicated arguments in args1 and args2, the prior argument has priority<br>\n  #i.e., args1 = list(a = 1, a = 2, b = 3) is equivalent to args1 = list(a = 1, b = 3)<\/p>\n\n<p>#read table as character matrix##################################<br>\n  #complete arguments<br>\n  args1 &lt;- c(args1, input = input, header = FALSE, colClasses = 'character')<br>\n  #remove duplicated arguments<br>\n  args1 &lt;- args1[!duplicated(names(args1))]<br>\n  #1st fread<br>\n  d &lt;- as.matrix(do.call(data.table::fread, args1))<br>\n  rm(args1)<\/p>\n\n<p>#replace error messages to blank#####################################<br>\n  if(stringr::str_detect(ss[1], '^(excel|libre)$')) {<br>\n      d &lt;- matrix(stringr::str_replace_all(d, '^#.*\\!$', ''), nrow = nrow(d), ncol = ncol(d))<br>\n  }<\/p>\n\n<p>#whether to remove rows and cols with no data############################<br>\n  if(remove_null){<br>\n      filled &lt;- d != ''<br>\n      filled[is.na(filled)] &lt;- FALSE<br>\n      rows &lt;- rowSums(filled) != 0<br>\n      cols &lt;- colSums(filled) != 0<br>\n  } else {<br>\n      rows &lt;- rep(TRUE, nrow(d))<br>\n      cols &lt;- rep(TRUE, ncol(d))<br>\n  }<\/p>\n\n<p>#transpose data########################################################<br>\n  args2 &lt;- c(input = paste(apply(d[rows, cols], 2, paste, collapse = '\\t'), collapse = '\\n'),  args2, header = TRUE)<br>\n  args2 &lt;- args2[!duplicated(names(args2))]<br>\n  do.call(data.table::fread, args2)<br>\n}<\/p>\n<\/blockquote>\n\n<p>ところでインデントのしかたがよくわからない。<\/p>\n\n<h1>\n<span id=\"なにはともあれenjoy\" class=\"fragment\"><\/span><a href=\"#%E3%81%AA%E3%81%AB%E3%81%AF%E3%81%A8%E3%82%82%E3%81%82%E3%82%8Cenjoy\"><i class=\"fa fa-link\"><\/i><\/a>なにはともあれEnjoy!<\/h1>\n"],"body":["#概要\ndata.table::freadは行が観測値、列が変数な表を読み込む関数\n行が変数で列が観測値な表をfreadすると残念な結果になるから工夫しよう\n\n#Rで表形式のファイル(csvなど)を読み込む一般的な方法\n- read.table\n- readr::read_delim\n- readxl::readxlsx\n- data.table::fread\n- など\n\nこれらはいずれも、行に観測値を記録したファイルの読み込みしか対応していない。\n例えばiris[1:5, ]のような表。\n\n| | Sepal.Length | Sepal.Width | Petal.Length | Petal.Width | Species |\n|:-----:|:-----:|:-----:|:-----:|:-----:|:------:|\n|1 | 5.1 | 3.5 | 1.4 | 0.2 | setosa |\n|2 | 4.9 | 3.0 | 1.4 | 0.2 | setosa |\n|3 | 4.7 | 3.2 | 1.3 | 0.2 | setosa |\n|4 | 4.6 | 3.1 | 1.5 | 0.2 | setosa |\n|5 | 5.0 | 3.6 | 1.4 | 0.2 | setosa |\n\nしかし、以下のように列に観測値を記録していく業界もあるのだ……。\n\n| | 1 | 2 | 3 | 4 | 5 | \n|:-:|:-:|:-:|:-:|:-:|:-:|\n|Sepal.Length | 5.1 | 4.9 | 4.7 | 4.6 | 5.0 | \n|Sepal.Width | 3.5 | 3.0 | 3.2 | 3.1 | 3.6 | \n|Petal.Length | 1.4 | 1.4 | 1.3 | 1.5 | 1.4 | \n|Petal.Width | 0.2 | 0.2 | 0.2 | 0.2 | 0.2 | \n|Species | setosa | setosa | setosa | setosa | setosa |\n\n後者をcsvファイルとして、例えばdata.table::freadで読み込むと以下の問題が起こる\n\n- data.tableはrow.namesを持たないので、項目(例えばSepal.Length)が観測値扱いになる\n- 各列の型がcharacterになってしまい、plotなどで扱い辛い\n    - data.tableはlist of columnsなので、型は列ごとに一意でなければならない。従って、列中に含まれる値を最も柔軟に表現できる型が選ばれる。\n- 無論、読み込んだデータをtransposeしても、理想的に成形された表形式データを得られない\n- 他にも細かい面倒が色々。\n\n> \\#今回は表の読み込みにdata.tableパッケージを使う\n> require(data.table)\n> \n> \\#iris[1:5, ]を元にcsvファイルを用意\n> csv <- \"Sepal.Length,5.1,4.9,4.7,4.6,5.0\\nSepal.Width,3.5,3.0,3.2,3.1,3.6\\nPetal.Length,1.4,1.4,1.3,1.5,1.4\\nPetal.Width,0.2,0.2,0.2,0.2,0.2\\nSpecies,setosa,setosa,setosa,setosa,setosa\\n\"\n> \n> \\#csvファイルを読み込み\n> d <- fread(csv)\n> \n> \\#各列の型はcharacterにcoercedされている\n> sapply(d, typeof)\n>>     V1          V2          V3          V4          V5          V6 \n>> \"character\" \"character\" \"character\" \"character\" \"character\" \"character\" \n> \n> \\#transposeしてみると\n> (現実 <- t(d))\n>>    [,1]           [,2]          [,3]           [,4]          [,5]     \n>> V1 \"Sepal.Length\" \"Sepal.Width\" \"Petal.Length\" \"Petal.Width\" \"Species\"\n>> V2 \"5.1\"          \"3.5\"         \"1.4\"          \"0.2\"         \"setosa\" \n>> V3 \"4.9\"          \"3.0\"         \"1.4\"          \"0.2\"         \"setosa\" \n>> V4 \"4.7\"          \"3.2\"         \"1.3\"          \"0.2\"         \"setosa\" \n>> V5 \"4.6\"          \"3.1\"         \"1.5\"          \"0.2\"         \"setosa\" \n>> V6 \"5.0\"          \"3.6\"         \"1.4\"          \"0.2\"         \"setosa\" \n> \n> (理想 <- data.table::as.data.table(iris[1:5, ]))\n>>    Sepal.Length Sepal.Width Petal.Length Petal.Width Species\n>> 1:          5.1         3.5          1.4         0.2  setosa\n>> 2:          4.9         3.0          1.4         0.2  setosa\n>> 3:          4.7         3.2          1.3         0.2  setosa\n>> 4:          4.6         3.1          1.5         0.2  setosa\n>> 5:          5.0         3.6          1.4         0.2  setosa\n>\n> 現実 == 理想\n>> FALSE\n\n現実と理想の差を悔み、本論から目を反らした話をすると、Rは日本語を変数にできる。\n\n#どうする？\n- 毎回、元データをtransposeしてcsvに保存\n- R上でデータを整形する関数を作る\n\n前者は面倒なので後者を試みる。\n##雛形\n1. データをheaderなしcharacter型のdata.tableとして読込\n2. 各列中の文字列をコンマ区切りの文字列として結合\n3. 2の各項を改行文字(\\n)で結合\n4. freadし直す(headerアリ)\n\n> require(data.table)\n> require(pipeR)\n> \\#transpose fread\n> tfread <- function(input) {\n>     input %>>%\n>         data.table::fread(header = FALSE) %>>%\n>         as.matrix %>>% \n>         apply(2, paste, collapse = \",\") %>>%\n>         paste(collapse = \"\\n\") %>>%\n>         data.table::fread(header = TRUE)\n\n\n##更に便利に\n- 2回のfreadに好きなargumentを与えたい\n- 表計算ソフト上のエラーメッセージ(e.g., #DIV/0!)を欠損値にしたい\n    - 放置すると、エラーメッセージを含む変数の型はcharacter型になってしまう\n- 空白の行・列を削除して、すっきりさせたい\n\n###うおりゃあああ\n\n> require(data.table)\n> require(stringr)\n>\n> tfread <- function(input, remove_null = TRUE, ss = c('excel', 'libre'), args1 = list(), args2 = list()) {\n> \t\\#ABOUT ARGUMENTS\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\n> \t\\#remove_null = TRUE removes null rows and columns\n> \t\\#ss: spread sheet\n> \t\\#args1: list of arguments to fread input data  \n> \t\\#args2: list of arguments to fread the transposed input data\n> \t\\#When there are duplicated arguments in args1 and args2, the prior argument has priority\n> \t\\#i.e., args1 = list(a = 1, a = 2, b = 3) is equivalent to args1 = list(a = 1, b = 3)\n> \n> \t\n> \t\\#read table as character matrix\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\n> \t\\#complete arguments\n> \targs1 <- c(args1, input = input, header = FALSE, colClasses = 'character')\n> \t\\#remove duplicated arguments\n> \targs1 <- args1[!duplicated(names(args1))]\n> \t\\#1st fread\n> \td <- as.matrix(do.call(data.table::fread, args1))\n> \trm(args1)\n> \t\n> \t\\#replace error messages to blank\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\n> \tif(stringr::str_detect(ss[1], '^(excel|libre)$')) {\n> \t\td <- matrix(stringr::str_replace_all(d, '^\\#.*\\\\!$', ''), nrow = nrow(d), ncol = ncol(d))\n> \t}\n> \t\n> \t\\#whether to remove rows and cols with no data\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\n> \tif(remove_null){\n> \t\tfilled <- d != ''\n> \t\tfilled[is.na(filled)] <- FALSE\n> \t\trows <- rowSums(filled) != 0\n> \t\tcols <- colSums(filled) != 0\n> \t} else {\n> \t\trows <- rep(TRUE, nrow(d))\n> \t\tcols <- rep(TRUE, ncol(d))\n> \t}\n> \n> \t\\#transpose data\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\\#\n> \targs2 <- c(input = paste(apply(d[rows, cols], 2, paste, collapse = '\\t'), collapse = '\\n'),  args2, header = TRUE)\n> \targs2 <- args2[!duplicated(names(args2))]\n> \tdo.call(data.table::fread, args2)\n> }\n> \n\nところでインデントのしかたがよくわからない。\n\n#なにはともあれEnjoy!\n"],"coediting":[false],"comments_count":[0],"created_at":["2017-03-23T22:45:21+09:00"],"group":{},"id":["ec44e1d057fe76464b25"],"likes_count":[0],"private":[false],"reactions_count":[0],"tags":[{"name":["R"],"versions":[]},{"name":["data.table"],"versions":[]}],"title":["Rで各列が観測値に対応する表の読み込み"],"updated_at":["2017-03-27T23:29:21+09:00"],"url":["https://qiita.com/Atsushi776/items/ec44e1d057fe76464b25"],"user":{"description":["EPMAデータをより効果的に扱うべくRを使い始めた。\r\n専門は変成岩岩石学。"],"facebook_id":[""],"followees_count":[23],"followers_count":[33],"github_login_name":["atusy"],"id":["Atsushi776"],"items_count":[32],"linkedin_id":[""],"location":[""],"name":[""],"organization":[""],"permanent_id":[149890],"profile_image_url":["https://pbs.twimg.com/profile_images/737129240/P7502_normal.jpg"],"team_only":[false],"twitter_screen_name":["Atsushi776"],"website_url":["https://blog.atusy.net"]},"page_views_count":{}}]
